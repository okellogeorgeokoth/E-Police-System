;(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory(global):typeof define==='function'&&define.amd?define(factory):factory(global)}((typeof self!=='undefined'?self:typeof window!=='undefined'?window:typeof global!=='undefined'?global:this),function(global){'use strict';global=global||{};var _Base64=global.Base64;var version="2.5.1";var buffer;if(typeof module!=='undefined'&&module.exports){try{buffer=eval("require('buffer').Buffer");}catch(err){buffer=undefined;}}
var b64chars='ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';var b64tab=function(bin){var t={};for(var i=0,l=bin.length;i<l;i++)t[bin.charAt(i)]=i;return t;}(b64chars);var fromCharCode=String.fromCharCode;var cb_utob=function(c){if(c.length<2){var cc=c.charCodeAt(0);return cc<0x80?c:cc<0x800?(fromCharCode(0xc0|(cc>>>6))
+fromCharCode(0x80|(cc&0x3f))):(fromCharCode(0xe0|((cc>>>12)&0x0f))
+fromCharCode(0x80|((cc>>>6)&0x3f))
+fromCharCode(0x80|(cc&0x3f)));}else{var cc=0x10000
+(c.charCodeAt(0)-0xD800)*0x400
+(c.charCodeAt(1)-0xDC00);return(fromCharCode(0xf0|((cc>>>18)&0x07))
+fromCharCode(0x80|((cc>>>12)&0x3f))
+fromCharCode(0x80|((cc>>>6)&0x3f))
+fromCharCode(0x80|(cc&0x3f)));}};var re_utob=/[\uD800-\uDBFF][\uDC00-\uDFFFF]|[^\x00-\x7F]/g;var utob=function(u){return u.replace(re_utob,cb_utob);};var cb_encode=function(ccc){var padlen=[0,2,1][ccc.length%3],ord=ccc.charCodeAt(0)<<16|((ccc.length>1?ccc.charCodeAt(1):0)<<8)|((ccc.length>2?ccc.charCodeAt(2):0)),chars=[b64chars.charAt(ord>>>18),b64chars.charAt((ord>>>12)&63),padlen>=2?'=':b64chars.charAt((ord>>>6)&63),padlen>=1?'=':b64chars.charAt(ord&63)];return chars.join('');};var btoa=global.btoa?function(b){return global.btoa(b);}:function(b){return b.replace(/[\s\S]{1,3}/g,cb_encode);};var _encode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(u){return(u.constructor===buffer.constructor?u:buffer.from(u)).toString('base64')}:function(u){return(u.constructor===buffer.constructor?u:new buffer(u)).toString('base64')}:function(u){return btoa(utob(u))};var encode=function(u,urisafe){return!urisafe?_encode(String(u)):_encode(String(u)).replace(/[+\/]/g,function(m0){return m0=='+'?'-':'_';}).replace(/=/g,'');};var encodeURI=function(u){return encode(u,true)};var re_btou=new RegExp(['[\xC0-\xDF][\x80-\xBF]','[\xE0-\xEF][\x80-\xBF]{2}','[\xF0-\xF7][\x80-\xBF]{3}'].join('|'),'g');var cb_btou=function(cccc){switch(cccc.length){case 4:var cp=((0x07&cccc.charCodeAt(0))<<18)|((0x3f&cccc.charCodeAt(1))<<12)|((0x3f&cccc.charCodeAt(2))<<6)|(0x3f&cccc.charCodeAt(3)),offset=cp-0x10000;return(fromCharCode((offset>>>10)+0xD800)
+fromCharCode((offset&0x3FF)+0xDC00));case 3:return fromCharCode(((0x0f&cccc.charCodeAt(0))<<12)|((0x3f&cccc.charCodeAt(1))<<6)|(0x3f&cccc.charCodeAt(2)));default:return fromCharCode(((0x1f&cccc.charCodeAt(0))<<6)|(0x3f&cccc.charCodeAt(1)));}};var btou=function(b){return b.replace(re_btou,cb_btou);};var cb_decode=function(cccc){var len=cccc.length,padlen=len%4,n=(len>0?b64tab[cccc.charAt(0)]<<18:0)|(len>1?b64tab[cccc.charAt(1)]<<12:0)|(len>2?b64tab[cccc.charAt(2)]<<6:0)|(len>3?b64tab[cccc.charAt(3)]:0),chars=[fromCharCode(n>>>16),fromCharCode((n>>>8)&0xff),fromCharCode(n&0xff)];chars.length-=[0,0,2,1][padlen];return chars.join('');};var _atob=global.atob?function(a){return global.atob(a);}:function(a){return a.replace(/\S{1,4}/g,cb_decode);};var atob=function(a){return _atob(String(a).replace(/[^A-Za-z0-9\+\/]/g,''));};var _decode=buffer?buffer.from&&Uint8Array&&buffer.from!==Uint8Array.from?function(a){return(a.constructor===buffer.constructor?a:buffer.from(a,'base64')).toString();}:function(a){return(a.constructor===buffer.constructor?a:new buffer(a,'base64')).toString();}:function(a){return btou(_atob(a))};var decode=function(a){return _decode(String(a).replace(/[-_]/g,function(m0){return m0=='-'?'+':'/'}).replace(/[^A-Za-z0-9\+\/]/g,''));};var noConflict=function(){var Base64=global.Base64;global.Base64=_Base64;return Base64;};global.Base64={VERSION:version,atob:atob,btoa:btoa,fromBase64:decode,toBase64:encode,utob:utob,encode:encode,encodeURI:encodeURI,btou:btou,decode:decode,noConflict:noConflict,__buffer__:buffer};if(typeof Object.defineProperty==='function'){var noEnum=function(v){return{value:v,enumerable:false,writable:true,configurable:true};};global.Base64.extendString=function(){Object.defineProperty(String.prototype,'fromBase64',noEnum(function(){return decode(this)}));Object.defineProperty(String.prototype,'toBase64',noEnum(function(urisafe){return encode(this,urisafe)}));Object.defineProperty(String.prototype,'toBase64URI',noEnum(function(){return encode(this,true)}));};}
if(global['Meteor']){Base64=global.Base64;}
if(typeof module!=='undefined'&&module.exports){module.exports.Base64=global.Base64;}
else if(typeof define==='function'&&define.amd){define([],function(){return global.Base64});}
return{Base64:global.Base64}}));;(function(global,factory){typeof exports==='object'&&typeof module!=='undefined'?module.exports=factory():typeof define==='function'&&define.amd?define(factory):(global=global||self,global.Sortable=factory());}(this,function(){'use strict';function _typeof(obj){if(typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"){_typeof=function(obj){return typeof obj;};}else{_typeof=function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj;};}
return _typeof(obj);}
function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}
return obj;}
function _extends(){_extends=Object.assign||function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source){if(Object.prototype.hasOwnProperty.call(source,key)){target[key]=source[key];}}}
return target;};return _extends.apply(this,arguments);}
function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==='function'){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable;}));}
ownKeys.forEach(function(key){_defineProperty(target,key,source[key]);});}
return target;}
function _objectWithoutPropertiesLoose(source,excluded){if(source==null)return{};var target={};var sourceKeys=Object.keys(source);var key,i;for(i=0;i<sourceKeys.length;i++){key=sourceKeys[i];if(excluded.indexOf(key)>=0)continue;target[key]=source[key];}
return target;}
function _objectWithoutProperties(source,excluded){if(source==null)return{};var target=_objectWithoutPropertiesLoose(source,excluded);var key,i;if(Object.getOwnPropertySymbols){var sourceSymbolKeys=Object.getOwnPropertySymbols(source);for(i=0;i<sourceSymbolKeys.length;i++){key=sourceSymbolKeys[i];if(excluded.indexOf(key)>=0)continue;if(!Object.prototype.propertyIsEnumerable.call(source,key))continue;target[key]=source[key];}}
return target;}
function _toConsumableArray(arr){return _arrayWithoutHoles(arr)||_iterableToArray(arr)||_nonIterableSpread();}
function _arrayWithoutHoles(arr){if(Array.isArray(arr)){for(var i=0,arr2=new Array(arr.length);i<arr.length;i++)arr2[i]=arr[i];return arr2;}}
function _iterableToArray(iter){if(Symbol.iterator in Object(iter)||Object.prototype.toString.call(iter)==="[object Arguments]")return Array.from(iter);}
function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance");}
var version="1.10.2";function userAgent(pattern){if(typeof window!=='undefined'&&window.navigator){return!!navigator.userAgent.match(pattern);}}
var IE11OrLess=userAgent(/(?:Trident.*rv[ :]?11\.|msie|iemobile|Windows Phone)/i);var Edge=userAgent(/Edge/i);var FireFox=userAgent(/firefox/i);var Safari=userAgent(/safari/i)&&!userAgent(/chrome/i)&&!userAgent(/android/i);var IOS=userAgent(/iP(ad|od|hone)/i);var ChromeForAndroid=userAgent(/chrome/i)&&userAgent(/android/i);var captureMode={capture:false,passive:false};function on(el,event,fn){el.addEventListener(event,fn,!IE11OrLess&&captureMode);}
function off(el,event,fn){el.removeEventListener(event,fn,!IE11OrLess&&captureMode);}
function matches(el,selector){if(!selector)return;selector[0]==='>'&&(selector=selector.substring(1));if(el){try{if(el.matches){return el.matches(selector);}else if(el.msMatchesSelector){return el.msMatchesSelector(selector);}else if(el.webkitMatchesSelector){return el.webkitMatchesSelector(selector);}}catch(_){return false;}}
return false;}
function getParentOrHost(el){return el.host&&el!==document&&el.host.nodeType?el.host:el.parentNode;}
function closest(el,selector,ctx,includeCTX){if(el){ctx=ctx||document;do{if(selector!=null&&(selector[0]==='>'?el.parentNode===ctx&&matches(el,selector):matches(el,selector))||includeCTX&&el===ctx){return el;}
if(el===ctx)break;}while(el=getParentOrHost(el));}
return null;}
var R_SPACE=/\s+/g;function toggleClass(el,name,state){if(el&&name){if(el.classList){el.classList[state?'add':'remove'](name);}else{var className=(' '+el.className+' ').replace(R_SPACE,' ').replace(' '+name+' ',' ');el.className=(className+(state?' '+name:'')).replace(R_SPACE,' ');}}}
function css(el,prop,val){var style=el&&el.style;if(style){if(val===void 0){if(document.defaultView&&document.defaultView.getComputedStyle){val=document.defaultView.getComputedStyle(el,'');}else if(el.currentStyle){val=el.currentStyle;}
return prop===void 0?val:val[prop];}else{if(!(prop in style)&&prop.indexOf('webkit')===-1){prop='-webkit-'+prop;}
style[prop]=val+(typeof val==='string'?'':'px');}}}
function matrix(el,selfOnly){var appliedTransforms='';if(typeof el==='string'){appliedTransforms=el;}else{do{var transform=css(el,'transform');if(transform&&transform!=='none'){appliedTransforms=transform+' '+appliedTransforms;}}while(!selfOnly&&(el=el.parentNode));}
var matrixFn=window.DOMMatrix||window.WebKitCSSMatrix||window.CSSMatrix||window.MSCSSMatrix;return matrixFn&&new matrixFn(appliedTransforms);}
function find(ctx,tagName,iterator){if(ctx){var list=ctx.getElementsByTagName(tagName),i=0,n=list.length;if(iterator){for(;i<n;i++){iterator(list[i],i);}}
return list;}
return[];}
function getWindowScrollingElement(){var scrollingElement=document.scrollingElement;if(scrollingElement){return scrollingElement;}else{return document.documentElement;}}
function getRect(el,relativeToContainingBlock,relativeToNonStaticParent,undoScale,container){if(!el.getBoundingClientRect&&el!==window)return;var elRect,top,left,bottom,right,height,width;if(el!==window&&el!==getWindowScrollingElement()){elRect=el.getBoundingClientRect();top=elRect.top;left=elRect.left;bottom=elRect.bottom;right=elRect.right;height=elRect.height;width=elRect.width;}else{top=0;left=0;bottom=window.innerHeight;right=window.innerWidth;height=window.innerHeight;width=window.innerWidth;}
if((relativeToContainingBlock||relativeToNonStaticParent)&&el!==window){container=container||el.parentNode;if(!IE11OrLess){do{if(container&&container.getBoundingClientRect&&(css(container,'transform')!=='none'||relativeToNonStaticParent&&css(container,'position')!=='static')){var containerRect=container.getBoundingClientRect();top-=containerRect.top+parseInt(css(container,'border-top-width'));left-=containerRect.left+parseInt(css(container,'border-left-width'));bottom=top+elRect.height;right=left+elRect.width;break;}}while(container=container.parentNode);}}
if(undoScale&&el!==window){var elMatrix=matrix(container||el),scaleX=elMatrix&&elMatrix.a,scaleY=elMatrix&&elMatrix.d;if(elMatrix){top/=scaleY;left/=scaleX;width/=scaleX;height/=scaleY;bottom=top+height;right=left+width;}}
return{top:top,left:left,bottom:bottom,right:right,width:width,height:height};}
function isScrolledPast(el,elSide,parentSide){var parent=getParentAutoScrollElement(el,true),elSideVal=getRect(el)[elSide];while(parent){var parentSideVal=getRect(parent)[parentSide],visible=void 0;if(parentSide==='top'||parentSide==='left'){visible=elSideVal>=parentSideVal;}else{visible=elSideVal<=parentSideVal;}
if(!visible)return parent;if(parent===getWindowScrollingElement())break;parent=getParentAutoScrollElement(parent,false);}
return false;}
function getChild(el,childNum,options){var currentChild=0,i=0,children=el.children;while(i<children.length){if(children[i].style.display!=='none'&&children[i]!==Sortable.ghost&&children[i]!==Sortable.dragged&&closest(children[i],options.draggable,el,false)){if(currentChild===childNum){return children[i];}
currentChild++;}
i++;}
return null;}
function lastChild(el,selector){var last=el.lastElementChild;while(last&&(last===Sortable.ghost||css(last,'display')==='none'||selector&&!matches(last,selector))){last=last.previousElementSibling;}
return last||null;}
function index(el,selector){var index=0;if(!el||!el.parentNode){return-1;}
while(el=el.previousElementSibling){if(el.nodeName.toUpperCase()!=='TEMPLATE'&&el!==Sortable.clone&&(!selector||matches(el,selector))){index++;}}
return index;}
function getRelativeScrollOffset(el){var offsetLeft=0,offsetTop=0,winScroller=getWindowScrollingElement();if(el){do{var elMatrix=matrix(el),scaleX=elMatrix.a,scaleY=elMatrix.d;offsetLeft+=el.scrollLeft*scaleX;offsetTop+=el.scrollTop*scaleY;}while(el!==winScroller&&(el=el.parentNode));}
return[offsetLeft,offsetTop];}
function indexOfObject(arr,obj){for(var i in arr){if(!arr.hasOwnProperty(i))continue;for(var key in obj){if(obj.hasOwnProperty(key)&&obj[key]===arr[i][key])return Number(i);}}
return-1;}
function getParentAutoScrollElement(el,includeSelf){if(!el||!el.getBoundingClientRect)return getWindowScrollingElement();var elem=el;var gotSelf=false;do{if(elem.clientWidth<elem.scrollWidth||elem.clientHeight<elem.scrollHeight){var elemCSS=css(elem);if(elem.clientWidth<elem.scrollWidth&&(elemCSS.overflowX=='auto'||elemCSS.overflowX=='scroll')||elem.clientHeight<elem.scrollHeight&&(elemCSS.overflowY=='auto'||elemCSS.overflowY=='scroll')){if(!elem.getBoundingClientRect||elem===document.body)return getWindowScrollingElement();if(gotSelf||includeSelf)return elem;gotSelf=true;}}}while(elem=elem.parentNode);return getWindowScrollingElement();}
function extend(dst,src){if(dst&&src){for(var key in src){if(src.hasOwnProperty(key)){dst[key]=src[key];}}}
return dst;}
function isRectEqual(rect1,rect2){return Math.round(rect1.top)===Math.round(rect2.top)&&Math.round(rect1.left)===Math.round(rect2.left)&&Math.round(rect1.height)===Math.round(rect2.height)&&Math.round(rect1.width)===Math.round(rect2.width);}
var _throttleTimeout;function throttle(callback,ms){return function(){if(!_throttleTimeout){var args=arguments,_this=this;if(args.length===1){callback.call(_this,args[0]);}else{callback.apply(_this,args);}
_throttleTimeout=setTimeout(function(){_throttleTimeout=void 0;},ms);}};}
function cancelThrottle(){clearTimeout(_throttleTimeout);_throttleTimeout=void 0;}
function scrollBy(el,x,y){el.scrollLeft+=x;el.scrollTop+=y;}
function clone(el){var Polymer=window.Polymer;var $=window.jQuery||window.Zepto;if(Polymer&&Polymer.dom){return Polymer.dom(el).cloneNode(true);}else if($){return $(el).clone(true)[0];}else{return el.cloneNode(true);}}
function setRect(el,rect){css(el,'position','absolute');css(el,'top',rect.top);css(el,'left',rect.left);css(el,'width',rect.width);css(el,'height',rect.height);}
function unsetRect(el){css(el,'position','');css(el,'top','');css(el,'left','');css(el,'width','');css(el,'height','');}
var expando='Sortable'+new Date().getTime();function AnimationStateManager(){var animationStates=[],animationCallbackId;return{captureAnimationState:function captureAnimationState(){animationStates=[];if(!this.options.animation)return;var children=[].slice.call(this.el.children);children.forEach(function(child){if(css(child,'display')==='none'||child===Sortable.ghost)return;animationStates.push({target:child,rect:getRect(child)});var fromRect=_objectSpread({},animationStates[animationStates.length-1].rect);if(child.thisAnimationDuration){var childMatrix=matrix(child,true);if(childMatrix){fromRect.top-=childMatrix.f;fromRect.left-=childMatrix.e;}}
child.fromRect=fromRect;});},addAnimationState:function addAnimationState(state){animationStates.push(state);},removeAnimationState:function removeAnimationState(target){animationStates.splice(indexOfObject(animationStates,{target:target}),1);},animateAll:function animateAll(callback){var _this=this;if(!this.options.animation){clearTimeout(animationCallbackId);if(typeof callback==='function')callback();return;}
var animating=false,animationTime=0;animationStates.forEach(function(state){var time=0,target=state.target,fromRect=target.fromRect,toRect=getRect(target),prevFromRect=target.prevFromRect,prevToRect=target.prevToRect,animatingRect=state.rect,targetMatrix=matrix(target,true);if(targetMatrix){toRect.top-=targetMatrix.f;toRect.left-=targetMatrix.e;}
target.toRect=toRect;if(target.thisAnimationDuration){if(isRectEqual(prevFromRect,toRect)&&!isRectEqual(fromRect,toRect)&&(animatingRect.top-toRect.top)/(animatingRect.left-toRect.left)===(fromRect.top-toRect.top)/(fromRect.left-toRect.left)){time=calculateRealTime(animatingRect,prevFromRect,prevToRect,_this.options);}}
if(!isRectEqual(toRect,fromRect)){target.prevFromRect=fromRect;target.prevToRect=toRect;if(!time){time=_this.options.animation;}
_this.animate(target,animatingRect,toRect,time);}
if(time){animating=true;animationTime=Math.max(animationTime,time);clearTimeout(target.animationResetTimer);target.animationResetTimer=setTimeout(function(){target.animationTime=0;target.prevFromRect=null;target.fromRect=null;target.prevToRect=null;target.thisAnimationDuration=null;},time);target.thisAnimationDuration=time;}});clearTimeout(animationCallbackId);if(!animating){if(typeof callback==='function')callback();}else{animationCallbackId=setTimeout(function(){if(typeof callback==='function')callback();},animationTime);}
animationStates=[];},animate:function animate(target,currentRect,toRect,duration){if(duration){css(target,'transition','');css(target,'transform','');var elMatrix=matrix(this.el),scaleX=elMatrix&&elMatrix.a,scaleY=elMatrix&&elMatrix.d,translateX=(currentRect.left-toRect.left)/(scaleX||1),translateY=(currentRect.top-toRect.top)/(scaleY||1);target.animatingX=!!translateX;target.animatingY=!!translateY;css(target,'transform','translate3d('+translateX+'px,'+translateY+'px,0)');repaint(target);css(target,'transition','transform '+duration+'ms'+(this.options.easing?' '+this.options.easing:''));css(target,'transform','translate3d(0,0,0)');typeof target.animated==='number'&&clearTimeout(target.animated);target.animated=setTimeout(function(){css(target,'transition','');css(target,'transform','');target.animated=false;target.animatingX=false;target.animatingY=false;},duration);}}};}
function repaint(target){return target.offsetWidth;}
function calculateRealTime(animatingRect,fromRect,toRect,options){return Math.sqrt(Math.pow(fromRect.top-animatingRect.top,2)+Math.pow(fromRect.left-animatingRect.left,2))/Math.sqrt(Math.pow(fromRect.top-toRect.top,2)+Math.pow(fromRect.left-toRect.left,2))*options.animation;}
var plugins=[];var defaults={initializeByDefault:true};var PluginManager={mount:function mount(plugin){for(var option in defaults){if(defaults.hasOwnProperty(option)&&!(option in plugin)){plugin[option]=defaults[option];}}
plugins.push(plugin);},pluginEvent:function pluginEvent(eventName,sortable,evt){var _this=this;this.eventCanceled=false;evt.cancel=function(){_this.eventCanceled=true;};var eventNameGlobal=eventName+'Global';plugins.forEach(function(plugin){if(!sortable[plugin.pluginName])return;if(sortable[plugin.pluginName][eventNameGlobal]){sortable[plugin.pluginName][eventNameGlobal](_objectSpread({sortable:sortable},evt));}
if(sortable.options[plugin.pluginName]&&sortable[plugin.pluginName][eventName]){sortable[plugin.pluginName][eventName](_objectSpread({sortable:sortable},evt));}});},initializePlugins:function initializePlugins(sortable,el,defaults,options){plugins.forEach(function(plugin){var pluginName=plugin.pluginName;if(!sortable.options[pluginName]&&!plugin.initializeByDefault)return;var initialized=new plugin(sortable,el,sortable.options);initialized.sortable=sortable;initialized.options=sortable.options;sortable[pluginName]=initialized;_extends(defaults,initialized.defaults);});for(var option in sortable.options){if(!sortable.options.hasOwnProperty(option))continue;var modified=this.modifyOption(sortable,option,sortable.options[option]);if(typeof modified!=='undefined'){sortable.options[option]=modified;}}},getEventProperties:function getEventProperties(name,sortable){var eventProperties={};plugins.forEach(function(plugin){if(typeof plugin.eventProperties!=='function')return;_extends(eventProperties,plugin.eventProperties.call(sortable[plugin.pluginName],name));});return eventProperties;},modifyOption:function modifyOption(sortable,name,value){var modifiedValue;plugins.forEach(function(plugin){if(!sortable[plugin.pluginName])return;if(plugin.optionListeners&&typeof plugin.optionListeners[name]==='function'){modifiedValue=plugin.optionListeners[name].call(sortable[plugin.pluginName],value);}});return modifiedValue;}};function dispatchEvent(_ref){var sortable=_ref.sortable,rootEl=_ref.rootEl,name=_ref.name,targetEl=_ref.targetEl,cloneEl=_ref.cloneEl,toEl=_ref.toEl,fromEl=_ref.fromEl,oldIndex=_ref.oldIndex,newIndex=_ref.newIndex,oldDraggableIndex=_ref.oldDraggableIndex,newDraggableIndex=_ref.newDraggableIndex,originalEvent=_ref.originalEvent,putSortable=_ref.putSortable,extraEventProperties=_ref.extraEventProperties;sortable=sortable||rootEl&&rootEl[expando];if(!sortable)return;var evt,options=sortable.options,onName='on'+name.charAt(0).toUpperCase()+name.substr(1);if(window.CustomEvent&&!IE11OrLess&&!Edge){evt=new CustomEvent(name,{bubbles:true,cancelable:true});}else{evt=document.createEvent('Event');evt.initEvent(name,true,true);}
evt.to=toEl||rootEl;evt.from=fromEl||rootEl;evt.item=targetEl||rootEl;evt.clone=cloneEl;evt.oldIndex=oldIndex;evt.newIndex=newIndex;evt.oldDraggableIndex=oldDraggableIndex;evt.newDraggableIndex=newDraggableIndex;evt.originalEvent=originalEvent;evt.pullMode=putSortable?putSortable.lastPutMode:undefined;var allEventProperties=_objectSpread({},extraEventProperties,PluginManager.getEventProperties(name,sortable));for(var option in allEventProperties){evt[option]=allEventProperties[option];}
if(rootEl){rootEl.dispatchEvent(evt);}
if(options[onName]){options[onName].call(sortable,evt);}}
var pluginEvent=function pluginEvent(eventName,sortable){var _ref=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{},originalEvent=_ref.evt,data=_objectWithoutProperties(_ref,["evt"]);PluginManager.pluginEvent.bind(Sortable)(eventName,sortable,_objectSpread({dragEl:dragEl,parentEl:parentEl,ghostEl:ghostEl,rootEl:rootEl,nextEl:nextEl,lastDownEl:lastDownEl,cloneEl:cloneEl,cloneHidden:cloneHidden,dragStarted:moved,putSortable:putSortable,activeSortable:Sortable.active,originalEvent:originalEvent,oldIndex:oldIndex,oldDraggableIndex:oldDraggableIndex,newIndex:newIndex,newDraggableIndex:newDraggableIndex,hideGhostForTarget:_hideGhostForTarget,unhideGhostForTarget:_unhideGhostForTarget,cloneNowHidden:function cloneNowHidden(){cloneHidden=true;},cloneNowShown:function cloneNowShown(){cloneHidden=false;},dispatchSortableEvent:function dispatchSortableEvent(name){_dispatchEvent({sortable:sortable,name:name,originalEvent:originalEvent});}},data));};function _dispatchEvent(info){dispatchEvent(_objectSpread({putSortable:putSortable,cloneEl:cloneEl,targetEl:dragEl,rootEl:rootEl,oldIndex:oldIndex,oldDraggableIndex:oldDraggableIndex,newIndex:newIndex,newDraggableIndex:newDraggableIndex},info));}
var dragEl,parentEl,ghostEl,rootEl,nextEl,lastDownEl,cloneEl,cloneHidden,oldIndex,newIndex,oldDraggableIndex,newDraggableIndex,activeGroup,putSortable,awaitingDragStarted=false,ignoreNextClick=false,sortables=[],tapEvt,touchEvt,lastDx,lastDy,tapDistanceLeft,tapDistanceTop,moved,lastTarget,lastDirection,pastFirstInvertThresh=false,isCircumstantialInvert=false,targetMoveDistance,ghostRelativeParent,ghostRelativeParentInitialScroll=[],_silent=false,savedInputChecked=[];var documentExists=typeof document!=='undefined',PositionGhostAbsolutely=IOS,CSSFloatProperty=Edge||IE11OrLess?'cssFloat':'float',supportDraggable=documentExists&&!ChromeForAndroid&&!IOS&&'draggable'in document.createElement('div'),supportCssPointerEvents=function(){if(!documentExists)return;if(IE11OrLess){return false;}
var el=document.createElement('x');el.style.cssText='pointer-events:auto';return el.style.pointerEvents==='auto';}(),_detectDirection=function _detectDirection(el,options){var elCSS=css(el),elWidth=parseInt(elCSS.width)-parseInt(elCSS.paddingLeft)-parseInt(elCSS.paddingRight)-parseInt(elCSS.borderLeftWidth)-parseInt(elCSS.borderRightWidth),child1=getChild(el,0,options),child2=getChild(el,1,options),firstChildCSS=child1&&css(child1),secondChildCSS=child2&&css(child2),firstChildWidth=firstChildCSS&&parseInt(firstChildCSS.marginLeft)+parseInt(firstChildCSS.marginRight)+getRect(child1).width,secondChildWidth=secondChildCSS&&parseInt(secondChildCSS.marginLeft)+parseInt(secondChildCSS.marginRight)+getRect(child2).width;if(elCSS.display==='flex'){return elCSS.flexDirection==='column'||elCSS.flexDirection==='column-reverse'?'vertical':'horizontal';}
if(elCSS.display==='grid'){return elCSS.gridTemplateColumns.split(' ').length<=1?'vertical':'horizontal';}
if(child1&&firstChildCSS["float"]&&firstChildCSS["float"]!=='none'){var touchingSideChild2=firstChildCSS["float"]==='left'?'left':'right';return child2&&(secondChildCSS.clear==='both'||secondChildCSS.clear===touchingSideChild2)?'vertical':'horizontal';}
return child1&&(firstChildCSS.display==='block'||firstChildCSS.display==='flex'||firstChildCSS.display==='table'||firstChildCSS.display==='grid'||firstChildWidth>=elWidth&&elCSS[CSSFloatProperty]==='none'||child2&&elCSS[CSSFloatProperty]==='none'&&firstChildWidth+secondChildWidth>elWidth)?'vertical':'horizontal';},_dragElInRowColumn=function _dragElInRowColumn(dragRect,targetRect,vertical){var dragElS1Opp=vertical?dragRect.left:dragRect.top,dragElS2Opp=vertical?dragRect.right:dragRect.bottom,dragElOppLength=vertical?dragRect.width:dragRect.height,targetS1Opp=vertical?targetRect.left:targetRect.top,targetS2Opp=vertical?targetRect.right:targetRect.bottom,targetOppLength=vertical?targetRect.width:targetRect.height;return dragElS1Opp===targetS1Opp||dragElS2Opp===targetS2Opp||dragElS1Opp+dragElOppLength/2===targetS1Opp+targetOppLength/2;},_detectNearestEmptySortable=function _detectNearestEmptySortable(x,y){var ret;sortables.some(function(sortable){if(lastChild(sortable))return;var rect=getRect(sortable),threshold=sortable[expando].options.emptyInsertThreshold,insideHorizontally=x>=rect.left-threshold&&x<=rect.right+threshold,insideVertically=y>=rect.top-threshold&&y<=rect.bottom+threshold;if(threshold&&insideHorizontally&&insideVertically){return ret=sortable;}});return ret;},_prepareGroup=function _prepareGroup(options){function toFn(value,pull){return function(to,from,dragEl,evt){var sameGroup=to.options.group.name&&from.options.group.name&&to.options.group.name===from.options.group.name;if(value==null&&(pull||sameGroup)){return true;}else if(value==null||value===false){return false;}else if(pull&&value==='clone'){return value;}else if(typeof value==='function'){return toFn(value(to,from,dragEl,evt),pull)(to,from,dragEl,evt);}else{var otherGroup=(pull?to:from).options.group.name;return value===true||typeof value==='string'&&value===otherGroup||value.join&&value.indexOf(otherGroup)>-1;}};}
var group={};var originalGroup=options.group;if(!originalGroup||_typeof(originalGroup)!='object'){originalGroup={name:originalGroup};}
group.name=originalGroup.name;group.checkPull=toFn(originalGroup.pull,true);group.checkPut=toFn(originalGroup.put);group.revertClone=originalGroup.revertClone;options.group=group;},_hideGhostForTarget=function _hideGhostForTarget(){if(!supportCssPointerEvents&&ghostEl){css(ghostEl,'display','none');}},_unhideGhostForTarget=function _unhideGhostForTarget(){if(!supportCssPointerEvents&&ghostEl){css(ghostEl,'display','');}};if(documentExists){document.addEventListener('click',function(evt){if(ignoreNextClick){evt.preventDefault();evt.stopPropagation&&evt.stopPropagation();evt.stopImmediatePropagation&&evt.stopImmediatePropagation();ignoreNextClick=false;return false;}},true);}
var nearestEmptyInsertDetectEvent=function nearestEmptyInsertDetectEvent(evt){if(dragEl){evt=evt.touches?evt.touches[0]:evt;var nearest=_detectNearestEmptySortable(evt.clientX,evt.clientY);if(nearest){var event={};for(var i in evt){if(evt.hasOwnProperty(i)){event[i]=evt[i];}}
event.target=event.rootEl=nearest;event.preventDefault=void 0;event.stopPropagation=void 0;nearest[expando]._onDragOver(event);}}};var _checkOutsideTargetEl=function _checkOutsideTargetEl(evt){if(dragEl){dragEl.parentNode[expando]._isOutsideThisEl(evt.target);}};function Sortable(el,options){if(!(el&&el.nodeType&&el.nodeType===1)){throw "Sortable: `el` must be an HTMLElement, not ".concat({}.toString.call(el));}
this.el=el;this.options=options=_extends({},options);el[expando]=this;var defaults={group:null,sort:true,disabled:false,store:null,handle:null,draggable:/^[uo]l$/i.test(el.nodeName)?'>li':'>*',swapThreshold:1,invertSwap:false,invertedSwapThreshold:null,removeCloneOnHide:true,direction:function direction(){return _detectDirection(el,this.options);},ghostClass:'sortable-ghost',chosenClass:'sortable-chosen',dragClass:'sortable-drag',ignore:'a, img',filter:null,preventOnFilter:true,animation:0,easing:null,setData:function setData(dataTransfer,dragEl){dataTransfer.setData('Text',dragEl.textContent);},dropBubble:false,dragoverBubble:false,dataIdAttr:'data-id',delay:0,delayOnTouchOnly:false,touchStartThreshold:(Number.parseInt?Number:window).parseInt(window.devicePixelRatio,10)||1,forceFallback:false,fallbackClass:'sortable-fallback',fallbackOnBody:false,fallbackTolerance:0,fallbackOffset:{x:0,y:0},supportPointer:Sortable.supportPointer!==false&&'PointerEvent'in window,emptyInsertThreshold:5};PluginManager.initializePlugins(this,el,defaults);for(var name in defaults){!(name in options)&&(options[name]=defaults[name]);}
_prepareGroup(options);for(var fn in this){if(fn.charAt(0)==='_'&&typeof this[fn]==='function'){this[fn]=this[fn].bind(this);}}
this.nativeDraggable=options.forceFallback?false:supportDraggable;if(this.nativeDraggable){this.options.touchStartThreshold=1;}
if(options.supportPointer){on(el,'pointerdown',this._onTapStart);}else{on(el,'mousedown',this._onTapStart);on(el,'touchstart',this._onTapStart);}
if(this.nativeDraggable){on(el,'dragover',this);on(el,'dragenter',this);}
sortables.push(this.el);options.store&&options.store.get&&this.sort(options.store.get(this)||[]);_extends(this,AnimationStateManager());}
Sortable.prototype={constructor:Sortable,_isOutsideThisEl:function _isOutsideThisEl(target){if(!this.el.contains(target)&&target!==this.el){lastTarget=null;}},_getDirection:function _getDirection(evt,target){return typeof this.options.direction==='function'?this.options.direction.call(this,evt,target,dragEl):this.options.direction;},_onTapStart:function _onTapStart(evt){if(!evt.cancelable)return;var _this=this,el=this.el,options=this.options,preventOnFilter=options.preventOnFilter,type=evt.type,touch=evt.touches&&evt.touches[0]||evt.pointerType&&evt.pointerType==='touch'&&evt,target=(touch||evt).target,originalTarget=evt.target.shadowRoot&&(evt.path&&evt.path[0]||evt.composedPath&&evt.composedPath()[0])||target,filter=options.filter;_saveInputCheckedState(el);if(dragEl){return;}
if(/mousedown|pointerdown/.test(type)&&evt.button!==0||options.disabled){return;}
if(originalTarget.isContentEditable){return;}
target=closest(target,options.draggable,el,false);if(target&&target.animated){return;}
if(lastDownEl===target){return;}
oldIndex=index(target);oldDraggableIndex=index(target,options.draggable);if(typeof filter==='function'){if(filter.call(this,evt,target,this)){_dispatchEvent({sortable:_this,rootEl:originalTarget,name:'filter',targetEl:target,toEl:el,fromEl:el});pluginEvent('filter',_this,{evt:evt});preventOnFilter&&evt.cancelable&&evt.preventDefault();return;}}else if(filter){filter=filter.split(',').some(function(criteria){criteria=closest(originalTarget,criteria.trim(),el,false);if(criteria){_dispatchEvent({sortable:_this,rootEl:criteria,name:'filter',targetEl:target,fromEl:el,toEl:el});pluginEvent('filter',_this,{evt:evt});return true;}});if(filter){preventOnFilter&&evt.cancelable&&evt.preventDefault();return;}}
if(options.handle&&!closest(originalTarget,options.handle,el,false)){return;}
this._prepareDragStart(evt,touch,target);},_prepareDragStart:function _prepareDragStart(evt,touch,target){var _this=this,el=_this.el,options=_this.options,ownerDocument=el.ownerDocument,dragStartFn;if(target&&!dragEl&&target.parentNode===el){var dragRect=getRect(target);rootEl=el;dragEl=target;parentEl=dragEl.parentNode;nextEl=dragEl.nextSibling;lastDownEl=target;activeGroup=options.group;Sortable.dragged=dragEl;tapEvt={target:dragEl,clientX:(touch||evt).clientX,clientY:(touch||evt).clientY};tapDistanceLeft=tapEvt.clientX-dragRect.left;tapDistanceTop=tapEvt.clientY-dragRect.top;this._lastX=(touch||evt).clientX;this._lastY=(touch||evt).clientY;dragEl.style['will-change']='all';dragStartFn=function dragStartFn(){pluginEvent('delayEnded',_this,{evt:evt});if(Sortable.eventCanceled){_this._onDrop();return;}
_this._disableDelayedDragEvents();if(!FireFox&&_this.nativeDraggable){dragEl.draggable=true;}
_this._triggerDragStart(evt,touch);_dispatchEvent({sortable:_this,name:'choose',originalEvent:evt});toggleClass(dragEl,options.chosenClass,true);};options.ignore.split(',').forEach(function(criteria){find(dragEl,criteria.trim(),_disableDraggable);});on(ownerDocument,'dragover',nearestEmptyInsertDetectEvent);on(ownerDocument,'mousemove',nearestEmptyInsertDetectEvent);on(ownerDocument,'touchmove',nearestEmptyInsertDetectEvent);on(ownerDocument,'mouseup',_this._onDrop);on(ownerDocument,'touchend',_this._onDrop);on(ownerDocument,'touchcancel',_this._onDrop);if(FireFox&&this.nativeDraggable){this.options.touchStartThreshold=4;dragEl.draggable=true;}
pluginEvent('delayStart',this,{evt:evt});if(options.delay&&(!options.delayOnTouchOnly||touch)&&(!this.nativeDraggable||!(Edge||IE11OrLess))){if(Sortable.eventCanceled){this._onDrop();return;}
on(ownerDocument,'mouseup',_this._disableDelayedDrag);on(ownerDocument,'touchend',_this._disableDelayedDrag);on(ownerDocument,'touchcancel',_this._disableDelayedDrag);on(ownerDocument,'mousemove',_this._delayedDragTouchMoveHandler);on(ownerDocument,'touchmove',_this._delayedDragTouchMoveHandler);options.supportPointer&&on(ownerDocument,'pointermove',_this._delayedDragTouchMoveHandler);_this._dragStartTimer=setTimeout(dragStartFn,options.delay);}else{dragStartFn();}}},_delayedDragTouchMoveHandler:function _delayedDragTouchMoveHandler(e){var touch=e.touches?e.touches[0]:e;if(Math.max(Math.abs(touch.clientX-this._lastX),Math.abs(touch.clientY-this._lastY))>=Math.floor(this.options.touchStartThreshold/(this.nativeDraggable&&window.devicePixelRatio||1))){this._disableDelayedDrag();}},_disableDelayedDrag:function _disableDelayedDrag(){dragEl&&_disableDraggable(dragEl);clearTimeout(this._dragStartTimer);this._disableDelayedDragEvents();},_disableDelayedDragEvents:function _disableDelayedDragEvents(){var ownerDocument=this.el.ownerDocument;off(ownerDocument,'mouseup',this._disableDelayedDrag);off(ownerDocument,'touchend',this._disableDelayedDrag);off(ownerDocument,'touchcancel',this._disableDelayedDrag);off(ownerDocument,'mousemove',this._delayedDragTouchMoveHandler);off(ownerDocument,'touchmove',this._delayedDragTouchMoveHandler);off(ownerDocument,'pointermove',this._delayedDragTouchMoveHandler);},_triggerDragStart:function _triggerDragStart(evt,touch){touch=touch||evt.pointerType=='touch'&&evt;if(!this.nativeDraggable||touch){if(this.options.supportPointer){on(document,'pointermove',this._onTouchMove);}else if(touch){on(document,'touchmove',this._onTouchMove);}else{on(document,'mousemove',this._onTouchMove);}}else{on(dragEl,'dragend',this);on(rootEl,'dragstart',this._onDragStart);}
try{if(document.selection){_nextTick(function(){document.selection.empty();});}else{window.getSelection().removeAllRanges();}}catch(err){}},_dragStarted:function _dragStarted(fallback,evt){awaitingDragStarted=false;if(rootEl&&dragEl){pluginEvent('dragStarted',this,{evt:evt});if(this.nativeDraggable){on(document,'dragover',_checkOutsideTargetEl);}
var options=this.options;!fallback&&toggleClass(dragEl,options.dragClass,false);toggleClass(dragEl,options.ghostClass,true);Sortable.active=this;fallback&&this._appendGhost();_dispatchEvent({sortable:this,name:'start',originalEvent:evt});}else{this._nulling();}},_emulateDragOver:function _emulateDragOver(){if(touchEvt){this._lastX=touchEvt.clientX;this._lastY=touchEvt.clientY;_hideGhostForTarget();var target=document.elementFromPoint(touchEvt.clientX,touchEvt.clientY);var parent=target;while(target&&target.shadowRoot){target=target.shadowRoot.elementFromPoint(touchEvt.clientX,touchEvt.clientY);if(target===parent)break;parent=target;}
dragEl.parentNode[expando]._isOutsideThisEl(target);if(parent){do{if(parent[expando]){var inserted=void 0;inserted=parent[expando]._onDragOver({clientX:touchEvt.clientX,clientY:touchEvt.clientY,target:target,rootEl:parent});if(inserted&&!this.options.dragoverBubble){break;}}
target=parent;}
while(parent=parent.parentNode);}
_unhideGhostForTarget();}},_onTouchMove:function _onTouchMove(evt){if(tapEvt){var options=this.options,fallbackTolerance=options.fallbackTolerance,fallbackOffset=options.fallbackOffset,touch=evt.touches?evt.touches[0]:evt,ghostMatrix=ghostEl&&matrix(ghostEl,true),scaleX=ghostEl&&ghostMatrix&&ghostMatrix.a,scaleY=ghostEl&&ghostMatrix&&ghostMatrix.d,relativeScrollOffset=PositionGhostAbsolutely&&ghostRelativeParent&&getRelativeScrollOffset(ghostRelativeParent),dx=(touch.clientX-tapEvt.clientX+fallbackOffset.x)/(scaleX||1)+(relativeScrollOffset?relativeScrollOffset[0]-ghostRelativeParentInitialScroll[0]:0)/(scaleX||1),dy=(touch.clientY-tapEvt.clientY+fallbackOffset.y)/(scaleY||1)+(relativeScrollOffset?relativeScrollOffset[1]-ghostRelativeParentInitialScroll[1]:0)/(scaleY||1);if(!Sortable.active&&!awaitingDragStarted){if(fallbackTolerance&&Math.max(Math.abs(touch.clientX-this._lastX),Math.abs(touch.clientY-this._lastY))<fallbackTolerance){return;}
this._onDragStart(evt,true);}
if(ghostEl){if(ghostMatrix){ghostMatrix.e+=dx-(lastDx||0);ghostMatrix.f+=dy-(lastDy||0);}else{ghostMatrix={a:1,b:0,c:0,d:1,e:dx,f:dy};}
var cssMatrix="matrix(".concat(ghostMatrix.a,",").concat(ghostMatrix.b,",").concat(ghostMatrix.c,",").concat(ghostMatrix.d,",").concat(ghostMatrix.e,",").concat(ghostMatrix.f,")");css(ghostEl,'webkitTransform',cssMatrix);css(ghostEl,'mozTransform',cssMatrix);css(ghostEl,'msTransform',cssMatrix);css(ghostEl,'transform',cssMatrix);lastDx=dx;lastDy=dy;touchEvt=touch;}
evt.cancelable&&evt.preventDefault();}},_appendGhost:function _appendGhost(){if(!ghostEl){var container=this.options.fallbackOnBody?document.body:rootEl,rect=getRect(dragEl,true,PositionGhostAbsolutely,true,container),options=this.options;if(PositionGhostAbsolutely){ghostRelativeParent=container;while(css(ghostRelativeParent,'position')==='static'&&css(ghostRelativeParent,'transform')==='none'&&ghostRelativeParent!==document){ghostRelativeParent=ghostRelativeParent.parentNode;}
if(ghostRelativeParent!==document.body&&ghostRelativeParent!==document.documentElement){if(ghostRelativeParent===document)ghostRelativeParent=getWindowScrollingElement();rect.top+=ghostRelativeParent.scrollTop;rect.left+=ghostRelativeParent.scrollLeft;}else{ghostRelativeParent=getWindowScrollingElement();}
ghostRelativeParentInitialScroll=getRelativeScrollOffset(ghostRelativeParent);}
ghostEl=dragEl.cloneNode(true);toggleClass(ghostEl,options.ghostClass,false);toggleClass(ghostEl,options.fallbackClass,true);toggleClass(ghostEl,options.dragClass,true);css(ghostEl,'transition','');css(ghostEl,'transform','');css(ghostEl,'box-sizing','border-box');css(ghostEl,'margin',0);css(ghostEl,'top',rect.top);css(ghostEl,'left',rect.left);css(ghostEl,'width',rect.width);css(ghostEl,'height',rect.height);css(ghostEl,'opacity','0.8');css(ghostEl,'position',PositionGhostAbsolutely?'absolute':'fixed');css(ghostEl,'zIndex','100000');css(ghostEl,'pointerEvents','none');Sortable.ghost=ghostEl;container.appendChild(ghostEl);css(ghostEl,'transform-origin',tapDistanceLeft/parseInt(ghostEl.style.width)*100+'% '+tapDistanceTop/parseInt(ghostEl.style.height)*100+'%');}},_onDragStart:function _onDragStart(evt,fallback){var _this=this;var dataTransfer=evt.dataTransfer;var options=_this.options;pluginEvent('dragStart',this,{evt:evt});if(Sortable.eventCanceled){this._onDrop();return;}
pluginEvent('setupClone',this);if(!Sortable.eventCanceled){cloneEl=clone(dragEl);cloneEl.draggable=false;cloneEl.style['will-change']='';this._hideClone();toggleClass(cloneEl,this.options.chosenClass,false);Sortable.clone=cloneEl;}
_this.cloneId=_nextTick(function(){pluginEvent('clone',_this);if(Sortable.eventCanceled)return;if(!_this.options.removeCloneOnHide){rootEl.insertBefore(cloneEl,dragEl);}
_this._hideClone();_dispatchEvent({sortable:_this,name:'clone'});});!fallback&&toggleClass(dragEl,options.dragClass,true);if(fallback){ignoreNextClick=true;_this._loopId=setInterval(_this._emulateDragOver,50);}else{off(document,'mouseup',_this._onDrop);off(document,'touchend',_this._onDrop);off(document,'touchcancel',_this._onDrop);if(dataTransfer){dataTransfer.effectAllowed='move';options.setData&&options.setData.call(_this,dataTransfer,dragEl);}
on(document,'drop',_this);css(dragEl,'transform','translateZ(0)');}
awaitingDragStarted=true;_this._dragStartId=_nextTick(_this._dragStarted.bind(_this,fallback,evt));on(document,'selectstart',_this);moved=true;if(Safari){css(document.body,'user-select','none');}},_onDragOver:function _onDragOver(evt){var el=this.el,target=evt.target,dragRect,targetRect,revert,options=this.options,group=options.group,activeSortable=Sortable.active,isOwner=activeGroup===group,canSort=options.sort,fromSortable=putSortable||activeSortable,vertical,_this=this,completedFired=false;if(_silent)return;function dragOverEvent(name,extra){pluginEvent(name,_this,_objectSpread({evt:evt,isOwner:isOwner,axis:vertical?'vertical':'horizontal',revert:revert,dragRect:dragRect,targetRect:targetRect,canSort:canSort,fromSortable:fromSortable,target:target,completed:completed,onMove:function onMove(target,after){return _onMove(rootEl,el,dragEl,dragRect,target,getRect(target),evt,after);},changed:changed},extra));}
function capture(){dragOverEvent('dragOverAnimationCapture');_this.captureAnimationState();if(_this!==fromSortable){fromSortable.captureAnimationState();}}
function completed(insertion){dragOverEvent('dragOverCompleted',{insertion:insertion});if(insertion){if(isOwner){activeSortable._hideClone();}else{activeSortable._showClone(_this);}
if(_this!==fromSortable){toggleClass(dragEl,putSortable?putSortable.options.ghostClass:activeSortable.options.ghostClass,false);toggleClass(dragEl,options.ghostClass,true);}
if(putSortable!==_this&&_this!==Sortable.active){putSortable=_this;}else if(_this===Sortable.active&&putSortable){putSortable=null;}
if(fromSortable===_this){_this._ignoreWhileAnimating=target;}
_this.animateAll(function(){dragOverEvent('dragOverAnimationComplete');_this._ignoreWhileAnimating=null;});if(_this!==fromSortable){fromSortable.animateAll();fromSortable._ignoreWhileAnimating=null;}}
if(target===dragEl&&!dragEl.animated||target===el&&!target.animated){lastTarget=null;}
if(!options.dragoverBubble&&!evt.rootEl&&target!==document){dragEl.parentNode[expando]._isOutsideThisEl(evt.target);!insertion&&nearestEmptyInsertDetectEvent(evt);}
!options.dragoverBubble&&evt.stopPropagation&&evt.stopPropagation();return completedFired=true;}
function changed(){newIndex=index(dragEl);newDraggableIndex=index(dragEl,options.draggable);_dispatchEvent({sortable:_this,name:'change',toEl:el,newIndex:newIndex,newDraggableIndex:newDraggableIndex,originalEvent:evt});}
if(evt.preventDefault!==void 0){evt.cancelable&&evt.preventDefault();}
target=closest(target,options.draggable,el,true);dragOverEvent('dragOver');if(Sortable.eventCanceled)return completedFired;if(dragEl.contains(evt.target)||target.animated&&target.animatingX&&target.animatingY||_this._ignoreWhileAnimating===target){return completed(false);}
ignoreNextClick=false;if(activeSortable&&!options.disabled&&(isOwner?canSort||(revert=!rootEl.contains(dragEl)):putSortable===this||(this.lastPutMode=activeGroup.checkPull(this,activeSortable,dragEl,evt))&&group.checkPut(this,activeSortable,dragEl,evt))){vertical=this._getDirection(evt,target)==='vertical';dragRect=getRect(dragEl);dragOverEvent('dragOverValid');if(Sortable.eventCanceled)return completedFired;if(revert){parentEl=rootEl;capture();this._hideClone();dragOverEvent('revert');if(!Sortable.eventCanceled){if(nextEl){rootEl.insertBefore(dragEl,nextEl);}else{rootEl.appendChild(dragEl);}}
return completed(true);}
var elLastChild=lastChild(el,options.draggable);if(!elLastChild||_ghostIsLast(evt,vertical,this)&&!elLastChild.animated){if(elLastChild===dragEl){return completed(false);}
if(elLastChild&&el===evt.target){target=elLastChild;}
if(target){targetRect=getRect(target);}
if(_onMove(rootEl,el,dragEl,dragRect,target,targetRect,evt,!!target)!==false){capture();el.appendChild(dragEl);parentEl=el;changed();return completed(true);}}else if(target.parentNode===el){targetRect=getRect(target);var direction=0,targetBeforeFirstSwap,differentLevel=dragEl.parentNode!==el,differentRowCol=!_dragElInRowColumn(dragEl.animated&&dragEl.toRect||dragRect,target.animated&&target.toRect||targetRect,vertical),side1=vertical?'top':'left',scrolledPastTop=isScrolledPast(target,'top','top')||isScrolledPast(dragEl,'top','top'),scrollBefore=scrolledPastTop?scrolledPastTop.scrollTop:void 0;if(lastTarget!==target){targetBeforeFirstSwap=targetRect[side1];pastFirstInvertThresh=false;isCircumstantialInvert=!differentRowCol&&options.invertSwap||differentLevel;}
direction=_getSwapDirection(evt,target,targetRect,vertical,differentRowCol?1:options.swapThreshold,options.invertedSwapThreshold==null?options.swapThreshold:options.invertedSwapThreshold,isCircumstantialInvert,lastTarget===target);var sibling;if(direction!==0){var dragIndex=index(dragEl);do{dragIndex-=direction;sibling=parentEl.children[dragIndex];}while(sibling&&(css(sibling,'display')==='none'||sibling===ghostEl));}
if(direction===0||sibling===target){return completed(false);}
lastTarget=target;lastDirection=direction;var nextSibling=target.nextElementSibling,after=false;after=direction===1;var moveVector=_onMove(rootEl,el,dragEl,dragRect,target,targetRect,evt,after);if(moveVector!==false){if(moveVector===1||moveVector===-1){after=moveVector===1;}
_silent=true;setTimeout(_unsilent,30);capture();if(after&&!nextSibling){el.appendChild(dragEl);}else{target.parentNode.insertBefore(dragEl,after?nextSibling:target);}
if(scrolledPastTop){scrollBy(scrolledPastTop,0,scrollBefore-scrolledPastTop.scrollTop);}
parentEl=dragEl.parentNode;if(targetBeforeFirstSwap!==undefined&&!isCircumstantialInvert){targetMoveDistance=Math.abs(targetBeforeFirstSwap-getRect(target)[side1]);}
changed();return completed(true);}}
if(el.contains(dragEl)){return completed(false);}}
return false;},_ignoreWhileAnimating:null,_offMoveEvents:function _offMoveEvents(){off(document,'mousemove',this._onTouchMove);off(document,'touchmove',this._onTouchMove);off(document,'pointermove',this._onTouchMove);off(document,'dragover',nearestEmptyInsertDetectEvent);off(document,'mousemove',nearestEmptyInsertDetectEvent);off(document,'touchmove',nearestEmptyInsertDetectEvent);},_offUpEvents:function _offUpEvents(){var ownerDocument=this.el.ownerDocument;off(ownerDocument,'mouseup',this._onDrop);off(ownerDocument,'touchend',this._onDrop);off(ownerDocument,'pointerup',this._onDrop);off(ownerDocument,'touchcancel',this._onDrop);off(document,'selectstart',this);},_onDrop:function _onDrop(evt){var el=this.el,options=this.options;newIndex=index(dragEl);newDraggableIndex=index(dragEl,options.draggable);pluginEvent('drop',this,{evt:evt});parentEl=dragEl&&dragEl.parentNode;newIndex=index(dragEl);newDraggableIndex=index(dragEl,options.draggable);if(Sortable.eventCanceled){this._nulling();return;}
awaitingDragStarted=false;isCircumstantialInvert=false;pastFirstInvertThresh=false;clearInterval(this._loopId);clearTimeout(this._dragStartTimer);_cancelNextTick(this.cloneId);_cancelNextTick(this._dragStartId);if(this.nativeDraggable){off(document,'drop',this);off(el,'dragstart',this._onDragStart);}
this._offMoveEvents();this._offUpEvents();if(Safari){css(document.body,'user-select','');}
css(dragEl,'transform','');if(evt){if(moved){evt.cancelable&&evt.preventDefault();!options.dropBubble&&evt.stopPropagation();}
ghostEl&&ghostEl.parentNode&&ghostEl.parentNode.removeChild(ghostEl);if(rootEl===parentEl||putSortable&&putSortable.lastPutMode!=='clone'){cloneEl&&cloneEl.parentNode&&cloneEl.parentNode.removeChild(cloneEl);}
if(dragEl){if(this.nativeDraggable){off(dragEl,'dragend',this);}
_disableDraggable(dragEl);dragEl.style['will-change']='';if(moved&&!awaitingDragStarted){toggleClass(dragEl,putSortable?putSortable.options.ghostClass:this.options.ghostClass,false);}
toggleClass(dragEl,this.options.chosenClass,false);_dispatchEvent({sortable:this,name:'unchoose',toEl:parentEl,newIndex:null,newDraggableIndex:null,originalEvent:evt});if(rootEl!==parentEl){if(newIndex>=0){_dispatchEvent({rootEl:parentEl,name:'add',toEl:parentEl,fromEl:rootEl,originalEvent:evt});_dispatchEvent({sortable:this,name:'remove',toEl:parentEl,originalEvent:evt});_dispatchEvent({rootEl:parentEl,name:'sort',toEl:parentEl,fromEl:rootEl,originalEvent:evt});_dispatchEvent({sortable:this,name:'sort',toEl:parentEl,originalEvent:evt});}
putSortable&&putSortable.save();}else{if(newIndex!==oldIndex){if(newIndex>=0){_dispatchEvent({sortable:this,name:'update',toEl:parentEl,originalEvent:evt});_dispatchEvent({sortable:this,name:'sort',toEl:parentEl,originalEvent:evt});}}}
if(Sortable.active){if(newIndex==null||newIndex===-1){newIndex=oldIndex;newDraggableIndex=oldDraggableIndex;}
_dispatchEvent({sortable:this,name:'end',toEl:parentEl,originalEvent:evt});this.save();}}}
this._nulling();},_nulling:function _nulling(){pluginEvent('nulling',this);rootEl=dragEl=parentEl=ghostEl=nextEl=cloneEl=lastDownEl=cloneHidden=tapEvt=touchEvt=moved=newIndex=newDraggableIndex=oldIndex=oldDraggableIndex=lastTarget=lastDirection=putSortable=activeGroup=Sortable.dragged=Sortable.ghost=Sortable.clone=Sortable.active=null;savedInputChecked.forEach(function(el){el.checked=true;});savedInputChecked.length=lastDx=lastDy=0;},handleEvent:function handleEvent(evt){switch(evt.type){case 'drop':case 'dragend':this._onDrop(evt);break;case 'dragenter':case 'dragover':if(dragEl){this._onDragOver(evt);_globalDragOver(evt);}
break;case 'selectstart':evt.preventDefault();break;}},toArray:function toArray(){var order=[],el,children=this.el.children,i=0,n=children.length,options=this.options;for(;i<n;i++){el=children[i];if(closest(el,options.draggable,this.el,false)){order.push(el.getAttribute(options.dataIdAttr)||_generateId(el));}}
return order;},sort:function sort(order){var items={},rootEl=this.el;this.toArray().forEach(function(id,i){var el=rootEl.children[i];if(closest(el,this.options.draggable,rootEl,false)){items[id]=el;}},this);order.forEach(function(id){if(items[id]){rootEl.removeChild(items[id]);rootEl.appendChild(items[id]);}});},save:function save(){var store=this.options.store;store&&store.set&&store.set(this);},closest:function closest$1(el,selector){return closest(el,selector||this.options.draggable,this.el,false);},option:function option(name,value){var options=this.options;if(value===void 0){return options[name];}else{var modifiedValue=PluginManager.modifyOption(this,name,value);if(typeof modifiedValue!=='undefined'){options[name]=modifiedValue;}else{options[name]=value;}
if(name==='group'){_prepareGroup(options);}}},destroy:function destroy(){pluginEvent('destroy',this);var el=this.el;el[expando]=null;off(el,'mousedown',this._onTapStart);off(el,'touchstart',this._onTapStart);off(el,'pointerdown',this._onTapStart);if(this.nativeDraggable){off(el,'dragover',this);off(el,'dragenter',this);}
Array.prototype.forEach.call(el.querySelectorAll('[draggable]'),function(el){el.removeAttribute('draggable');});this._onDrop();this._disableDelayedDragEvents();sortables.splice(sortables.indexOf(this.el),1);this.el=el=null;},_hideClone:function _hideClone(){if(!cloneHidden){pluginEvent('hideClone',this);if(Sortable.eventCanceled)return;css(cloneEl,'display','none');if(this.options.removeCloneOnHide&&cloneEl.parentNode){cloneEl.parentNode.removeChild(cloneEl);}
cloneHidden=true;}},_showClone:function _showClone(putSortable){if(putSortable.lastPutMode!=='clone'){this._hideClone();return;}
if(cloneHidden){pluginEvent('showClone',this);if(Sortable.eventCanceled)return;if(rootEl.contains(dragEl)&&!this.options.group.revertClone){rootEl.insertBefore(cloneEl,dragEl);}else if(nextEl){rootEl.insertBefore(cloneEl,nextEl);}else{rootEl.appendChild(cloneEl);}
if(this.options.group.revertClone){this.animate(dragEl,cloneEl);}
css(cloneEl,'display','');cloneHidden=false;}}};function _globalDragOver(evt){if(evt.dataTransfer){evt.dataTransfer.dropEffect='move';}
evt.cancelable&&evt.preventDefault();}
function _onMove(fromEl,toEl,dragEl,dragRect,targetEl,targetRect,originalEvent,willInsertAfter){var evt,sortable=fromEl[expando],onMoveFn=sortable.options.onMove,retVal;if(window.CustomEvent&&!IE11OrLess&&!Edge){evt=new CustomEvent('move',{bubbles:true,cancelable:true});}else{evt=document.createEvent('Event');evt.initEvent('move',true,true);}
evt.to=toEl;evt.from=fromEl;evt.dragged=dragEl;evt.draggedRect=dragRect;evt.related=targetEl||toEl;evt.relatedRect=targetRect||getRect(toEl);evt.willInsertAfter=willInsertAfter;evt.originalEvent=originalEvent;fromEl.dispatchEvent(evt);if(onMoveFn){retVal=onMoveFn.call(sortable,evt,originalEvent);}
return retVal;}
function _disableDraggable(el){el.draggable=false;}
function _unsilent(){_silent=false;}
function _ghostIsLast(evt,vertical,sortable){var rect=getRect(lastChild(sortable.el,sortable.options.draggable));var spacer=10;return vertical?evt.clientX>rect.right+spacer||evt.clientX<=rect.right&&evt.clientY>rect.bottom&&evt.clientX>=rect.left:evt.clientX>rect.right&&evt.clientY>rect.top||evt.clientX<=rect.right&&evt.clientY>rect.bottom+spacer;}
function _getSwapDirection(evt,target,targetRect,vertical,swapThreshold,invertedSwapThreshold,invertSwap,isLastTarget){var mouseOnAxis=vertical?evt.clientY:evt.clientX,targetLength=vertical?targetRect.height:targetRect.width,targetS1=vertical?targetRect.top:targetRect.left,targetS2=vertical?targetRect.bottom:targetRect.right,invert=false;if(!invertSwap){if(isLastTarget&&targetMoveDistance<targetLength*swapThreshold){if(!pastFirstInvertThresh&&(lastDirection===1?mouseOnAxis>targetS1+targetLength*invertedSwapThreshold/2:mouseOnAxis<targetS2-targetLength*invertedSwapThreshold/2)){pastFirstInvertThresh=true;}
if(!pastFirstInvertThresh){if(lastDirection===1?mouseOnAxis<targetS1+targetMoveDistance:mouseOnAxis>targetS2-targetMoveDistance){return-lastDirection;}}else{invert=true;}}else{if(mouseOnAxis>targetS1+targetLength*(1-swapThreshold)/2&&mouseOnAxis<targetS2-targetLength*(1-swapThreshold)/2){return _getInsertDirection(target);}}}
invert=invert||invertSwap;if(invert){if(mouseOnAxis<targetS1+targetLength*invertedSwapThreshold/2||mouseOnAxis>targetS2-targetLength*invertedSwapThreshold/2){return mouseOnAxis>targetS1+targetLength/2?1:-1;}}
return 0;}
function _getInsertDirection(target){if(index(dragEl)<index(target)){return 1;}else{return-1;}}
function _generateId(el){var str=el.tagName+el.className+el.src+el.href+el.textContent,i=str.length,sum=0;while(i--){sum+=str.charCodeAt(i);}
return sum.toString(36);}
function _saveInputCheckedState(root){savedInputChecked.length=0;var inputs=root.getElementsByTagName('input');var idx=inputs.length;while(idx--){var el=inputs[idx];el.checked&&savedInputChecked.push(el);}}
function _nextTick(fn){return setTimeout(fn,0);}
function _cancelNextTick(id){return clearTimeout(id);}
if(documentExists){on(document,'touchmove',function(evt){if((Sortable.active||awaitingDragStarted)&&evt.cancelable){evt.preventDefault();}});}
Sortable.utils={on:on,off:off,css:css,find:find,is:function is(el,selector){return!!closest(el,selector,el,false);},extend:extend,throttle:throttle,closest:closest,toggleClass:toggleClass,clone:clone,index:index,nextTick:_nextTick,cancelNextTick:_cancelNextTick,detectDirection:_detectDirection,getChild:getChild};Sortable.get=function(element){return element[expando];};Sortable.mount=function(){for(var _len=arguments.length,plugins=new Array(_len),_key=0;_key<_len;_key++){plugins[_key]=arguments[_key];}
if(plugins[0].constructor===Array)plugins=plugins[0];plugins.forEach(function(plugin){if(!plugin.prototype||!plugin.prototype.constructor){throw "Sortable: Mounted plugin must be a constructor function, not ".concat({}.toString.call(plugin));}
if(plugin.utils)Sortable.utils=_objectSpread({},Sortable.utils,plugin.utils);PluginManager.mount(plugin);});};Sortable.create=function(el,options){return new Sortable(el,options);};Sortable.version=version;var autoScrolls=[],scrollEl,scrollRootEl,scrolling=false,lastAutoScrollX,lastAutoScrollY,touchEvt$1,pointerElemChangedInterval;function AutoScrollPlugin(){function AutoScroll(){this.defaults={scroll:true,scrollSensitivity:30,scrollSpeed:10,bubbleScroll:true};for(var fn in this){if(fn.charAt(0)==='_'&&typeof this[fn]==='function'){this[fn]=this[fn].bind(this);}}}
AutoScroll.prototype={dragStarted:function dragStarted(_ref){var originalEvent=_ref.originalEvent;if(this.sortable.nativeDraggable){on(document,'dragover',this._handleAutoScroll);}else{if(this.options.supportPointer){on(document,'pointermove',this._handleFallbackAutoScroll);}else if(originalEvent.touches){on(document,'touchmove',this._handleFallbackAutoScroll);}else{on(document,'mousemove',this._handleFallbackAutoScroll);}}},dragOverCompleted:function dragOverCompleted(_ref2){var originalEvent=_ref2.originalEvent;if(!this.options.dragOverBubble&&!originalEvent.rootEl){this._handleAutoScroll(originalEvent);}},drop:function drop(){if(this.sortable.nativeDraggable){off(document,'dragover',this._handleAutoScroll);}else{off(document,'pointermove',this._handleFallbackAutoScroll);off(document,'touchmove',this._handleFallbackAutoScroll);off(document,'mousemove',this._handleFallbackAutoScroll);}
clearPointerElemChangedInterval();clearAutoScrolls();cancelThrottle();},nulling:function nulling(){touchEvt$1=scrollRootEl=scrollEl=scrolling=pointerElemChangedInterval=lastAutoScrollX=lastAutoScrollY=null;autoScrolls.length=0;},_handleFallbackAutoScroll:function _handleFallbackAutoScroll(evt){this._handleAutoScroll(evt,true);},_handleAutoScroll:function _handleAutoScroll(evt,fallback){var _this=this;var x=(evt.touches?evt.touches[0]:evt).clientX,y=(evt.touches?evt.touches[0]:evt).clientY,elem=document.elementFromPoint(x,y);touchEvt$1=evt;if(fallback||Edge||IE11OrLess||Safari){autoScroll(evt,this.options,elem,fallback);var ogElemScroller=getParentAutoScrollElement(elem,true);if(scrolling&&(!pointerElemChangedInterval||x!==lastAutoScrollX||y!==lastAutoScrollY)){pointerElemChangedInterval&&clearPointerElemChangedInterval();pointerElemChangedInterval=setInterval(function(){var newElem=getParentAutoScrollElement(document.elementFromPoint(x,y),true);if(newElem!==ogElemScroller){ogElemScroller=newElem;clearAutoScrolls();}
autoScroll(evt,_this.options,newElem,fallback);},10);lastAutoScrollX=x;lastAutoScrollY=y;}}else{if(!this.options.bubbleScroll||getParentAutoScrollElement(elem,true)===getWindowScrollingElement()){clearAutoScrolls();return;}
autoScroll(evt,this.options,getParentAutoScrollElement(elem,false),false);}}};return _extends(AutoScroll,{pluginName:'scroll',initializeByDefault:true});}
function clearAutoScrolls(){autoScrolls.forEach(function(autoScroll){clearInterval(autoScroll.pid);});autoScrolls=[];}
function clearPointerElemChangedInterval(){clearInterval(pointerElemChangedInterval);}
var autoScroll=throttle(function(evt,options,rootEl,isFallback){if(!options.scroll)return;var x=(evt.touches?evt.touches[0]:evt).clientX,y=(evt.touches?evt.touches[0]:evt).clientY,sens=options.scrollSensitivity,speed=options.scrollSpeed,winScroller=getWindowScrollingElement();var scrollThisInstance=false,scrollCustomFn;if(scrollRootEl!==rootEl){scrollRootEl=rootEl;clearAutoScrolls();scrollEl=options.scroll;scrollCustomFn=options.scrollFn;if(scrollEl===true){scrollEl=getParentAutoScrollElement(rootEl,true);}}
var layersOut=0;var currentParent=scrollEl;do{var el=currentParent,rect=getRect(el),top=rect.top,bottom=rect.bottom,left=rect.left,right=rect.right,width=rect.width,height=rect.height,canScrollX=void 0,canScrollY=void 0,scrollWidth=el.scrollWidth,scrollHeight=el.scrollHeight,elCSS=css(el),scrollPosX=el.scrollLeft,scrollPosY=el.scrollTop;if(el===winScroller){canScrollX=width<scrollWidth&&(elCSS.overflowX==='auto'||elCSS.overflowX==='scroll'||elCSS.overflowX==='visible');canScrollY=height<scrollHeight&&(elCSS.overflowY==='auto'||elCSS.overflowY==='scroll'||elCSS.overflowY==='visible');}else{canScrollX=width<scrollWidth&&(elCSS.overflowX==='auto'||elCSS.overflowX==='scroll');canScrollY=height<scrollHeight&&(elCSS.overflowY==='auto'||elCSS.overflowY==='scroll');}
var vx=canScrollX&&(Math.abs(right-x)<=sens&&scrollPosX+width<scrollWidth)-(Math.abs(left-x)<=sens&&!!scrollPosX);var vy=canScrollY&&(Math.abs(bottom-y)<=sens&&scrollPosY+height<scrollHeight)-(Math.abs(top-y)<=sens&&!!scrollPosY);if(!autoScrolls[layersOut]){for(var i=0;i<=layersOut;i++){if(!autoScrolls[i]){autoScrolls[i]={};}}}
if(autoScrolls[layersOut].vx!=vx||autoScrolls[layersOut].vy!=vy||autoScrolls[layersOut].el!==el){autoScrolls[layersOut].el=el;autoScrolls[layersOut].vx=vx;autoScrolls[layersOut].vy=vy;clearInterval(autoScrolls[layersOut].pid);if(vx!=0||vy!=0){scrollThisInstance=true;autoScrolls[layersOut].pid=setInterval(function(){if(isFallback&&this.layer===0){Sortable.active._onTouchMove(touchEvt$1);}
var scrollOffsetY=autoScrolls[this.layer].vy?autoScrolls[this.layer].vy*speed:0;var scrollOffsetX=autoScrolls[this.layer].vx?autoScrolls[this.layer].vx*speed:0;if(typeof scrollCustomFn==='function'){if(scrollCustomFn.call(Sortable.dragged.parentNode[expando],scrollOffsetX,scrollOffsetY,evt,touchEvt$1,autoScrolls[this.layer].el)!=='continue'){return;}}
scrollBy(autoScrolls[this.layer].el,scrollOffsetX,scrollOffsetY);}.bind({layer:layersOut}),24);}}
layersOut++;}while(options.bubbleScroll&&currentParent!==winScroller&&(currentParent=getParentAutoScrollElement(currentParent,false)));scrolling=scrollThisInstance;},30);var drop=function drop(_ref){var originalEvent=_ref.originalEvent,putSortable=_ref.putSortable,dragEl=_ref.dragEl,activeSortable=_ref.activeSortable,dispatchSortableEvent=_ref.dispatchSortableEvent,hideGhostForTarget=_ref.hideGhostForTarget,unhideGhostForTarget=_ref.unhideGhostForTarget;if(!originalEvent)return;var toSortable=putSortable||activeSortable;hideGhostForTarget();var touch=originalEvent.changedTouches&&originalEvent.changedTouches.length?originalEvent.changedTouches[0]:originalEvent;var target=document.elementFromPoint(touch.clientX,touch.clientY);unhideGhostForTarget();if(toSortable&&!toSortable.el.contains(target)){dispatchSortableEvent('spill');this.onSpill({dragEl:dragEl,putSortable:putSortable});}};function Revert(){}
Revert.prototype={startIndex:null,dragStart:function dragStart(_ref2){var oldDraggableIndex=_ref2.oldDraggableIndex;this.startIndex=oldDraggableIndex;},onSpill:function onSpill(_ref3){var dragEl=_ref3.dragEl,putSortable=_ref3.putSortable;this.sortable.captureAnimationState();if(putSortable){putSortable.captureAnimationState();}
var nextSibling=getChild(this.sortable.el,this.startIndex,this.options);if(nextSibling){this.sortable.el.insertBefore(dragEl,nextSibling);}else{this.sortable.el.appendChild(dragEl);}
this.sortable.animateAll();if(putSortable){putSortable.animateAll();}},drop:drop};_extends(Revert,{pluginName:'revertOnSpill'});function Remove(){}
Remove.prototype={onSpill:function onSpill(_ref4){var dragEl=_ref4.dragEl,putSortable=_ref4.putSortable;var parentSortable=putSortable||this.sortable;parentSortable.captureAnimationState();dragEl.parentNode&&dragEl.parentNode.removeChild(dragEl);parentSortable.animateAll();},drop:drop};_extends(Remove,{pluginName:'removeOnSpill'});var lastSwapEl;function SwapPlugin(){function Swap(){this.defaults={swapClass:'sortable-swap-highlight'};}
Swap.prototype={dragStart:function dragStart(_ref){var dragEl=_ref.dragEl;lastSwapEl=dragEl;},dragOverValid:function dragOverValid(_ref2){var completed=_ref2.completed,target=_ref2.target,onMove=_ref2.onMove,activeSortable=_ref2.activeSortable,changed=_ref2.changed,cancel=_ref2.cancel;if(!activeSortable.options.swap)return;var el=this.sortable.el,options=this.options;if(target&&target!==el){var prevSwapEl=lastSwapEl;if(onMove(target)!==false){toggleClass(target,options.swapClass,true);lastSwapEl=target;}else{lastSwapEl=null;}
if(prevSwapEl&&prevSwapEl!==lastSwapEl){toggleClass(prevSwapEl,options.swapClass,false);}}
changed();completed(true);cancel();},drop:function drop(_ref3){var activeSortable=_ref3.activeSortable,putSortable=_ref3.putSortable,dragEl=_ref3.dragEl;var toSortable=putSortable||this.sortable;var options=this.options;lastSwapEl&&toggleClass(lastSwapEl,options.swapClass,false);if(lastSwapEl&&(options.swap||putSortable&&putSortable.options.swap)){if(dragEl!==lastSwapEl){toSortable.captureAnimationState();if(toSortable!==activeSortable)activeSortable.captureAnimationState();swapNodes(dragEl,lastSwapEl);toSortable.animateAll();if(toSortable!==activeSortable)activeSortable.animateAll();}}},nulling:function nulling(){lastSwapEl=null;}};return _extends(Swap,{pluginName:'swap',eventProperties:function eventProperties(){return{swapItem:lastSwapEl};}});}
function swapNodes(n1,n2){var p1=n1.parentNode,p2=n2.parentNode,i1,i2;if(!p1||!p2||p1.isEqualNode(n2)||p2.isEqualNode(n1))return;i1=index(n1);i2=index(n2);if(p1.isEqualNode(p2)&&i1<i2){i2++;}
p1.insertBefore(n2,p1.children[i1]);p2.insertBefore(n1,p2.children[i2]);}
var multiDragElements=[],multiDragClones=[],lastMultiDragSelect,multiDragSortable,initialFolding=false,folding=false,dragStarted=false,dragEl$1,clonesFromRect,clonesHidden;function MultiDragPlugin(){function MultiDrag(sortable){for(var fn in this){if(fn.charAt(0)==='_'&&typeof this[fn]==='function'){this[fn]=this[fn].bind(this);}}
if(sortable.options.supportPointer){on(document,'pointerup',this._deselectMultiDrag);}else{on(document,'mouseup',this._deselectMultiDrag);on(document,'touchend',this._deselectMultiDrag);}
on(document,'keydown',this._checkKeyDown);on(document,'keyup',this._checkKeyUp);this.defaults={selectedClass:'sortable-selected',multiDragKey:null,setData:function setData(dataTransfer,dragEl){var data='';if(multiDragElements.length&&multiDragSortable===sortable){multiDragElements.forEach(function(multiDragElement,i){data+=(!i?'':', ')+multiDragElement.textContent;});}else{data=dragEl.textContent;}
dataTransfer.setData('Text',data);}};}
MultiDrag.prototype={multiDragKeyDown:false,isMultiDrag:false,delayStartGlobal:function delayStartGlobal(_ref){var dragged=_ref.dragEl;dragEl$1=dragged;},delayEnded:function delayEnded(){this.isMultiDrag=~multiDragElements.indexOf(dragEl$1);},setupClone:function setupClone(_ref2){var sortable=_ref2.sortable,cancel=_ref2.cancel;if(!this.isMultiDrag)return;for(var i=0;i<multiDragElements.length;i++){multiDragClones.push(clone(multiDragElements[i]));multiDragClones[i].sortableIndex=multiDragElements[i].sortableIndex;multiDragClones[i].draggable=false;multiDragClones[i].style['will-change']='';toggleClass(multiDragClones[i],this.options.selectedClass,false);multiDragElements[i]===dragEl$1&&toggleClass(multiDragClones[i],this.options.chosenClass,false);}
sortable._hideClone();cancel();},clone:function clone(_ref3){var sortable=_ref3.sortable,rootEl=_ref3.rootEl,dispatchSortableEvent=_ref3.dispatchSortableEvent,cancel=_ref3.cancel;if(!this.isMultiDrag)return;if(!this.options.removeCloneOnHide){if(multiDragElements.length&&multiDragSortable===sortable){insertMultiDragClones(true,rootEl);dispatchSortableEvent('clone');cancel();}}},showClone:function showClone(_ref4){var cloneNowShown=_ref4.cloneNowShown,rootEl=_ref4.rootEl,cancel=_ref4.cancel;if(!this.isMultiDrag)return;insertMultiDragClones(false,rootEl);multiDragClones.forEach(function(clone){css(clone,'display','');});cloneNowShown();clonesHidden=false;cancel();},hideClone:function hideClone(_ref5){var _this=this;var sortable=_ref5.sortable,cloneNowHidden=_ref5.cloneNowHidden,cancel=_ref5.cancel;if(!this.isMultiDrag)return;multiDragClones.forEach(function(clone){css(clone,'display','none');if(_this.options.removeCloneOnHide&&clone.parentNode){clone.parentNode.removeChild(clone);}});cloneNowHidden();clonesHidden=true;cancel();},dragStartGlobal:function dragStartGlobal(_ref6){var sortable=_ref6.sortable;if(!this.isMultiDrag&&multiDragSortable){multiDragSortable.multiDrag._deselectMultiDrag();}
multiDragElements.forEach(function(multiDragElement){multiDragElement.sortableIndex=index(multiDragElement);});multiDragElements=multiDragElements.sort(function(a,b){return a.sortableIndex-b.sortableIndex;});dragStarted=true;},dragStarted:function dragStarted(_ref7){var _this2=this;var sortable=_ref7.sortable;if(!this.isMultiDrag)return;if(this.options.sort){sortable.captureAnimationState();if(this.options.animation){multiDragElements.forEach(function(multiDragElement){if(multiDragElement===dragEl$1)return;css(multiDragElement,'position','absolute');});var dragRect=getRect(dragEl$1,false,true,true);multiDragElements.forEach(function(multiDragElement){if(multiDragElement===dragEl$1)return;setRect(multiDragElement,dragRect);});folding=true;initialFolding=true;}}
sortable.animateAll(function(){folding=false;initialFolding=false;if(_this2.options.animation){multiDragElements.forEach(function(multiDragElement){unsetRect(multiDragElement);});}
if(_this2.options.sort){removeMultiDragElements();}});},dragOver:function dragOver(_ref8){var target=_ref8.target,completed=_ref8.completed,cancel=_ref8.cancel;if(folding&&~multiDragElements.indexOf(target)){completed(false);cancel();}},revert:function revert(_ref9){var fromSortable=_ref9.fromSortable,rootEl=_ref9.rootEl,sortable=_ref9.sortable,dragRect=_ref9.dragRect;if(multiDragElements.length>1){multiDragElements.forEach(function(multiDragElement){sortable.addAnimationState({target:multiDragElement,rect:folding?getRect(multiDragElement):dragRect});unsetRect(multiDragElement);multiDragElement.fromRect=dragRect;fromSortable.removeAnimationState(multiDragElement);});folding=false;insertMultiDragElements(!this.options.removeCloneOnHide,rootEl);}},dragOverCompleted:function dragOverCompleted(_ref10){var sortable=_ref10.sortable,isOwner=_ref10.isOwner,insertion=_ref10.insertion,activeSortable=_ref10.activeSortable,parentEl=_ref10.parentEl,putSortable=_ref10.putSortable;var options=this.options;if(insertion){if(isOwner){activeSortable._hideClone();}
initialFolding=false;if(options.animation&&multiDragElements.length>1&&(folding||!isOwner&&!activeSortable.options.sort&&!putSortable)){var dragRectAbsolute=getRect(dragEl$1,false,true,true);multiDragElements.forEach(function(multiDragElement){if(multiDragElement===dragEl$1)return;setRect(multiDragElement,dragRectAbsolute);parentEl.appendChild(multiDragElement);});folding=true;}
if(!isOwner){if(!folding){removeMultiDragElements();}
if(multiDragElements.length>1){var clonesHiddenBefore=clonesHidden;activeSortable._showClone(sortable);if(activeSortable.options.animation&&!clonesHidden&&clonesHiddenBefore){multiDragClones.forEach(function(clone){activeSortable.addAnimationState({target:clone,rect:clonesFromRect});clone.fromRect=clonesFromRect;clone.thisAnimationDuration=null;});}}else{activeSortable._showClone(sortable);}}}},dragOverAnimationCapture:function dragOverAnimationCapture(_ref11){var dragRect=_ref11.dragRect,isOwner=_ref11.isOwner,activeSortable=_ref11.activeSortable;multiDragElements.forEach(function(multiDragElement){multiDragElement.thisAnimationDuration=null;});if(activeSortable.options.animation&&!isOwner&&activeSortable.multiDrag.isMultiDrag){clonesFromRect=_extends({},dragRect);var dragMatrix=matrix(dragEl$1,true);clonesFromRect.top-=dragMatrix.f;clonesFromRect.left-=dragMatrix.e;}},dragOverAnimationComplete:function dragOverAnimationComplete(){if(folding){folding=false;removeMultiDragElements();}},drop:function drop(_ref12){var evt=_ref12.originalEvent,rootEl=_ref12.rootEl,parentEl=_ref12.parentEl,sortable=_ref12.sortable,dispatchSortableEvent=_ref12.dispatchSortableEvent,oldIndex=_ref12.oldIndex,putSortable=_ref12.putSortable;var toSortable=putSortable||this.sortable;if(!evt)return;var options=this.options,children=parentEl.children;if(!dragStarted){if(options.multiDragKey&&!this.multiDragKeyDown){this._deselectMultiDrag();}
toggleClass(dragEl$1,options.selectedClass,!~multiDragElements.indexOf(dragEl$1));if(!~multiDragElements.indexOf(dragEl$1)){multiDragElements.push(dragEl$1);dispatchEvent({sortable:sortable,rootEl:rootEl,name:'select',targetEl:dragEl$1,originalEvt:evt});if(evt.shiftKey&&lastMultiDragSelect&&sortable.el.contains(lastMultiDragSelect)){var lastIndex=index(lastMultiDragSelect),currentIndex=index(dragEl$1);if(~lastIndex&&~currentIndex&&lastIndex!==currentIndex){var n,i;if(currentIndex>lastIndex){i=lastIndex;n=currentIndex;}else{i=currentIndex;n=lastIndex+1;}
for(;i<n;i++){if(~multiDragElements.indexOf(children[i]))continue;toggleClass(children[i],options.selectedClass,true);multiDragElements.push(children[i]);dispatchEvent({sortable:sortable,rootEl:rootEl,name:'select',targetEl:children[i],originalEvt:evt});}}}else{lastMultiDragSelect=dragEl$1;}
multiDragSortable=toSortable;}else{multiDragElements.splice(multiDragElements.indexOf(dragEl$1),1);lastMultiDragSelect=null;dispatchEvent({sortable:sortable,rootEl:rootEl,name:'deselect',targetEl:dragEl$1,originalEvt:evt});}}
if(dragStarted&&this.isMultiDrag){if((parentEl[expando].options.sort||parentEl!==rootEl)&&multiDragElements.length>1){var dragRect=getRect(dragEl$1),multiDragIndex=index(dragEl$1,':not(.'+this.options.selectedClass+')');if(!initialFolding&&options.animation)dragEl$1.thisAnimationDuration=null;toSortable.captureAnimationState();if(!initialFolding){if(options.animation){dragEl$1.fromRect=dragRect;multiDragElements.forEach(function(multiDragElement){multiDragElement.thisAnimationDuration=null;if(multiDragElement!==dragEl$1){var rect=folding?getRect(multiDragElement):dragRect;multiDragElement.fromRect=rect;toSortable.addAnimationState({target:multiDragElement,rect:rect});}});}
removeMultiDragElements();multiDragElements.forEach(function(multiDragElement){if(children[multiDragIndex]){parentEl.insertBefore(multiDragElement,children[multiDragIndex]);}else{parentEl.appendChild(multiDragElement);}
multiDragIndex++;});if(oldIndex===index(dragEl$1)){var update=false;multiDragElements.forEach(function(multiDragElement){if(multiDragElement.sortableIndex!==index(multiDragElement)){update=true;return;}});if(update){dispatchSortableEvent('update');}}}
multiDragElements.forEach(function(multiDragElement){unsetRect(multiDragElement);});toSortable.animateAll();}
multiDragSortable=toSortable;}
if(rootEl===parentEl||putSortable&&putSortable.lastPutMode!=='clone'){multiDragClones.forEach(function(clone){clone.parentNode&&clone.parentNode.removeChild(clone);});}},nullingGlobal:function nullingGlobal(){this.isMultiDrag=dragStarted=false;multiDragClones.length=0;},destroyGlobal:function destroyGlobal(){this._deselectMultiDrag();off(document,'pointerup',this._deselectMultiDrag);off(document,'mouseup',this._deselectMultiDrag);off(document,'touchend',this._deselectMultiDrag);off(document,'keydown',this._checkKeyDown);off(document,'keyup',this._checkKeyUp);},_deselectMultiDrag:function _deselectMultiDrag(evt){if(typeof dragStarted!=="undefined"&&dragStarted)return;if(multiDragSortable!==this.sortable)return;if(evt&&closest(evt.target,this.options.draggable,this.sortable.el,false))return;if(evt&&evt.button!==0)return;while(multiDragElements.length){var el=multiDragElements[0];toggleClass(el,this.options.selectedClass,false);multiDragElements.shift();dispatchEvent({sortable:this.sortable,rootEl:this.sortable.el,name:'deselect',targetEl:el,originalEvt:evt});}},_checkKeyDown:function _checkKeyDown(evt){if(evt.key===this.options.multiDragKey){this.multiDragKeyDown=true;}},_checkKeyUp:function _checkKeyUp(evt){if(evt.key===this.options.multiDragKey){this.multiDragKeyDown=false;}}};return _extends(MultiDrag,{pluginName:'multiDrag',utils:{select:function select(el){var sortable=el.parentNode[expando];if(!sortable||!sortable.options.multiDrag||~multiDragElements.indexOf(el))return;if(multiDragSortable&&multiDragSortable!==sortable){multiDragSortable.multiDrag._deselectMultiDrag();multiDragSortable=sortable;}
toggleClass(el,sortable.options.selectedClass,true);multiDragElements.push(el);},deselect:function deselect(el){var sortable=el.parentNode[expando],index=multiDragElements.indexOf(el);if(!sortable||!sortable.options.multiDrag||!~index)return;toggleClass(el,sortable.options.selectedClass,false);multiDragElements.splice(index,1);}},eventProperties:function eventProperties(){var _this3=this;var oldIndicies=[],newIndicies=[];multiDragElements.forEach(function(multiDragElement){oldIndicies.push({multiDragElement:multiDragElement,index:multiDragElement.sortableIndex});var newIndex;if(folding&&multiDragElement!==dragEl$1){newIndex=-1;}else if(folding){newIndex=index(multiDragElement,':not(.'+_this3.options.selectedClass+')');}else{newIndex=index(multiDragElement);}
newIndicies.push({multiDragElement:multiDragElement,index:newIndex});});return{items:_toConsumableArray(multiDragElements),clones:[].concat(multiDragClones),oldIndicies:oldIndicies,newIndicies:newIndicies};},optionListeners:{multiDragKey:function multiDragKey(key){key=key.toLowerCase();if(key==='ctrl'){key='Control';}else if(key.length>1){key=key.charAt(0).toUpperCase()+key.substr(1);}
return key;}}});}
function insertMultiDragElements(clonesInserted,rootEl){multiDragElements.forEach(function(multiDragElement,i){var target=rootEl.children[multiDragElement.sortableIndex+(clonesInserted?Number(i):0)];if(target){rootEl.insertBefore(multiDragElement,target);}else{rootEl.appendChild(multiDragElement);}});}
function insertMultiDragClones(elementsInserted,rootEl){multiDragClones.forEach(function(clone,i){var target=rootEl.children[clone.sortableIndex+(elementsInserted?Number(i):0)];if(target){rootEl.insertBefore(clone,target);}else{rootEl.appendChild(clone);}});}
function removeMultiDragElements(){multiDragElements.forEach(function(multiDragElement){if(multiDragElement===dragEl$1)return;multiDragElement.parentNode&&multiDragElement.parentNode.removeChild(multiDragElement);});}
Sortable.mount(new AutoScrollPlugin());Sortable.mount(Remove,Revert);Sortable.mount(new SwapPlugin());Sortable.mount(new MultiDragPlugin());return Sortable;}));;(function($){$.fn.visible=function(partial,hidden,direction,container){if(this.length<1)
return;var $t=this.length>1?this.eq(0):this,isContained=typeof container!=='undefined'&&container!==null,$w=isContained?$(container):$(window),wPosition=isContained?$w.position():0,t=$t.get(0),vpWidth=$w.outerWidth(),vpHeight=$w.outerHeight(),direction=(direction)?direction:'both',clientSize=hidden===true?t.offsetWidth*t.offsetHeight:true;if(typeof t.getBoundingClientRect==='function'){var rec=t.getBoundingClientRect(),tViz=isContained?rec.top-wPosition.top>=0&&rec.top<vpHeight+wPosition.top:rec.top>=0&&rec.top<vpHeight,bViz=isContained?rec.bottom-wPosition.top>0&&rec.bottom<=vpHeight+wPosition.top:rec.bottom>0&&rec.bottom<=vpHeight,lViz=isContained?rec.left-wPosition.left>=0&&rec.left<vpWidth+wPosition.left:rec.left>=0&&rec.left<vpWidth,rViz=isContained?rec.right-wPosition.left>0&&rec.right<vpWidth+wPosition.left:rec.right>0&&rec.right<=vpWidth,vVisible=partial?tViz||bViz:tViz&&bViz,hVisible=partial?lViz||rViz:lViz&&rViz;if(direction==='both')
return clientSize&&vVisible&&hVisible;else if(direction==='vertical')
return clientSize&&vVisible;else if(direction==='horizontal')
return clientSize&&hVisible;}else{var viewTop=isContained?0:wPosition,viewBottom=viewTop+vpHeight,viewLeft=$w.scrollLeft(),viewRight=viewLeft+vpWidth,position=$t.position(),_top=position.top,_bottom=_top+$t.height(),_left=position.left,_right=_left+$t.width(),compareTop=partial===true?_bottom:_top,compareBottom=partial===true?_top:_bottom,compareLeft=partial===true?_right:_left,compareRight=partial===true?_left:_right;if(direction==='both')
return!!clientSize&&((compareBottom<=viewBottom)&&(compareTop>=viewTop))&&((compareRight<=viewRight)&&(compareLeft>=viewLeft));else if(direction==='vertical')
return!!clientSize&&((compareBottom<=viewBottom)&&(compareTop>=viewTop));else if(direction==='horizontal')
return!!clientSize&&((compareRight<=viewRight)&&(compareLeft>=viewLeft));}};})(jQuery);;(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.LC=f()}})(function(){var define,module,exports;return(function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){var INFINITE,JSONToShape,LiterallyCanvas,Pencil,actions,bindEvents,createShape,math,ref,renderShapeToContext,renderShapeToSVG,renderSnapshotToImage,renderSnapshotToSVG,shapeToJSON,util,bind=function(fn,me){return function(){return fn.apply(me,arguments);};},slice=[].slice,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;};actions=require('./actions');bindEvents=require('./bindEvents');math=require('./math');ref=require('./shapes'),createShape=ref.createShape,shapeToJSON=ref.shapeToJSON,JSONToShape=ref.JSONToShape;renderShapeToContext=require('./canvasRenderer').renderShapeToContext;renderShapeToSVG=require('./svgRenderer').renderShapeToSVG;renderSnapshotToImage=require('./renderSnapshotToImage');renderSnapshotToSVG=require('./renderSnapshotToSVG');Pencil=require('../tools/Pencil');util=require('./util');INFINITE='infinite';module.exports=LiterallyCanvas=(function(){function LiterallyCanvas(arg1,arg2){this.setImageSize=bind(this.setImageSize,this);var containerEl,opts;opts=null;containerEl=null;if(arg1 instanceof HTMLElement){containerEl=arg1;opts=arg2;}else{opts=arg1;}
this.opts=opts||{};this.config={zoomMin:opts.zoomMin||0.2,zoomMax:opts.zoomMax||4.0,zoomStep:opts.zoomStep||0.2};this.colors={primary:opts.primaryColor||'#000',secondary:opts.secondaryColor||'#fff',background:opts.backgroundColor||'transparent'};this.watermarkImage=opts.watermarkImage;this.watermarkScale=opts.watermarkScale||1;this.backgroundCanvas=document.createElement('canvas');this.backgroundCtx=this.backgroundCanvas.getContext('2d');this.canvas=document.createElement('canvas');this.canvas.style['background-color']='transparent';this.buffer=document.createElement('canvas');this.buffer.style['background-color']='transparent';this.ctx=this.canvas.getContext('2d');this.bufferCtx=this.buffer.getContext('2d');this.backingScale=util.getBackingScale(this.ctx);this.backgroundShapes=opts.backgroundShapes||[];this._shapesInProgress=[];this.shapes=[];this.undoStack=[];this.redoStack=[];this.deleteStack=[];this.shapeDeletedStack=[];this.isDragging=false;this.position={x:0,y:0};this.scale=1.0;this.setTool(new this.opts.tools[0](this));this.width=opts.imageSize.width||INFINITE;this.height=opts.imageSize.height||INFINITE;this.setZoom(this.scale);if(opts.snapshot){this.loadSnapshot(opts.snapshot);}
this.isBound=false;if(containerEl){this.bindToElement(containerEl);}}
LiterallyCanvas.prototype.bindToElement=function(containerEl){var ref1,repaintAll;if(this.containerEl){console.warn("Trying to bind Literally Canvas to a DOM element more than once is unsupported.");return;}
this.containerEl=containerEl;this._unsubscribeEvents=bindEvents(this,this.containerEl,this.opts.keyboardShortcuts);this.containerEl.style['background-color']=this.colors.background;this.containerEl.appendChild(this.backgroundCanvas);this.containerEl.appendChild(this.canvas);this.isBound=true;repaintAll=(function(_this){return function(){_this.keepPanInImageBounds();return _this.repaintAllLayers();};})(this);util.matchElementSize(this.containerEl,[this.backgroundCanvas,this.canvas],this.backingScale,repaintAll);if(this.watermarkImage){this.watermarkImage.onload=(function(_this){return function(){return _this.repaintLayer('background');};})(this);}
if((ref1=this.tool)!=null){ref1.didBecomeActive(this);}
return repaintAll();};LiterallyCanvas.prototype._teardown=function(){this.tool.willBecomeInactive(this);if(typeof this._unsubscribeEvents==="function"){this._unsubscribeEvents();}
this.tool=null;this.containerEl=null;return this.isBound=false;};LiterallyCanvas.prototype.trigger=function(name,data){this.canvas.dispatchEvent(new CustomEvent(name,{detail:data}));return null;};LiterallyCanvas.prototype.on=function(name,fn){var wrapper;wrapper=function(e){return fn(e.detail);};this.canvas.addEventListener(name,wrapper);return(function(_this){return function(){return _this.canvas.removeEventListener(name,wrapper);};})(this);};LiterallyCanvas.prototype.getRenderScale=function(){return this.scale*this.backingScale;};LiterallyCanvas.prototype.clientCoordsToDrawingCoords=function(x,y){return{x:(x*this.backingScale-this.position.x)/this.getRenderScale(),y:(y*this.backingScale-this.position.y)/this.getRenderScale()};};LiterallyCanvas.prototype.drawingCoordsToClientCoords=function(x,y){return{x:x*this.getRenderScale()+this.position.x,y:y*this.getRenderScale()+this.position.y};};LiterallyCanvas.prototype.setImageSize=function(width,height){this.width=width||INFINITE;this.height=height||INFINITE;this.keepPanInImageBounds();this.repaintAllLayers();return this.trigger('imageSizeChange',{width:this.width,height:this.height});};LiterallyCanvas.prototype.setTool=function(tool){var ref1;if(this.isBound){if((ref1=this.tool)!=null){ref1.willBecomeInactive(this);}}
this.tool=tool;this.trigger('toolChange',{tool:tool});if(this.isBound){return this.tool.didBecomeActive(this);}};LiterallyCanvas.prototype.setShapesInProgress=function(newVal){return this._shapesInProgress=newVal;};LiterallyCanvas.prototype.pointerDown=function(x,y){var p;p=this.clientCoordsToDrawingCoords(x,y);if(typeof this.tool!='undefined'&&this.tool!=''&&typeof this.tool.usesSimpleAPI!='undefined'&&this.tool.usesSimpleAPI){this.tool.begin(p.x,p.y,this);this.isDragging=true;return this.trigger("drawStart",{tool:this.tool});}else{this.isDragging=true;return this.trigger("lc-pointerdown",{tool:this.tool,x:p.x,y:p.y,rawX:x,rawY:y});}};LiterallyCanvas.prototype.pointerMove=function(x,y){return util.requestAnimationFrame((function(_this){return function(){var p,ref1;p=_this.clientCoordsToDrawingCoords(x,y);if((ref1=_this.tool)!=null?ref1.usesSimpleAPI:void 0){if(_this.isDragging){_this.tool["continue"](p.x,p.y,_this);return _this.trigger("drawContinue",{tool:_this.tool});}}else{if(_this.isDragging){return _this.trigger("lc-pointerdrag",{tool:_this.tool,x:p.x,y:p.y,rawX:x,rawY:y});}else{return _this.trigger("lc-pointermove",{tool:_this.tool,x:p.x,y:p.y,rawX:x,rawY:y});}}};})(this));};LiterallyCanvas.prototype.pointerUp=function(x,y){var p;p=this.clientCoordsToDrawingCoords(x,y);if(typeof this.tool!='undefined'&&this.tool!=''&&typeof this.tool.usesSimpleAPI!='undefined'&&this.tool.usesSimpleAPI){if(this.isDragging){this.tool.end(p.x,p.y,this);this.isDragging=false;return this.trigger("drawEnd",{tool:this.tool});}}else{this.isDragging=false;return this.trigger("lc-pointerup",{tool:this.tool,x:p.x,y:p.y,rawX:x,rawY:y});}};LiterallyCanvas.prototype.setColor=function(name,color){this.colors[name]=color;if(!this.isBound){return;}
switch(name){case 'background':this.containerEl.style.backgroundColor=this.colors.background;this.repaintLayer('background');break;case 'primary':this.repaintLayer('main');break;case 'secondary':this.repaintLayer('main');}
this.trigger(name+"ColorChange",this.colors[name]);if(name==='background'){return this.trigger("drawingChange");}};LiterallyCanvas.prototype.getColor=function(name){return this.colors[name];};LiterallyCanvas.prototype.saveShape=function(shape,triggerShapeSaveEvent,previousShapeId,stack){if(triggerShapeSaveEvent==null){triggerShapeSaveEvent=true;}
if(previousShapeId==null){previousShapeId=null;}
if(!previousShapeId){previousShapeId=this.shapes.length?this.shapes[this.shapes.length-1].id:null;}
this.execute(new actions.AddShapeAction(this,shape,previousShapeId));if(triggerShapeSaveEvent){this.trigger('shapeSave',{shape:shape,previousShapeId:previousShapeId});}
return this.trigger('drawingChange');};LiterallyCanvas.prototype.pan=function(x,y){return this.setPan(this.position.x-x,this.position.y-y);};LiterallyCanvas.prototype.keepPanInImageBounds=function(){var ref1,renderScale,x,y;renderScale=this.getRenderScale();ref1=this.position,x=ref1.x,y=ref1.y;if(this.width!==INFINITE){if(this.canvas.width>this.width*renderScale){x=(this.canvas.width-this.width*renderScale)/2;}else{x=Math.max(Math.min(0,x),this.canvas.width-this.width*renderScale);}}
if(this.height!==INFINITE){if(this.canvas.height>this.height*renderScale){y=(this.canvas.height-this.height*renderScale)/2;}else{y=Math.max(Math.min(0,y),this.canvas.height-this.height*renderScale);}}
return this.position={x:x,y:y};};LiterallyCanvas.prototype.setPan=function(x,y){this.position={x:x,y:y};this.keepPanInImageBounds();this.repaintAllLayers();return this.trigger('pan',{x:this.position.x,y:this.position.y});};LiterallyCanvas.prototype.zoom=function(factor){var newScale;newScale=this.scale+factor;newScale=Math.max(newScale,this.config.zoomMin);newScale=Math.min(newScale,this.config.zoomMax);newScale=Math.round(newScale*100)/100;return this.setZoom(newScale);};LiterallyCanvas.prototype.setZoom=function(scale){var oldScale;oldScale=this.scale;this.scale=scale;this.position.x=math.scalePositionScalar(this.position.x,this.canvas.width,oldScale,this.scale);this.position.y=math.scalePositionScalar(this.position.y,this.canvas.height,oldScale,this.scale);this.keepPanInImageBounds();this.repaintAllLayers();return this.trigger('zoom',{oldScale:oldScale,newScale:this.scale});};LiterallyCanvas.prototype.setWatermarkImage=function(newImage){this.watermarkImage=newImage;util.addImageOnload(newImage,(function(_this){return function(){return _this.repaintLayer('background');};})(this));if(newImage.width){return this.repaintLayer('background');}};LiterallyCanvas.prototype.repaintAllLayers=function(){var i,key,len,ref1;ref1=['background','main'];for(i=0,len=ref1.length;i<len;i++){key=ref1[i];this.repaintLayer(key);}
return null;};LiterallyCanvas.prototype.repaintLayer=function(repaintLayerKey,dirty){var retryCallback;if(dirty==null){dirty=repaintLayerKey==='main';}
if(!this.isBound){return;}
switch(repaintLayerKey){case 'background':this.backgroundCtx.clearRect(0,0,this.backgroundCanvas.width,this.backgroundCanvas.height);retryCallback=(function(_this){return function(){return _this.repaintLayer('background');};})(this);if(this.watermarkImage){this._renderWatermark(this.backgroundCtx,true,retryCallback);}
this.draw(this.backgroundShapes,this.backgroundCtx,retryCallback);break;case 'main':retryCallback=(function(_this){return function(){return _this.repaintLayer('main',true);};})(this);if(dirty){this.buffer.width=this.canvas.width;this.buffer.height=this.canvas.height;this.bufferCtx.clearRect(0,0,this.buffer.width,this.buffer.height);this.draw(this.shapes,this.bufferCtx,retryCallback);}
this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);if(this.canvas.width>0&&this.canvas.height>0){this.ctx.fillStyle='#ccc';this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height);this.clipped(((function(_this){return function(){_this.ctx.clearRect(0,0,_this.canvas.width,_this.canvas.height);return _this.ctx.drawImage(_this.buffer,0,0);};})(this)),this.ctx);this.clipped(((function(_this){return function(){return _this.transformed((function(){var i,len,ref1,results,shape;ref1=_this._shapesInProgress;results=[];for(i=0,len=ref1.length;i<len;i++){shape=ref1[i];results.push(renderShapeToContext(_this.ctx,shape,{bufferCtx:_this.bufferCtx,shouldOnlyDrawLatest:true}));}
return results;}),_this.ctx,_this.bufferCtx);};})(this)),this.ctx,this.bufferCtx);}}
return this.trigger('repaint',{layerKey:repaintLayerKey});};LiterallyCanvas.prototype._renderWatermark=function(ctx,worryAboutRetina,retryCallback){if(worryAboutRetina==null){worryAboutRetina=true;}
if(!this.watermarkImage.width){this.watermarkImage.onload=retryCallback;return;}
ctx.save();ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2);ctx.scale(this.watermarkScale,this.watermarkScale);if(worryAboutRetina){ctx.scale(this.backingScale,this.backingScale);}
ctx.drawImage(this.watermarkImage,-this.watermarkImage.width/2,-this.watermarkImage.height/2);return ctx.restore();};LiterallyCanvas.prototype.drawShapeInProgress=function(shape){this.repaintLayer('main',false);return this.clipped(((function(_this){return function(){return _this.transformed((function(){return renderShapeToContext(_this.ctx,shape,{bufferCtx:_this.bufferCtx,shouldOnlyDrawLatest:true});}),_this.ctx,_this.bufferCtx);};})(this)),this.ctx,this.bufferCtx);};LiterallyCanvas.prototype.draw=function(shapes,ctx,retryCallback){var drawShapes;if(!shapes.length){return;}
drawShapes=(function(_this){return function(){var i,len,results,shape;results=[];for(i=0,len=shapes.length;i<len;i++){shape=shapes[i];results.push(renderShapeToContext(ctx,shape,{retryCallback:retryCallback}));}
return results;};})(this);return this.clipped(((function(_this){return function(){return _this.transformed(drawShapes,ctx);};})(this)),ctx);};LiterallyCanvas.prototype.clipped=function(){var contexts,ctx,fn,height,i,j,len,len1,results,width,x,y;fn=arguments[0],contexts=2<=arguments.length?slice.call(arguments,1):[];x=this.width===INFINITE?0:this.position.x;y=this.height===INFINITE?0:this.position.y;width=(function(){switch(this.width){case INFINITE:return this.canvas.width;default:return this.width*this.getRenderScale();}}).call(this);height=(function(){switch(this.height){case INFINITE:return this.canvas.height;default:return this.height*this.getRenderScale();}}).call(this);for(i=0,len=contexts.length;i<len;i++){ctx=contexts[i];ctx.save();ctx.beginPath();ctx.rect(x,y,width,height);ctx.clip();}
fn();results=[];for(j=0,len1=contexts.length;j<len1;j++){ctx=contexts[j];results.push(ctx.restore());}
return results;};LiterallyCanvas.prototype.transformed=function(){var contexts,ctx,fn,i,j,len,len1,results,scale;fn=arguments[0],contexts=2<=arguments.length?slice.call(arguments,1):[];for(i=0,len=contexts.length;i<len;i++){ctx=contexts[i];ctx.save();ctx.translate(Math.floor(this.position.x),Math.floor(this.position.y));scale=this.getRenderScale();ctx.scale(scale,scale);}
fn();results=[];for(j=0,len1=contexts.length;j<len1;j++){ctx=contexts[j];results.push(ctx.restore());}
return results;};LiterallyCanvas.prototype.clear=function(triggerClearEvent){var newShapes,oldShapes;if(triggerClearEvent==null){triggerClearEvent=true;}
oldShapes=this.shapes;newShapes=[];this.setShapesInProgress([]);this.execute(new actions.ClearAction(this,oldShapes,newShapes));this.repaintLayer('main');if(triggerClearEvent){this.trigger('clear',null);}
return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.execute=function(action){this.undoStack.push(action);this.deleteStack.push(action);action["do"]();return this.redoStack=[];};LiterallyCanvas.prototype.undo=function(){var action;if(!this.undoStack.length){return;}
action=this.undoStack.pop();action.undo();this.redoStack.push(action);this.trigger('undo',{action:action});return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.delete=function(triggerDeleteEvent){var action=this.deleteStack.pop();var i,len,newUndoStack,ref,shape,lastShapeId;action.delete(triggerDeleteEvent);this.trigger('delete',{action:action});var newShapes,oldShapes;oldShapes=triggerDeleteEvent;newShapes=[];this.setShapesInProgress([]);new actions.ClearAction(this,oldShapes,newShapes);this.repaintLayer('main');if(triggerDeleteEvent){this.trigger('clear',null);}
return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.clearDrawing=function(triggerClearEvent){if(typeof triggerClearEvent.rectcopy!=='undefined'){var i,len,newShapes,ref,shape2;newShapes=[];ref=this.shapes;for(i=0,len=ref.length;i<len;i++){shape2=ref[i];if(typeof shape2.rectcopy==='undefined'){newShapes.push(shape2);}}}
this.shapes=newShapes;this.repaintLayer('main');return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.redo=function(){var action;if(!this.redoStack.length){return;}
action=this.redoStack.pop();this.undoStack.push(action);this.deleteStack.push(action);action["do"]();this.trigger('redo',{action:action});return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.canUndo=function(){return!!this.undoStack.length;};LiterallyCanvas.prototype.canRedo=function(){return!!this.redoStack.length;};LiterallyCanvas.prototype.getPixel=function(x,y){var p,pixel;p=this.drawingCoordsToClientCoords(x,y);pixel=this.ctx.getImageData(p.x,p.y,1,1).data;if(pixel[3]){return "rgb("+pixel[0]+", "+pixel[1]+", "+pixel[2]+")";}else{return null;}};LiterallyCanvas.prototype.getContentBounds=function(){return util.getBoundingRect((this.shapes.concat(this.backgroundShapes)).map(function(s){return s.getBoundingRect();}),this.width===INFINITE?0:this.width,this.height===INFINITE?0:this.height);};LiterallyCanvas.prototype.getDefaultImageRect=function(explicitSize,margin){var s;if(explicitSize==null){explicitSize={width:0,height:0};}
if(margin==null){margin={top:0,right:0,bottom:0,left:0};}
return util.getDefaultImageRect((function(){var i,len,ref1,results;ref1=this.shapes.concat(this.backgroundShapes);results=[];for(i=0,len=ref1.length;i<len;i++){s=ref1[i];results.push(s.getBoundingRect(this.ctx));}
return results;}).call(this),explicitSize,margin);};LiterallyCanvas.prototype.getImage=function(opts){if(opts==null){opts={};}
if(opts.includeWatermark==null){opts.includeWatermark=true;}
if(opts.scaleDownRetina==null){opts.scaleDownRetina=true;}
if(opts.scale==null){opts.scale=1;}
if(!opts.scaleDownRetina){opts.scale*=this.backingScale;}
if(opts.includeWatermark){opts.watermarkImage=this.watermarkImage;opts.watermarkScale=this.watermarkScale;if(!opts.scaleDownRetina){opts.watermarkScale*=this.backingScale;}}
return renderSnapshotToImage(this.getSnapshot(),opts);};LiterallyCanvas.prototype.canvasForExport=function(){this.repaintAllLayers();return util.combineCanvases(this.backgroundCanvas,this.canvas);};LiterallyCanvas.prototype.canvasWithBackground=function(backgroundImageOrCanvas){return util.combineCanvases(backgroundImageOrCanvas,this.canvasForExport());};LiterallyCanvas.prototype.getSnapshot=function(keys){var i,k,len,ref1,shape,snapshot;if(keys==null){keys=null;}
if(keys==null){keys=['shapes','imageSize','colors','position','scale','backgroundShapes'];}
snapshot={};ref1=['colors','position','scale'];for(i=0,len=ref1.length;i<len;i++){k=ref1[i];if(indexOf.call(keys,k)>=0){snapshot[k]=this[k];}}
if(indexOf.call(keys,'shapes')>=0){snapshot.shapes=(function(){var j,len1,ref2,results;ref2=this.shapes;results=[];for(j=0,len1=ref2.length;j<len1;j++){shape=ref2[j];results.push(shapeToJSON(shape));}
return results;}).call(this);}
if(indexOf.call(keys,'backgroundShapes')>=0){snapshot.backgroundShapes=(function(){var j,len1,ref2,results;ref2=this.backgroundShapes;results=[];for(j=0,len1=ref2.length;j<len1;j++){shape=ref2[j];results.push(shapeToJSON(shape));}
return results;}).call(this);}
if(indexOf.call(keys,'imageSize')>=0){snapshot.imageSize={width:this.width,height:this.height};}
return snapshot;};LiterallyCanvas.prototype.getSnapshotJSON=function(){console.warn("lc.getSnapshotJSON() is deprecated. use JSON.stringify(lc.getSnapshot()) instead.");return JSON.stringify(this.getSnapshot());};LiterallyCanvas.prototype.getSVGString=function(opts){if(opts==null){opts={};}
return renderSnapshotToSVG(this.getSnapshot(),opts);};LiterallyCanvas.prototype.loadSnapshot=function(snapshot){var i,j,k,len,len1,ref1,ref2,s,shape,shapeRepr;if(!snapshot){return;}
if(snapshot.colors){ref1=['primary','secondary','background'];for(i=0,len=ref1.length;i<len;i++){k=ref1[i];this.setColor(k,snapshot.colors[k]);}}
if(snapshot.shapes){this.shapes=[];ref2=snapshot.shapes;for(j=0,len1=ref2.length;j<len1;j++){shapeRepr=ref2[j];shape=JSONToShape(shapeRepr);if(shape){this.execute(new actions.AddShapeAction(this,shape));}}}
if(snapshot.backgroundShapes){this.backgroundShapes=(function(){var l,len2,ref3,results;ref3=snapshot.backgroundShapes;results=[];for(l=0,len2=ref3.length;l<len2;l++){s=ref3[l];results.push(JSONToShape(s));}
return results;})();}
if(snapshot.imageSize){this.width=snapshot.imageSize.width;this.height=snapshot.imageSize.height;}
if(snapshot.position){this.position=snapshot.position;}
if(snapshot.scale){this.scale=snapshot.scale;}
this.repaintAllLayers();this.trigger('snapshotLoad');return this.trigger('drawingChange',{});};LiterallyCanvas.prototype.loadSnapshotJSON=function(str){console.warn("lc.loadSnapshotJSON() is deprecated. use lc.loadSnapshot(JSON.parse(snapshot)) instead.");return this.loadSnapshot(JSON.parse(str));};LiterallyCanvas.prototype.rerender=function(newShapes){var oldShapes;oldShapes=this.shapes;this.setShapesInProgress([]);this.execute(new actions.ClearAction(this,oldShapes,newShapes),false);this.trigger('drawingChange',{});this.repaintLayer('main');};return LiterallyCanvas;})();},{"../tools/Pencil":24,"./actions":3,"./bindEvents":4,"./canvasRenderer":5,"./math":10,"./renderSnapshotToImage":11,"./renderSnapshotToSVG":12,"./shapes":13,"./svgRenderer":14,"./util":15}],2:[function(require,module,exports){var TextRenderer,getLinesToRender,getNextLine,parseFontString,TextUnderline,getTextHeight;getTextHeight=function(text1,fontFamily,fontSize){var text=$('<span>'+text1+'</span>').css({'font-family':fontFamily,'font-size':fontSize});$('body').append(text);var height=parseInt(window.getComputedStyle(text[0]).fontSize,10)-1;text.remove();return height;};TextUnderline=function(context,text,textDecorationObj,align){var x=textDecorationObj.x,textHeight=getTextHeight(text,textDecorationObj.fontFamily,textDecorationObj.size);if(textDecorationObj.name=='line-through'){textHeight/=2;}
var y=textDecorationObj.y+textHeight;context.beginPath();context.strokeStyle=textDecorationObj.color;context.lineWidth=1;context.moveTo(x,y);context.lineTo(x+context.measureText(text).width,y);context.stroke();};require('./fontmetrics.js');parseFontString=function(font){var fontFamily,fontItems,fontSize,item,j,len,maybeSize,remainingFontString;fontItems=font.split(' ');fontSize=0;for(j=0,len=fontItems.length;j<len;j++){item=fontItems[j];maybeSize=parseInt(item.replace("px",""),10);if(!isNaN(maybeSize)){fontSize=maybeSize;}}
if(!fontSize){throw "Font size not found";}
remainingFontString=font.substring(fontItems[0].length+fontItems[1].length+fontItems[2].length+fontItems[3].length+fontItems[4].length+5);fontFamily=remainingFontString;return{fontSize:fontSize,fontFamily:fontFamily,textDecoration:fontItems[4]};};getNextLine=function(ctx,text,forcedWidth){var doesSubstringFit,endIndex,isEndOfString,isNonWord,isWhitespace,lastGoodIndex,lastOkayIndex,nextWordStartIndex,textToHere,wasInWord;if(!text.length){return['',''];}
endIndex=0;lastGoodIndex=0;lastOkayIndex=0;wasInWord=false;while(true){endIndex+=1;isEndOfString=endIndex>=text.length;isWhitespace=(!isEndOfString)&&text[endIndex].match(/\s/);isNonWord=isWhitespace||isEndOfString;textToHere=text.substring(0,endIndex);doesSubstringFit=forcedWidth?ctx.measureTextWidth(textToHere).width<=forcedWidth:true;if(doesSubstringFit){lastOkayIndex=endIndex;}
if(isNonWord&&wasInWord){wasInWord=false;if(doesSubstringFit){lastGoodIndex=endIndex;}}
wasInWord=!isWhitespace;if(isEndOfString||!doesSubstringFit){if(doesSubstringFit){return[text,''];}else if(lastGoodIndex>0){nextWordStartIndex=lastGoodIndex+1;while(nextWordStartIndex<text.length&&text[nextWordStartIndex].match('/\s/')){nextWordStartIndex+=1;}
return[text.substring(0,lastGoodIndex),text.substring(nextWordStartIndex)];}else{return[text.substring(0,lastOkayIndex),text.substring(lastOkayIndex)];}}}};getLinesToRender=function(ctx,text,forcedWidth){var j,len,lines,nextLine,ref,ref1,remainingText,textLine,textSplitOnLines;textSplitOnLines=text.split(/\r\n|\r|\n/g);lines=[];for(j=0,len=textSplitOnLines.length;j<len;j++){textLine=textSplitOnLines[j];ref=getNextLine(ctx,textLine,forcedWidth),nextLine=ref[0],remainingText=ref[1];if(nextLine){while(nextLine){lines.push(nextLine);ref1=getNextLine(ctx,remainingText,forcedWidth),nextLine=ref1[0],remainingText=ref1[1];}}else{lines.push(textLine);}}
return lines;};TextRenderer=(function(){function TextRenderer(ctx,text1,font1,forcedWidth1,forcedHeight,text1XC,text1YC,text1Color){var fontFamily,fontSize,ref;this.text=text1;this.font=font1;this.forcedWidth=forcedWidth1;this.forcedHeight=forcedHeight;ref=parseFontString(this.font),fontFamily=ref.fontFamily,fontSize=ref.fontSize;this.textDecoration={'name':ref.textDecoration,'x':text1XC,'y':text1YC,'fontFamily':fontFamily,'color':text1Color,'size':fontSize};ctx.font=this.font.replace('underline ','').replace('line-through ','').replace('none ','');ctx.textBaseline='baseline';this.emDashWidth=ctx.measureTextWidth('—',fontSize,fontFamily).width;this.caratWidth=ctx.measureTextWidth('|',fontSize,fontFamily).width;this.lines=getLinesToRender(ctx,this.text,this.forcedWidth);this.metricses=this.lines.map((function(_this){return function(line){return ctx.measureText2(line||'X',fontSize,_this.font);};})(this));this.metrics={ascent:Math.max.apply(Math,this.metricses.map(function(arg){var ascent;ascent=arg.ascent;return ascent;})),descent:Math.max.apply(Math,this.metricses.map(function(arg){var descent;descent=arg.descent;return descent;})),fontsize:Math.max.apply(Math,this.metricses.map(function(arg){var fontsize;fontsize=arg.fontsize;return fontsize;})),leading:Math.max.apply(Math,this.metricses.map(function(arg){var leading;leading=arg.leading;return leading;})),width:Math.max.apply(Math,this.metricses.map(function(arg){var width;width=arg.width;return width;})),height:Math.max.apply(Math,this.metricses.map(function(arg){var height;height=arg.height;return height;})),bounds:{minx:Math.min.apply(Math,this.metricses.map(function(arg){var bounds;bounds=arg.bounds;return bounds.minx;})),miny:Math.min.apply(Math,this.metricses.map(function(arg){var bounds;bounds=arg.bounds;return bounds.miny;})),maxx:Math.max.apply(Math,this.metricses.map(function(arg){var bounds;bounds=arg.bounds;return bounds.maxx;})),maxy:Math.max.apply(Math,this.metricses.map(function(arg){var bounds;bounds=arg.bounds;return bounds.maxy;}))}};this.boundingBoxWidth=Math.ceil(this.metrics.width);}
TextRenderer.prototype.draw=function(ctx,x,y){var i,j,len,line,ref,results;ctx.textBaseline='top';ctx.font=this.font.replace('underline ','').replace('line-through ','').replace('none ','');i=0;ref=this.lines;results=[];for(j=0,len=ref.length;j<len;j++){line=ref[j];ctx.fillText(line,x,y+i*this.metrics.leading);this.textDecoration.x=x;this.textDecoration.y=y;if(this.textDecoration.name=='underline'||this.textDecoration.name=='line-through'){TextUnderline(ctx,line,this.textDecoration);}
results.push(i+=1);}
return results;};TextRenderer.prototype.getWidth=function(isEditing){if(isEditing==null){isEditing=false;}
if(this.forcedWidth){return this.forcedWidth;}else{if(isEditing){return this.metrics.bounds.maxx+this.caratWidth;}else{return this.metrics.bounds.maxx;}}};TextRenderer.prototype.getHeight=function(){return this.forcedHeight||(this.metrics.leading*this.lines.length);};return TextRenderer;})();module.exports=TextRenderer;},{"./fontmetrics.js":7}],3:[function(require,module,exports){var AddShapeAction,ClearAction;ClearAction=(function(){function ClearAction(lc1,oldShapes,newShapes1){this.lc=lc1;this.oldShapes=oldShapes;this.newShapes=newShapes1;}
ClearAction.prototype["do"]=function(){this.lc.shapes=this.newShapes;return this.lc.repaintLayer('main');};ClearAction.prototype.undo=function(){this.lc.shapes=this.oldShapes;return this.lc.repaintLayer('main');};ClearAction.prototype.delete=function(){this.lc.shapes=this.oldShapes;return this.lc.repaintLayer('main');};return ClearAction;})();AddShapeAction=(function(){var redostack=[],deletestack=[];function AddShapeAction(lc1,shape1,previousShapeId,stack){this.lc=lc1;this.shape=shape1;this.previousShapeId=previousShapeId!=null?previousShapeId:null;this.undostack=stack;}
AddShapeAction.prototype["do"]=function(){var found,i,len,newShapes,ref,shape;if(!this.lc.shapes.length||this.lc.shapes[this.lc.shapes.length-1].id===this.previousShapeId||this.previousShapeId===null){this.lc.shapes.push(this.shape);}else{newShapes=[];found=false;ref=this.lc.shapes;for(i=0,len=ref.length;i<len;i++){shape=ref[i];newShapes.push(shape);if(shape.id===this.previousShapeId){newShapes.push(this.shape);found=true;}}
if(!found){newShapes.push(this.shape);}
this.lc.shapes=newShapes;}
return this.lc.repaintLayer('main');};AddShapeAction.prototype.undo=function(){var i,len,newShapes,ref,shape;if(this.lc.shapes!=''&&typeof this.lc.shapes!='undefined'){if(this.lc.shapes[this.lc.shapes.length-1].id===this.shape.id){this.lc.shapes.pop();}
else{newShapes=[];ref=this.lc.shapes;for(i=0,len=ref.length;i<len;i++){shape=ref[i];if(shape.id!==this.shape.id){newShapes.push(shape);}}
this.lc.shapes=newShapes;}}
return this.lc.repaintLayer('main');};AddShapeAction.prototype.delete=function(selectedShape){var i,len,newShapes,ref,shape;newShapes=[];ref=this.lc.shapes;for(i=0,len=ref.length;i<len;i++){shape=ref[i];if(shape.id!==selectedShape.id){newShapes.push(shape);}}
this.lc.shapes=newShapes;deletestack.push(selectedShape);return this.lc.repaintLayer('main');};return AddShapeAction;})();module.exports={ClearAction:ClearAction,AddShapeAction:AddShapeAction};},{}],4:[function(require,module,exports){var bindEvents,buttonIsDown,coordsForTouchEvent,position;coordsForTouchEvent=function(el,e){var p,tx,ty;tx=e.changedTouches[0].clientX;ty=e.changedTouches[0].clientY;p=el.getBoundingClientRect();return[tx-p.left,ty-p.top];};position=function(el,e){var p;p=el.getBoundingClientRect();return{left:e.clientX-p.left,top:e.clientY-p.top};};buttonIsDown=function(e){if(e.buttons!=null){return e.buttons===1;}else{return e.which>0;}};module.exports=bindEvents=function(lc,canvas,panWithKeyboard){var listener,mouseMoveListener,mouseUpListener,touchEndListener,touchMoveListener,unsubs;if(panWithKeyboard==null){panWithKeyboard=false;}
unsubs=[];mouseMoveListener=(function(_this){return function(e){var p;e.preventDefault();p=position(canvas,e);return lc.pointerMove(p.left,p.top);};})(this);mouseUpListener=(function(_this){return function(e){var p;e.preventDefault();canvas.onselectstart=function(){return true;};p=position(canvas,e);lc.pointerUp(p.left,p.top);document.removeEventListener('mousemove',mouseMoveListener);document.removeEventListener('mouseup',mouseUpListener);return canvas.addEventListener('mousemove',mouseMoveListener);};})(this);canvas.addEventListener('mousedown',(function(_this){return function(e){var down,p;if(e.target.tagName.toLowerCase()!=='canvas'){return;}
down=true;e.preventDefault();canvas.onselectstart=function(){return false;};p=position(canvas,e);lc.pointerDown(p.left,p.top);canvas.removeEventListener('mousemove',mouseMoveListener);document.addEventListener('mousemove',mouseMoveListener);return document.addEventListener('mouseup',mouseUpListener);};})(this));touchMoveListener=function(e){e.preventDefault();return lc.pointerMove.apply(lc,coordsForTouchEvent(canvas,e));};touchEndListener=function(e){e.preventDefault();lc.pointerUp.apply(lc,coordsForTouchEvent(canvas,e));document.removeEventListener('touchmove',touchMoveListener);document.removeEventListener('touchend',touchEndListener);return document.removeEventListener('touchcancel',touchEndListener);};canvas.addEventListener('touchstart',function(e){if(e.target.tagName.toLowerCase()!=='canvas'){return;}
e.preventDefault();if(e.touches.length===1){lc.pointerDown.apply(lc,coordsForTouchEvent(canvas,e));document.addEventListener('touchmove',touchMoveListener);document.addEventListener('touchend',touchEndListener);return document.addEventListener('touchcancel',touchEndListener);}else{return lc.pointerMove.apply(lc,coordsForTouchEvent(canvas,e));}});if(panWithKeyboard){console.warn("Keyboard panning is deprecated.");listener=function(e){switch(e.keyCode){case 37:lc.pan(-10,0);break;case 38:lc.pan(0,-10);break;case 39:lc.pan(10,0);break;case 40:lc.pan(0,10);}
return lc.repaintAllLayers();};document.addEventListener('keydown',listener);unsubs.push(function(){return document.removeEventListener(listener);});}
return function(){var f,i,len,results;results=[];for(i=0,len=unsubs.length;i<len;i++){f=unsubs[i];results.push(f());}
return results;};};},{}],5:[function(require,module,exports){var _drawRawLinePath,defineCanvasRenderer,drawErasedLinePath,drawErasedLinePathLatest,drawLinePath,drawLinePathLatest,lineEndCapShapes,noop,renderShapeToCanvas,renderShapeToContext,renderers;lineEndCapShapes=require('./lineEndCapShapes');renderers={};defineCanvasRenderer=function(shapeName,drawFunc,drawLatestFunc){return renderers[shapeName]={drawFunc:drawFunc,drawLatestFunc:drawLatestFunc};};noop=function(){};renderShapeToContext=function(ctx,shape,opts){var bufferCtx;if(opts==null){opts={};}
if(opts.shouldIgnoreUnsupportedShapes==null){opts.shouldIgnoreUnsupportedShapes=false;}
if(opts.retryCallback==null){opts.retryCallback=noop;}
if(opts.shouldOnlyDrawLatest==null){opts.shouldOnlyDrawLatest=false;}
if(opts.bufferCtx==null){opts.bufferCtx=null;}
bufferCtx=opts.bufferCtx;if(renderers[shape.className]){if(opts.shouldOnlyDrawLatest&&renderers[shape.className].drawLatestFunc){return renderers[shape.className].drawLatestFunc(ctx,bufferCtx,shape,opts.retryCallback);}else{return renderers[shape.className].drawFunc(ctx,shape,opts.retryCallback);}}else if(opts.shouldIgnoreUnsupportedShapes){return console.warn("Can't render shape of type "+shape.className+" to canvas");}else{throw "Can't render shape of type "+shape.className+" to canvas";}};renderShapeToCanvas=function(canvas,shape,opts){return renderShapeToContext(canvas.getContext('2d'),shape,opts);};defineCanvasRenderer('Rectangle',function(ctx,shape){var x,y;x=shape.x;y=shape.y;if(shape.strokeWidth%2!==0){x+=0.5;y+=0.5;}
ctx.fillStyle=shape.fillColor;ctx.fillRect(x,y,shape.width,shape.height);ctx.lineWidth=shape.strokeWidth;ctx.strokeStyle=shape.strokeColor;return ctx.strokeRect(x,y,shape.width,shape.height);});defineCanvasRenderer('Ellipse',function(ctx,shape){var centerX,centerY,halfHeight,halfWidth;ctx.save();halfWidth=Math.floor(shape.width/2);halfHeight=Math.floor(shape.height/2);centerX=shape.x+halfWidth;centerY=shape.y+halfHeight;ctx.translate(centerX,centerY);ctx.scale(1,Math.abs(shape.height/shape.width));ctx.beginPath();ctx.arc(0,0,Math.abs(halfWidth),0,Math.PI*2);ctx.closePath();ctx.restore();ctx.fillStyle=shape.fillColor;ctx.fill();ctx.lineWidth=shape.strokeWidth;ctx.strokeStyle=shape.strokeColor;return ctx.stroke();});defineCanvasRenderer('SelectionBox',(function(){var _drawHandle;_drawHandle=function(ctx,arg,handleSize){var x,y;x=arg.x,y=arg.y;if(handleSize===0){return;}
ctx.fillStyle='#fff';ctx.fillRect(x,y,handleSize,handleSize);ctx.strokeStyle='#000';return ctx.strokeRect(x,y,handleSize,handleSize);};return function(ctx,shape){_drawHandle(ctx,shape.getTopLeftHandleRect(),shape.handleSize);_drawHandle(ctx,shape.getTopRightHandleRect(),shape.handleSize);_drawHandle(ctx,shape.getBottomLeftHandleRect(),shape.handleSize);_drawHandle(ctx,shape.getBottomRightHandleRect(),shape.handleSize);if(shape.backgroundColor){ctx.fillStyle=shape.backgroundColor;ctx.fillRect(shape._br.x-shape.margin,shape._br.y-shape.margin,shape._br.width+shape.margin*2,shape._br.height+shape.margin*2);}
ctx.lineWidth=1;ctx.strokeStyle='#000';ctx.setLineDash([2,4]);ctx.strokeRect(shape._br.x-shape.margin,shape._br.y-shape.margin,shape._br.width+shape.margin*2,shape._br.height+shape.margin*2);return ctx.setLineDash([]);};})());defineCanvasRenderer('Image',function(ctx,shape,retryCallback){var iop=shape.image.style.opacity;if(iop==''){iop=1;}
ctx.globalAlpha=iop;if(shape.image.width){if(shape.scale===1){return ctx.drawImage(shape.image,shape.x,shape.y);}else{return ctx.drawImage(shape.image,shape.x,shape.y,shape.image.width*shape.scale,shape.image.height*shape.scale);}}else if(retryCallback){return shape.image.onload=retryCallback;}});defineCanvasRenderer('Line',function(ctx,shape){var arrowWidth,x1,x2,y1,y2;if(shape.x1===shape.x2&&shape.y1===shape.y2){return;}
x1=shape.x1;x2=shape.x2;y1=shape.y1;y2=shape.y2;if(shape.strokeWidth%2!==0){x1+=0.5;x2+=0.5;y1+=0.5;y2+=0.5;}
ctx.lineWidth=shape.strokeWidth;ctx.strokeStyle=shape.color;ctx.lineCap=shape.capStyle;if(shape.dash){ctx.setLineDash(shape.dash);}
ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.stroke();if(shape.dash){ctx.setLineDash([]);}
arrowWidth=Math.max(shape.strokeWidth*2.2,5);if(shape.endCapShapes[0]){lineEndCapShapes[shape.endCapShapes[0]].drawToCanvas(ctx,x1,y1,Math.atan2(y1-y2,x1-x2),arrowWidth,shape.color);}
if(shape.endCapShapes[1]){return lineEndCapShapes[shape.endCapShapes[1]].drawToCanvas(ctx,x2,y2,Math.atan2(y2-y1,x2-x1),arrowWidth,shape.color);}});_drawRawLinePath=function(ctx,points,close,lineCap){var i,len,point,ref;if(close==null){close=false;}
if(lineCap==null){lineCap='round';}
if(!points.length){return;}
ctx.lineCap=lineCap;ctx.strokeStyle=points[0].color;ctx.lineWidth=points[0].size;ctx.beginPath();if(points[0].size%2===0){ctx.moveTo(points[0].x,points[0].y);}else{ctx.moveTo(points[0].x+0.5,points[0].y+0.5);}
ref=points.slice(1);for(i=0,len=ref.length;i<len;i++){point=ref[i];if(points[0].size%2===0){ctx.lineTo(point.x,point.y);}else{ctx.lineTo(point.x+0.5,point.y+0.5);}}
if(close){return ctx.closePath();}};drawLinePath=function(ctx,shape){_drawRawLinePath(ctx,shape.smoothedPoints);return ctx.stroke();};drawLinePathLatest=function(ctx,bufferCtx,shape){var drawEnd,drawStart,segmentStart;if(shape.tail){segmentStart=shape.smoothedPoints.length-shape.segmentSize*shape.tailSize;drawStart=segmentStart<shape.segmentSize*2?0:segmentStart;drawEnd=segmentStart+shape.segmentSize+1;_drawRawLinePath(bufferCtx,shape.smoothedPoints.slice(drawStart,drawEnd));return bufferCtx.stroke();}else{_drawRawLinePath(bufferCtx,shape.smoothedPoints);return bufferCtx.stroke();}};defineCanvasRenderer('LinePath',drawLinePath,drawLinePathLatest);drawErasedLinePath=function(ctx,shape){ctx.save();ctx.globalCompositeOperation="destination-out";drawLinePath(ctx,shape);return ctx.restore();};drawErasedLinePathLatest=function(ctx,bufferCtx,shape){ctx.save();ctx.globalCompositeOperation="destination-out";bufferCtx.save();bufferCtx.globalCompositeOperation="destination-out";drawLinePathLatest(ctx,bufferCtx,shape);ctx.restore();return bufferCtx.restore();};defineCanvasRenderer('ErasedLinePath',drawErasedLinePath,drawErasedLinePathLatest);defineCanvasRenderer('Text',function(ctx,shape){if(!shape.renderer){shape._makeRenderer(ctx);}
ctx.fillStyle=shape.color;return shape.renderer.draw(ctx,shape.x,shape.y);});defineCanvasRenderer('Polygon',function(ctx,shape){ctx.fillStyle=shape.fillColor;_drawRawLinePath(ctx,shape.points,shape.isClosed,'butt');ctx.fill();return ctx.stroke();});module.exports={defineCanvasRenderer:defineCanvasRenderer,renderShapeToCanvas:renderShapeToCanvas,renderShapeToContext:renderShapeToContext};},{"./lineEndCapShapes":8}],6:[function(require,module,exports){'use strict';module.exports={imageURLPrefix:'lib/img',primaryColor:'hsla(0, 0%, 0%, 1)',secondaryColor:'hsla(0, 0%, 100%, 1)',backgroundColor:'transparent',strokeWidths:[1,2,5,10,20,30],defaultStrokeWidth:5,toolbarPosition:'top',keyboardShortcuts:false,imageSize:{width:'infinite',height:'infinite'},backgroundShapes:[],watermarkImage:null,watermarkScale:1,zoomMin:0.2,zoomMax:4.0,zoomStep:0.2,snapshot:null,tools:[require('../tools/Pencil'),require('../tools/Eraser'),require('../tools/Line'),require('../tools/Rectangle'),require('../tools/Ellipse'),require('../tools/Text'),require('../tools/Polygon'),require('../tools/Pan'),require('../tools/Eyedropper')]};},{"../tools/Ellipse":19,"../tools/Eraser":20,"../tools/Eyedropper":21,"../tools/Line":22,"../tools/Pan":23,"../tools/Pencil":24,"../tools/Polygon":25,"../tools/Rectangle":26,"../tools/Text":28}],7:[function(require,module,exports){"use strict";(function(){var NAME="FontMetrics Library";var VERSION="1-2012.0121.1300";if(!document.defaultView.getComputedStyle){throw "ERROR: 'document.defaultView.getComputedStyle' not found. This library only works in browsers that can report computed CSS values.";}
CanvasRenderingContext2D.prototype.measureTextWidth=CanvasRenderingContext2D.prototype.measureText;var getCSSValue=function getCSSValue(element,property){return document.defaultView.getComputedStyle(element,null).getPropertyValue(property);};var show=function show(canvas,ctx,xstart,w,h,metrics){document.body.appendChild(canvas);ctx.strokeStyle='rgba(0, 0, 0, 0.5)';ctx.beginPath();ctx.moveTo(xstart,0);ctx.lineTo(xstart,h);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(xstart+metrics.bounds.maxx,0);ctx.lineTo(xstart+metrics.bounds.maxx,h);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(0,h/2-metrics.ascent);ctx.lineTo(w,h/2-metrics.ascent);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(0,h/2+metrics.descent);ctx.lineTo(w,h/2+metrics.descent);ctx.closePath();ctx.stroke();};CanvasRenderingContext2D.prototype.measureText2=function(textstring,fontSize,fontString){fontString=fontString.replace('none ','').replace('underline ','').replace('line-through ','');var metrics=this.measureTextWidth(textstring),isSpace=!/\S/.test(textstring);metrics.fontsize=fontSize;var leadDiv=document.createElement("div");leadDiv.style.position="absolute";leadDiv.style.opacity=0;leadDiv.style.font=fontString;leadDiv.innerHTML=textstring+"<br/>"+textstring;document.body.appendChild(leadDiv);metrics.leading=1.2*fontSize;var leadDivHeight=getCSSValue(leadDiv,"height");leadDivHeight=leadDivHeight.replace("px","");if(leadDivHeight>=fontSize*2){metrics.leading=leadDivHeight/2|0;}
document.body.removeChild(leadDiv);if(!isSpace){var canvas=document.createElement("canvas");var padding=100;canvas.width=metrics.width+padding;canvas.height=3*fontSize;canvas.style.opacity=1;canvas.style.font=fontString;var ctx=canvas.getContext("2d");ctx.font=fontString;var w=canvas.width,h=canvas.height,baseline=h/2;ctx.fillStyle="white";ctx.fillRect(-1,-1,w+2,h+2);ctx.fillStyle="black";ctx.fillText(textstring,padding/2,baseline);var pixelData=ctx.getImageData(0,0,w,h).data;var i=0,w4=w*4,len=pixelData.length;while(++i<len&&pixelData[i]===255){}
var ascent=i/w4|0;i=len-1;while(--i>0&&pixelData[i]===255){}
var descent=i/w4|0;for(i=0;i<len&&pixelData[i]===255;){i+=w4;if(i>=len){i=i-len+4;}}
var minx=i%w4/4|0;var step=1;for(i=len-3;i>=0&&pixelData[i]===255;){i-=w4;if(i<0){i=len-3-step++*4;}}
var maxx=i%w4/4+1|0;metrics.ascent=baseline-ascent;metrics.descent=descent-baseline;metrics.bounds={minx:minx-padding/2,maxx:maxx-padding/2,miny:0,maxy:descent-ascent};metrics.height=1+(descent-ascent);}
else{metrics.ascent=0;metrics.descent=0;metrics.bounds={minx:0,maxx:metrics.width,miny:0,maxy:0};metrics.height=0;}
return metrics;};})();},{}],8:[function(require,module,exports){module.exports={arrow:(function(){var getPoints;getPoints=function(x,y,angle,width,length){return[{x:x+Math.cos(angle+Math.PI/2)*width/2,y:y+Math.sin(angle+Math.PI/2)*width/2},{x:x+Math.cos(angle)*length,y:y+Math.sin(angle)*length},{x:x+Math.cos(angle-Math.PI/2)*width/2,y:y+Math.sin(angle-Math.PI/2)*width/2}];};return{drawToCanvas:function(ctx,x,y,angle,width,color,length){var points;if(length==null){length=0;}
length=length||width;ctx.fillStyle=color;ctx.lineWidth=0;ctx.strokeStyle='transparent';ctx.beginPath();points=getPoints(x,y,angle,width,length);ctx.moveTo(points[0].x,points[0].y);ctx.lineTo(points[1].x,points[1].y);ctx.lineTo(points[2].x,points[2].y);return ctx.fill();},svg:function(x,y,angle,width,color,length){var points;if(length==null){length=0;}
length=length||width;points=getPoints(x,y,angle,width,length);return "<polygon fill='"+color+"' stroke='none' points='"+(points.map(function(p){return p.x+","+p.y;}))+"' />";}};})()};},{}],9:[function(require,module,exports){var _,localize,strings;strings={};localize=function(localStrings){return strings=localStrings;};_=function(string){var translation;translation=strings[string];return translation||string;};module.exports={localize:localize,_:_};},{}],10:[function(require,module,exports){var Point,_slope,math,normals,unit,util;Point=require('./shapes').Point;util=require('./util');math={};math.toPoly=function(line){var i,index,len,n,point,polyLeft,polyRight;polyLeft=[];polyRight=[];index=0;for(i=0,len=line.length;i<len;i++){point=line[i];n=normals(point,_slope(line,index));polyLeft=polyLeft.concat([n[0]]);polyRight=[n[1]].concat(polyRight);index+=1;}
return polyLeft.concat(polyRight);};_slope=function(line,index){var point;if(line.length<3){point={x:0,y:0};}
if(index===0){point=_slope(line,index+1);}else if(index===line.length-1){point=_slope(line,index-1);}else{point=math.diff(line[index-1],line[index+1]);}
return point;};math.diff=function(a,b){return{x:b.x-a.x,y:b.y-a.y};};unit=function(vector){var length;length=math.len(vector);return{x:vector.x/length,y:vector.y/length};};normals=function(p,slope){slope=unit(slope);slope.x=slope.x*p.size/2;slope.y=slope.y*p.size/2;return[{x:p.x-slope.y,y:p.y+slope.x,color:p.color},{x:p.x+slope.y,y:p.y-slope.x,color:p.color}];};math.len=function(vector){return Math.sqrt(Math.pow(vector.x,2)+Math.pow(vector.y,2));};math.scalePositionScalar=function(val,viewportSize,oldScale,newScale){var newSize,oldSize;oldSize=viewportSize*oldScale;newSize=viewportSize*newScale;return val+(oldSize-newSize)/2;};module.exports=math;},{"./shapes":13,"./util":15}],11:[function(require,module,exports){var INFINITE,JSONToShape,renderWatermark,util;util=require('./util');JSONToShape=require('./shapes').JSONToShape;INFINITE='infinite';renderWatermark=function(ctx,image,scale){if(!image.width){return;}
ctx.save();ctx.translate(ctx.canvas.width/2,ctx.canvas.height/2);ctx.scale(scale,scale);ctx.drawImage(image,-image.width/2,-image.height/2);return ctx.restore();};module.exports=function(snapshot,opts){var allShapes,backgroundShapes,colors,imageSize,s,shapes,watermarkCanvas,watermarkCtx;if(opts==null){opts={};}
if(opts.scale==null){opts.scale=1;}
shapes=(function(){var i,len,ref,results;ref=snapshot.shapes;results=[];for(i=0,len=ref.length;i<len;i++){s=ref[i];results.push(JSONToShape(s));}
return results;})();backgroundShapes=[];if(snapshot.backgroundShapes){backgroundShapes=(function(){var i,len,ref,results;ref=snapshot.backgroundShapes;results=[];for(i=0,len=ref.length;i<len;i++){s=ref[i];results.push(JSONToShape(s));}
return results;})();}
if(opts.margin==null){opts.margin={top:0,right:0,bottom:0,left:0};}
imageSize=snapshot.imageSize||{width:INFINITE,height:INFINITE};colors=snapshot.colors||{background:'transparent'};allShapes=shapes.concat(backgroundShapes);watermarkCanvas=document.createElement('canvas');watermarkCtx=watermarkCanvas.getContext('2d');if(opts.rect){opts.rect.x-=opts.margin.left;opts.rect.y-=opts.margin.top;opts.rect.width+=opts.margin.left+opts.margin.right;opts.rect.height+=opts.margin.top+opts.margin.bottom;}else{opts.rect=util.getDefaultImageRect((function(){var i,len,results;results=[];for(i=0,len=allShapes.length;i<len;i++){s=allShapes[i];results.push(s.getBoundingRect(watermarkCtx));}
return results;})(),imageSize,opts.margin);}
watermarkCanvas.width=opts.rect.width*opts.scale;watermarkCanvas.height=opts.rect.height*opts.scale;watermarkCtx.fillStyle=colors.background;watermarkCtx.fillRect(0,0,watermarkCanvas.width,watermarkCanvas.height);if(!(opts.rect.width&&opts.rect.height)){return null;}
if(opts.watermarkImage){renderWatermark(watermarkCtx,opts.watermarkImage,opts.watermarkScale);}
return util.combineCanvases(watermarkCanvas,util.renderShapes(backgroundShapes,opts.rect,opts.scale),util.renderShapes(shapes,opts.rect,opts.scale));};},{"./shapes":13,"./util":15}],12:[function(require,module,exports){var INFINITE,JSONToShape,util;util=require('./util');JSONToShape=require('./shapes').JSONToShape;INFINITE='infinite';module.exports=function(snapshot,opts){var allShapes,backgroundShapes,colors,ctx,dummyCanvas,imageSize,s,shapes;if(opts==null){opts={};}
shapes=(function(){var i,len,ref,results;ref=snapshot.shapes;results=[];for(i=0,len=ref.length;i<len;i++){s=ref[i];results.push(JSONToShape(s));}
return results;})();backgroundShapes=[];if(snapshot.backgroundShapes){backgroundShapes=(function(){var i,len,ref,results;ref=snapshot.backgroundShapes;results=[];for(i=0,len=ref.length;i<len;i++){s=ref[i];results.push(JSONToShape(s));}
return results;})();}
if(opts.margin==null){opts.margin={top:0,right:0,bottom:0,left:0};}
imageSize=snapshot.imageSize||{width:INFINITE,height:INFINITE};colors=snapshot.colors||{background:'transparent'};allShapes=shapes.concat(backgroundShapes);dummyCanvas=document.createElement('canvas');ctx=dummyCanvas.getContext('2d');if(opts.rect){opts.rect.x-=opts.margin.left;opts.rect.y-=opts.margin.top;opts.rect.width+=opts.margin.left+opts.margin.right;opts.rect.height+=opts.margin.top+opts.margin.bottom;}else{opts.rect=util.getDefaultImageRect((function(){var i,len,results;results=[];for(i=0,len=allShapes.length;i<len;i++){s=allShapes[i];results.push(s.getBoundingRect(ctx));}
return results;})(),imageSize,opts.margin);}
return LC.renderShapesToSVG(backgroundShapes.concat(shapes),opts.rect,colors.background);};},{"./shapes":13,"./util":15}],13:[function(require,module,exports){var JSONToShape,LinePath,TextRenderer,_createLinePathFromData,_doAllPointsShareStyle,_dual,_mid,_refine,bspline,createShape,defineCanvasRenderer,defineSVGRenderer,defineShape,lineEndCapShapes,linePathFuncs,ref,ref1,renderShapeToContext,renderShapeToSVG,shapeToJSON,shapes,util;util=require('./util');TextRenderer=require('./TextRenderer');lineEndCapShapes=require('./lineEndCapShapes');ref=require('./canvasRenderer'),defineCanvasRenderer=ref.defineCanvasRenderer,renderShapeToContext=ref.renderShapeToContext;ref1=require('./svgRenderer'),defineSVGRenderer=ref1.defineSVGRenderer,renderShapeToSVG=ref1.renderShapeToSVG;shapes={};defineShape=function(name,props){var Shape,drawFunc,drawLatestFunc,k,legacyDrawFunc,legacyDrawLatestFunc,legacySVGFunc,svgFunc;Shape=function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){props.constructor.call(this,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p);return this;};Shape.prototype.className=name;Shape.fromJSON=props.fromJSON;if(props.draw){legacyDrawFunc=props.draw;legacyDrawLatestFunc=props.draw||function(ctx,bufferCtx,retryCallback){return this.draw(ctx,bufferCtx,retryCallback);};drawFunc=function(ctx,shape,retryCallback){return legacyDrawFunc.call(shape,ctx,retryCallback);};drawLatestFunc=function(ctx,bufferCtx,shape,retryCallback){return legacyDrawLatestFunc.call(shape,ctx,bufferCtx,retryCallback);};delete props.draw;if(props.drawLatest){delete props.drawLatest;}
defineCanvasRenderer(name,drawFunc,drawLatestFunc);}
if(props.toSVG){legacySVGFunc=props.toSVG;svgFunc=function(shape){return legacySVGFunc.call(shape);};delete props.toSVG;defineSVGRenderer(name,svgFunc);}
Shape.prototype.draw=function(ctx,retryCallback){return renderShapeToContext(ctx,this,{retryCallback:retryCallback});};Shape.prototype.drawLatest=function(ctx,bufferCtx,retryCallback){return renderShapeToContext(ctx,this,{retryCallback:retryCallback,bufferCtx:bufferCtx,shouldOnlyDrawLatest:true});};Shape.prototype.toSVG=function(){return renderShapeToSVG(this);};for(k in props){if(k!=='fromJSON'){Shape.prototype[k]=props[k];}}
shapes[name]=Shape;return Shape;};createShape=function(name,a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){var s;s=new shapes[name](a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p);s.id=util.getGUID();return s;};JSONToShape=function(arg){var className,data,id,shape;className=arg.className,data=arg.data,id=arg.id;if(className in shapes){shape=shapes[className].fromJSON(data);if(shape){if(id){shape.id=id;}
return shape;}else{console.log('Unreadable shape:',className,data);return null;}}else{console.log("Unknown shape:",className,data);return null;}};shapeToJSON=function(shape){return{className:shape.className,data:shape.toJSON(),id:shape.id};};bspline=function(points,order){if(!order){return points;}
return bspline(_dual(_dual(_refine(points))),order-1);};_refine=function(points){var index,len,point,q,refined;points=[points[0]].concat(points).concat(util.last(points));refined=[];index=0;for(q=0,len=points.length;q<len;q++){point=points[q];refined[index*2]=point;if(points[index+1]){refined[index*2+1]=_mid(point,points[index+1]);}
index+=1;}
return refined;};_dual=function(points){var dualed,index,len,point,q;dualed=[];index=0;for(q=0,len=points.length;q<len;q++){point=points[q];if(points[index+1]){dualed[index]=_mid(point,points[index+1]);}
index+=1;}
return dualed;};_mid=function(a,b){return createShape('Point',{x:a.x+((b.x-a.x)/2),y:a.y+((b.y-a.y)/2),size:a.size+((b.size-a.size)/2),color:a.color});};defineShape('Image',{constructor:function(args){if(args==null){args={};}
this.x=args.x||0;this.y=args.y||0;this.scale=args.scale||1;return this.image=args.image||null;},getBoundingRect:function(){return{x:this.x,y:this.y,width:this.image.width*this.scale,height:this.image.height*this.scale};},toJSON:function(){return{x:this.x,y:this.y,imageSrc:this.image.src,imageObject:this.image,scale:this.scale,opacity:this.image.style.opacity,imgWidth:this.image.width,imgHeight:this.image.height,imgType:(typeof this.image!='undefined'&&this.image!=null&&typeof this.image.dataset!='undefined'&&this.image.dataset!=null)?((typeof this.image.dataset.imageType!='undefined'&&this.image.dataset.imageType!=null&&this.image.dataset.imageType=='checkmark')?'checkmark':'general'):'general'};},fromJSON:function(data){var img,ref2;img=null;if((ref2=data.imageObject)!=null?ref2.width:void 0){img=data.imageObject;}else{img=new Image();img.src=data.imageSrc;}
img.style.opacity=data.opacity;if(data.imgType=='checkmark'){img.width=data.imgWidth;img.height=data.imgHeight;}
if(data.imgType!=''&&typeof data.imgType!='undefined'){img.dataset.imageType=data.imgType;}
return createShape('Image',{x:data.x,y:data.y,image:img,scale:data.scale});},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x=this.x-moveInfo.xDiff;return this.y=this.y-moveInfo.yDiff;},setUpperLeft:function(upperLeft){if(upperLeft==null){upperLeft={};}
this.x=upperLeft.x;return this.y=upperLeft.y;}});defineShape('Rectangle',{constructor:function(args){if(args==null){args={};}
if(args.isWhiteout===true){args.strokeWidth=1;}
this.x=args.x||0;this.y=args.y||0;this.width=args.width||0;this.height=args.height||0;this.strokeWidth=args.strokeWidth||1;this.strokeColor=args.strokeColor||'black';this.isWhiteout=args.isWhiteout;this.originalFillColor=args.originalFillColor;this.rectcopy=args.rectcopy;this.rectAlpha=args.rectAlpha;this.setHighliter=args.setHighliter;return this.fillColor=args.fillColor||'transparent';},getBoundingRect:function(){return{x:this.x-this.strokeWidth/2,y:this.y-this.strokeWidth/2,width:this.width+this.strokeWidth,height:this.height+this.strokeWidth};},toJSON:function(){return{x:this.x,y:this.y,width:this.width,height:this.height,strokeWidth:this.strokeWidth,strokeColor:this.strokeColor,fillColor:this.fillColor,isWhiteout:this.isWhiteout,originalFillColor:this.originalFillColor,rectcopy:this.rectcopy,rectAlpha:this.rectAlpha,setHighliter:this.setHighliter,};},fromJSON:function(data){return createShape('Rectangle',data);},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x=this.x-moveInfo.xDiff;return this.y=this.y-moveInfo.yDiff;},setUpperLeft:function(upperLeft){if(upperLeft==null){upperLeft={};}
this.x=upperLeft.x;return this.y=upperLeft.y;}});defineShape('Ellipse',{constructor:function(args){if(args==null){args={};}
this.x=args.x||0;this.y=args.y||0;this.width=args.width||0;this.height=args.height||0;this.strokeWidth=args.strokeWidth||1;this.strokeColor=args.strokeColor||'black';this.alpha=args.alpha;this.originalFillColor=args.originalFillColor;return this.fillColor=args.fillColor||'transparent';},getBoundingRect:function(){return{x:this.x-this.strokeWidth/2,y:this.y-this.strokeWidth/2,width:this.width+this.strokeWidth,height:this.height+this.strokeWidth};},toJSON:function(){return{x:this.x,y:this.y,width:this.width,height:this.height,strokeWidth:this.strokeWidth,strokeColor:this.strokeColor,originalFillColor:this.originalFillColor,alpha:this.alpha,fillColor:this.fillColor};},fromJSON:function(data){return createShape('Ellipse',data);},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x=this.x-moveInfo.xDiff;return this.y=this.y-moveInfo.yDiff;},setUpperLeft:function(upperLeft){if(upperLeft==null){upperLeft={};}
this.x=upperLeft.x;return this.y=upperLeft.y;}});defineShape('Line',{constructor:function(args){if(args==null){args={};}
this.x1=args.x1||0;this.y1=args.y1||0;this.x2=args.x2||0;this.y2=args.y2||0;this.strokeWidth=args.strokeWidth||1;this.color=args.color||'black';this.capStyle=args.capStyle||'round';this.endCapShapes=args.endCapShapes||[null,null];return this.dash=args.dash||null;},getBoundingRect:function(){return{x:Math.min(this.x1,this.x2)-this.strokeWidth/2,y:Math.min(this.y1,this.y2)-this.strokeWidth/2,width:Math.abs(this.x2-this.x1)+this.strokeWidth/2,height:Math.abs(this.y2-this.y1)+this.strokeWidth/2};},toJSON:function(){return{x1:this.x1,y1:this.y1,x2:this.x2,y2:this.y2,strokeWidth:this.strokeWidth,color:this.color,capStyle:this.capStyle,dash:this.dash,endCapShapes:this.endCapShapes};},fromJSON:function(data){return createShape('Line',data);},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x1=this.x1-moveInfo.xDiff;this.y1=this.y1-moveInfo.yDiff;this.x2=this.x2-moveInfo.xDiff;return this.y2=this.y2-moveInfo.yDiff;},setUpperLeft:function(upperLeft){var br,xDiff,yDiff;if(upperLeft==null){upperLeft={};}
br=this.getBoundingRect();xDiff=br.x-upperLeft.x;yDiff=br.y-upperLeft.y;return this.move({xDiff:xDiff,yDiff:yDiff});}});_doAllPointsShareStyle=function(points){var color,len,point,q,size;if(!points.length){return false;}
size=points[0].size;color=points[0].color;for(q=0,len=points.length;q<len;q++){point=points[q];if(!(point.size===size&&point.color===color)){console.log(size,color,point.size,point.color);}
if(!(point.size===size&&point.color===color)){return false;}}
return true;};_createLinePathFromData=function(shapeName,data){var pointData,points,smoothedPoints,x,y;points=null;if(data.points){points=(function(){var len,q,ref2,results;ref2=data.points;results=[];for(q=0,len=ref2.length;q<len;q++){pointData=ref2[q];results.push(JSONToShape(pointData));}
return results;})();}else if(data.pointCoordinatePairs){points=(function(){var len,q,ref2,ref3,results;ref2=data.pointCoordinatePairs;results=[];for(q=0,len=ref2.length;q<len;q++){ref3=ref2[q],x=ref3[0],y=ref3[1];results.push(JSONToShape({className:'Point',data:{x:x,y:y,size:data.pointSize,color:data.pointColor,smooth:data.smooth}}));}
return results;})();}
smoothedPoints=null;if(data.smoothedPointCoordinatePairs){smoothedPoints=(function(){var len,q,ref2,ref3,results;ref2=data.smoothedPointCoordinatePairs;results=[];for(q=0,len=ref2.length;q<len;q++){ref3=ref2[q],x=ref3[0],y=ref3[1];results.push(JSONToShape({className:'Point',data:{x:x,y:y,size:data.pointSize,color:data.pointColor,smooth:data.smooth}}));}
return results;})();}
if(!points[0]){return null;}
return createShape(shapeName,{points:points,smoothedPoints:smoothedPoints,order:data.order,tailSize:data.tailSize,smooth:data.smooth});};linePathFuncs={constructor:function(args){var len,point,points,q,results;if(args==null){args={};}
points=args.points||[];this.order=args.order||3;this.tailSize=args.tailSize||3;this.smooth='smooth'in args?args.smooth:true;this.segmentSize=Math.pow(2,this.order);this.sampleSize=this.tailSize+1;if(args.smoothedPoints){this.points=args.points;return this.smoothedPoints=args.smoothedPoints;}else{this.points=[];results=[];for(q=0,len=points.length;q<len;q++){point=points[q];results.push(this.addPoint(point));}
return results;}},getBoundingRect:function(){return util.getBoundingRect(this.points.map(function(p){return{x:p.x-p.size/2,y:p.y-p.size/2,width:p.size,height:p.size};}));},toJSON:function(){var p,point;if(_doAllPointsShareStyle(this.points)){return{order:this.order,tailSize:this.tailSize,smooth:this.smooth,pointCoordinatePairs:(function(){var len,q,ref2,results;ref2=this.points;results=[];for(q=0,len=ref2.length;q<len;q++){point=ref2[q];results.push([point.x,point.y]);}
return results;}).call(this),smoothedPointCoordinatePairs:(function(){var len,q,ref2,results;ref2=this.smoothedPoints;results=[];for(q=0,len=ref2.length;q<len;q++){point=ref2[q];results.push([point.x,point.y]);}
return results;}).call(this),pointSize:this.points[0].size,pointColor:this.points[0].color};}else{return{order:this.order,tailSize:this.tailSize,smooth:this.smooth,points:(function(){var len,q,ref2,results;ref2=this.points;results=[];for(q=0,len=ref2.length;q<len;q++){p=ref2[q];results.push(shapeToJSON(p));}
return results;}).call(this)};}},fromJSON:function(data){return _createLinePathFromData('LinePath',data);},addPoint:function(point){this.points.push(point);if(!this.smooth){this.smoothedPoints=this.points;return;}
if(!this.smoothedPoints||this.points.length<this.sampleSize){return this.smoothedPoints=bspline(this.points,this.order);}else{this.tail=util.last(bspline(util.last(this.points,this.sampleSize),this.order),this.segmentSize*this.tailSize);return this.smoothedPoints=this.smoothedPoints.slice(0,this.smoothedPoints.length-this.segmentSize*(this.tailSize-1)).concat(this.tail);}},move:function(moveInfo){var len,pt,pts,q;if(moveInfo==null){moveInfo={};}
if(!this.smooth){pts=this.points;}else{pts=this.smoothedPoints;}
for(q=0,len=pts.length;q<len;q++){pt=pts[q];pt.move(moveInfo);}
return this.points=this.smoothedPoints;},setUpperLeft:function(upperLeft){var br,xDiff,yDiff;if(upperLeft==null){upperLeft={};}
br=this.getBoundingRect();xDiff=br.x-upperLeft.x;yDiff=br.y-upperLeft.y;return this.move({xDiff:xDiff,yDiff:yDiff});}};LinePath=defineShape('LinePath',linePathFuncs);defineShape('ErasedLinePath',{constructor:linePathFuncs.constructor,toJSON:linePathFuncs.toJSON,addPoint:linePathFuncs.addPoint,getBoundingRect:linePathFuncs.getBoundingRect,fromJSON:function(data){return _createLinePathFromData('ErasedLinePath',data);}});defineShape('Point',{constructor:function(args){if(args==null){args={};}
this.x=args.x||0;this.y=args.y||0;this.size=args.size||0;return this.color=args.color||'';},getBoundingRect:function(){return{x:this.x-this.size/2,y:this.y-this.size/2,width:this.size,height:this.size};},toJSON:function(){return{x:this.x,y:this.y,size:this.size,color:this.color};},fromJSON:function(data){return createShape('Point',data);},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x=this.x-moveInfo.xDiff;return this.y=this.y-moveInfo.yDiff;},setUpperLeft:function(upperLeft){if(upperLeft==null){upperLeft={};}
this.x=upperLeft.x;return this.y=upperLeft.y;}});defineShape('Polygon',{constructor:function(args){var len,point,q,ref2,results;if(args==null){args={};}
this.points=args.points;this.fillColor=args.fillColor||'white';this.strokeColor=args.strokeColor||'black';this.strokeWidth=args.strokeWidth;this.originalFillColor=args.originalFillColor;this.alpha=args.alpha;this.dash=args.dash||null;if(args.isClosed==null){args.isClosed=true;}
this.isClosed=args.isClosed;ref2=this.points;results=[];for(q=0,len=ref2.length;q<len;q++){point=ref2[q];point.color=this.strokeColor;results.push(point.size=this.strokeWidth);}
return results;},addPoint:function(x,y){return this.points.push(LC.createShape('Point',{x:x,y:y}));},getBoundingRect:function(){return util.getBoundingRect(this.points.map(function(p){return p.getBoundingRect();}));},toJSON:function(){return{strokeWidth:this.strokeWidth,fillColor:this.fillColor,strokeColor:this.strokeColor,dash:this.dash,isClosed:this.isClosed,originalFillColor:this.originalFillColor,alpha:this.alpha,pointCoordinatePairs:this.points.map(function(p){return[p.x,p.y];})};},fromJSON:function(data){data.points=data.pointCoordinatePairs.map(function(arg){var x,y;x=arg[0],y=arg[1];return createShape('Point',{x:x,y:y,size:data.strokeWidth,color:data.strokeColor});});return createShape('Polygon',data);},move:function(moveInfo){var len,pt,q,ref2,results;if(moveInfo==null){moveInfo={};}
ref2=this.points;results=[];for(q=0,len=ref2.length;q<len;q++){pt=ref2[q];results.push(pt.move(moveInfo));}
return results;},setUpperLeft:function(upperLeft){var br,xDiff,yDiff;if(upperLeft==null){upperLeft={};}
br=this.getBoundingRect();xDiff=br.x-upperLeft.x;yDiff=br.y-upperLeft.y;return this.move({xDiff:xDiff,yDiff:yDiff});}});defineShape('Text',{constructor:function(args){if(args==null){args={};}
this.x=args.x||0;this.y=args.y||0;this.v=args.v||0;this.text=args.text||'';this.color=args.color||'black';this.font=args.font||'18px sans-serif';this.forcedWidth=args.forcedWidth||null;this.fontItalic=args.fontItalic||null;this.fontBold=args.fontBold||null;this.fontSize=args.fontSize||null;this.fontType=args.fontType||null;return this.forcedHeight=args.forcedHeight||null;},_makeRenderer:function(ctx){ctx.lineHeight=1.2;this.renderer=new TextRenderer(ctx,this.text,this.font,this.forcedWidth,this.forcedHeight,this.x,this.y,this.color);if(this.v<1){console.log('repairing baseline');this.v=1;this.x-=this.renderer.metrics.bounds.minx;return this.y-=this.renderer.metrics.leading-this.renderer.metrics.descent;}},setText:function(text){this.text=text;return this.renderer=null;},setFont:function(font){this.font=font;return this.renderer=null;},setPosition:function(x,y){this.x=x;return this.y=y;},setSize:function(forcedWidth,forcedHeight){this.forcedWidth=Math.max(forcedWidth,0);this.forcedHeight=Math.max(forcedHeight,0);return this.renderer=null;},enforceMaxBoundingRect:function(lc){var br,dx,lcBoundingRect;br=this.getBoundingRect(lc.ctx);lcBoundingRect={x:-lc.position.x/lc.scale,y:-lc.position.y/lc.scale,width:lc.canvas.width/lc.scale,height:lc.canvas.height/lc.scale};if(br.x+br.width>lcBoundingRect.x+lcBoundingRect.width){dx=br.x-lcBoundingRect.x;this.forcedWidth=lcBoundingRect.width-dx-10;return this.renderer=null;}},getBoundingRect:function(ctx,isEditing){if(isEditing==null){isEditing=false;}
if(!this.renderer){if(ctx){this._makeRenderer(ctx);}else{throw "Must pass ctx if text hasn't been rendered yet";}}
return{x:Math.floor(this.x),y:Math.floor(this.y),width:Math.ceil(this.renderer.getWidth(true)),height:Math.ceil(this.renderer.getHeight())};},toJSON:function(){return{x:this.x,y:this.y,text:this.text,color:this.color,font:this.font,forcedWidth:this.forcedWidth,forcedHeight:this.forcedHeight,fontItalic:this.fontItalic,fontBold:this.fontBold,fontSize:this.fontSize,fontType:this.fontType,v:this.v};},fromJSON:function(data){return createShape('Text',data);},move:function(moveInfo){if(moveInfo==null){moveInfo={};}
this.x=this.x-moveInfo.xDiff;return this.y=this.y-moveInfo.yDiff;},setUpperLeft:function(upperLeft){if(upperLeft==null){upperLeft={};}
this.x=upperLeft.x;return this.y=upperLeft.y;}});defineShape('SelectionBox',{constructor:function(args){if(args==null){args={};}
this.shape=args.shape;if(args.handleSize!=null){this.handleSize=args.handleSize;}else{this.handleSize=10;}
this.margin=4;this.backgroundColor=args.backgroundColor||null;return this._br=this.shape.getBoundingRect(args.ctx);},toJSON:function(){return{shape:shapeToJSON(this.shape),backgroundColor:this.backgroundColor};},fromJSON:function(arg){var backgroundColor,handleSize,margin,shape;shape=arg.shape,handleSize=arg.handleSize,margin=arg.margin,backgroundColor=arg.backgroundColor;return createShape('SelectionBox',{shape:JSONToShape(shape),backgroundColor:backgroundColor});},getTopLeftHandleRect:function(){return{x:this._br.x-this.handleSize-this.margin,y:this._br.y-this.handleSize-this.margin,width:this.handleSize,height:this.handleSize};},getBottomLeftHandleRect:function(){return{x:this._br.x-this.handleSize-this.margin,y:this._br.y+this._br.height+this.margin,width:this.handleSize,height:this.handleSize};},getTopRightHandleRect:function(){return{x:this._br.x+this._br.width+this.margin,y:this._br.y-this.handleSize-this.margin,width:this.handleSize,height:this.handleSize};},getBottomRightHandleRect:function(){return{x:this._br.x+this._br.width+this.margin,y:this._br.y+this._br.height+this.margin,width:this.handleSize,height:this.handleSize};},getBoundingRect:function(){return{x:this._br.x-this.margin,y:this._br.y-this.margin,width:this._br.width+this.margin*2,height:this._br.height+this.margin*2};}});module.exports={defineShape:defineShape,createShape:createShape,JSONToShape:JSONToShape,shapeToJSON:shapeToJSON};},{"./TextRenderer":2,"./canvasRenderer":5,"./lineEndCapShapes":8,"./svgRenderer":14,"./util":15}],14:[function(require,module,exports){var defineSVGRenderer,lineEndCapShapes,renderShapeToSVG,renderers;lineEndCapShapes=require('./lineEndCapShapes');renderers={};defineSVGRenderer=function(shapeName,shapeToSVGFunc){return renderers[shapeName]=shapeToSVGFunc;};renderShapeToSVG=function(shape,opts){if(opts==null){opts={};}
if(opts.shouldIgnoreUnsupportedShapes==null){opts.shouldIgnoreUnsupportedShapes=false;}
if(renderers[shape.className]){return renderers[shape.className](shape);}else if(opts.shouldIgnoreUnsupportedShapes){console.warn("Can't render shape of type "+shape.className+" to SVG");return "";}else{throw "Can't render shape of type "+shape.className+" to SVG";}};defineSVGRenderer('Rectangle',function(shape){var height,width,x,x1,x2,y,y1,y2,es;if('yes'===shape.setHighliter){es=" fill-opacity='0.4'";shape.strokeWidth=0;shape.fillColor=shape.originalFillColor;}
if('undefined'!=typeof shape.isWhiteout)
{es=" fill-opacity='1'";shape.fillColor='#FFFFFF';}
if('copy'===shape.rectcopy){es=" fill-opacity='0' stroke-opacity='0'";shape.fillColor='transparent';shape.strokeWidth=1;shape.strokeColor='black';}
if('undefined'!=typeof shape.rectAlpha)
{es=" fill-opacity='"+shape.rectAlpha+"'";shape.fillColor=shape.originalFillColor;}
if('undefined'==typeof es)
{es=" fill-opacity='0'";shape.fillColor='transparent';}
x1=shape.x;y1=shape.y;x2=shape.x+shape.width;y2=shape.y+shape.height;x=Math.min(x1,x2);y=Math.min(y1,y2);width=Math.max(x1,x2)-x;height=Math.max(y1,y2)-y;if(shape.strokeWidth%2!==0){x+=0.5;y+=0.5;}
return "<rect x='"+x+"' y='"+y+"' width='"+width+"' height='"+height+"' stroke='"+shape.strokeColor+"' fill='"+shape.fillColor+"' stroke-width='"+shape.strokeWidth+"'"+es+"  />";});defineSVGRenderer('SelectionBox',function(shape){return "";});defineSVGRenderer('Ellipse',function(shape){var centerX,centerY,halfHeight,halfWidth,es;halfWidth=Math.floor(shape.width/2);halfHeight=Math.floor(shape.height/2);centerX=shape.x+halfWidth;centerY=shape.y+halfHeight;if('undefined'!=shape.alpha){es=" fill-opacity='"+shape.alpha+"'";}
if('undefined'===typeof shape.originalFillColor){es=" fill-opacity='0'";shape.originalFillColor='transparent';}
return "<ellipse cx='"+centerX+"' cy='"+centerY+"' rx='"+(Math.abs(halfWidth))+"' ry='"+(Math.abs(halfHeight))+"' stroke='"+shape.strokeColor+"' fill='"+shape.originalFillColor+"' stroke-width='"+shape.strokeWidth+"'"+es+" />";});defineSVGRenderer('Image',function(shape){var returnText;returnText="<image x='"+shape.x+"' y='"+shape.y+"' style='opacity:"+shape.image.style.opacity+"'";if(shape.image.dataset.imageType=='checkmark'){returnText+=" width='"+shape.image.width*shape.scale+"' height='"+shape.image.height*shape.scale+"'";}else{returnText+=" width='"+shape.image.naturalWidth*shape.scale+"' height='"+shape.image.naturalHeight*shape.scale+"'";}
returnText+=" xlink:href='"+shape.image.src+"' />";return returnText;});defineSVGRenderer('Line',function(shape){var arrowWidth,capString,dashString,x1,x2,y1,y2;dashString=shape.dash?"stroke-dasharray='"+(shape.dash.join(', '))+"'":'';capString='';arrowWidth=Math.max(shape.strokeWidth*2.2,5);x1=shape.x1;x2=shape.x2;y1=shape.y1;y2=shape.y2;if(shape.strokeWidth%2!==0){x1+=0.5;x2+=0.5;y1+=0.5;y2+=0.5;}
if(shape.endCapShapes[0]){capString+=lineEndCapShapes[shape.endCapShapes[0]].svg(x1,y1,Math.atan2(y1-y2,x1-x2),arrowWidth,shape.color);}
if(shape.endCapShapes[1]){capString+=lineEndCapShapes[shape.endCapShapes[1]].svg(x2,y2,Math.atan2(y2-y1,x2-x1),arrowWidth,shape.color);}
return "<g> <line x1='"+x1+"' y1='"+y1+"' x2='"+x2+"' y2='"+y2+"' "+dashString+" stroke-linecap='"+shape.capStyle+"' stroke='"+shape.color+"' stroke-width='"+shape.strokeWidth+"' /> "+capString+" </g>";});defineSVGRenderer('LinePath',function(shape){return "<polyline fill='none' points='"+(shape.smoothedPoints.map(function(p){var offset;offset=p.strokeWidth%2===0?0.0:0.5;return(p.x+offset)+","+(p.y+offset);}).join(' '))+"' stroke='"+shape.points[0].color+"' stroke-linecap='round' stroke-width='"+shape.points[0].size+"' />";});defineSVGRenderer('ErasedLinePath',function(shape){return "";});defineSVGRenderer('Polygon',function(shape){if('undefined'==typeof shape.alpha)
{shape.alpha=1;}
if('undefined'==typeof shape.originalFillColor)
{shape.originalFillColor="transparent";shape.alpha=0;}
if(shape.isClosed){return "<polygon fill='"+shape.originalFillColor+"' points='"+(shape.points.map(function(p){var offset;offset=p.strokeWidth%2===0?0.0:0.5;return(p.x+offset)+","+(p.y+offset);}).join(' '))+"' stroke='"+shape.strokeColor+"' stroke-width='"+shape.strokeWidth+"' fill-opacity='"+shape.alpha+"' />";}else{return "<polyline fill='"+shape.originalFillColor+"' points='"+(shape.points.map(function(p){var offset;offset=p.strokeWidth%2===0?0.0:0.5;return(p.x+offset)+","+(p.y+offset);}).join(' '))+"' stroke='none' /> <polyline fill='none' points='"+(shape.points.map(function(p){var offset;offset=p.strokeWidth%2===0?0.0:0.5;return(p.x+offset)+","+(p.y+offset);}).join(' '))+"' stroke='"+shape.strokeColor+"' stroke-width='"+shape.strokeWidth+"' fill-opacity='"+shape.alpha+"' />";}});defineSVGRenderer('Text',function(shape){var heightString,textSplitOnLines,widthString;widthString=shape.forcedWidth?"width='"+shape.forcedWidth+"px'":"";heightString=shape.forcedHeight?"height='"+shape.forcedHeight+"px'":"";textSplitOnLines=shape.text.split(/\r\n|\r|\n/g);if(shape.renderer){textSplitOnLines=shape.renderer.lines;}
return "<text xml:space='preserve' x='"+shape.x+"' y='"+shape.y+"' "+widthString+" "+heightString+" fill='"+shape.color+"' style='font: "+shape.font+";' "+shape.fontItalic+" "+shape.fontBold+" "+shape.fontSize+" "+shape.fontType+"> "+(textSplitOnLines.map((function(_this){return function(line,i){var dy;var dx;dy='0.8em';dx=i===0?0:0;return "<tspan x='"+shape.x+"' dy='"+dy+"' dx='"+dx+"'"+" alignment-baseline='text-before-edge' text-decoration='"+shape.font.split(' ')[4]+"'>"+escapeXml(line)+"</tspan>";};})(this)).join(''))+" </text>";});module.exports={defineSVGRenderer:defineSVGRenderer,renderShapeToSVG:renderShapeToSVG};},{"./lineEndCapShapes":8}],15:[function(require,module,exports){var renderShapeToContext,renderShapeToSVG,slice,util,slice1=[].slice;slice=Array.prototype.slice;renderShapeToContext=require('./canvasRenderer').renderShapeToContext;renderShapeToSVG=require('./svgRenderer').renderShapeToSVG;util={addImageOnload:function(img,fn){var oldOnload;oldOnload=img.onload;img.onload=function(){if(typeof oldOnload==="function"){oldOnload();}
return fn();};return img;},last:function(array,n){if(n==null){n=null;}
if(n){return slice.call(array,Math.max(array.length-n,0));}else{return array[array.length-1];}},classSet:function(classNameToIsPresent){var classNames,key;classNames=[];for(key in classNameToIsPresent){if(classNameToIsPresent[key]){classNames.push(key);}}
return classNames.join(' ');},matchElementSize:function(elementToMatch,elementsToResize,scale,callback){var resize;if(callback==null){callback=function(){};}
resize=(function(_this){return function(){var el,i,len;for(i=0,len=elementsToResize.length;i<len;i++){el=elementsToResize[i];el.style.width=elementToMatch.offsetWidth+"px";el.style.height=elementToMatch.offsetHeight+"px";if(el.width!=null){el.setAttribute('width',el.offsetWidth*scale);el.setAttribute('height',el.offsetHeight*scale);}}
return callback();};})(this);elementToMatch.addEventListener('resize',resize);window.addEventListener('resize',resize);window.addEventListener('orientationchange',resize);return resize();},combineCanvases:function(){var c,canvas,canvases,ctx,i,j,len,len1;canvases=1<=arguments.length?slice1.call(arguments,0):[];c=document.createElement('canvas');c.width=canvases[0].width;c.height=canvases[0].height;for(i=0,len=canvases.length;i<len;i++){canvas=canvases[i];c.width=Math.max(canvas.width,c.width);c.height=Math.max(canvas.height,c.height);}
ctx=c.getContext('2d');for(j=0,len1=canvases.length;j<len1;j++){canvas=canvases[j];ctx.drawImage(canvas,0,0);}
return c;},renderShapes:function(shapes,bounds,scale,canvas){var ctx,i,len,shape;if(scale==null){scale=1;}
if(canvas==null){canvas=null;}
canvas=canvas||document.createElement('canvas');canvas.width=bounds.width*scale;canvas.height=bounds.height*scale;ctx=canvas.getContext('2d');ctx.translate(-bounds.x*scale,-bounds.y*scale);ctx.scale(scale,scale);for(i=0,len=shapes.length;i<len;i++){shape=shapes[i];renderShapeToContext(ctx,shape);}
return canvas;},renderShapesToSVG:function(shapes,arg,backgroundColor){var height,width,x,y;x=arg.x,y=arg.y,width=arg.width,height=arg.height;return("<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' width='"+width+"' height='"+height+"' viewBox='0 0 "+width+" "+height+"' version='1.1' preserveAspectRatio='xMidYMid meet' zoomAndPan='magnify' contentScriptType='application/ecmascript'> <rect width='"+width+"' height='"+height+"' x='0' y='0' fill='"+backgroundColor+"' /> <g transform='translate("+(-x)+", "+(-y)+")'> "+(shapes.map(renderShapeToSVG).join(''))+" </g> </svg>").replace(/(\r\n|\n|\r)/gm,"");},getBoundingRect:function(rects,width,height){var i,len,maxX,maxY,minX,minY,rect;if(!rects.length){return{x:0,y:0,width:0||width,height:0||height};}
minX=rects[0].x;minY=rects[0].y;maxX=rects[0].x+rects[0].width;maxY=rects[0].y+rects[0].height;for(i=0,len=rects.length;i<len;i++){rect=rects[i];minX=Math.floor(Math.min(rect.x,minX));minY=Math.floor(Math.min(rect.y,minY));maxX=Math.ceil(Math.max(maxX,rect.x+rect.width));maxY=Math.ceil(Math.max(maxY,rect.y+rect.height));}
minX=width?0:minX;minY=height?0:minY;maxX=width||maxX;maxY=height||maxY;return{x:minX,y:minY,width:maxX-minX,height:maxY-minY};},getDefaultImageRect:function(shapeBoundingRects,explicitSize,margin){var height,rect,width;if(explicitSize==null){explicitSize={width:0,height:0};}
if(margin==null){margin={top:0,right:0,bottom:0,left:0};}
width=explicitSize.width,height=explicitSize.height;rect=util.getBoundingRect(shapeBoundingRects,width==='infinite'?0:width,height==='infinite'?0:height);rect.x-=margin.left;rect.y-=margin.top;rect.width+=margin.left+margin.right;rect.height+=margin.top+margin.bottom;return rect;},getBackingScale:function(context){if(window.devicePixelRatio==null){return 1;}
if(!(window.devicePixelRatio>1)){return 1;}
return window.devicePixelRatio;},requestAnimationFrame:(window.requestAnimationFrame||window.setTimeout).bind(window),getGUID:(function(){var s4;s4=function(){return Math.floor((1+Math.random())*0x10000).toString(16).substring(1);};return function(){return s4()+s4()+'-'+s4()+'-'+s4()+'-'+s4()+'-'+s4()+s4()+s4();};})(),requestAnimationFrame:function(f){if(window.webkitRequestAnimationFrame){return window.webkitRequestAnimationFrame(f);}
if(window.requestAnimationFrame){return window.requestAnimationFrame(f);}
if(window.mozRequestAnimationFrame){return window.mozRequestAnimationFrame(f);}
return setTimeout(f,0);},cancelAnimationFrame:function(f){if(window.webkitCancelRequestAnimationFrame){return window.webkitCancelRequestAnimationFrame(f);}
if(window.webkitCancelAnimationFrame){return window.webkitCancelAnimationFrame(f);}
if(window.cancelAnimationFrame){return window.cancelAnimationFrame(f);}
if(window.mozCancelAnimationFrame){return window.mozCancelAnimationFrame(f);}
return clearTimeout(f);}};module.exports=util;},{"./canvasRenderer":5,"./svgRenderer":14}],16:[function(require,module,exports){'use strict';(function(){function CustomEvent(event,params){params=params||{bubbles:false,cancelable:false,detail:undefined};var evt=document.createEvent('CustomEvent');evt.initCustomEvent(event,params.bubbles,params.cancelable,params.detail);return evt;};CustomEvent.prototype=window.CustomEvent.prototype;window.CustomEvent=CustomEvent;})();},{}],17:[function(require,module,exports){"use strict";var hasWarned=false;if(!CanvasRenderingContext2D.prototype.setLineDash){CanvasRenderingContext2D.prototype.setLineDash=function(){if(!hasWarned){console.warn("context2D.setLineDash is a no-op in this browser.");hasWarned=true;}};}
module.exports=null;},{}],18:[function(require,module,exports){var LiterallyCanvasModel,baseTools,canvasRenderer,conversion,defaultImageURLPrefix,defaultOptions,defaultTools,init,initWithoutGUI,localize,registerJQueryPlugin,renderSnapshotToImage,renderSnapshotToSVG,setDefaultImageURLPrefix,shapes,svgRenderer,tools,util;require('./ie_customevent');require('./ie_setLineDash');LiterallyCanvasModel=require('./core/LiterallyCanvas');defaultOptions=require('./core/defaultOptions');canvasRenderer=require('./core/canvasRenderer');svgRenderer=require('./core/svgRenderer');shapes=require('./core/shapes');util=require('./core/util');renderSnapshotToImage=require('./core/renderSnapshotToImage');renderSnapshotToSVG=require('./core/renderSnapshotToSVG');localize=require('./core/localization').localize;conversion={snapshotToShapes:function(snapshot){var i,len,ref,results,shape;ref=snapshot.shapes;results=[];for(i=0,len=ref.length;i<len;i++){shape=ref[i];results.push(shapes.JSONToShape(shape));}
return results;},snapshotJSONToShapes:function(json){return conversion.snapshotToShapes(JSON.parse(json));}};baseTools=require('./tools/base');tools={Pencil:require('./tools/Pencil'),Eraser:require('./tools/Eraser'),Line:require('./tools/Line'),Rectangle:require('./tools/Rectangle'),Ellipse:require('./tools/Ellipse'),Text:require('./tools/Text'),Polygon:require('./tools/Polygon'),Pan:require('./tools/Pan'),Eyedropper:require('./tools/Eyedropper'),SelectShape:require('./tools/SelectShape'),Tool:baseTools.Tool,ToolWithStroke:baseTools.ToolWithStroke};defaultTools=defaultOptions.tools;defaultImageURLPrefix=defaultOptions.imageURLPrefix;setDefaultImageURLPrefix=function(newDefault){defaultImageURLPrefix=newDefault;return defaultOptions.imageURLPrefix=newDefault;};init=function(el,opts){var child,i,len,opt,ref;if(opts==null){opts={};}
for(opt in defaultOptions){if(!(opt in opts)){opts[opt]=defaultOptions[opt];}}
ref=el.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];el.removeChild(child);}
return initWithoutGUI(el,opts);};initWithoutGUI=function(el,opts){var drawingViewElement,lc,originalClassName;originalClassName=el.className;if([' ',' '].join(el.className).indexOf(' literally ')===-1){el.className=el.className+' literally';}
el.className=el.className+' toolbar-hidden';drawingViewElement=document.createElement('div');drawingViewElement.className='lc-drawing';el.appendChild(drawingViewElement);lc=new LiterallyCanvasModel(drawingViewElement,opts);lc.teardown=function(){var child,i,len,ref;lc._teardown();ref=el.children;for(i=0,len=ref.length;i<len;i++){child=ref[i];el.removeChild(child);}
return el.className=originalClassName;};if('onInit'in opts){opts.onInit(lc);}
return lc;};registerJQueryPlugin=function(_$){return _$.fn.literallycanvas=function(opts){if(opts==null){opts={};}
this.each((function(_this){return function(ix,el){return el.literallycanvas=init(el,opts);};})(this));return this;};};if(typeof window!=='undefined'){window.LC={init:init};if(window.$){registerJQueryPlugin(window.$);}}
module.exports={init:init,registerJQueryPlugin:registerJQueryPlugin,util:util,tools:tools,setDefaultImageURLPrefix:setDefaultImageURLPrefix,defaultTools:defaultTools,defineShape:shapes.defineShape,createShape:shapes.createShape,JSONToShape:shapes.JSONToShape,shapeToJSON:shapes.shapeToJSON,defineCanvasRenderer:canvasRenderer.defineCanvasRenderer,renderShapeToContext:canvasRenderer.renderShapeToContext,renderShapeToCanvas:canvasRenderer.renderShapeToCanvas,renderShapesToCanvas:util.renderShapes,defineSVGRenderer:svgRenderer.defineSVGRenderer,renderShapeToSVG:svgRenderer.renderShapeToSVG,renderShapesToSVG:util.renderShapesToSVG,snapshotToShapes:conversion.snapshotToShapes,snapshotJSONToShapes:conversion.snapshotJSONToShapes,renderSnapshotToImage:renderSnapshotToImage,renderSnapshotToSVG:renderSnapshotToSVG,localize:localize};},{"./core/LiterallyCanvas":1,"./core/canvasRenderer":5,"./core/defaultOptions":6,"./core/localization":9,"./core/renderSnapshotToImage":11,"./core/renderSnapshotToSVG":12,"./core/shapes":13,"./core/svgRenderer":14,"./core/util":15,"./ie_customevent":16,"./ie_setLineDash":17,"./tools/Ellipse":19,"./tools/Eraser":20,"./tools/Eyedropper":21,"./tools/Line":22,"./tools/Pan":23,"./tools/Pencil":24,"./tools/Polygon":25,"./tools/Rectangle":26,"./tools/SelectShape":27,"./tools/Text":28,"./tools/base":29}],19:[function(require,module,exports){var Ellipse,ToolWithStroke,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ToolWithStroke=require('./base').ToolWithStroke;createShape=require('../core/shapes').createShape;module.exports=Ellipse=(function(superClass){extend(Ellipse,superClass);function Ellipse(){return Ellipse.__super__.constructor.apply(this,arguments);}
Ellipse.prototype.name='Ellipse';Ellipse.prototype.iconName='ellipse';Ellipse.prototype.begin=function(x,y,lc){return this.currentShape=createShape('Ellipse',{x:x,y:y,strokeWidth:this.strokeWidth,strokeColor:lc.getColor('primary'),fillColor:this.fillColor||lc.getColor('secondary'),alpha:this.alpha,originalFillColor:this.originalFillColor});};Ellipse.prototype["continue"]=function(x,y,lc){this.currentShape.width=x-this.currentShape.x;this.currentShape.height=y-this.currentShape.y;return lc.drawShapeInProgress(this.currentShape);};Ellipse.prototype.end=function(x,y,lc){return lc.saveShape(this.currentShape);};Ellipse.prototype.setFillColor=function(bc){return this.fillColor=bc;};Ellipse.prototype.setRectAlpha=function(alpha){return this.alpha=alpha;};Ellipse.prototype.setOriginalFillColor=function(oc){return this.originalFillColor=oc;};return Ellipse;})(ToolWithStroke);},{"../core/shapes":13,"./base":29}],20:[function(require,module,exports){var Eraser,Pencil,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;Pencil=require('./Pencil');createShape=require('../core/shapes').createShape;module.exports=Eraser=(function(superClass){extend(Eraser,superClass);function Eraser(){return Eraser.__super__.constructor.apply(this,arguments);}
Eraser.prototype.name='Eraser';Eraser.prototype.iconName='eraser';Eraser.prototype.makePoint=function(x,y,lc){return createShape('Point',{x:x,y:y,size:this.strokeWidth,color:'#000'});};Eraser.prototype.makeShape=function(){return createShape('ErasedLinePath');};return Eraser;})(Pencil);},{"../core/shapes":13,"./Pencil":24}],21:[function(require,module,exports){var Eyedropper,Tool,getPixel,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;Tool=require('./base').Tool;getPixel=function(ctx,arg){var pixel,x,y;x=arg.x,y=arg.y;pixel=ctx.getImageData(x,y,1,1).data;if(pixel[3]){return "rgb("+pixel[0]+", "+pixel[1]+", "+pixel[2]+")";}else{return null;}};module.exports=Eyedropper=(function(superClass){extend(Eyedropper,superClass);Eyedropper.prototype.name='Eyedropper';Eyedropper.prototype.iconName='eyedropper';Eyedropper.prototype.optionsStyle='stroke-or-fill';function Eyedropper(lc){Eyedropper.__super__.constructor.call(this,lc);this.strokeOrFill='stroke';}
Eyedropper.prototype.readColor=function(x,y,lc){var canvas,color,newColor,offset;offset=lc.getDefaultImageRect();canvas=lc.getImage();newColor=getPixel(canvas.getContext('2d'),{x:x-offset.x,y:y-offset.y});color=newColor||lc.getColor('background');if(this.strokeOrFill==='stroke'){return lc.setColor('primary',newColor);}else{return lc.setColor('secondary',newColor);}};Eyedropper.prototype.begin=function(x,y,lc){return this.readColor(x,y,lc);};Eyedropper.prototype["continue"]=function(x,y,lc){return this.readColor(x,y,lc);};return Eyedropper;})(Tool);},{"./base":29}],22:[function(require,module,exports){var Line,ToolWithStroke,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ToolWithStroke=require('./base').ToolWithStroke;createShape=require('../core/shapes').createShape;module.exports=Line=(function(superClass){extend(Line,superClass);function Line(){return Line.__super__.constructor.apply(this,arguments);}
Line.prototype.name='Line';Line.prototype.iconName='line';Line.prototype.optionsStyle='line-options-and-stroke-width';Line.prototype.begin=function(x,y,lc){return this.currentShape=createShape('Line',{x1:x,y1:y,x2:x,y2:y,strokeWidth:this.strokeWidth,dash:(function(){switch(false){case!this.isDashed:return[this.strokeWidth*2,this.strokeWidth*4];default:return null;}}).call(this),endCapShapes:this.hasEndArrow?[null,'arrow']:null,color:lc.getColor('primary')});};Line.prototype["continue"]=function(x,y,lc){this.currentShape.x2=x;this.currentShape.y2=y;return lc.drawShapeInProgress(this.currentShape);};Line.prototype.end=function(x,y,lc){return lc.saveShape(this.currentShape);};return Line;})(ToolWithStroke);},{"../core/shapes":13,"./base":29}],23:[function(require,module,exports){var Pan,Tool,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;Tool=require('./base').Tool;createShape=require('../core/shapes').createShape;module.exports=Pan=(function(superClass){extend(Pan,superClass);function Pan(){return Pan.__super__.constructor.apply(this,arguments);}
Pan.prototype.name='Pan';Pan.prototype.iconName='pan';Pan.prototype.usesSimpleAPI=false;Pan.prototype.didBecomeActive=function(lc){var unsubscribeFuncs;unsubscribeFuncs=[];this.unsubscribe=(function(_this){return function(){var func,i,len,results;results=[];for(i=0,len=unsubscribeFuncs.length;i<len;i++){func=unsubscribeFuncs[i];results.push(func());}
return results;};})(this);unsubscribeFuncs.push(lc.on('lc-pointerdown',(function(_this){return function(arg){var rawX,rawY;rawX=arg.rawX,rawY=arg.rawY;_this.oldPosition=lc.position;return _this.pointerStart={x:rawX,y:rawY};};})(this)));return unsubscribeFuncs.push(lc.on('lc-pointerdrag',(function(_this){return function(arg){var dp,rawX,rawY;rawX=arg.rawX,rawY=arg.rawY;dp={x:(rawX-_this.pointerStart.x)*lc.backingScale,y:(rawY-_this.pointerStart.y)*lc.backingScale};return lc.setPan(_this.oldPosition.x+dp.x,_this.oldPosition.y+dp.y);};})(this)));};Pan.prototype.willBecomeInactive=function(lc){return this.unsubscribe();};return Pan;})(Tool);},{"../core/shapes":13,"./base":29}],24:[function(require,module,exports){var Pencil,ToolWithStroke,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ToolWithStroke=require('./base').ToolWithStroke;createShape=require('../core/shapes').createShape;module.exports=Pencil=(function(superClass){extend(Pencil,superClass);function Pencil(){return Pencil.__super__.constructor.apply(this,arguments);}
Pencil.prototype.name='Pencil';Pencil.prototype.iconName='pencil';Pencil.prototype.eventTimeThreshold=10;Pencil.prototype.begin=function(x,y,lc){this.color=lc.getColor('primary');this.currentShape=this.makeShape();this.currentShape.addPoint(this.makePoint(x,y,lc));return this.lastEventTime=Date.now();};Pencil.prototype["continue"]=function(x,y,lc){var timeDiff;timeDiff=Date.now()-this.lastEventTime;if(timeDiff>this.eventTimeThreshold){this.lastEventTime+=timeDiff;this.currentShape.addPoint(this.makePoint(x,y,lc));return lc.drawShapeInProgress(this.currentShape);}};Pencil.prototype.end=function(x,y,lc){lc.saveShape(this.currentShape);return this.currentShape=void 0;};Pencil.prototype.makePoint=function(x,y,lc){return createShape('Point',{x:x,y:y,size:this.strokeWidth,color:this.color});};Pencil.prototype.makeShape=function(){return createShape('LinePath');};return Pencil;})(ToolWithStroke);},{"../core/shapes":13,"./base":29}],25:[function(require,module,exports){var Polygon,ToolWithStroke,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ToolWithStroke=require('./base').ToolWithStroke;createShape=require('../core/shapes').createShape;module.exports=Polygon=(function(superClass){extend(Polygon,superClass);function Polygon(){return Polygon.__super__.constructor.apply(this,arguments);}
Polygon.prototype.name='Polygon';Polygon.prototype.iconName='polygon';Polygon.prototype.usesSimpleAPI=false;Polygon.prototype.didBecomeActive=function(lc){var onDown,onMove,onUp,polygonCancel,polygonFinishClosed,polygonFinishOpen,polygonUnsubscribeFuncs;Polygon.__super__.didBecomeActive.call(this,lc);polygonUnsubscribeFuncs=[];this.polygonUnsubscribe=(function(_this){return function(){var func,i,len,results;results=[];for(i=0,len=polygonUnsubscribeFuncs.length;i<len;i++){func=polygonUnsubscribeFuncs[i];results.push(func());}
return results;};})(this);this.points=null;this.maybePoint=null;onUp=(function(_this){return function(){if(_this._getWillFinish()){return _this._close(lc);}
lc.trigger('lc-polygon-started');if(_this.points){_this.points.push(_this.maybePoint);}else{_this.points=[_this.maybePoint];}
_this.maybePoint={x:_this.maybePoint.x,y:_this.maybePoint.y};lc.setShapesInProgress(_this._getShapes(lc));return lc.repaintLayer('main');};})(this);onMove=(function(_this){return function(arg){var x,y;x=arg.x,y=arg.y;if(_this.maybePoint){_this.maybePoint.x=x;_this.maybePoint.y=y;lc.setShapesInProgress(_this._getShapes(lc));return lc.repaintLayer('main');}};})(this);onDown=(function(_this){return function(arg){var x,y;x=arg.x,y=arg.y;_this.maybePoint={x:x,y:y};lc.setShapesInProgress(_this._getShapes(lc));return lc.repaintLayer('main');};})(this);polygonFinishOpen=(function(_this){return function(){_this.maybePoint={x:Infinity,y:Infinity};return _this._close(lc);};})(this);polygonFinishClosed=(function(_this){return function(){_this.maybePoint=_this.points[0];return _this._close(lc);};})(this);polygonCancel=(function(_this){return function(){return _this._cancel(lc);};})(this);polygonUnsubscribeFuncs.push(lc.on('drawingChange',(function(_this){return function(){return _this._cancel(lc);};})(this)));polygonUnsubscribeFuncs.push(lc.on('lc-pointerdown',onDown));polygonUnsubscribeFuncs.push(lc.on('lc-pointerdrag',onMove));polygonUnsubscribeFuncs.push(lc.on('lc-pointermove',onMove));polygonUnsubscribeFuncs.push(lc.on('lc-pointerup',onUp));polygonUnsubscribeFuncs.push(lc.on('lc-polygon-finishopen',polygonFinishOpen));polygonUnsubscribeFuncs.push(lc.on('lc-polygon-finishclosed',polygonFinishClosed));return polygonUnsubscribeFuncs.push(lc.on('lc-polygon-cancel',polygonCancel));};Polygon.prototype.willBecomeInactive=function(lc){Polygon.__super__.willBecomeInactive.call(this,lc);if(this.points||this.maybePoint){this._cancel(lc);}
return this.polygonUnsubscribe();};Polygon.prototype._getArePointsClose=function(a,b){return(Math.abs(a.x-b.x)+Math.abs(a.y-b.y))<10;};Polygon.prototype._getWillClose=function(){if(!(this.points&&this.points.length>1)){return false;}
if(!this.maybePoint){return false;}
return this._getArePointsClose(this.points[0],this.maybePoint);};Polygon.prototype._getWillFinish=function(){if(!(this.points&&this.points.length>1)){return false;}
if(!this.maybePoint){return false;}
return this._getArePointsClose(this.points[0],this.maybePoint)||this._getArePointsClose(this.points[this.points.length-1],this.maybePoint);};Polygon.prototype._cancel=function(lc){lc.trigger('lc-polygon-stopped');this.maybePoint=null;this.points=null;lc.setShapesInProgress([]);return lc.repaintLayer('main');};Polygon.prototype._close=function(lc){lc.trigger('lc-polygon-stopped');lc.setShapesInProgress([]);if(this.points.length>2){lc.saveShape(this._getShape(lc,false));}
this.maybePoint=null;return this.points=null;};Polygon.prototype._getShapes=function(lc,isInProgress){var shape;if(isInProgress==null){isInProgress=true;}
shape=this._getShape(lc,isInProgress);if(shape){return[shape];}else{return[];}};Polygon.prototype._getShape=function(lc,isInProgress){var points;if(isInProgress==null){isInProgress=true;}
points=[];if(this.points){points=points.concat(this.points);}
if((!isInProgress)&&points.length<3){return null;}
if(isInProgress&&this.maybePoint){points.push(this.maybePoint);}
if(points.length>1){return createShape('Polygon',{isClosed:this._getWillClose(),strokeColor:lc.getColor('primary'),fillColor:this.fillColor||lc.getColor('secondary'),originalFillColor:this.originalFillColor,alpha:this.alpha,strokeWidth:this.strokeWidth,points:points.map(function(xy){return createShape('Point',xy);})});}else{return null;}};Polygon.prototype.setOriginalFillColor=function(oc){return this.originalFillColor=oc;};Polygon.prototype.setFillColor=function(bc){return this.fillColor=bc;};Polygon.prototype.setRectAlpha=function(alpha){return this.alpha=alpha;};Polygon.prototype.optionsStyle='polygon-and-stroke-width';return Polygon;})(ToolWithStroke);},{"../core/shapes":13,"./base":29}],26:[function(require,module,exports){var Rectangle,ToolWithStroke,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;ToolWithStroke=require('./base').ToolWithStroke;createShape=require('../core/shapes').createShape;module.exports=Rectangle=(function(superClass){extend(Rectangle,superClass);function Rectangle(){return Rectangle.__super__.constructor.apply(this,arguments);}
Rectangle.prototype.name='Rectangle';Rectangle.prototype.iconName='rectangle';Rectangle.prototype.begin=function(x,y,lc){return this.currentShape=createShape('Rectangle',{x:x,y:y,strokeWidth:this.strokeWidth,strokeColor:this.strokeColor||lc.getColor('primary'),fillColor:this.fillColor||lc.getColor('secondary'),isWhiteout:this.isWhiteout,originalFillColor:this.originalFillColor,rectcopy:this.rectcopy,rectAlpha:this.rectAlpha,setHighliter:this.setHighliter});};Rectangle.prototype["continue"]=function(x,y,lc){this.currentShape.width=x-this.currentShape.x;this.currentShape.height=y-this.currentShape.y;return lc.drawShapeInProgress(this.currentShape);};Rectangle.prototype.end=function(x,y,lc){if(this.currentShape.isWhiteout===true){this.currentShape.strokeColor='transparent';}
return lc.saveShape(this.currentShape);};Rectangle.prototype.setOriginalFillColor=function(oc){return this.originalFillColor=oc;};Rectangle.prototype.setFillColor=function(bc){return this.fillColor=bc;};Rectangle.prototype.setRectCopy=function(rc){return this.rectcopy=rc;};Rectangle.prototype.setRectAlpha=function(alpha){return this.rectAlpha=alpha;};return Rectangle;})(ToolWithStroke);},{"../core/shapes":13,"./base":29}],27:[function(require,module,exports){var SelectShape,Tool,createShape,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;Tool=require('./base').Tool;createShape=require('../core/shapes').createShape;module.exports=SelectShape=(function(superClass){extend(SelectShape,superClass);SelectShape.prototype.name='SelectShape';SelectShape.prototype.usesSimpleAPI=false;function SelectShape(lc){this.selectCanvas=document.createElement('canvas');this.selectCanvas.style['background-color']='transparent';this.selectCtx=this.selectCanvas.getContext('2d');}
SelectShape.prototype.didBecomeActive=function(lc){var onDown,onDrag,onUp,selectShapeUnsubscribeFuncs;selectShapeUnsubscribeFuncs=[];this._selectShapeUnsubscribe=(function(_this){return function(){var func,j,len,results;results=[];for(j=0,len=selectShapeUnsubscribeFuncs.length;j<len;j++){func=selectShapeUnsubscribeFuncs[j];results.push(func());}
return results;};})(this);onDown=(function(_this){return function(arg){var br,shapeIndex,x,y;x=arg.x,y=arg.y;_this.didDrag=false;shapeIndex=_this._getPixel(x,y,lc,_this.selectCtx);_this.selectedShape=lc.shapes[shapeIndex];if(_this.selectedShape!=null){lc.trigger('shapeSelected',{selectedShape:_this.selectedShape});lc.setShapesInProgress([_this.selectedShape,createShape('SelectionBox',{shape:_this.selectedShape,handleSize:0})]);lc.repaintLayer('main');br=_this.selectedShape.getBoundingRect();return _this.dragOffset={x:x-br.x,y:y-br.y};}};})(this);onDrag=(function(_this){return function(arg){var x,y;x=arg.x,y=arg.y;if(_this.selectedShape!=null){_this.didDrag=true;_this.selectedShape.setUpperLeft({x:x-_this.dragOffset.x,y:y-_this.dragOffset.y});lc.setShapesInProgress([_this.selectedShape,createShape('SelectionBox',{shape:_this.selectedShape,handleSize:0})]);return lc.repaintLayer('main');}};})(this);onUp=(function(_this){return function(arg){var x,y;x=arg.x,y=arg.y;if(_this.didDrag){_this.didDrag=false;lc.trigger('shapeMoved',{shape:_this.selectedShape});lc.trigger('drawingChange',{});lc.repaintLayer('main');return _this._drawSelectCanvas(lc);}};})(this);selectShapeUnsubscribeFuncs.push(lc.on('lc-pointerdown',onDown));selectShapeUnsubscribeFuncs.push(lc.on('lc-pointerdrag',onDrag));selectShapeUnsubscribeFuncs.push(lc.on('lc-pointerup',onUp));return this._drawSelectCanvas(lc);};SelectShape.prototype.willBecomeInactive=function(lc){this._selectShapeUnsubscribe();return lc.setShapesInProgress([]);};SelectShape.prototype._drawSelectCanvas=function(lc){var shapes;this.selectCanvas.width=lc.canvas.width;this.selectCanvas.height=lc.canvas.height;this.selectCtx.clearRect(0,0,this.selectCanvas.width,this.selectCanvas.height);shapes=lc.shapes.map((function(_this){return function(shape,index){return createShape('SelectionBox',{shape:shape,handleSize:0,backgroundColor:"#"+(_this._intToHex(index))});};})(this));return lc.draw(shapes,this.selectCtx);};SelectShape.prototype._intToHex=function(i){return("000000"+(i.toString(16))).slice(-6);};SelectShape.prototype._getPixel=function(x,y,lc,ctx){var p,pixel;p=lc.drawingCoordsToClientCoords(x,y);pixel=ctx.getImageData(p.x,p.y,1,1).data;if(pixel[3]){return parseInt(this._rgbToHex(pixel[0],pixel[1],pixel[2]),16);}else{return null;}};SelectShape.prototype._componentToHex=function(c){var hex;hex=c.toString(16);return("0"+hex).slice(-2);};SelectShape.prototype._rgbToHex=function(r,g,b){return ""+(this._componentToHex(r))+(this._componentToHex(g))+(this._componentToHex(b));};return SelectShape;})(Tool);},{"../core/shapes":13,"./base":29}],28:[function(require,module,exports){var Text,Tool,createShape,getIsPointInBox,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;Tool=require('./base').Tool;createShape=require('../core/shapes').createShape;getIsPointInBox=function(point,box){if(point.x<box.x){return false;}
if(point.y<box.y){return false;}
if(point.x>box.x+box.width){return false;}
if(point.y>box.y+box.height){return false;}
return true;};module.exports=Text=(function(superClass){extend(Text,superClass);Text.prototype.name='Text';Text.prototype.iconName='text';function Text(){this.text='';this.font='bold 18px sans-serif';this.currentShape=null;this.currentShapeState=null;this.initialShapeBoundingRect=null;this.dragAction=null;this.didDrag=false;}
Text.prototype.didBecomeActive=function(lc){var switchAway,unsubscribeFuncs,updateInputEl;unsubscribeFuncs=[];this.unsubscribe=(function(_this){return function(){var func,i,len,results;results=[];for(i=0,len=unsubscribeFuncs.length;i<len;i++){func=unsubscribeFuncs[i];results.push(func());}
return results;};})(this);switchAway=(function(_this){return function(){_this._ensureNotEditing(lc);_this._clearCurrentShape(lc);return lc.repaintLayer('main');};})(this);updateInputEl=(function(_this){return function(){return _this._updateInputEl(lc);};})(this);unsubscribeFuncs.push(lc.on('drawingChange',switchAway));unsubscribeFuncs.push(lc.on('zoom',updateInputEl));unsubscribeFuncs.push(lc.on('imageSizeChange',updateInputEl));unsubscribeFuncs.push(lc.on('snapshotLoad',(function(_this){return function(){_this._clearCurrentShape(lc);return lc.repaintLayer('main');};})(this)));unsubscribeFuncs.push(lc.on('primaryColorChange',(function(_this){return function(newColor){if(!_this.currentShape){return;}
_this.currentShape.color=newColor;_this._updateInputEl(lc);return lc.repaintLayer('main');};})(this)));return unsubscribeFuncs.push(lc.on('setFont',(function(_this){return function(font){if(!_this.currentShape){return;}
_this.font=font;_this.currentShape.setFont(font);_this._setShapesInProgress(lc);_this._updateInputEl(lc);return lc.repaintLayer('main');};})(this)));};Text.prototype.willBecomeInactive=function(lc){if(this.currentShape){this._ensureNotEditing(lc);this.commit(lc);}
return this.unsubscribe();};Text.prototype.setText=function(text){return this.text=text;};Text.prototype._ensureNotEditing=function(lc){if(this.currentShapeState==='editing'){return this._exitEditingState(lc);}};Text.prototype._clearCurrentShape=function(lc){this.currentShape=null;this.initialShapeBoundingRect=null;this.currentShapeState=null;return lc.setShapesInProgress([]);};Text.prototype.commit=function(lc){if(this.currentShape.text){lc.saveShape(this.currentShape);}
this._clearCurrentShape(lc);return lc.repaintLayer('main');};Text.prototype._getSelectionShape=function(ctx,backgroundColor){if(backgroundColor==null){backgroundColor=null;}
return createShape('SelectionBox',{shape:this.currentShape,ctx:ctx,backgroundColor:backgroundColor});};Text.prototype._setShapesInProgress=function(lc){switch(this.currentShapeState){case 'selected':return lc.setShapesInProgress([this._getSelectionShape(lc.ctx),this.currentShape]);case 'editing':return lc.setShapesInProgress([this._getSelectionShape(lc.ctx,'#fff')]);default:return lc.setShapesInProgress([this.currentShape]);}};Text.prototype.begin=function(x,y,lc){var br,point,selectionBox,selectionShape;this.dragAction='none';this.didDrag=false;if(this.currentShapeState==='selected'||this.currentShapeState==='editing'){br=this.currentShape.getBoundingRect(lc.ctx);selectionShape=this._getSelectionShape(lc.ctx);selectionBox=selectionShape.getBoundingRect();point={x:x,y:y};if(getIsPointInBox(point,br)){this.dragAction='move';}
if(getIsPointInBox(point,selectionShape.getBottomRightHandleRect())){this.dragAction='resizeBottomRight';}
if(getIsPointInBox(point,selectionShape.getTopLeftHandleRect())){this.dragAction='resizeTopLeft';}
if(getIsPointInBox(point,selectionShape.getBottomLeftHandleRect())){this.dragAction='resizeBottomLeft';}
if(getIsPointInBox(point,selectionShape.getTopRightHandleRect())){this.dragAction='resizeTopRight';}
if(this.dragAction==='none'&&this.currentShapeState==='editing'){this.dragAction='stop-editing';this._exitEditingState(lc);}}else{this.color=lc.getColor('primary');this.currentShape=createShape('Text',{x:x,y:y,text:this.text,color:this.color,font:this.font,fontItalic:this.fontItalic,fontBold:this.fontBold,fontSize:this.fontSize,fontType:this.fontType,v:1});this.dragAction='place';this.currentShapeState='selected';}
if(this.dragAction==='none'){this.commit(lc);return;}
this.initialShapeBoundingRect=this.currentShape.getBoundingRect(lc.ctx);this.dragOffset={x:x-this.initialShapeBoundingRect.x,y:y-this.initialShapeBoundingRect.y};this._setShapesInProgress(lc);return lc.repaintLayer('main');};Text.prototype["continue"]=function(x,y,lc){var br,brBottom,brRight;if(this.dragAction==='none'){return;}
br=this.initialShapeBoundingRect;if(typeof br!=='undefined'&&br!=null){brRight=br.x+br.width;brBottom=br.y+br.height;switch(this.dragAction){case 'place':this.currentShape.x=x;this.currentShape.y=y;this.didDrag=true;break;case 'move':this.currentShape.x=x-this.dragOffset.x;this.currentShape.y=y-this.dragOffset.y;this.didDrag=true;break;case 'resizeBottomRight':this.currentShape.setSize(x-(this.dragOffset.x-this.initialShapeBoundingRect.width)-br.x,y-(this.dragOffset.y-this.initialShapeBoundingRect.height)-br.y);break;case 'resizeTopLeft':this.currentShape.setSize(brRight-x+this.dragOffset.x,brBottom-y+this.dragOffset.y);this.currentShape.setPosition(x-this.dragOffset.x,y-this.dragOffset.y);break;case 'resizeBottomLeft':this.currentShape.setSize(brRight-x+this.dragOffset.x,y-(this.dragOffset.y-this.initialShapeBoundingRect.height)-br.y);this.currentShape.setPosition(x-this.dragOffset.x,this.currentShape.y);break;case 'resizeTopRight':this.currentShape.setSize(x-(this.dragOffset.x-this.initialShapeBoundingRect.width)-br.x,brBottom-y+this.dragOffset.y);this.currentShape.setPosition(this.currentShape.x,y-this.dragOffset.y);}}
this._setShapesInProgress(lc);lc.repaintLayer('main');return this._updateInputEl(lc);};Text.prototype.end=function(x,y,lc){if(!this.currentShape){return;}
this.currentShape.setSize(this.currentShape.forcedWidth,0);if(this.currentShapeState==='selected'){if(this.dragAction==='place'||(this.dragAction==='move'&&!this.didDrag)){this._enterEditingState(lc);}}
this._setShapesInProgress(lc);lc.repaintLayer('main');return this._updateInputEl(lc);};Text.prototype._enterEditingState=function(lc){var onChange;this.currentShapeState='editing';if(this.inputEl){throw "State error";}
this.inputEl=document.createElement('textarea');this.inputEl.className='text-tool-input';this.inputEl.name="canvasTextArea";this.inputEl.id="canvasTextArea";this.inputEl.style.position='absolute';this.inputEl.style.transformOrigin='0px 0px';this.inputEl.style.backgroundColor='transparent';this.inputEl.style.border='none';this.inputEl.style.outline='none';this.inputEl.style.margin='0';this.inputEl.style.padding='4px';this.inputEl.style.zIndex='1000';this.inputEl.style.overflow='hidden';this.inputEl.style.resize='none';this.inputEl.value=this.currentShape.text;this.inputEl.addEventListener('mousedown',function(e){return e.stopPropagation();});this.inputEl.addEventListener('touchstart',function(e){return e.stopPropagation();});onChange=(function(_this){return function(e){_this.currentShape.setText(e.target.value);_this.currentShape.enforceMaxBoundingRect(lc);_this._setShapesInProgress(lc);lc.repaintLayer('main');_this._updateInputEl(lc);return e.stopPropagation();};})(this);this.inputEl.addEventListener('keydown',(function(_this){return function(){return _this._updateInputEl(lc,true);};})(this));this.inputEl.addEventListener('keyup',onChange);this.inputEl.addEventListener('change',onChange);this._updateInputEl(lc);lc.containerEl.appendChild(this.inputEl);this.inputEl.focus();return this._setShapesInProgress(lc);};Text.prototype._exitEditingState=function(lc){this.currentShapeState='selected';lc.containerEl.removeChild(this.inputEl);this.inputEl=null;this._setShapesInProgress(lc);return lc.repaintLayer('main');};Text.prototype._updateInputEl=function(lc,withMargin){var br,transformString;if(withMargin==null){withMargin=false;}
if(!this.inputEl){return;}
br=this.currentShape.getBoundingRect(lc.ctx,true);this.inputEl.style.font=this.currentShape.font.replace('underline ','').replace('line-through ','').replace('none ','');this.inputEl.style.textDecoration=this.currentShape.font.split(' ')[4];this.inputEl.style.color=this.currentShape.color;this.inputEl.style.left=(lc.position.x/lc.backingScale+br.x*lc.scale-4)+"px";this.inputEl.style.top=(lc.position.y/lc.backingScale+br.y*lc.scale-4)+"px";if(withMargin&&!this.currentShape.forcedWidth){this.inputEl.style.width=(br.width+10+this.currentShape.renderer.emDashWidth)+"px";}else{this.inputEl.style.width=(br.width+12)+"px";}
if(withMargin){this.inputEl.style.height=(br.height+10+this.currentShape.renderer.metrics.leading)+"px";}else{this.inputEl.style.height=(br.height+10)+"px";}
transformString="scale("+lc.scale+")";this.inputEl.style.transform=transformString;this.inputEl.style.webkitTransform=transformString;this.inputEl.style.MozTransform=transformString;this.inputEl.style.msTransform=transformString;return this.inputEl.style.OTransform=transformString;};Text.prototype.optionsStyle='font';return Text;})(Tool);},{"../core/shapes":13,"./base":29}],29:[function(require,module,exports){var Tool,ToolWithStroke,tools,extend=function(child,parent){for(var key in parent){if(hasProp.call(parent,key))child[key]=parent[key];}function ctor(){this.constructor=child;}ctor.prototype=parent.prototype;child.prototype=new ctor();child.__super__=parent.prototype;return child;},hasProp={}.hasOwnProperty;tools={};tools.Tool=Tool=(function(){function Tool(){}
Tool.prototype.name=null;Tool.prototype.iconName=null;Tool.prototype.usesSimpleAPI=true;Tool.prototype.begin=function(x,y,lc){};Tool.prototype["continue"]=function(x,y,lc){};Tool.prototype.end=function(x,y,lc){};Tool.prototype.optionsStyle=null;Tool.prototype.didBecomeActive=function(lc){};Tool.prototype.willBecomeInactive=function(lc){};return Tool;})();tools.ToolWithStroke=ToolWithStroke=(function(superClass){extend(ToolWithStroke,superClass);function ToolWithStroke(lc){this.strokeWidth=lc.opts.defaultStrokeWidth;}
ToolWithStroke.prototype.optionsStyle='stroke-width';ToolWithStroke.prototype.didBecomeActive=function(lc){var unsubscribeFuncs;unsubscribeFuncs=[];this.unsubscribe=(function(_this){return function(){var func,i,len,results;results=[];for(i=0,len=unsubscribeFuncs.length;i<len;i++){func=unsubscribeFuncs[i];results.push(func());}
return results;};})(this);return unsubscribeFuncs.push(lc.on('setStrokeWidth',(function(_this){return function(strokeWidth){_this.strokeWidth=strokeWidth;return lc.trigger('toolDidUpdateOptions');};})(this)));};ToolWithStroke.prototype.willBecomeInactive=function(lc){return this.unsubscribe();};return ToolWithStroke;})(Tool);module.exports=tools;},{}]},{},[18])(18)});var escapeXml=(function(xmlString){return xmlString.replace(/[<>&'"]/g,function(c){switch(c){case '<':return '&lt;';case '>':return '&gt;';case '&':return '&amp;';case '\'':return '&apos;';case '"':return '&quot;';}});});;(function(factory){"use strict";if(typeof define==='function'&&define.amd){define(['jquery'],factory);}
else if(typeof exports=="object"&&typeof module=="object"){module.exports=factory(require('jquery'));}
else{factory(jQuery);}})(function($,undefined){"use strict";var defaultOpts={beforeShow:noop,move:noop,change:noop,show:noop,hide:noop,color:false,flat:false,showInput:false,allowEmpty:false,showButtons:true,clickoutFiresChange:true,showInitial:false,showPalette:false,showPaletteOnly:false,hideAfterPaletteSelect:false,togglePaletteOnly:false,showSelectionPalette:true,localStorageKey:false,appendTo:"body",maxSelectionSize:7,cancelText:"cancel",chooseText:"choose",togglePaletteMoreText:"more",togglePaletteLessText:"less",clearText:"Clear Color Selection",noColorSelectedText:"No Color Selected",preferredFormat:false,className:"",containerClassName:"",replacerClassName:"",showAlpha:false,theme:"sp-light",palette:[["#ffffff","#000000","#ff0000","#ff8000","#ffff00","#008000","#0000ff","#4b0082","#9400d3"]],selectionPalette:[],disabled:false,offset:null},spectrums=[],IE=!!/msie/i.exec(window.navigator.userAgent),rgbaSupport=(function(){function contains(str,substr){return!!~(''+str).indexOf(substr);}
var elem=document.createElement('div');var style=elem.style;style.cssText='background-color:rgba(0,0,0,.5)';return contains(style.backgroundColor,'rgba')||contains(style.backgroundColor,'hsla');})(),replaceInput=["<div class='sp-replacer'>","<div class='sp-preview'><div class='sp-preview-inner'></div></div>","<div class='sp-dd'>&#9660;</div>","</div>"].join(''),markup=(function(){var gradientFix="";if(IE){for(var i=1;i<=6;i++){gradientFix+="<div class='sp-"+i+"'></div>";}}
return["<div class='sp-container sp-hidden'>","<div class='sp-palette-container'>","<div class='sp-palette sp-thumb sp-cf'></div>","<div class='sp-palette-button-container sp-cf'>","<button type='button' class='sp-palette-toggle'></button>","</div>","</div>","<div class='sp-picker-container'>","<div class='sp-top sp-cf'>","<div class='sp-fill'></div>","<div class='sp-top-inner'>","<div class='sp-color'>","<div class='sp-sat'>","<div class='sp-val'>","<div class='sp-dragger'></div>","</div>","</div>","</div>","<div class='sp-clear sp-clear-display'>","</div>","<div class='sp-hue'>","<div class='sp-slider'></div>",gradientFix,"</div>","</div>","<div class='sp-alpha'><div class='sp-alpha-inner'><div class='sp-alpha-handle'></div></div></div>","</div>","<div class='sp-input-container sp-cf'>","<input class='sp-input' type='text' spellcheck='false'  />","</div>","<div class='sp-initial sp-thumb sp-cf'></div>","<div class='sp-button-container sp-cf'>","<a class='sp-cancel' href='#'></a>","<button type='button' class='sp-choose'></button>","</div>","</div>","</div>"].join("");})();function paletteTemplate(p,color,className,opts){var html=[];for(var i=0;i<p.length;i++){var current=p[i];if(current){var tiny=tinycolor(current);var c=tiny.toHsl().l<0.5?"sp-thumb-el sp-thumb-dark":"sp-thumb-el sp-thumb-light";c+=(tinycolor.equals(color,current))?" sp-thumb-active":"";var formattedString=tiny.toString(opts.preferredFormat||"rgb");var swatchStyle=rgbaSupport?("background-color:"+tiny.toRgbString()):"filter:"+tiny.toFilter();html.push('<span title="'+formattedString+'" data-color="'+tiny.toRgbString()+'" class="'+c+'"><span class="sp-thumb-inner" style="'+swatchStyle+';" /></span>');}else{var cls='sp-clear-display';html.push($('<div />').append($('<span data-color="" style="background-color:transparent;" class="'+cls+'"></span>').attr('title',opts.noColorSelectedText)).html());}}
return "<div class='sp-cf "+className+"'>"+html.join('')+"</div>";}
function hideAll(){for(var i=0;i<spectrums.length;i++){if(spectrums[i]){spectrums[i].hide();}}}
function instanceOptions(o,callbackContext){var opts=$.extend({},defaultOpts,o);opts.callbacks={'move':bind(opts.move,callbackContext),'change':bind(opts.change,callbackContext),'show':bind(opts.show,callbackContext),'hide':bind(opts.hide,callbackContext),'beforeShow':bind(opts.beforeShow,callbackContext)};return opts;}
function spectrum(element,o){var opts=instanceOptions(o,element),flat=opts.flat,showSelectionPalette=opts.showSelectionPalette,localStorageKey=opts.localStorageKey,theme=opts.theme,callbacks=opts.callbacks,resize=throttle(reflow,10),visible=false,isDragging=false,dragWidth=0,dragHeight=0,dragHelperHeight=0,slideHeight=0,slideWidth=0,alphaWidth=0,alphaSlideHelperWidth=0,slideHelperHeight=0,currentHue=0,currentSaturation=0,currentValue=0,currentAlpha=1,palette=[],paletteArray=[],paletteLookup={},selectionPalette=opts.selectionPalette.slice(0),maxSelectionSize=opts.maxSelectionSize,draggingClass="sp-dragging",shiftMovementDirection=null;var doc=element.ownerDocument,body=doc.body,boundElement=$(element),disabled=false,container=$(markup,doc).addClass(theme),pickerContainer=container.find(".sp-picker-container"),dragger=container.find(".sp-color"),dragHelper=container.find(".sp-dragger"),slider=container.find(".sp-hue"),slideHelper=container.find(".sp-slider"),alphaSliderInner=container.find(".sp-alpha-inner"),alphaSlider=container.find(".sp-alpha"),alphaSlideHelper=container.find(".sp-alpha-handle"),textInput=container.find(".sp-input"),paletteContainer=container.find(".sp-palette"),initialColorContainer=container.find(".sp-initial"),cancelButton=container.find(".sp-cancel"),clearButton=container.find(".sp-clear"),chooseButton=container.find(".sp-choose"),toggleButton=container.find(".sp-palette-toggle"),isInput=boundElement.is("input"),isInputTypeColor=isInput&&boundElement.attr("type")==="color"&&inputTypeColorSupport(),shouldReplace=isInput&&!flat,replacer=(shouldReplace)?$(replaceInput).addClass(theme).addClass(opts.className).addClass(opts.replacerClassName):$([]),offsetElement=(shouldReplace)?replacer:boundElement,previewElement=replacer.find(".sp-preview-inner"),initialColor=opts.color||(isInput&&boundElement.val()),colorOnShow=false,currentPreferredFormat=opts.preferredFormat,clickoutFiresChange=!opts.showButtons||opts.clickoutFiresChange,isEmpty=!initialColor,allowEmpty=opts.allowEmpty&&!isInputTypeColor;function applyOptions(){if(opts.showPaletteOnly){opts.showPalette=true;}
toggleButton.text(opts.showPaletteOnly?opts.togglePaletteMoreText:opts.togglePaletteLessText);if(opts.palette){palette=opts.palette.slice(0);paletteArray=$.isArray(palette[0])?palette:[palette];paletteLookup={};for(var i=0;i<paletteArray.length;i++){for(var j=0;j<paletteArray[i].length;j++){var rgb=tinycolor(paletteArray[i][j]).toRgbString();paletteLookup[rgb]=true;}}}
container.toggleClass("sp-flat",flat);container.toggleClass("sp-input-disabled",!opts.showInput);container.toggleClass("sp-alpha-enabled",opts.showAlpha);container.toggleClass("sp-clear-enabled",allowEmpty);container.toggleClass("sp-buttons-disabled",!opts.showButtons);container.toggleClass("sp-palette-buttons-disabled",!opts.togglePaletteOnly);container.toggleClass("sp-palette-disabled",!opts.showPalette);container.toggleClass("sp-palette-only",opts.showPaletteOnly);container.toggleClass("sp-initial-disabled",!opts.showInitial);container.addClass(opts.className).addClass(opts.containerClassName);reflow();}
function initialize(){if(IE){container.find("*:not(input)").attr("unselectable","on");}
applyOptions();if(shouldReplace){boundElement.after(replacer).hide();}
if(!allowEmpty){clearButton.hide();}
if(flat){boundElement.after(container).hide();}
else{var appendTo=opts.appendTo==="parent"?boundElement.parent():$(opts.appendTo);if(appendTo.length!==1){appendTo=$("body");}
appendTo.append(container);}
updateSelectionPaletteFromStorage();offsetElement.bind("click.spectrum touchstart.spectrum",function(e){if(!disabled){toggle();}
e.stopPropagation();if(!$(e.target).is("input")){e.preventDefault();}});if(boundElement.is(":disabled")||(opts.disabled===true)){disable();}
container.click(stopPropagation);textInput.change(setFromTextInput);textInput.bind("paste",function(){setTimeout(setFromTextInput,1);});textInput.keydown(function(e){if(e.keyCode==13){setFromTextInput();}});cancelButton.text(opts.cancelText);cancelButton.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();revert();hide();});clearButton.attr("title",opts.clearText);clearButton.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();isEmpty=true;move();if(flat){updateOriginalInput(true);}});chooseButton.text(opts.chooseText);chooseButton.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();if(IE&&textInput.is(":focus")){textInput.trigger('change');}
if(isValid()){updateOriginalInput(true);hide();}});toggleButton.text(opts.showPaletteOnly?opts.togglePaletteMoreText:opts.togglePaletteLessText);toggleButton.bind("click.spectrum",function(e){e.stopPropagation();e.preventDefault();opts.showPaletteOnly=!opts.showPaletteOnly;if(!opts.showPaletteOnly&&!flat){container.css('left','-='+(pickerContainer.outerWidth(true)+5));}
applyOptions();});draggable(alphaSlider,function(dragX,dragY,e){currentAlpha=(dragX/alphaWidth);isEmpty=false;if(e.shiftKey){currentAlpha=Math.round(currentAlpha*10)/10;}
move();},dragStart,dragStop);draggable(slider,function(dragX,dragY){currentHue=parseFloat(dragY/slideHeight);isEmpty=false;if(!opts.showAlpha){currentAlpha=1;}
move();},dragStart,dragStop);draggable(dragger,function(dragX,dragY,e){if(!e.shiftKey){shiftMovementDirection=null;}
else if(!shiftMovementDirection){var oldDragX=currentSaturation*dragWidth;var oldDragY=dragHeight-(currentValue*dragHeight);var furtherFromX=Math.abs(dragX-oldDragX)>Math.abs(dragY-oldDragY);shiftMovementDirection=furtherFromX?"x":"y";}
var setSaturation=!shiftMovementDirection||shiftMovementDirection==="x";var setValue=!shiftMovementDirection||shiftMovementDirection==="y";if(setSaturation){currentSaturation=parseFloat(dragX/dragWidth);}
if(setValue){currentValue=parseFloat((dragHeight-dragY)/dragHeight);}
isEmpty=false;if(!opts.showAlpha){currentAlpha=1;}
move();},dragStart,dragStop);if(!!initialColor){set(initialColor);updateUI();currentPreferredFormat=opts.preferredFormat||tinycolor(initialColor).format;addColorToSelectionPalette(initialColor);}
else{updateUI();}
if(flat){show();}
function paletteElementClick(e){if(e.data&&e.data.ignore){set($(e.target).closest(".sp-thumb-el").data("color"));move();}
else{set($(e.target).closest(".sp-thumb-el").data("color"));move();updateOriginalInput(true);if(opts.hideAfterPaletteSelect){hide();}}
return false;}
var paletteEvent=IE?"mousedown.spectrum":"click.spectrum touchstart.spectrum";paletteContainer.delegate(".sp-thumb-el",paletteEvent,paletteElementClick);initialColorContainer.delegate(".sp-thumb-el:nth-child(1)",paletteEvent,{ignore:true},paletteElementClick);}
function updateSelectionPaletteFromStorage(){if(localStorageKey&&window.localStorage){try{var oldPalette=window.localStorage[localStorageKey].split(",#");if(oldPalette.length>1){delete window.localStorage[localStorageKey];$.each(oldPalette,function(i,c){addColorToSelectionPalette(c);});}}
catch(e){}
try{selectionPalette=window.localStorage[localStorageKey].split(";");}
catch(e){}}}
function addColorToSelectionPalette(color){if(showSelectionPalette){var rgb=tinycolor(color).toRgbString();if(!paletteLookup[rgb]&&$.inArray(rgb,selectionPalette)===-1){selectionPalette.push(rgb);while(selectionPalette.length>maxSelectionSize){selectionPalette.shift();}}
if(localStorageKey&&window.localStorage){try{window.localStorage[localStorageKey]=selectionPalette.join(";");}
catch(e){}}}}
function getUniqueSelectionPalette(){var unique=[];if(opts.showPalette){for(var i=0;i<selectionPalette.length;i++){var rgb=tinycolor(selectionPalette[i]).toRgbString();if(!paletteLookup[rgb]){unique.push(selectionPalette[i]);}}}
return unique.reverse().slice(0,opts.maxSelectionSize);}
function drawPalette(){var currentColor=get();var html=$.map(paletteArray,function(palette,i){return paletteTemplate(palette,currentColor,"sp-palette-row sp-palette-row-"+i,opts);});updateSelectionPaletteFromStorage();if(selectionPalette){html.push(paletteTemplate(getUniqueSelectionPalette(),currentColor,"sp-palette-row sp-palette-row-selection",opts));}
paletteContainer.html(html.join(""));}
function drawInitial(){if(opts.showInitial){var initial=colorOnShow;var current=get();initialColorContainer.html(paletteTemplate([initial,current],current,"sp-palette-row-initial",opts));}}
function dragStart(){if(dragHeight<=0||dragWidth<=0||slideHeight<=0){reflow();}
isDragging=true;container.addClass(draggingClass);shiftMovementDirection=null;boundElement.trigger('dragstart.spectrum',[get()]);}
function dragStop(){isDragging=false;container.removeClass(draggingClass);boundElement.trigger('dragstop.spectrum',[get()]);}
function setFromTextInput(){var value=textInput.val();if((value===null||value==="")&&allowEmpty){set(null);updateOriginalInput(true);}
else{var tiny=tinycolor(value);if(tiny.isValid()){set(tiny);updateOriginalInput(true);}
else{textInput.addClass("sp-validation-error");}}}
function toggle(){if(visible){hide();}
else{show();}}
function show(){var event=$.Event('beforeShow.spectrum');if(visible){reflow();return;}
boundElement.trigger(event,[get()]);if(callbacks.beforeShow(get())===false||event.isDefaultPrevented()){return;}
hideAll();visible=true;$(doc).bind("keydown.spectrum",onkeydown);$(doc).bind("click.spectrum",clickout);$(window).bind("resize.spectrum",resize);replacer.addClass("sp-active");container.removeClass("sp-hidden");reflow();updateUI();colorOnShow=get();drawInitial();callbacks.show(colorOnShow);boundElement.trigger('show.spectrum',[colorOnShow]);}
function onkeydown(e){if(e.keyCode===27){hide();}}
function clickout(e){if(e.button==2){return;}
if(isDragging){return;}
if(clickoutFiresChange){updateOriginalInput(true);}
else{revert();}
hide();}
function hide(){if(!visible||flat){return;}
visible=false;$(doc).unbind("keydown.spectrum",onkeydown);$(doc).unbind("click.spectrum",clickout);$(window).unbind("resize.spectrum",resize);replacer.removeClass("sp-active");container.addClass("sp-hidden");callbacks.hide(get());boundElement.trigger('hide.spectrum',[get()]);}
function revert(){set(colorOnShow,true);}
function set(color,ignoreFormatChange){if(tinycolor.equals(color,get())){updateUI();return;}
var newColor,newHsv;if(!color&&allowEmpty){isEmpty=true;}else{isEmpty=false;newColor=tinycolor(color);newHsv=newColor.toHsv();currentHue=(newHsv.h%360)/360;currentSaturation=newHsv.s;currentValue=newHsv.v;currentAlpha=newHsv.a;}
updateUI();if(newColor&&newColor.isValid()&&!ignoreFormatChange){currentPreferredFormat=opts.preferredFormat||newColor.getFormat();}}
function get(opts){opts=opts||{};if(allowEmpty&&isEmpty){return null;}
return tinycolor.fromRatio({h:currentHue,s:currentSaturation,v:currentValue,a:Math.round(currentAlpha*100)/100},{format:opts.format||currentPreferredFormat});}
function isValid(){return!textInput.hasClass("sp-validation-error");}
function move(){updateUI();callbacks.move(get());boundElement.trigger('move.spectrum',[get()]);}
function updateUI(){textInput.removeClass("sp-validation-error");updateHelperLocations();var flatColor=tinycolor.fromRatio({h:currentHue,s:1,v:1});dragger.css("background-color",flatColor.toHexString());var format=currentPreferredFormat;if(currentAlpha<1&&!(currentAlpha===0&&format==="name")){if(format==="hex"||format==="hex3"||format==="hex6"||format==="name"){format="rgb";}}
var realColor=get({format:format}),displayColor='';previewElement.removeClass("sp-clear-display");previewElement.css('background-color','transparent');if(!realColor&&allowEmpty){previewElement.addClass("sp-clear-display");}
else{var realHex=realColor.toHexString(),realRgb=realColor.toRgbString();if(rgbaSupport||realColor.alpha===1){previewElement.css("background-color",realRgb);}
else{previewElement.css("background-color","transparent");previewElement.css("filter",realColor.toFilter());}
if(opts.showAlpha){var rgb=realColor.toRgb();rgb.a=0;var realAlpha=tinycolor(rgb).toRgbString();var gradient="linear-gradient(left, "+realAlpha+", "+realHex+")";if(IE){alphaSliderInner.css("filter",tinycolor(realAlpha).toFilter({gradientType:1},realHex));}
else{alphaSliderInner.css("background","-webkit-"+gradient);alphaSliderInner.css("background","-moz-"+gradient);alphaSliderInner.css("background","-ms-"+gradient);alphaSliderInner.css("background","linear-gradient(to right, "+realAlpha+", "+realHex+")");}}
displayColor=realColor.toString(format);}
if(opts.showInput){textInput.val(displayColor);}
if(opts.showPalette){drawPalette();}
drawInitial();}
function updateHelperLocations(){var s=currentSaturation;var v=currentValue;if(allowEmpty&&isEmpty){alphaSlideHelper.hide();slideHelper.hide();dragHelper.hide();}
else{alphaSlideHelper.show();slideHelper.show();dragHelper.show();var dragX=s*dragWidth;var dragY=dragHeight-(v*dragHeight);dragX=Math.max(-dragHelperHeight,Math.min(dragWidth-dragHelperHeight,dragX-dragHelperHeight));dragY=Math.max(-dragHelperHeight,Math.min(dragHeight-dragHelperHeight,dragY-dragHelperHeight));dragHelper.css({"top":dragY+"px","left":dragX+"px"});var alphaX=currentAlpha*alphaWidth;alphaSlideHelper.css({"left":(alphaX-(alphaSlideHelperWidth/2))+"px"});var slideY=(currentHue)*slideHeight;slideHelper.css({"top":(slideY-slideHelperHeight)+"px"});}}
function updateOriginalInput(fireCallback){var color=get(),displayColor='',hasChanged=!tinycolor.equals(color,colorOnShow);if(color){displayColor=color.toString(currentPreferredFormat);addColorToSelectionPalette(color);}
if(isInput){boundElement.val(displayColor);}
if(fireCallback&&hasChanged){callbacks.change(color);boundElement.trigger('change',[color]);}}
function reflow(){if(!visible){return;}
dragWidth=dragger.width();dragHeight=dragger.height();dragHelperHeight=dragHelper.height();slideWidth=slider.width();slideHeight=slider.height();slideHelperHeight=slideHelper.height();alphaWidth=alphaSlider.width();alphaSlideHelperWidth=alphaSlideHelper.width();if(!flat){container.css("position","absolute");if(opts.offset){container.offset(opts.offset);}else{container.offset(getOffset(container,offsetElement));}}
updateHelperLocations();if(opts.showPalette){drawPalette();}
boundElement.trigger('reflow.spectrum');}
function destroy(){boundElement.show();offsetElement.unbind("click.spectrum touchstart.spectrum");container.remove();replacer.remove();spectrums[spect.id]=null;}
function option(optionName,optionValue){if(optionName===undefined){return $.extend({},opts);}
if(optionValue===undefined){return opts[optionName];}
opts[optionName]=optionValue;if(optionName==="preferredFormat"){currentPreferredFormat=opts.preferredFormat;}
applyOptions();}
function enable(){disabled=false;boundElement.attr("disabled",false);offsetElement.removeClass("sp-disabled");}
function disable(){hide();disabled=true;boundElement.attr("disabled",true);offsetElement.addClass("sp-disabled");}
function setOffset(coord){opts.offset=coord;reflow();}
initialize();var spect={show:show,hide:hide,toggle:toggle,reflow:reflow,option:option,enable:enable,disable:disable,offset:setOffset,set:function(c){set(c);updateOriginalInput();},get:get,destroy:destroy,container:container};spect.id=spectrums.push(spect)-1;return spect;}
function getOffset(picker,input){var extraY=0;var dpWidth=picker.outerWidth();var dpHeight=picker.outerHeight();var inputHeight=input.outerHeight();var doc=picker[0].ownerDocument;var docElem=doc.documentElement;var viewWidth=docElem.clientWidth+$(doc).scrollLeft();var viewHeight=docElem.clientHeight+$(doc).scrollTop();var offset=input.offset();offset.top+=inputHeight;offset.left-=Math.min(offset.left,(offset.left+dpWidth>viewWidth&&viewWidth>dpWidth)?Math.abs(offset.left+dpWidth-viewWidth):0);offset.top-=Math.min(offset.top,((offset.top+dpHeight>viewHeight&&viewHeight>dpHeight)?Math.abs(dpHeight+inputHeight-extraY):extraY));return offset;}
function noop(){}
function stopPropagation(e){e.stopPropagation();}
function bind(func,obj){var slice=Array.prototype.slice;var args=slice.call(arguments,2);return function(){return func.apply(obj,args.concat(slice.call(arguments)));};}
function draggable(element,onmove,onstart,onstop){onmove=onmove||function(){};onstart=onstart||function(){};onstop=onstop||function(){};var doc=document;var dragging=false;var offset={};var maxHeight=0;var maxWidth=0;var hasTouch=('ontouchstart'in window);var duringDragEvents={};duringDragEvents["selectstart"]=prevent;duringDragEvents["dragstart"]=prevent;duringDragEvents["touchmove mousemove"]=move;duringDragEvents["touchend mouseup"]=stop;function prevent(e){if(e.stopPropagation){e.stopPropagation();}
if(e.preventDefault){e.preventDefault();}
e.returnValue=false;}
function move(e){if(dragging){if(IE&&doc.documentMode<9&&!e.button){return stop();}
var t0=e.originalEvent&&e.originalEvent.touches&&e.originalEvent.touches[0];var pageX=t0&&t0.pageX||e.pageX;var pageY=t0&&t0.pageY||e.pageY;var dragX=Math.max(0,Math.min(pageX-offset.left,maxWidth));var dragY=Math.max(0,Math.min(pageY-offset.top,maxHeight));if(hasTouch){prevent(e);}
onmove.apply(element,[dragX,dragY,e]);}}
function start(e){var rightclick=(e.which)?(e.which==3):(e.button==2);if(!rightclick&&!dragging){if(onstart.apply(element,arguments)!==false){dragging=true;maxHeight=$(element).height();maxWidth=$(element).width();offset=$(element).offset();$(doc).bind(duringDragEvents);$(doc.body).addClass("sp-dragging");move(e);prevent(e);}}}
function stop(){if(dragging){$(doc).unbind(duringDragEvents);$(doc.body).removeClass("sp-dragging");setTimeout(function(){onstop.apply(element,arguments);},0);}
dragging=false;}
$(element).bind("touchstart mousedown",start);}
function throttle(func,wait,debounce){var timeout;return function(){var context=this,args=arguments;var throttler=function(){timeout=null;func.apply(context,args);};if(debounce)clearTimeout(timeout);if(debounce||!timeout)timeout=setTimeout(throttler,wait);};}
function inputTypeColorSupport(){return $.fn.spectrum.inputTypeColorSupport();}
var dataID="spectrum.id";$.fn.spectrum=function(opts,extra){if(typeof opts=="string"){var returnValue=this;var args=Array.prototype.slice.call(arguments,1);this.each(function(){var spect=spectrums[$(this).data(dataID)];if(spect){var method=spect[opts];if(!method){throw new Error("Spectrum: no such method: '"+opts+"'");}
if(opts=="get"){returnValue=spect.get();}
else if(opts=="container"){returnValue=spect.container;}
else if(opts=="option"){returnValue=spect.option.apply(spect,args);}
else if(opts=="destroy"){spect.destroy();$(this).removeData(dataID);}
else{method.apply(spect,args);}}});return returnValue;}
return this.spectrum("destroy").each(function(){var options=$.extend({},opts,$(this).data());var spect=spectrum(this,options);$(this).data(dataID,spect.id);});};$.fn.spectrum.load=true;$.fn.spectrum.loadOpts={};$.fn.spectrum.draggable=draggable;$.fn.spectrum.defaults=defaultOpts;$.fn.spectrum.inputTypeColorSupport=function inputTypeColorSupport(){if(typeof inputTypeColorSupport._cachedResult==="undefined"){var colorInput=$("<input type='color'/>")[0];inputTypeColorSupport._cachedResult=colorInput.type==="color"&&colorInput.value!=="";}
return inputTypeColorSupport._cachedResult;};$.spectrum={};$.spectrum.localization={};$.spectrum.palettes={};$.fn.spectrum.processNativeColorInputs=function(){var colorInputs=$("input[type=color]");if(colorInputs.length&&!inputTypeColorSupport()){colorInputs.spectrum({preferredFormat:"hex6"});}};(function(){var trimLeft=/^[\s,#]+/,trimRight=/\s+$/,tinyCounter=0,math=Math,mathRound=math.round,mathMin=math.min,mathMax=math.max,mathRandom=math.random;var tinycolor=function(color,opts){color=(color)?color:'';opts=opts||{};if(color instanceof tinycolor){return color;}
if(!(this instanceof tinycolor)){return new tinycolor(color,opts);}
var rgb=inputToRGB(color);this._originalInput=color,this._r=rgb.r,this._g=rgb.g,this._b=rgb.b,this._a=rgb.a,this._roundA=mathRound(100*this._a)/100,this._format=opts.format||rgb.format;this._gradientType=opts.gradientType;if(this._r<1){this._r=mathRound(this._r);}
if(this._g<1){this._g=mathRound(this._g);}
if(this._b<1){this._b=mathRound(this._b);}
this._ok=rgb.ok;this._tc_id=tinyCounter++;};tinycolor.prototype={isDark:function(){return this.getBrightness()<128;},isLight:function(){return!this.isDark();},isValid:function(){return this._ok;},getOriginalInput:function(){return this._originalInput;},getFormat:function(){return this._format;},getAlpha:function(){return this._a;},getBrightness:function(){var rgb=this.toRgb();return(rgb.r*299+rgb.g*587+rgb.b*114)/1000;},setAlpha:function(value){this._a=boundAlpha(value);this._roundA=mathRound(100*this._a)/100;return this;},toHsv:function(){var hsv=rgbToHsv(this._r,this._g,this._b);return{h:hsv.h*360,s:hsv.s,v:hsv.v,a:this._a};},toHsvString:function(){var hsv=rgbToHsv(this._r,this._g,this._b);var h=mathRound(hsv.h*360),s=mathRound(hsv.s*100),v=mathRound(hsv.v*100);return(this._a==1)?"hsv("+h+", "+s+"%, "+v+"%)":"hsva("+h+", "+s+"%, "+v+"%, "+this._roundA+")";},toHsl:function(){var hsl=rgbToHsl(this._r,this._g,this._b);return{h:hsl.h*360,s:hsl.s,l:hsl.l,a:this._a};},toHslString:function(){var hsl=rgbToHsl(this._r,this._g,this._b);var h=mathRound(hsl.h*360),s=mathRound(hsl.s*100),l=mathRound(hsl.l*100);return(this._a==1)?"hsl("+h+", "+s+"%, "+l+"%)":"hsla("+h+", "+s+"%, "+l+"%, "+this._roundA+")";},toHex:function(allow3Char){return rgbToHex(this._r,this._g,this._b,allow3Char);},toHexString:function(allow3Char){return '#'+this.toHex(allow3Char);},toHex8:function(){return rgbaToHex(this._r,this._g,this._b,this._a);},toHex8String:function(){return '#'+this.toHex8();},toRgb:function(){return{r:mathRound(this._r),g:mathRound(this._g),b:mathRound(this._b),a:this._a};},toRgbString:function(){return(this._a==1)?"rgb("+mathRound(this._r)+", "+mathRound(this._g)+", "+mathRound(this._b)+")":"rgba("+mathRound(this._r)+", "+mathRound(this._g)+", "+mathRound(this._b)+", "+this._roundA+")";},toPercentageRgb:function(){return{r:mathRound(bound01(this._r,255)*100)+"%",g:mathRound(bound01(this._g,255)*100)+"%",b:mathRound(bound01(this._b,255)*100)+"%",a:this._a};},toPercentageRgbString:function(){return(this._a==1)?"rgb("+mathRound(bound01(this._r,255)*100)+"%, "+mathRound(bound01(this._g,255)*100)+"%, "+mathRound(bound01(this._b,255)*100)+"%)":"rgba("+mathRound(bound01(this._r,255)*100)+"%, "+mathRound(bound01(this._g,255)*100)+"%, "+mathRound(bound01(this._b,255)*100)+"%, "+this._roundA+")";},toName:function(){if(this._a===0){return "transparent";}
if(this._a<1){return false;}
return hexNames[rgbToHex(this._r,this._g,this._b,true)]||false;},toFilter:function(secondColor){var hex8String='#'+rgbaToHex(this._r,this._g,this._b,this._a);var secondHex8String=hex8String;var gradientType=this._gradientType?"GradientType = 1, ":"";if(secondColor){var s=tinycolor(secondColor);secondHex8String=s.toHex8String();}
return "progid:DXImageTransform.Microsoft.gradient("+gradientType+"startColorstr="+hex8String+",endColorstr="+secondHex8String+")";},toString:function(format){var formatSet=!!format;format=format||this._format;var formattedString=false;var hasAlpha=this._a<1&&this._a>=0;var needsAlphaFormat=!formatSet&&hasAlpha&&(format==="hex"||format==="hex6"||format==="hex3"||format==="name");if(needsAlphaFormat){if(format==="name"&&this._a===0){return this.toName();}
return this.toRgbString();}
if(format==="rgb"){formattedString=this.toRgbString();}
if(format==="prgb"){formattedString=this.toPercentageRgbString();}
if(format==="hex"||format==="hex6"){formattedString=this.toHexString();}
if(format==="hex3"){formattedString=this.toHexString(true);}
if(format==="hex8"){formattedString=this.toHex8String();}
if(format==="name"){formattedString=this.toName();}
if(format==="hsl"){formattedString=this.toHslString();}
if(format==="hsv"){formattedString=this.toHsvString();}
return formattedString||this.toHexString();},_applyModification:function(fn,args){var color=fn.apply(null,[this].concat([].slice.call(args)));this._r=color._r;this._g=color._g;this._b=color._b;this.setAlpha(color._a);return this;},lighten:function(){return this._applyModification(lighten,arguments);},brighten:function(){return this._applyModification(brighten,arguments);},darken:function(){return this._applyModification(darken,arguments);},desaturate:function(){return this._applyModification(desaturate,arguments);},saturate:function(){return this._applyModification(saturate,arguments);},greyscale:function(){return this._applyModification(greyscale,arguments);},spin:function(){return this._applyModification(spin,arguments);},_applyCombination:function(fn,args){return fn.apply(null,[this].concat([].slice.call(args)));},analogous:function(){return this._applyCombination(analogous,arguments);},complement:function(){return this._applyCombination(complement,arguments);},monochromatic:function(){return this._applyCombination(monochromatic,arguments);},splitcomplement:function(){return this._applyCombination(splitcomplement,arguments);},triad:function(){return this._applyCombination(triad,arguments);},tetrad:function(){return this._applyCombination(tetrad,arguments);}};tinycolor.fromRatio=function(color,opts){if(typeof color=="object"){var newColor={};for(var i in color){if(color.hasOwnProperty(i)){if(i==="a"){newColor[i]=color[i];}
else{newColor[i]=convertToPercentage(color[i]);}}}
color=newColor;}
return tinycolor(color,opts);};function inputToRGB(color){var rgb={r:0,g:0,b:0};var a=1;var ok=false;var format=false;if(typeof color=="string"){color=stringInputToObject(color);}
if(typeof color=="object"){if(color.hasOwnProperty("r")&&color.hasOwnProperty("g")&&color.hasOwnProperty("b")){rgb=rgbToRgb(color.r,color.g,color.b);ok=true;format=String(color.r).substr(-1)==="%"?"prgb":"rgb";}
else if(color.hasOwnProperty("h")&&color.hasOwnProperty("s")&&color.hasOwnProperty("v")){color.s=convertToPercentage(color.s);color.v=convertToPercentage(color.v);rgb=hsvToRgb(color.h,color.s,color.v);ok=true;format="hsv";}
else if(color.hasOwnProperty("h")&&color.hasOwnProperty("s")&&color.hasOwnProperty("l")){color.s=convertToPercentage(color.s);color.l=convertToPercentage(color.l);rgb=hslToRgb(color.h,color.s,color.l);ok=true;format="hsl";}
if(color.hasOwnProperty("a")){a=color.a;}}
a=boundAlpha(a);return{ok:ok,format:color.format||format,r:mathMin(255,mathMax(rgb.r,0)),g:mathMin(255,mathMax(rgb.g,0)),b:mathMin(255,mathMax(rgb.b,0)),a:a};}
function rgbToRgb(r,g,b){return{r:bound01(r,255)*255,g:bound01(g,255)*255,b:bound01(b,255)*255};}
function rgbToHsl(r,g,b){r=bound01(r,255);g=bound01(g,255);b=bound01(b,255);var max=mathMax(r,g,b),min=mathMin(r,g,b);var h,s,l=(max+min)/2;if(max==min){h=s=0;}
else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,l:l};}
function hslToRgb(h,s,l){var r,g,b;h=bound01(h,360);s=bound01(s,100);l=bound01(l,100);function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;}
if(s===0){r=g=b=l;}
else{var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return{r:r*255,g:g*255,b:b*255};}
function rgbToHsv(r,g,b){r=bound01(r,255);g=bound01(g,255);b=bound01(b,255);var max=mathMax(r,g,b),min=mathMin(r,g,b);var h,s,v=max;var d=max-min;s=max===0?0:d/max;if(max==min){h=0;}
else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return{h:h,s:s,v:v};}
function hsvToRgb(h,s,v){h=bound01(h,360)*6;s=bound01(s,100);v=bound01(v,100);var i=math.floor(h),f=h-i,p=v*(1-s),q=v*(1-f*s),t=v*(1-(1-f)*s),mod=i%6,r=[v,q,p,p,t,v][mod],g=[t,v,v,q,p,p][mod],b=[p,p,t,v,v,q][mod];return{r:r*255,g:g*255,b:b*255};}
function rgbToHex(r,g,b,allow3Char){var hex=[pad2(mathRound(r).toString(16)),pad2(mathRound(g).toString(16)),pad2(mathRound(b).toString(16))];if(allow3Char&&hex[0].charAt(0)==hex[0].charAt(1)&&hex[1].charAt(0)==hex[1].charAt(1)&&hex[2].charAt(0)==hex[2].charAt(1)){return hex[0].charAt(0)+hex[1].charAt(0)+hex[2].charAt(0);}
return hex.join("");}
function rgbaToHex(r,g,b,a){var hex=[pad2(convertDecimalToHex(a)),pad2(mathRound(r).toString(16)),pad2(mathRound(g).toString(16)),pad2(mathRound(b).toString(16))];return hex.join("");}
tinycolor.equals=function(color1,color2){if(!color1||!color2){return false;}
return tinycolor(color1).toRgbString()==tinycolor(color2).toRgbString();};tinycolor.random=function(){return tinycolor.fromRatio({r:mathRandom(),g:mathRandom(),b:mathRandom()});};function desaturate(color,amount){amount=(amount===0)?0:(amount||10);var hsl=tinycolor(color).toHsl();hsl.s-=amount/100;hsl.s=clamp01(hsl.s);return tinycolor(hsl);}
function saturate(color,amount){amount=(amount===0)?0:(amount||10);var hsl=tinycolor(color).toHsl();hsl.s+=amount/100;hsl.s=clamp01(hsl.s);return tinycolor(hsl);}
function greyscale(color){return tinycolor(color).desaturate(100);}
function lighten(color,amount){amount=(amount===0)?0:(amount||10);var hsl=tinycolor(color).toHsl();hsl.l+=amount/100;hsl.l=clamp01(hsl.l);return tinycolor(hsl);}
function brighten(color,amount){amount=(amount===0)?0:(amount||10);var rgb=tinycolor(color).toRgb();rgb.r=mathMax(0,mathMin(255,rgb.r-mathRound(255*-(amount/100))));rgb.g=mathMax(0,mathMin(255,rgb.g-mathRound(255*-(amount/100))));rgb.b=mathMax(0,mathMin(255,rgb.b-mathRound(255*-(amount/100))));return tinycolor(rgb);}
function darken(color,amount){amount=(amount===0)?0:(amount||10);var hsl=tinycolor(color).toHsl();hsl.l-=amount/100;hsl.l=clamp01(hsl.l);return tinycolor(hsl);}
function spin(color,amount){var hsl=tinycolor(color).toHsl();var hue=(mathRound(hsl.h)+amount)%360;hsl.h=hue<0?360+hue:hue;return tinycolor(hsl);}
function complement(color){var hsl=tinycolor(color).toHsl();hsl.h=(hsl.h+180)%360;return tinycolor(hsl);}
function triad(color){var hsl=tinycolor(color).toHsl();var h=hsl.h;return[tinycolor(color),tinycolor({h:(h+120)%360,s:hsl.s,l:hsl.l}),tinycolor({h:(h+240)%360,s:hsl.s,l:hsl.l})];}
function tetrad(color){var hsl=tinycolor(color).toHsl();var h=hsl.h;return[tinycolor(color),tinycolor({h:(h+90)%360,s:hsl.s,l:hsl.l}),tinycolor({h:(h+180)%360,s:hsl.s,l:hsl.l}),tinycolor({h:(h+270)%360,s:hsl.s,l:hsl.l})];}
function splitcomplement(color){var hsl=tinycolor(color).toHsl();var h=hsl.h;return[tinycolor(color),tinycolor({h:(h+72)%360,s:hsl.s,l:hsl.l}),tinycolor({h:(h+216)%360,s:hsl.s,l:hsl.l})];}
function analogous(color,results,slices){results=results||6;slices=slices||30;var hsl=tinycolor(color).toHsl();var part=360/slices;var ret=[tinycolor(color)];for(hsl.h=((hsl.h-(part*results>>1))+720)%360;--results;){hsl.h=(hsl.h+part)%360;ret.push(tinycolor(hsl));}
return ret;}
function monochromatic(color,results){results=results||6;var hsv=tinycolor(color).toHsv();var h=hsv.h,s=hsv.s,v=hsv.v;var ret=[];var modification=1/results;while(results--){ret.push(tinycolor({h:h,s:s,v:v}));v=(v+modification)%1;}
return ret;}
tinycolor.mix=function(color1,color2,amount){amount=(amount===0)?0:(amount||50);var rgb1=tinycolor(color1).toRgb();var rgb2=tinycolor(color2).toRgb();var p=amount/100;var w=p*2-1;var a=rgb2.a-rgb1.a;var w1;if(w*a==-1){w1=w;}else{w1=(w+a)/(1+w*a);}
w1=(w1+1)/2;var w2=1-w1;var rgba={r:rgb2.r*w1+rgb1.r*w2,g:rgb2.g*w1+rgb1.g*w2,b:rgb2.b*w1+rgb1.b*w2,a:rgb2.a*p+rgb1.a*(1-p)};return tinycolor(rgba);};tinycolor.readability=function(color1,color2){var c1=tinycolor(color1);var c2=tinycolor(color2);var rgb1=c1.toRgb();var rgb2=c2.toRgb();var brightnessA=c1.getBrightness();var brightnessB=c2.getBrightness();var colorDiff=(Math.max(rgb1.r,rgb2.r)-Math.min(rgb1.r,rgb2.r)+
Math.max(rgb1.g,rgb2.g)-Math.min(rgb1.g,rgb2.g)+
Math.max(rgb1.b,rgb2.b)-Math.min(rgb1.b,rgb2.b));return{brightness:Math.abs(brightnessA-brightnessB),color:colorDiff};};tinycolor.isReadable=function(color1,color2){var readability=tinycolor.readability(color1,color2);return readability.brightness>125&&readability.color>500;};tinycolor.mostReadable=function(baseColor,colorList){var bestColor=null;var bestScore=0;var bestIsReadable=false;for(var i=0;i<colorList.length;i++){var readability=tinycolor.readability(baseColor,colorList[i]);var readable=readability.brightness>125&&readability.color>500;var score=3*(readability.brightness/125)+(readability.color/500);if((readable&&!bestIsReadable)||(readable&&bestIsReadable&&score>bestScore)||((!readable)&&(!bestIsReadable)&&score>bestScore)){bestIsReadable=readable;bestScore=score;bestColor=tinycolor(colorList[i]);}}
return bestColor;};var names=tinycolor.names={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"0ff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000",blanchedalmond:"ffebcd",blue:"00f",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",burntsienna:"ea7e5d",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"0ff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"f0f",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"789",lightslategrey:"789",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"0f0",limegreen:"32cd32",linen:"faf0e6",magenta:"f0f",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",rebeccapurple:"663399",red:"f00",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"fff",whitesmoke:"f5f5f5",yellow:"ff0",yellowgreen:"9acd32"};var hexNames=tinycolor.hexNames=flip(names);function flip(o){var flipped={};for(var i in o){if(o.hasOwnProperty(i)){flipped[o[i]]=i;}}
return flipped;}
function boundAlpha(a){a=parseFloat(a);if(isNaN(a)||a<0||a>1){a=1;}
return a;}
function bound01(n,max){if(isOnePointZero(n)){n="100%";}
var processPercent=isPercentage(n);n=mathMin(max,mathMax(0,parseFloat(n)));if(processPercent){n=parseInt(n*max,10)/100;}
if((math.abs(n-max)<0.000001)){return 1;}
return(n%max)/parseFloat(max);}
function clamp01(val){return mathMin(1,mathMax(0,val));}
function parseIntFromHex(val){return parseInt(val,16);}
function isOnePointZero(n){return typeof n=="string"&&n.indexOf('.')!=-1&&parseFloat(n)===1;}
function isPercentage(n){return typeof n==="string"&&n.indexOf('%')!=-1;}
function pad2(c){return c.length==1?'0'+c:''+c;}
function convertToPercentage(n){if(n<=1){n=(n*100)+"%";}
return n;}
function convertDecimalToHex(d){return Math.round(parseFloat(d)*255).toString(16);}
function convertHexToDecimal(h){return(parseIntFromHex(h)/255);}
var matchers=(function(){var CSS_INTEGER="[-\\+]?\\d+%?";var CSS_NUMBER="[-\\+]?\\d*\\.\\d+%?";var CSS_UNIT="(?:"+CSS_NUMBER+")|(?:"+CSS_INTEGER+")";var PERMISSIVE_MATCH3="[\\s|\\(]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")\\s*\\)?";var PERMISSIVE_MATCH4="[\\s|\\(]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")[,|\\s]+("+CSS_UNIT+")\\s*\\)?";return{rgb:new RegExp("rgb"+PERMISSIVE_MATCH3),rgba:new RegExp("rgba"+PERMISSIVE_MATCH4),hsl:new RegExp("hsl"+PERMISSIVE_MATCH3),hsla:new RegExp("hsla"+PERMISSIVE_MATCH4),hsv:new RegExp("hsv"+PERMISSIVE_MATCH3),hsva:new RegExp("hsva"+PERMISSIVE_MATCH4),hex3:/^([0-9a-fA-F]{1})([0-9a-fA-F]{1})([0-9a-fA-F]{1})$/,hex6:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/,hex8:/^([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})([0-9a-fA-F]{2})$/};})();function stringInputToObject(color){color=color.replace(trimLeft,'').replace(trimRight,'').toLowerCase();var named=false;if(names[color]){color=names[color];named=true;}
else if(color=='transparent'){return{r:0,g:0,b:0,a:0,format:"name"};}
var match;if((match=matchers.rgb.exec(color))){return{r:match[1],g:match[2],b:match[3]};}
if((match=matchers.rgba.exec(color))){return{r:match[1],g:match[2],b:match[3],a:match[4]};}
if((match=matchers.hsl.exec(color))){return{h:match[1],s:match[2],l:match[3]};}
if((match=matchers.hsla.exec(color))){return{h:match[1],s:match[2],l:match[3],a:match[4]};}
if((match=matchers.hsv.exec(color))){return{h:match[1],s:match[2],v:match[3]};}
if((match=matchers.hsva.exec(color))){return{h:match[1],s:match[2],v:match[3],a:match[4]};}
if((match=matchers.hex8.exec(color))){return{a:convertHexToDecimal(match[1]),r:parseIntFromHex(match[2]),g:parseIntFromHex(match[3]),b:parseIntFromHex(match[4]),format:named?"name":"hex8"};}
if((match=matchers.hex6.exec(color))){return{r:parseIntFromHex(match[1]),g:parseIntFromHex(match[2]),b:parseIntFromHex(match[3]),format:named?"name":"hex"};}
if((match=matchers.hex3.exec(color))){return{r:parseIntFromHex(match[1]+''+match[1]),g:parseIntFromHex(match[2]+''+match[2]),b:parseIntFromHex(match[3]+''+match[3]),format:named?"name":"hex"};}
return false;}
window.tinycolor=tinycolor;})();$(function(){if($.fn.spectrum.load){$.fn.spectrum.processNativeColorInputs();}});});;(function(){'use strict';var globalLogger={addLogData:function(key,value){try{window.qgLogger.addLogData(key,value);}catch(e){}},log:function(message,extra){try{window.qgLogger.log(message,extra);}catch(e){}},debug:function(message,extra){try{window.qgLogger.debug(message,extra);}catch(e){}},info:function(message,extra){try{window.qgLogger.info(message,extra);}catch(e){}},notice:function(message,extra){try{window.qgLogger.notice(message,extra);}catch(e){}},warning:function(message,extra){try{window.qgLogger.warning(message,extra);}catch(e){}},error:function(message,extra){try{window.qgLogger.error(message,extra);}catch(e){}},critical:function(message,extra){try{window.qgLogger.critical(message,extra);}catch(e){}}};var getAssertMessage=function(defaultMessage,message){if(typeof message==='string'){return 'qgAssert: '+message;}
return 'qgAssert: '+defaultMessage;};var assertIsTrue=function(value,message){if(!testIsTrue(value)){throw new Error(getAssertMessage('value is not true',message));}};var assertIsFalse=function(value,message){if(!testIsFalse(value)){throw new Error(getAssertMessage('value is not false',message));}};var assertIsNull=function(value,message){if(!testIsNull(value)){throw new Error(getAssertMessage('value is not null',message));}};var assertIsNotNull=function(value,message){if(!testIsNotNull(value)){throw new Error(getAssertMessage('value is null',message));}};var assertIsBoolean=function(value,message){if(!testIsBoolean(value)){throw new Error(getAssertMessage('value is not a boolean',message));}};var assertIsNotBoolean=function(value,message){if(testIsBoolean(value)){throw new Error(getAssertMessage('value is a boolean',message));}};var assertIsFunction=function(value,message){if(!testIsFunction(value)){throw new Error(getAssertMessage('value is not a function',message));}};var assertIsObject=function(value,message){if(!testIsObject(value)){throw new Error(getAssertMessage('value is not an object',message));}};var assertIsArray=function(value,message){if(!testIsArray(value)){throw new Error(getAssertMessage('value is not an array',message));}};var assertIsNotArray=function(value,message){if(testIsArray(value)){throw new Error(getAssertMessage('value is an array',message));}};var assertIsNumber=function(value,message){if(!testIsNumber(value)){throw new Error(getAssertMessage('value is not a number',message));}};var assertIsString=function(string,message){if(!testIsString(string)){throw new Error(getAssertMessage('value is not a string',message));}};var assertIsUUID4=function(uuid4,message){var m='value is not a uuid4';if(typeof message==='string'){m=message;}
assertIsString(uuid4,m);if(!testIsUUID4(uuid4)){throw new Error(getAssertMessage(message));}};var assertIsNonEmptyString=function(string,message){if(!testIsString(string)){throw new Error(getAssertMessage('value is not a string',message));}
if(testIsEmptyString(string)){throw new Error(getAssertMessage('value is an empty string',message));}};var assertArrayHasIndex=function(value,index,message){assertIsArray(value,message);assertIsNumber(index,message);if(!testArrayHasIndex(value,index)){throw new Error(getAssertMessage('array does not have index',message));}};var assertObjectHasKey=function(object,key,message){if(!testObjectHasKey(object,key)){throw new Error(getAssertMessage('object does not have key: '+key,message));}};var isArrayPolyfill=function(array){return Object.prototype.toString.call(array)==='[object Array]';};var testIsBoolean=function(value){return typeof value==='boolean';};var testIsFunction=function(value){return typeof value==='function';};var testIsObject=function(value){return typeof value==='object'&&value!==null;};var testIsArray=function(value){if(!Array.isArray){return isArrayPolyfill(value);}
return Array.isArray(value);};var testIsNumber=function(value){return typeof value==='number';};var testIsString=function(value){return typeof value==='string';};var testIsUUID4=function(value){if(!testIsString(value)){return false;}
return /^[0-9A-F]{8}-[0-9A-F]{4}-[4][0-9A-F]{3}-[89AB][0-9A-F]{3}-[0-9A-F]{12}$/i.test(value);};var testIsTrue=function(value){return Boolean(value);};var testIsFalse=function(value){return!Boolean(value);};var testIsNull=function(value){return value===null;};var testIsNotNull=function(value){return value!==null;};var testIsEmptyString=function(value){return testIsString(value)&&value==='';};var testIsNonEmptyString=function(value){return testIsString(value)&&value!=='';};var testArrayHasIndex=function(array,index){assertIsArray(array);assertIsNumber(index);return typeof array[index]!=='undefined';};var testObjectHasKey=function(object,key){assertIsObject(object);assertIsNotNull(key);return object.hasOwnProperty(key);};var testObjectHasValue=function(object,value){assertIsObject(object);var found=false;var findValue=function(key,objectValue){if(value===objectValue){found=true;return false;}};$.each(object,findValue);return found;};var testIsRawJobInfo=function(rawJobInfo){if(!testIsObject(rawJobInfo)){return false;}
if(!testIsUUID4(rawJobInfo.id)){return false;}
if(!testIsNonEmptyString(rawJobInfo.server)){return false;}
if(!testIsNonEmptyString(rawJobInfo.token)){return false;}
if(!testIsArray(rawJobInfo.conversion)){return false;}
return true;};var testIsRawInputInfo=function(rawInputInfo){if(!testIsObject(rawInputInfo)){return false;}
if(!testIsUUID4(rawInputInfo.id)){return false;}
if(!testIsString(rawInputInfo.source)){return false;}
if(!testIsNonEmptyString(rawInputInfo.type)){return false;}
if(!testIsObject(rawInputInfo.metadata)){return false;}
if(!testIsString(rawInputInfo.status)||!testIsInputStatusApi(rawInputInfo.status)){return false;}
return true;};var testIsUploadedFileInfoObject=function(uploadedFileInfo){if(!testIsObject(uploadedFileInfo)){return false;}
if(!testObjectHasKey(uploadedFileInfo,'id')){return false;}
if(!testIsUUID4(uploadedFileInfo.id.job)){return false;}
if(!testIsUUID4(uploadedFileInfo.id.input)){return false;}
if(!testIsObject(uploadedFileInfo.metadata)){return false;}
if(!testIsBoolean(uploadedFileInfo.completed)){return false;}
return true;};var testIsInputStatusUploader=function(status){if(!testIsNonEmptyString(status)){return false;}
return testObjectHasValue(inputStatusUploader,status);};var testIsInputStatusApi=function(status){if(!testIsNonEmptyString(status)){return false;}
return testObjectHasValue(inputStatusApi,status);};var testIsInputType=function(type){if(!testIsNonEmptyString(type)){return false;}
return testObjectHasValue(inputTypes,type);};var testIsGlobalEvent=function(event){if(!testIsNonEmptyString(event)){return false;}
return testObjectHasValue(globalEvents,event);};var testIsInputEvent=function(event){if(!testIsNonEmptyString(event)){return false;}
return testObjectHasValue(inputEvents,event);};var testIsUploaderError=function(error){if(!testIsNonEmptyString(error)){return false;}
return testObjectHasValue(uploaderErrors,error);};var assertIsRawJobInfo=function(rawJobInfo){if(!testIsRawJobInfo(rawJobInfo)){throw new Error(getAssertMessage('invalid raw job object'));}};var assertIsRawInputInfo=function(rawInputInfo){if(!testIsRawInputInfo(rawInputInfo)){throw new Error(getAssertMessage('invalid raw input info'));}};var assertIsInputStatusUploader=function(status){if(!testIsInputStatusUploader(status)){throw new Error(getAssertMessage('invalid input status (uploader)'));}};var assertIsInputStatusApi=function(status){if(!testIsInputStatusApi(status)){throw new Error(getAssertMessage('invalid input status (api)'));}};var assertIsUploaderError=function(error){if(!testIsUploaderError(error)){throw new Error(getAssertMessage('not valid uploaderError'));}};var assertIsInputType=function(type){if(!testIsInputType(type)){throw new Error(getAssertMessage('invalid input type'));}};var assertIsInputEvent=function(event){if(!testIsInputEvent(event)){throw new Error(getAssertMessage('invalid input event'));}};var assertIsGlobalEvent=function(event){if(!testIsGlobalEvent(event)){throw new Error(getAssertMessage('invalid global event'));}};var globalEvents={JOB_CREATE_START:'global-event-job-create-start',JOB_CREATE_DONE:'global-event-job-create-done',JOB_CREATE_FAIL:'global-event-job-create-fail',LIMITS_TOO_MANY_INPUTS:'global-event-too-many-inputs',LIMITS_INPUT_TOO_LARGE:'global-event-input-too-large',LIMITS_JOB_TOO_LARGE:'global-event-job-too-large',LIMITS_YOUTUBE_FORBIDDEN:'global-event-youtube-forbidden'};var inputEvents={QUEUED:'input-event-queued',SUBMITTING:'input-event-start-submitting',LOADING:'input-event-start-loading',DONE:'input-event-done',FAIL:'input-event-fail',PASSWORD_MISSING:'input-event-password-missing',UPLOAD_CANCELED:'input-event-upload-canceled',DELETED:'input-event-deleted',UPLOAD_PROGRESS:'input-event-upload-progress'};var inputStatusApi={READY:'ready',FAILED:'failed',DOWNLOADING:'downloading',CANCELED:'canceled'};var inputStatusUploader={QUEUED:'status-queued',SUBMITTING:'status-submitting-to-api',LOADING:'status-loading',DONE:'status-done',PASSWORD_MISSING:'status-password-missing',DELETING:'status-deleting',DELETED:'status-deleted',FAILED:'status-failed'};var isInputInApi=function(status){assertIsInputStatusUploader(status);if(status===inputStatusUploader.QUEUED){return false;}
if(status===inputStatusUploader.DELETED){return false;}
if(status===inputStatusUploader.FAILED){return false;}
return true;};var inputTypes={EXTERNAL_URL:'type-external-url',FILE_UPLOAD:'type-upload',GDRIVE:'type-gdrive',INPUT_ID:'type-input-id',DROPBOX:'type-dropbox'};var uploadServerErrors={JOB_CAN_NOT_BE_MODIFIED:2,FILE_TOO_LARGE:3,EMPTY_OR_INVALID_FILE:5,PROBLEM_UPLOADING_FILE:6,UNSUPPORTED_CONTENT_RANGE_HEADER:8,SUM_OF_UPLOADS_TOO_LARGE:34,UNKNOWN:99};var uploaderErrors={EXCEPTION:'uploader-error-EXCEPTION',UNKNOWN:'uploader-error-unknown',OVERUSE:'uploader-error-overuse',CONNECTION_PROBLEM:'uploader-error-connection-problem',BROKEN_SERVER_RESPONSE:'uploader-error-broken-server-response',NO_UPLOAD_SERVER:'uploader-error-no-upload-server',INVALID_API_KEY:'uploader-error-invalid-api-key',PAYMENT_REQUIRED:'uploader-error-payment-required',LIMITS_INPUT_TOO_LARGE:'uploader-error-file-too-large',LIMITS_TOO_MANY_INPUTS:'uploader-error-too-many-inputs',LIMITS_YOUTUBE_FORBIDDEN:'uploader-error-youtube-forbidden',ERROR_TRY_RELOAD:'uploader-error-try-reload'};var conversions={document:{global:{allow_multiple_outputs:'boolean'},doc:{ocr:'boolean',language:'string'},docx:{ocr:'boolean',language:'string'},html:{},odt:{ocr:'boolean',language:'string'},pdf:{images_quality:'integer',dpi:'integer',quality:'string',color:'string',page_size:'string',custom_page_size_width:'string',custom_page_size_height:'string',custom_page_size_unit:'string',rotate:'array',rearrange:'string',split:'string',merge:'boolean',stamp:'boolean',watermark:'boolean',grayscale:'boolean',deskew:'boolean',ocr:'boolean',language:'string'},ppt:{},pptx:{},rtf:{},swf:{},txt:{ocr:'boolean',language:'string'}},video:{global:{allow_multiple_outputs:'boolean'},mp4:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer',audio_bitrate:'integer',audio_codec:'string',codec:'string',rotate:'integer',start:'string',end:'string',mirror:'string'},avi:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},'3g2':{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},'3gp':{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},flv:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},mkv:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},mov:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},ogv:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},webm:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'},wmv:{video_bitrate:'integer',remove_audio:'boolean',framerate:'integer',width:'integer',height:'integer'}},image:{global:{allow_multiple_outputs:'boolean',dpi:'integer',width:'integer',height:'integer',crop_top:'integer',crop_bottom:'integer',crop_left:'integer',crop_right:'integer',crop_origin_x:'integer',crop_origin_y:'integer',crop_width:'integer',crop_height:'integer'},bmp:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},eps:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},exr:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},gif:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},ico:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',},jpg:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean',quality:'integer',compress:'string'},png:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean',quality:'integer'},svg:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},tga:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},tiff:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},wbmp:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'},webp:{color:'string',enhance:'boolean',normalize:'boolean',sharpen:'boolean',antialias:'boolean',despeckle:'boolean',equalize:'boolean',deskew:'boolean'}}};var showRelevantOptionsForTarget=function(category,target){if(!conversions.hasOwnProperty(category)){return false;}
if(!conversions[category].hasOwnProperty(target)){return false;}
var $fields=$('#sendform').find('input, select');$.each($fields,function(key,value){var $e=$(value);var optName=$e.prop('name');var optType=$e.data('options-type');var $formGroup=$e.parents('.form-group');var optCategory=$e.data('category');if(optType!=='options'){return;}
if((!conversions[category][target].hasOwnProperty(optName)&&!conversions[category]['global'].hasOwnProperty(optName))||(optCategory!==category&&typeof optCategory!=='undefined')){$e.data('option-ignore',true).hide();$e.parent('label').hide();if($formGroup.find('input, select').is(':visible')===false){$formGroup.hide();}
return;}
$formGroup.show();$e.parent('label').show();$e.data('option-ignore',false).show();});};var getConversionOptionsFromForm=function(formId){var data={};var $form=$(formId);var $fields=$form.find('input, select');$.each($fields,function(key,value){var $e=$(value);var inputType=$e.prop('type');var optName=$e.prop('name');var optType=$e.data('options-type');var optInverse=$e.data('options-inverse');var optValueType=$e.data('value-type');var optIgnore=$e.data('option-ignore');var optValue=$e.val();if(optIgnore==='true'||optIgnore===true){return;}
if(optValueType==='boolean'){optValue=optValue==='true'||optValue===true;}
if(inputType==='checkbox'){optValue=$e.is(':checked');if(optInverse===true){optValue=!optValue;}}
if(inputType==='checkbox'&&optValueType==='integer'){if($e.is(':checked')===true){optValue=$e.val();}}
if(inputType==='radio'){optValue=$e.is(':checked');if(optInverse===true){optValue=!optValue;}}
if(optValueType==='integer'){optValue=parseInt(optValue);}
if(optValueType==='float'){optValue=parseFloat(optValue);}
if(optValueType==='string'){optValue=optValue.toString();}
if(optType==='base'){data[optName]=optValue;return;}
if(inputType==='select-one'&&optValue==='null'){return;}
if(!data.hasOwnProperty(optType)){data[optType]={};}
data[optType][optName]=optValue;});return data;};var setupTargetDropDown=function(){$(document).on('click','.radio-toggle',function(){var dataName=$(this).attr('data-name');var target=$(this).find("input[name='"+dataName+"']");target.prop('checked',true);});$(document).on('change','select[name="target"]',function(){var $e=$(this).find(':selected');var target=$e.val();var category='';if($e.is('[data-category]')){category=$e.attr('data-category');}else{category=$('[name="category"]').val();}
showRelevantOptionsForTarget(category,target);});};var updateOptionsForDropDown=function(){var $selected=$('#inputTarget :selected');if($selected.length===0){return;}
var target=$selected.val();var category='';if($selected.is('[data-category]')){category=$selected.attr('data-category');}else{category=$('[name="category"]').val();}
showRelevantOptionsForTarget(category,target);};var conversionOptions={showRelevantOptionsForTarget:showRelevantOptionsForTarget,getConversionOptionsFromForm:getConversionOptionsFromForm,setupTargetDropDown:setupTargetDropDown,updateOptionsForDropDown:updateOptionsForDropDown};var getLocationOrigin=function(){var location=window.location;if(location.origin){return location.origin;}
return location.protocol+'//'+location.hostname+(location.port&&':'+location.port);};function JobInfoHelper(jobInfoRaw){this._isValid=true;this._data={};this._inputs={};if(!testIsRawJobInfo(jobInfoRaw)){this._isValid=false;return;}
this._data=jobInfoRaw;}
JobInfoHelper.prototype.isValid=function(){return this._isValid;};JobInfoHelper.prototype.getId=function(){assertIsTrue(this._isValid);return this._data.id;};JobInfoHelper.prototype.getConversionId=function(){assertIsTrue(this._isValid);try{return this._data.conversion[0].id;}catch(e){}
return null;};JobInfoHelper.prototype.getConversionTarget=function(){assertIsTrue(this._isValid);try{return this._data.conversion[0].target;}catch(e){}
return null;};JobInfoHelper.prototype.getToken=function(){assertIsTrue(this._isValid);return this._data.token;};JobInfoHelper.prototype.getServer=function(){assertIsTrue(this._isValid);return this._data.server;};JobInfoHelper.prototype.getUploadUrl=function(){assertIsTrue(this._isValid);return this.getServer()+'/upload-file/'+this.getId();};JobInfoHelper.prototype.getUploadUrlBase64=function(){assertIsTrue(this._isValid);return this.getServer()+'/upload-base64/'+this.getId();};JobInfoHelper.prototype.getRedirectedUploadUrl=function(){assertIsTrue(this._isValid);var parts=this.getServer().match(/^[^:]*:\/\/([^.]+)\.([^\/]+)(\/.*)$/);if(parts===null){globalLogger.error('Can not create redirect upload url',this.getServer());return this.getUploadUrl();}
var uploadServer=parts[1];var path=parts[3];var currentUrl=getLocationOrigin();return currentUrl+'/upload-redirect/'+uploadServer+path+'/upload-file/'+this.getId();};JobInfoHelper.prototype.getInput=function(inputId){assertIsTrue(this._isValid);assertIsUUID4(inputId);var input=null;$.each(this._data.input,function(idx,inp){if(inp.id===inputId){input=inp;}});return input;};JobInfoHelper.prototype.getInputs=function(){assertIsTrue(this._isValid);return this._data.input;};JobInfoHelper.prototype.getInputError=function(inputId){assertIsTrue(this._isValid);assertIsUUID4(inputId);var error=null;$.each(this._data.errors,function(idx,err){if(err.hasOwnProperty('id_source')&&err.id_source===inputId){error=err;}});return error;};JobInfoHelper.prototype.getInputWarning=function(inputId){assertIsTrue(this._isValid);assertIsUUID4(inputId);var warning=null;$.each(this._data.warnings,function(idx,err){if(err.hasOwnProperty('id_source')&&err.id_source===inputId){warning=err;}});return warning;};JobInfoHelper.prototype.isInputReady=function(inputId){assertIsTrue(this._isValid);assertIsUUID4(inputId);var input=this.getInput(inputId);return input.status===inputStatusApi.READY;};JobInfoHelper.prototype.isInputDownloading=function(inputId){assertIsTrue(this._isValid);assertIsUUID4(inputId);var input=this.getInput(inputId);return input.status===inputStatusApi.DOWNLOADING;};JobInfoHelper.prototype.getRawJobInfo=function(){assertIsTrue(this._isValid);return this._data;};var ajaxTimeoutMilliseconds=59000;function AjaxWrapper(config){this._logger=globalLogger;if(testIsObject(config)){if(testObjectHasKey(config,'logger')){assertIsFunction(config.logger.log);this._logger=config.logger;}}}
var getSecondsUntilNextRetry=function(currentRetry){assertIsNumber(currentRetry);if(currentRetry<1){currentRetry=1;}
var delayS=currentRetry;if(delayS>20){delayS=20;}
return delayS;};var getSlowSecondsUntilNextRetry=function(currentRetry){assertIsNumber(currentRetry);if(currentRetry<1){currentRetry=1;}
if(currentRetry<3){return 10;}
return 20;};AjaxWrapper.prototype.ajax=function(options,DEPRECATEDmaxRetries){assertIsObject(options);var maxRetries=0;if(typeof DEPRECATEDmaxRetries!=='undefined'){assertIsNumber(DEPRECATEDmaxRetries);maxRetries=DEPRECATEDmaxRetries;}
if(options.hasOwnProperty('maxRetries')){assertIsNumber(options.maxRetries);maxRetries=options.maxRetries;}
if(options.hasOwnProperty('timeout')){assertIsNumber(options.timeout);}else{options.timeout=ajaxTimeoutMilliseconds;}
if(!options.hasOwnProperty('method')&&options.hasOwnProperty('type')){options.method=options.type;}
if(!options.hasOwnProperty('method')){options.method='GET';}
var retry400=false;var retry500=true;if(options.hasOwnProperty('retry400')){assertIsBoolean(options.retry400);retry400=options.retry400;}
if(options.hasOwnProperty('retry500')){assertIsBoolean(options.retry500);retry500=options.retry500;}
if(!options.hasOwnProperty('cache')){options.cache=false;}
var nRetries=0;var deferred=$.Deferred();var logger=this._logger;var doJqueryAjaxCall=function(){var startTime_ms=Date.now();$.ajax(options).done(function(response,textStatus,jqXHR){var duration_s=(Date.now()-startTime_ms)/1000;if(duration_s>15){logger.log('qgAjaxWrapper info - long running ajax call','url: '+options.url+' duration: '+duration_s+'s');}
deferred.resolve(response,textStatus,jqXHR);}).fail(function(jqXHR,textStatus,errorThrown){if(textStatus==='timeout'){logger.log('qgAjaxWrapper fail - timeout',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});}
var is400=jqXHR.status>=400&&jqXHR.status<500;if(is400&&!retry400){logger.log('qgAjaxWrapper fail - client error',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});deferred.reject(jqXHR,textStatus,errorThrown);return;}
var is500=jqXHR.status>=500&&jqXHR.status<600;if(is500&&!retry500){logger.log('qgAjaxWrapper fail - server error',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});deferred.reject(jqXHR,textStatus,errorThrown);return;}
if(maxRetries===0){logger.log('qgAjaxWrapper fail - no retries',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});deferred.reject(jqXHR,textStatus,errorThrown);return;}
if(nRetries>=maxRetries){logger.log('qgAjaxWrapper fail - even with retries',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});deferred.reject(jqXHR,textStatus,errorThrown);return;}
nRetries+=1;var delayS=getSecondsUntilNextRetry(nRetries);if(is500){delayS=getSlowSecondsUntilNextRetry(nRetries);}
setTimeout(function(){doJqueryAjaxCall();},delayS*1000);});};doJqueryAjaxCall();return deferred;};AjaxWrapper.prototype.post=function(options,DEPRECATEDmaxRetries){options.method='POST';return this.ajax(options,DEPRECATEDmaxRetries);};AjaxWrapper.prototype.postJson=function(options){options.method='POST';options.contentType='application/json';options.processData=false;if(typeof options.data==='object'){options.data=JSON.stringify(options.data);}
return this.ajax(options);};AjaxWrapper.prototype.get=function(options,DEPRECATEDmaxRetries){options.method='GET';return this.ajax(options,DEPRECATEDmaxRetries);};function InputInfoHelper(rawInputInfo){this._isValid=true;this._rawData={};if(!testIsRawInputInfo(rawInputInfo)){this._isValid=false;return;}
this._rawData=rawInputInfo;}
InputInfoHelper.prototype.isValid=function(){return this._isValid;};InputInfoHelper.prototype.getId=function(){assertIsTrue(this._isValid);return this._rawData.id;};InputInfoHelper.prototype.getSize=function(){assertIsTrue(this._isValid);return this._rawData.size;};InputInfoHelper.prototype.getStatus=function(){assertIsTrue(this._isValid);assertIsInputStatusApi(this._rawData.status);return this._rawData.status;};InputInfoHelper.prototype.isFinished=function(){assertIsTrue(this._isValid);var rawData=this._rawData;return rawData.status===inputStatusApi.READY;};function SatApiHelper(api,config){assertIsObject(config);this._api=api;}
SatApiHelper.prototype.createJob=function(jobData){var api=this._api;if(!testIsObject(jobData)){jobData={};}
var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs';options.data=jobData;var deferred=$.Deferred();api.ajaxWrapper.postJson(options).done(function(jobInfoRaw,textStatus,jqXHR){var jobInfoHelper=new JobInfoHelper(jobInfoRaw);if(!jobInfoHelper.isValid()){globalLogger.log('qgApiHelper createJob fail broken response',{info:'response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
var jobId=jobInfoHelper.getId();api.jobCache.setData(jobId,jobInfoRaw);globalLogger.addLogData('job_id',jobId);globalLogger.log('qgApiHelper createJob done');deferred.resolve(jobInfoRaw);}).fail(function(jqXHR,textStatus,errorThrown){if(jqXHR.status===402){limitReached();}
deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.getJobInfo=function(jobId){assertIsUUID4(jobId);var api=this._api;var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId;if(!api.numberOfCurrentJobInfoRequests.hasOwnProperty(jobId)){api.numberOfCurrentJobInfoRequests[jobId]=0;}
api.numberOfCurrentJobInfoRequests[jobId]++;api.ajaxWrapper.get(options).done(function(jobInfoRaw,textStatus,jqXHR){api.numberOfCurrentJobInfoRequests[jobId]--;jobInfoRaw=api.fixOldBrowser(jobInfoRaw);var jobInfoHelper=new JobInfoHelper(jobInfoRaw);if(!jobInfoHelper.isValid()){globalLogger.log('qgApiHelper getJobInfo fail broken response',{info:'response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
api.jobCache.setData(jobId,jobInfoRaw);deferred.resolve(jobInfoRaw);}).fail(function(jqXHR,textStatus,errorThrown){api.numberOfCurrentJobInfoRequests[jobId]--;globalLogger.log('qgApiHelper getJobInfo fail connection problem',jqXHR.status);if(jqXHR.status===402){try{limitReached();}catch(e){}
deferred.reject(uploaderErrors.PAYMENT_REQUIRED);return;}
deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.addInput=function(jobId,inputData){assertIsUUID4(jobId);assertIsObject(inputData);assertIsNotArray(inputData);assertObjectHasKey(inputData,'type');var api=this._api;var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/input';options.data=inputData;api.ajaxWrapper.postJson(options).done(function(rawInputInfo,textStatus,jqXHR){rawInputInfo=api.fixOldBrowser(rawInputInfo);var inputInfoHelper=new InputInfoHelper(rawInputInfo);if(!inputInfoHelper.isValid()){globalLogger.log('qgApiHelper addJobInput fail broken response',{info:'response: '+JSON.stringify(rawInputInfo)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
globalLogger.log('qgApiHelper addJobInput done',JSON.stringify(inputData));deferred.resolve(rawInputInfo);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper addJobInput fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.addInputs=function(jobId,inputsData){assertIsUUID4(jobId);assertIsObject(inputsData);var api=this._api;var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/input';options.data=inputsData;api.ajaxWrapper.postJson(options).done(function(rawInputInfo,textStatus,jqXHR){rawInputInfo=api.fixOldBrowser(rawInputInfo);var input=rawInputInfo;if(Array.isArray(rawInputInfo)){input=rawInputInfo[0];}
var inputInfoHelper=new InputInfoHelper(input);if(!inputInfoHelper.isValid()){globalLogger.log('qgApiHelper addJobInput fail broken response',{info:'response: '+JSON.stringify(rawInputInfo)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
globalLogger.log('qgApiHelper addJobInput done',JSON.stringify(inputsData));deferred.resolve(rawInputInfo);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper addJobInput fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.addConversion=function(jobId,conversion){assertIsUUID4(jobId);assertIsObject(conversion);var api=this._api;var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/conversions';options.data=conversion;api.ajaxWrapper.postJson(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);globalLogger.log('qgApiHelper addConversion done',JSON.stringify(conversion));deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper addConversion fail connection problem',jqXHR.status);if(jqXHR.status===402){limitReached();}
deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.startJob=function(jobId,serializedForm){assertIsUUID4(jobId);var api=this._api;if(typeof serializedForm==='undefined'){serializedForm='';}
assertIsString(serializedForm);var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/start';options.data=serializedForm;api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);globalLogger.log('qgApiHelper startJob done',JSON.stringify(serializedForm));deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper startJob fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.deleteInput=function(jobId,inputId){assertIsUUID4(jobId);assertIsUUID4(inputId);var api=this._api;var deferred=$.Deferred();var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/input/'+inputId+'/delete';options.data=$.extend({},api.baseData);api.ajaxWrapper.postJson(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);globalLogger.log('qgApiHelper deleteInput done',inputId);deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper deleteInput fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};SatApiHelper.prototype.setPassword=function(jobId,inputId,password){assertIsUUID4(jobId);assertIsUUID4(inputId);var deferred=$.Deferred();var api=this._api;var data=$.extend({},api.baseData,{credentials:{decrypt_password:password}});var options=$.extend({},api.baseAjaxOptions);options.url='/api/jobs/'+jobId+'/input/'+inputId+'/patch';options.data=data;api.ajaxWrapper.postJson(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);globalLogger.log('qgApiHelper set password done',inputId);deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper set password fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};var serverResponseHasErrorCode=function(serverResponse){if(typeof serverResponse==='undefined'||serverResponse===null){return false;}
return serverResponse.hasOwnProperty('code')&&serverResponse.hasOwnProperty('text');};function OcApiHelper(api,config){assertIsObject(config);this.api=api;this.baseUrlApi='';assertObjectHasKey(config,'baseUrlApi');this.baseUrlApi=config.baseUrlApi;}
OcApiHelper.prototype.createJob=function(jobData){var api=this.api;if(!testIsObject(jobData)){jobData={};}
var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs';options.data=$.extend({},api.baseData,jobData);var startTime_ms=Date.now();var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(jobInfoRaw,textStatus,jqXHR){jobInfoRaw=api.fixOldBrowser(jobInfoRaw);if(serverResponseHasErrorCode(jobInfoRaw)){var message='qgApiHelper createJob fail error code';var uploaderError=uploaderErrors.UNKNOWN;if(jobInfoRaw.code===1){message='qgApiHelper createJob fail overuse';uploaderError=uploaderErrors.OVERUSE;}
if(jobInfoRaw.code===1013){message='qgApiHelper createJob Csrf mismatch';uploaderError=uploaderErrors.ERROR_TRY_RELOAD;}
globalLogger.log(message,{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderError);return;}
var jobInfoHelper=new JobInfoHelper(jobInfoRaw);if(!jobInfoHelper.isValid()){globalLogger.log('qgApiHelper createJob fail broken response',{info:'response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
var jobId=jobInfoHelper.getId();api.jobCache.setData(jobId,jobInfoRaw);globalLogger.addLogData('job_id',jobId);var duration_s=(Date.now()-startTime_ms)/1000;globalLogger.log('qgApiHelper createJob done',{duration_s:duration_s});deferred.resolve(jobInfoRaw);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper createJob fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.getJobInfo=function(jobId){assertIsUUID4(jobId);var api=this.api;var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId;options.data=$.extend({},api.baseData);var deferred=$.Deferred();if(!api.numberOfCurrentJobInfoRequests.hasOwnProperty(jobId)){api.numberOfCurrentJobInfoRequests[jobId]=0;}
api.numberOfCurrentJobInfoRequests[jobId]++;api.ajaxWrapper.get(options).done(function(jobInfoRaw,textStatus,jqXHR){api.numberOfCurrentJobInfoRequests[jobId]--;jobInfoRaw=api.fixOldBrowser(jobInfoRaw);if(serverResponseHasErrorCode(jobInfoRaw)){globalLogger.log('qgApiHelper getJobInfo fail error code',{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderErrors.UNKNOWN);return;}
var jobInfoHelper=new JobInfoHelper(jobInfoRaw);if(!jobInfoHelper.isValid()){globalLogger.log('qgApiHelper getJobInfo fail broken response',{info:'response: '+JSON.stringify(jobInfoRaw)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
api.jobCache.setData(jobId,jobInfoRaw);deferred.resolve(jobInfoRaw);}).fail(function(jqXHR,textStatus,errorThrown){api.numberOfCurrentJobInfoRequests[jobId]--;globalLogger.log('qgApiHelper getJobInfo fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.addInput=function(jobId,inputData){assertIsUUID4(jobId);assertIsObject(inputData);assertIsNotArray(inputData);assertObjectHasKey(inputData,'type');var api=this.api;inputData=$.extend({},api.baseData,inputData);var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId+'/input';options.data=inputData;var startTime_ms=Date.now();var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(rawInputInfo,textStatus,jqXHR){rawInputInfo=api.fixOldBrowser(rawInputInfo);if(serverResponseHasErrorCode(rawInputInfo)){var message='qgApiHelper addJobInput fail error code';var uploaderError=uploaderErrors.UNKNOWN;if(rawInputInfo.code===50||rawInputInfo.code===34){message='qgApiHelper addJobInput fail file too large';uploaderError=uploaderErrors.LIMITS_INPUT_TOO_LARGE;}
if(rawInputInfo.code===1013){message='qgApiHelper addJobInput fail Csrf mismatch';uploaderError=uploaderErrors.ERROR_TRY_RELOAD;}
globalLogger.log(message,{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(rawInputInfo)});deferred.reject(uploaderError);return;}
var inputInfoHelper=new InputInfoHelper(rawInputInfo);if(!inputInfoHelper.isValid()){globalLogger.log('qgApiHelper addJobInput fail broken response',{info:'response: '+JSON.stringify(rawInputInfo)});deferred.reject(uploaderErrors.BROKEN_SERVER_RESPONSE);return;}
var duration_s=(Date.now()-startTime_ms)/1000;globalLogger.log('qgApiHelper addJobInput done',{duration_s:duration_s});deferred.resolve(rawInputInfo);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper addJobInput fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.addConversion=function(jobId,conversion){assertIsUUID4(jobId);assertIsObject(conversion);var api=this.api;var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId+'/conversions';options.data=conversion;var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);if(serverResponseHasErrorCode(serverResponse)){var message='qgApiHelper addConversion fail error code';var uploaderError=uploaderErrors.UNKNOWN;if(serverResponse.code===1013){message='qgApiHelper addJobInput fail Csrf mismatch';uploaderError=uploaderErrors.ERROR_TRY_RELOAD;}
globalLogger.log(message,{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(serverResponse)});deferred.reject(uploaderError);return;}
globalLogger.log('qgApiHelper addConversion done','conversion: '+JSON.stringify(conversion));deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper addConversion fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.startJob=function(jobId,serializedForm){assertIsUUID4(jobId);var api=this.api;if(typeof serializedForm==='undefined'){serializedForm='';}
assertIsString(serializedForm);var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId+'/start';options.data=serializedForm;var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);if(serverResponseHasErrorCode(serverResponse)){globalLogger.log('qgApiHelper startJob fail error code',{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(serverResponse)});var error=uploaderErrors.UNKNOWN;if(serverResponse.code===1012){error=uploaderErrors.INVALID_API_KEY;}
if(serverResponse.code===1013){error=uploaderErrors.ERROR_TRY_RELOAD;}
deferred.reject(error);return;}
globalLogger.log('qgApiHelper startJob done');deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper startJob fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.savePreset=function(conversionOptions){var api=this.api;var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/presets';options.data=conversionOptions;options.maxRetries=2;var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);if(serverResponseHasErrorCode(serverResponse)){globalLogger.log('qgApiHelper savePreset fail error code',{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(serverResponse)});deferred.reject(uploaderErrors.UNKNOWN);return;}
globalLogger.log('qgApiHelper savePreset done');deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper savePreset fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.deleteInput=function(jobId,inputId){assertIsUUID4(jobId);assertIsUUID4(inputId);var api=this.api;var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId+'/input/'+inputId+'/delete';options.data=$.extend({},api.baseData);var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);if(serverResponseHasErrorCode(serverResponse)){globalLogger.log('qgApiHelper deleteInput fail error code',{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(serverResponse)});deferred.reject(uploaderErrors.UNKNOWN);return;}
globalLogger.log('qgApiHelper deleteInput done','input_id: '+inputId);deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper deleteInput fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};OcApiHelper.prototype.setPassword=function(jobId,inputId,password){assertIsUUID4(jobId);assertIsUUID4(inputId);assertIsString(password);var api=this.api;var options=$.extend({},api.baseAjaxOptions);options.url=this.baseUrlApi+'/api/jobs/'+jobId+'/input/'+inputId+'/patch';options.data=$.extend({},api.baseData);options.data.decrypt_password=password;var deferred=$.Deferred();api.ajaxWrapper.post(options).done(function(serverResponse,textStatus,jqXHR){serverResponse=api.fixOldBrowser(serverResponse);if(serverResponseHasErrorCode(serverResponse)){var message='qgApiHelper set password - fail error code';var uploaderError=uploaderErrors.UNKNOWN;if(serverResponse.code===1013){message='qgApiHelper addJobInput fail Csrf mismatch';uploaderError=uploaderErrors.ERROR_TRY_RELOAD;}
globalLogger.log(message,{info:'data: '+JSON.stringify(options.data)+' | response: '+JSON.stringify(serverResponse)});deferred.reject(uploaderError);return;}
globalLogger.log('qgApiHelper set password - done','input_id: '+inputId);deferred.resolve(serverResponse);}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('qgApiHelper set password - fail connection problem',jqXHR.status);deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};function SimpleCache(maxCacheTimeSeconds){assertIsNumber(maxCacheTimeSeconds);this.maxCacheTimeSeconds=maxCacheTimeSeconds;this.data={};}
SimpleCache.prototype.setData=function(id,data){assertIsNonEmptyString(id);assertIsNotNull(data);assertIsNotBoolean(data);this.data[id]={time_ms:Date.now(),data:data};};SimpleCache.prototype.getData=function(id){assertIsNonEmptyString(id);if(!this.data.hasOwnProperty(id)){return null;}
var ageInSeconds=(Date.now()-this.data[id].time_ms)/1000.0;if(ageInSeconds>this.maxCacheTimeSeconds){return false;}
return this.data[id].data;};SimpleCache.prototype.getDataEvenIfTooOld=function(id){assertIsNonEmptyString(id);if(!this.data.hasOwnProperty(id)){return null;}
return this.data[id].data;};var MAX_JOB_INFO_CACHING_TIME_SEC=2;function Api(type,config){assertIsNonEmptyString(type);this.apiHelper=null;if(type==='oc'){this.apiHelper=new OcApiHelper(this,config);}else if(type==='sat'){this.apiHelper=new SatApiHelper(this,config);}
assertIsNotNull(this.apiHelper);this.ajaxWrapper=new AjaxWrapper();this.jobCache=new SimpleCache(MAX_JOB_INFO_CACHING_TIME_SEC);this.numberOfCurrentJobInfoRequests={};this.baseData={};if(config.hasOwnProperty('baseApiData')){this.baseData=config.baseApiData;}
this.baseAjaxOptions={dataType:'json',crossDomain:true,xhrFields:{withCredentials:true},cache:false,maxRetries:5};}
Api.prototype.createJob=function(jobData){var apiHelper=this.apiHelper;try{return apiHelper.createJob(jobData);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.createJobWithUploadServerCheck=function(jobData,maxJobCreateRetries){if(!testIsNumber(maxJobCreateRetries)){maxJobCreateRetries=1;}
var deferred=$.Deferred();var _this=this;var currentJobCreateRetry=0;var createJob=function(){_this.apiHelper.createJob(jobData).done(function(rawJobInfo){checkUploadServer(rawJobInfo);}).fail(function(error){assertIsUploaderError(error);deferred.reject(error);});};var checkUploadServer=function(rawJobInfo){_this.checkUploadServer(rawJobInfo.server).done(function(){var uploadServerReachable=true;deferred.resolve(rawJobInfo,uploadServerReachable);}).fail(function(){if(currentJobCreateRetry>=maxJobCreateRetries){globalLogger.log('qgApiHelper createJob info','no upload server found');var uploadServerReachable=false;deferred.resolve(rawJobInfo,uploadServerReachable);return;}
currentJobCreateRetry++;var maxTimeoutMs=10000;var timeoutMs=currentJobCreateRetry*1000;if(timeoutMs>maxTimeoutMs){timeoutMs=maxTimeoutMs;}
setTimeout(function(){createJob();},timeoutMs);});};createJob();return deferred;};Api.prototype.checkUploadServer=function(serverUrl,maxRetries){assertIsNonEmptyString(serverUrl);if(!testIsNumber(maxRetries)){maxRetries=0;}
var aliveEndpointUrl=serverUrl.replace(/(\/dl.*)/,'/dl/alive');var options={url:aliveEndpointUrl,timeout:10000,maxRetries:maxRetries};var startTime_ms=Date.now();var deferred=$.Deferred();this.ajaxWrapper.get(options).done(function(response,textStatus,jqXHR){deferred.resolve();}).fail(function(jqXHR,textStatus,errorThrown){var uploadServer=serverUrl.match(/(www[^.]*)/)[0];var duration_s=(Date.now()-startTime_ms)/1000;globalLogger.log('qgApiHelper checkUploadServer fail upload server not available',{upload_server:uploadServer,http_status:jqXHR.status,ajax_status:textStatus,ajax_error:errorThrown,duration_s:duration_s});deferred.reject(uploaderErrors.CONNECTION_PROBLEM);});return deferred;};Api.prototype.getJobInfo=function(jobId){assertIsUUID4(jobId);var apiHelper=this.apiHelper;try{return apiHelper.getJobInfo(jobId);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.getCachedJobInfo=function(jobId){assertIsUUID4(jobId);var cachedData=this.jobCache.getData(jobId);assertIsNotNull(cachedData);if(!this.numberOfCurrentJobInfoRequests.hasOwnProperty(jobId)){this.numberOfCurrentJobInfoRequests[jobId]=0;}
var areJobInfoRequestsRunning=this.numberOfCurrentJobInfoRequests[jobId]>0;if(cachedData===false&&!areJobInfoRequestsRunning){return this.getJobInfo(jobId);}
var jobInfo=this.jobCache.getDataEvenIfTooOld(jobId);var deferred=$.Deferred();deferred.resolve(jobInfo);return deferred;};Api.prototype.addInput=function(jobId,inputData){assertIsUUID4(jobId);assertIsObject(inputData);var apiHelper=this.apiHelper;try{return apiHelper.addInput(jobId,inputData);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.addInputs=function(jobId,inputsData){assertIsUUID4(jobId);var apiHelper=this.apiHelper;try{return apiHelper.addInputs(jobId,inputsData);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.addInputId=function(jobId,inputId){assertIsUUID4(jobId);assertIsUUID4(inputId);var input={type:'input_id',source:inputId};return this.addInput(jobId,input);};Api.prototype.addExternalUrl=function(jobId,externalUrl){assertIsUUID4(jobId);assertIsNonEmptyString(externalUrl);var input={type:'remote',source:externalUrl};return this.addInput(jobId,input);};Api.prototype.addConversion=function(jobId,conversion){assertIsUUID4(jobId);var apiHelper=this.apiHelper;try{return apiHelper.addConversion(jobId,conversion);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.startJob=function(jobId,serializedForm){assertIsUUID4(jobId);var apiHelper=this.apiHelper;try{return apiHelper.startJob(jobId,serializedForm);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.deleteInput=function(jobId,inputId){assertIsUUID4(jobId);assertIsUUID4(inputId);var apiHelper=this.apiHelper;try{return apiHelper.deleteInput(jobId,inputId);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.setPassword=function(jobId,inputId,password){assertIsUUID4(jobId);assertIsUUID4(inputId);assertIsString(password);var apiHelper=this.apiHelper;try{return apiHelper.setPassword(jobId,inputId,password);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};Api.prototype.fixOldBrowser=function(serverResponse){if(typeof serverResponse!=='string'){return serverResponse;}
try{var newResponse=JSON.parse(serverResponse);if(typeof newResponse==='object'&&newResponse!==null){globalLogger.log('qgApiHelper server response was fixed',JSON.stringify(serverResponse));return newResponse;}}catch(e){}
globalLogger.log('qgApiHelper server response was not fixed',JSON.stringify(serverResponse));return serverResponse;};Api.prototype.waitForRemoteInput=function(jobId,inputId){assertIsUUID4(jobId);assertIsUUID4(inputId);var _this=this;var deferred=$.Deferred();var startMs=Date.now();var retry=function(){var secondsSinceStart=(Date.now()-startMs)/1000.0;var timeoutMs=5000;if(secondsSinceStart<10){timeoutMs=1000;}else if(secondsSinceStart<30){timeoutMs=2000;}else if(secondsSinceStart<60){timeoutMs=3000;}
setTimeout(tryToGetJobInfo,timeoutMs);};var handleInputFail=function(errorData,jobInfoRaw,secondsSinceStart){globalLogger.log('qgApiHelper waitForRemoteInput fail',{info:JSON.stringify(errorData),input_id:inputId,job_info:JSON.stringify(jobInfoRaw),duration_s:secondsSinceStart});var error=uploaderErrors.UNKNOWN;if(errorData.code===50||errorData.code===34){error=uploaderErrors.LIMITS_INPUT_TOO_LARGE;}else if(errorData.code===10){error=uploaderErrors.LIMITS_YOUTUBE_FORBIDDEN;}
return error;};var handleGetJobInfo=function(jobInfoRaw){var secondsSinceStart=(Date.now()-startMs)/1000.0;var jobInfoHelper=new JobInfoHelper(jobInfoRaw);var rawInputInfo=jobInfoHelper.getInput(inputId);if(rawInputInfo===null){if(secondsSinceStart>10){globalLogger.log('qgApiHelper waitForRemoteInput info',{info:'input id missing from job',input_id:inputId,job_info:JSON.stringify(jobInfoRaw),duration_s:secondsSinceStart});}
retry();return;}
if(jobInfoHelper.isInputDownloading(inputId)){retry();return;}
if(jobInfoHelper.isInputReady(inputId)){deferred.resolve(rawInputInfo);globalLogger.log('qgApiHelper waitForRemoteInput done',{input_id:inputId,duration_s:secondsSinceStart});return;}
var errorData={code:0,message:'should never happen'};var inputError=jobInfoHelper.getInputError(inputId);var inputWarning=jobInfoHelper.getInputWarning(inputId);if(inputError!==null){errorData=inputError;}else if(inputWarning!==null){errorData=inputWarning;}else if(rawInputInfo.status===inputStatusApi.FAILED){errorData={code:0,message:'server response is missing input warnings and input errrors'};}else if(rawInputInfo.status===inputStatusApi.CANCELED){errorData={code:0,message:'input was canceled'};}
var uploaderError=handleInputFail(errorData,jobInfoRaw,secondsSinceStart);deferred.reject(uploaderError);};var tryToGetJobInfo=function(){_this.getCachedJobInfo(jobId).done(function(jobInfoRaw){assertIsRawJobInfo(jobInfoRaw);handleGetJobInfo(jobInfoRaw);}).fail(function(error){assertIsUploaderError(error);if(error===uploaderErrors.PAYMENT_REQUIRED){deferred.reject(error);return;}
globalLogger.log('qgApiHelper waitForRemoteInput retry',{info:'error: '+error,input_id:inputId});retry();});};tryToGetJobInfo();return deferred;};Api.prototype.savePreset=function(conversionOptions){var apiHelper=this.apiHelper;try{return apiHelper.savePreset(conversionOptions);}catch(e){globalLogger.log('api wrapper exception',e);}
var deferred=$.Deferred();deferred.reject(uploaderErrors.EXCEPTION);return deferred;};var createSatApi=function(config){assertIsObject(config);return new Api('sat',config);};function Input(type){assertIsInputType(type);this._type=type;this._name='';this._callback=null;this._localId=null;this._size=null;this._inputId=null;this._status=inputStatusUploader.QUEUED;this._uploadData=null;}
Input.prototype.getType=function(){assertIsInputType(this._type);return this._type;};Input.prototype.getLocalId=function(){return this._localId;};Input.prototype.setLocalId=function(localId){assertIsNumber(localId);assertIsTrue(localId>=0);this._localId=localId;return this;};Input.prototype.getCallback=function(){return this._callback;};Input.prototype.setCallback=function(callback){assertIsFunction(callback);this._callback=callback;return this;};Input.prototype.getName=function(){return this._name;};Input.prototype.setName=function(name){assertIsString(name);this._name=name;return this;};Input.prototype.getSize=function(){return this._size;};Input.prototype.setSize=function(size){assertIsNumber(size);assertIsTrue(size>=0);this._size=size;return this;};Input.prototype.getInputId=function(){return this._inputId;};Input.prototype.setInputId=function(inputId){assertIsUUID4(inputId);this._inputId=inputId;return this;};Input.prototype.getStatus=function(){return this._status;};Input.prototype.setStatus=function(status){assertIsInputStatusUploader(status);this._status=status;return this;};Input.prototype.setUploadData=function(uploadData){assertIsTrue(this._type===inputTypes.FILE_UPLOAD);this._uploadData=uploadData;return this;};Input.prototype.getUploadData=function(){assertIsTrue(this._type===inputTypes.FILE_UPLOAD);assertIsNotNull(this._uploadData);return this._uploadData;};Input.prototype.isInApi=function(){return isInputInApi(this._status);};Input.prototype.isQueued=function(){return this._status===inputStatusUploader.QUEUED;};Input.prototype.isSubmitting=function(){return this._status===inputStatusUploader.SUBMITTING;};Input.prototype.isLoading=function(){return this._status===inputStatusUploader.LOADING;};Input.prototype.isDone=function(){return this._status===inputStatusUploader.DONE;};Input.prototype.isPasswordMissing=function(){return this._status===inputStatusUploader.PASSWORD_MISSING;};Input.prototype.isDeleting=function(){return this._status===inputStatusUploader.DELETING;};Input.prototype.isFileUploading=function(){if(this._type!==inputTypes.FILE_UPLOAD){return false;}
return this._status===inputStatusUploader.LOADING;};Input.prototype.isRemoteInputDownloading=function(){if(this._type===inputTypes.FILE_UPLOAD){return false;}
return this._status===inputStatusUploader.LOADING;};function EventHandler(){this.listener=[];}
EventHandler.prototype.register=function(callback){this.listener.push(callback);};EventHandler.prototype.dispatch=function(event,data1,data2,data3){if(!testIsNonEmptyString(event)){globalLogger.log('eventhandler fail','event is not a string');return;}
var callbacks=this.listener;$.each(callbacks,function(i,callback){try{callback(event,data1,data2,data3);}catch(e){globalLogger.log('eventhandler exception',e);}});};function Job(api,config){this._api=api;this._jobInfoHelper=null;this._isJobCreationFailed=false;this._isCreating=false;this._isUploadFallbackFeatureEnabled=false;if(config&&config.enableUploadFallback===true){this._isUploadFallbackFeatureEnabled=true;}
this._jobNeedsUploadFallback=false;}
Job.prototype.initFromExistingJob=function(jobId){assertIsNull(this._jobInfoHelper);assertIsFalse(this._isCreating);assertIsUUID4(jobId);var deferred=$.Deferred();var _this=this;_this._isCreating=true;this._api.getJobInfo(jobId).done(function(rawJobInfo){_this._jobInfoHelper=new JobInfoHelper(rawJobInfo);deferred.resolve(rawJobInfo);_this._isCreating=false;}).fail(function(error){_this._isJobCreationFailed=true;deferred.reject(error);_this._isCreating=false;});return deferred;};Job.prototype.create=function(jobData){assertIsNull(this._jobInfoHelper);assertIsFalse(this._isCreating);var deferred=$.Deferred();var _this=this;_this._isCreating=true;this._api.createJob(jobData).done(function(rawJobInfo){_this._jobInfoHelper=new JobInfoHelper(rawJobInfo);deferred.resolve(rawJobInfo);_this._isCreating=false;}).fail(function(error){_this._isJobCreationFailed=true;deferred.reject(error);_this._isCreating=false;});return deferred;};Job.prototype.createWithServerCheck=function(jobData){assertIsNull(this._jobInfoHelper);assertIsFalse(this._isCreating);var deferred=$.Deferred();var _this=this;_this._isCreating=true;this._api.createJobWithUploadServerCheck(jobData,2).done(function(rawJobInfo,uploadServerReachable){_this._jobInfoHelper=new JobInfoHelper(rawJobInfo);_this._isCreating=false;if(uploadServerReachable===false){if(_this._isUploadFallbackFeatureEnabled===true){_this._jobNeedsUploadFallback=true;}}
deferred.resolve(rawJobInfo);}).fail(function(error){_this._isJobCreationFailed=true;deferred.reject(error);_this._isCreating=false;});return deferred;};Job.prototype.isCreated=function(){return this._jobInfoHelper!==null;};Job.prototype.isCreating=function(){return this._isCreating;};Job.prototype.isFailed=function(){return this._isJobCreationFailed;};Job.prototype.jobNeedsUploadFallback=function(){return this._jobNeedsUploadFallback;};Job.prototype.getId=function(){assertIsFalse(this._isJobCreationFailed);if(this._jobInfoHelper===null){return null;}
return this._jobInfoHelper.getId();};Job.prototype.getConversionId=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getConversionId();};Job.prototype.getConversionTarget=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getConversionTarget();};Job.prototype.getUploadToken=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getToken();};Job.prototype.getServerUrl=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getServer();};Job.prototype.getUploadUrl=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getUploadUrl();};Job.prototype.getRedirectUploadUrl=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getRedirectedUploadUrl();};Job.prototype.getJobInfo=function(){assertIsFalse(this._isJobCreationFailed);assertIsNotNull(this._jobInfoHelper);var deferred=$.Deferred();var _this=this;this._api.getJobInfo(_this.getId()).done(function(jobInfoRaw){assertIsRawJobInfo(jobInfoRaw);_this._jobInfoHelper=new JobInfoHelper(jobInfoRaw);deferred.resolve(jobInfoRaw);}).fail(function(error){assertIsUploaderError(error);deferred.reject(error);});return deferred;};Job.prototype.getCachedJobInfo=function(){assertIsFalse(this._isJobCreationFailed);assertIsNotNull(this._jobInfoHelper);var deferred=$.Deferred();var _this=this;this._api.getCachedJobInfo(_this.getId()).done(function(jobInfoRaw){assertIsRawJobInfo(jobInfoRaw);_this._jobInfoHelper=new JobInfoHelper(jobInfoRaw);deferred.resolve(jobInfoRaw);}).fail(function(error){assertIsUploaderError(error);deferred.reject(error);});return deferred;};Job.prototype.getRawJobInfo=function(){assertIsFalse(this._isJobCreationFailed);return this._jobInfoHelper.getRawJobInfo();};Job.prototype.waitForRemoteInput=function(inputId){var jobId=this._jobInfoHelper.getId();return this._api.waitForRemoteInput(jobId,inputId);};var DEFAULT_MAX_NUMBER_OF_INPUTS=60;var countInputsWithFunction=function(inputs,f){assertIsArray(inputs);assertIsFunction(f);var n=0;$.each(inputs,function(id,input){if(f(input)){n++;}});return n;};function InputList(config){this._inputs=[];this._maxNumberOfInputs=DEFAULT_MAX_NUMBER_OF_INPUTS;if(config.hasOwnProperty('maxNumberOfInputs')){this._maxNumberOfInputs=config.maxNumberOfInputs;}}
InputList.prototype._assertThatInputExists=function(localId){assertArrayHasIndex(this._inputs,localId);};InputList.prototype.getInput=function(localId){assertIsNumber(localId);this._assertThatInputExists(localId);return this._inputs[localId];};InputList.prototype.getInputs=function(){return this._inputs;};InputList.prototype.addInput=function(input){var localId=this._inputs.length;input.setLocalId(localId);this._inputs.push(input);return localId;};InputList.prototype.isInputLimitReached=function(){var numberOfInputsInApi=this.getNumberOfInputsInApi();assertIsFalse(numberOfInputsInApi>this._maxNumberOfInputs);return numberOfInputsInApi>=this._maxNumberOfInputs;};InputList.prototype.getNumberOfAllInputs=function(){return this._inputs.length;};InputList.prototype.getNumberOfQueuedInputs=function(){var f=function(input){return input.isQueued();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfInputsInApi=function(){var f=function(input){return input.isInApi();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfDoneInputs=function(){var f=function(input){return input.isDone();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfDeletingInputs=function(){var f=function(input){return input.isDeleting();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfActiveFileUploads=function(){var f=function(input){return input.isFileUploading();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfSubmittingInputs=function(){var f=function(input){return input.isSubmitting();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfLoadingInputs=function(){var f=function(input){return input.isLoading();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfActiveRemoteInputsDownloading=function(){var f=function(input){return input.isRemoteInputDownloading();};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getNumberOfPasswordMissing=function(){var f=function(input){return input.getStatus()===inputStatusUploader.PASSWORD_MISSING;};return countInputsWithFunction(this._inputs,f);};InputList.prototype.getBytesInJob=function(){var bytesInJob=0;var f=function(localId,input){if(input.isLoading()||input.isDone()||input.isPasswordMissing()){bytesInJob+=input.getSize();}};$.each(this._inputs,f);return bytesInJob;};function AddExternalUrl(uploader,config){this._uploader=uploader;}
AddExternalUrl.prototype.add=function(url){assertIsString(url);var _uploader=this._uploader;var callback=function(localId){var deferred=$.Deferred();var jobId=_uploader.getJob().getId();_uploader.getInput(localId).setStatus(inputStatusUploader.SUBMITTING);_uploader.getInput(localId).setName(url);_uploader.dispatchInputEvent(inputEvents.SUBMITTING,localId);if(url.trim()===''){var errorData={error:uploaderErrors.UNKNOWN};_uploader.failInput(localId,errorData);deferred.resolve();return deferred;}
_uploader.getApiHelper().addExternalUrl(jobId,url).done(function(rawInputInfo){assertIsRawInputInfo(rawInputInfo);var inputId=rawInputInfo.id;_uploader.getInput(localId).setInputId(inputId);_uploader.getInput(localId).setStatus(inputStatusUploader.LOADING);_uploader.dispatchInputEvent(inputEvents.LOADING,localId);_uploader.waitForRemoteInput(localId);deferred.resolve();}).fail(function(error){assertIsUploaderError(error);var errorData={error:error};_uploader.failInput(localId,errorData);deferred.resolve();});return deferred;};var input=new Input(inputTypes.EXTERNAL_URL);input.setName(url).setCallback(callback);this._uploader._queueInput(input);};function AddDropbox(uploader,config){this._uploader=uploader;this._maxFileSize=config.maxFileSize;}
AddDropbox.prototype.add=function(){if(!window.hasOwnProperty('Dropbox')){globalLogger.log('qgMultiUpload dropbox fail','dropbox JS missing');alert('Dropbox could not be initialized, please try again later!');return;}
var _uploader=this._uploader;var _this=this;var _dbCallback=function(files){$.each(files,function(key,value){var url=value.link;var size=0;var name='Dropbox';if(value.hasOwnProperty('bytes')&&typeof value.bytes==='number'){size=value.bytes;}
if(value.hasOwnProperty('name')){name=value.name;}
helper(url,size,name);});};var helper=function(url,size,name){var callback=function(localId){var deferred=$.Deferred();_uploader.getInput(localId).setName(name);_uploader.getInput(localId).setSize(size);var totalSize=_uploader.getBytesInJob()+size;if(totalSize>_this._maxFileSize){var errorData={error:uploaderErrors.LIMITS_INPUT_TOO_LARGE,size:totalSize};globalLogger.log('qgMultiUpload dropbox fail',{info:'file too large',filename:name,file_size:size,max_file_size:_this._maxFileSize});_uploader.failInput(localId,errorData);_uploader.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);return deferred.resolve();}
var jobId=_uploader.getJob().getId();_uploader.getInput(localId).setStatus(inputStatusUploader.SUBMITTING);_uploader.dispatchInputEvent(inputEvents.SUBMITTING,localId);_uploader.getApiHelper().addExternalUrl(jobId,url).done(function(rawInputInfo){assertIsRawInputInfo(rawInputInfo);var inputId=rawInputInfo.id;_uploader.getInput(localId).setInputId(inputId);_uploader.getInput(localId).setStatus(inputStatusUploader.LOADING);_uploader.dispatchInputEvent(inputEvents.LOADING,localId);_uploader.waitForRemoteInput(localId);deferred.resolve();}).fail(function(error){assertIsUploaderError(error);var errorData={error:error};_uploader.failInput(localId,errorData);deferred.resolve();});return deferred;};var input=new Input(inputTypes.DROPBOX);input.setName(name).setSize(size).setCallback(callback);_uploader._queueInput(input);};var options={success:_dbCallback,linkType:'direct',multiselect:true};Dropbox.choose(options);};var createUUID4=function(){function s4(){return Math.floor((1+Math.random())*0x10000).toString(16).substring(1);}
return s4()+s4()+'-'+s4()+'-'+s4()+'-'+s4()+'-'+s4()+s4()+s4();};var isPasswordMissing=function(metadata){var hasPasswordProtectedField=metadata.hasOwnProperty('password_protected');var hasPasswordValidField=metadata.hasOwnProperty('password_valid');var hasPdfUserPasswordField=metadata.hasOwnProperty('pdf_has_user_password');var hasPdfOwnerPasswordField=metadata.hasOwnProperty('pdf_has_owner_password');var hasPdfPasswordValidField=metadata.hasOwnProperty('pdf_password_valid');if(!hasPasswordValidField&&!hasPasswordProtectedField){return false;}
if(hasPasswordProtectedField&&metadata.password_protected===false){if(hasPdfUserPasswordField&&metadata.pdf_has_user_password===true){globalLogger.error('password helper info','password fields broken: '+JSON.stringify(metadata));}
if(hasPdfOwnerPasswordField&&metadata.pdf_has_owner_password===true){globalLogger.error('password helper info','password fields broken: '+JSON.stringify(metadata));}
return false;}
if(!hasPasswordValidField||!hasPasswordProtectedField){globalLogger.error('password helper info','password fields broken: '+JSON.stringify(metadata));return false;}
if(metadata.password_protected!==true&&metadata.password_protected!==false){globalLogger.error('password helper info','password_protected not a boolean value: '+JSON.stringify(metadata));}
if(metadata.password_protected!==true){return false;}
var hasNoPdfPasswordFields=!hasPdfOwnerPasswordField&&!hasPdfUserPasswordField&&!hasPdfPasswordValidField;if(hasNoPdfPasswordFields){var passwordValid=metadata.password_valid===true;return!passwordValid;}
if(!hasPdfOwnerPasswordField||!hasPdfUserPasswordField||!hasPdfPasswordValidField){globalLogger.error('password helper info','pdf password fields missing: '+JSON.stringify(metadata));return false;}
if(metadata.password_valid!==metadata.pdf_password_valid){globalLogger.error('password helper info','pdf password valid inconsistent state: '+JSON.stringify(metadata));return false;}
if(metadata.pdf_has_user_password===true){return!metadata.pdf_password_valid;}
return false;};function RetryHandler(maxRetries){this._maxRetries=20;this._maxTimeOut_s=10;if(typeof maxRetries==='number'){this._maxRetries=maxRetries;}
this._currentRetry=0;this._sucessfulChunks=0;this._failedChunks=0;}
RetryHandler.prototype.getCurrentRetry=function(){return this._currentRetry;};RetryHandler.prototype.getSuccessfullChunks=function(){return this._sucessfulChunks;};RetryHandler.prototype.getFailedChunks=function(){return this._failedChunks;};RetryHandler.prototype.handleChunkSuccess=function(){this._currentRetry=0;this._sucessfulChunks++;};RetryHandler.prototype.handleChunkFail=function(){this._currentRetry++;this._failedChunks++;};RetryHandler.prototype.isAllowedToRetry=function(){return this._currentRetry<=this._maxRetries;};RetryHandler.prototype.getTimeOutForNextChunk_s=function(){var timeOut_s=2*this._currentRetry;if(timeOut_s>this._maxTimeOut_s){return this._maxTimeOut_s;}
return timeOut_s;};RetryHandler.prototype.getTimeOutForNextChunk_ms=function(){return this.getTimeOutForNextChunk_s()*1000;};var logRetryInfo=function(data){var ajax_status=0;var ajax_error='';var info='';try{logChangeFileData(data);info='current retry: '+data.pgRetryHandler.getCurrentRetry();info+=' | uploaded bytes: '+data.uploadedBytes;info+=' | file size: '+data.files[0].size;info+=' | file name: '+data.files[0].name;try{info+=' | file last modified: '+data.files[0].lastModified;}catch(e){}
if(!data.hasOwnProperty('jqXHR')){info+=' | jqXHR missing!';}
try{if(data.jqXHR.hasOwnProperty('status')){info+=' | status code: '+data.jqXHR.status;}}catch(e){}
try{if(data.jqXHR.hasOwnProperty('responseText')){if(typeof data.jqXHR.responseText==='string'){info+=' | response text: '+data.jqXHR.responseText.substr(0,512);}else{info+=' | response text: NOT A STRING '+JSON.stringify(data.jqXHR.responseText);}}}catch(e){}
try{if(data.jqXHR.hasOwnProperty('responseJSON')){if(typeof data.jqXHR.responseJSON==='object'){info+=' | response json: '+JSON.stringify(data.jqXHR.responseJSON);}else{info+=' | response json: NOT AN OBJECT '+JSON.stringify(data.jqXHR.responseJSON);}}}catch(e){}
if(data.hasOwnProperty('url')){if(typeof data.url!=='string'){info+=' | url: URL NOT A STRING';}else if(data.url===''){info+=' | url: EMPTY URL';}else{info+=' | url: "'+data.url+'"';}}else{info+=' | url: NO URL';}
if(data.hasOwnProperty('headers')){info+=' | headers: '+JSON.stringify(data.headers);}else{info+=' | headers: NO HEADERS';}
ajax_status=data.textStatus;ajax_error=data.errorThrown;}catch(e){info='exception during logging';if(e.hasOwnProperty('message')){info+=': '+e.message;}}
globalLogger.log('qgMultiUpload fileUpload retry',{info:info,ajax_status:ajax_status,ajax_error:ajax_error});};var logFailInfo=function(data){var ajax_status=0;var ajax_error='';var info='';try{logChangeFileData(data);info='retries: '+data.pgRetryHandler.getCurrentRetry();info+=' | uploaded bytes: '+data.uploadedBytes;try{info+=' | file size: '+data.files[0].size;}catch(e){}
try{info+=' | file last modified: '+data.files[0].lastModified;}catch(e){}
try{info+=' | server response: '+data.jqXHR.responseText.substr(0,250);}catch(e){}
try{info+=' | server error message: '+data.jqXHR.responseJSON.error.substr(0,250);}catch(e){}
try{info+=' | status code: '+data.jqXHR.status;}catch(e){}
ajax_status=data.textStatus;ajax_error=data.errorThrown;}catch(e){info='exception during logging';if(e.hasOwnProperty('message')){info+=': '+e.message;}}
globalLogger.log('qgMultiUpload fileUpload fail',{info:info,ajax_status:ajax_status,ajax_error:ajax_error});};var logChangeFileData=function(data){var currentFilename=null;var currentFilesize=null;var currentLastModified=null;try{if(testIsNonEmptyString(data.files[0].name)){currentFilename=data.files[0].name;}}catch(e){}
try{if(testIsNumber(data.files[0].size)){currentFilesize=data.files[0].size;}}catch(e){}
try{if(testIsNumber(data.files[0].lastModified)){currentLastModified=data.files[0].lastModified;}}catch(e){}
if(currentFilename!==data.pgInitialName||currentFilesize!==data.pgInitialSize){var info='name initial: '+
data.pgInitialName+
' name now: '+
currentFilename+
' size initial: '+
data.pgInitialSize+
' size now: '+
currentFilesize+
' last modified now: '+
currentLastModified;globalLogger.log('qgMultiUpload fileUpload info - file data changed',{info:info});}};function DynamicChunkHandler(){this._baseChunkSize=1000000;this._minChunkSize=100000;this._maxChunkSize=100000000;this._speedModifier=3;this._maxSpeedModifier=5;}
DynamicChunkHandler.prototype.increaseChunkSpeed=function(){this._limitSpeed(++this._speedModifier);};DynamicChunkHandler.prototype.resetChunkSpeed=function(){this._speedModifier=1;};DynamicChunkHandler.prototype.getDynamicChunkSize=function(fileData){try{var progress=fileData.progress();if(progress.loaded===0){var firstChunkSize=this._baseChunkSize;if(fileData.pgRetryHandler.getCurrentRetry()>0){firstChunkSize=this._minChunkSize;}
return firstChunkSize;}
if(this._speedModifier===1){return this._minChunkSize;}
var chunkSize=parseInt(progress.bitrate)*this._speedModifier;return this._limitChunk(chunkSize);}catch(e){return this._baseChunkSize;}};DynamicChunkHandler.prototype._limitChunk=function(chunkSize){return Math.max(this._minChunkSize,Math.min(chunkSize,this._maxChunkSize));};DynamicChunkHandler.prototype._limitSpeed=function(speed){this._speedModifier=Math.max(1,Math.min(speed,this._maxSpeedModifier));};var AddFileUpload=function(uploader,config){assertIsObject(config);this._uploader=uploader;this._maxFileSize=config.maxFileSize;this._enablePasswords=config.enablePasswords===true;this._isUploadFallbackFeatureEnabled=config.enableUploadFallback===true;this._dynamicChunkHandler=new DynamicChunkHandler();assertIsNonEmptyString(config.fileUploadInputId);assertIsTrue($(config.fileUploadInputId).length===1);var _this=this;var getCurrentChunkSize=function(fileData){return _this._dynamicChunkHandler.getDynamicChunkSize(fileData);};var fileUploaderOptions={singleFileUploads:true,sequentialUploads:false,maxChunkSize:getCurrentChunkSize,autoUpload:false,progressInterval:500,messages:{unknownError:'Unknown error',maxNumberOfFiles:'Maximum number of files exceeded',acceptFileTypes:'File type not allowed',maxFileSize:'File is too large',minFileSize:'File is too small',uploadedBytes:'Uploaded bytes exceed file size'}};var inputElement=$(config.fileUploadInputId);var fileuploader=inputElement.fileupload(fileUploaderOptions);fileuploader.on('fileuploadadd',function(e,fileData){_this._processFileUploadAdd(e,fileData);});fileuploader.on('fileuploadsubmit',function(e,fileData){_this._processFileUploadSubmit(e,fileData);});fileuploader.on('fileuploaddone',function(e,fileData){_this._processFileUploadDone(e,fileData);});fileuploader.on('fileuploadfail',function(e,fileData){_this._processFileUploadFail(e,fileData);});fileuploader.on('fileuploadprogress',function(e,fileData){_this._processFileUploadProgress(e,fileData);});fileuploader.on('fileuploadchunkdone',function(e,fileData){fileData.pgRetryHandler.handleChunkSuccess();_this._dynamicChunkHandler.increaseChunkSpeed();});};AddFileUpload.prototype._processFileUploadAdd=function(event,data){var filename='file';try{if(testIsNonEmptyString(data.files[0].name)){filename=data.files[0].name;}}catch(e){}
data.pgInitialName=filename;var filesize=0;try{if(testIsNumber(data.files[0].size)){filesize=data.files[0].size;}}catch(e){}
data.pgInitialSize=filesize;var fileLastModified=0;try{if(testIsNumber(data.files[0].lastModified)){fileLastModified=data.files[0].lastModified;}}catch(e){}
if(filename==='file'||filesize===0){try{var info='name: '+filename+' size: '+filesize;globalLogger.log('qgMultiUpload fileUpload info incorrect file data',info);}catch(e){}}
var _this=this;var _uploader=this._uploader;var callBack=function(localId){var deferred=$.Deferred();_uploader.getInput(localId).setName(filename);_uploader.getInput(localId).setSize(filesize);var totalSize=_uploader.getBytesInJob()+filesize;if(totalSize>_this._maxFileSize){var errorData={error:uploaderErrors.LIMITS_INPUT_TOO_LARGE,size:totalSize};globalLogger.log('qgMultiUpload fileUpload fail file too large',{info:'file too large',filename:filename,total_size:totalSize,file_size:filesize,max_file_size:_this._maxFileSize});_uploader.failInput(localId,errorData);_uploader.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);return deferred.resolve();}
var job=_uploader.getJob();data.url=job.getUploadUrl();if(_this._isUploadFallbackFeatureEnabled&&job.jobNeedsUploadFallback()){data.url=job.getRedirectUploadUrl();}
data.pgLocalId=localId;_uploader.getInput(localId).setStatus(inputStatusUploader.LOADING);_uploader.dispatchInputEvent(inputEvents.LOADING,localId);data.headers={'X-Oc-Upload-Uuid':createUUID4(),'X-Oc-Token':_uploader.getJob().getUploadToken()};data.pgRetryHandler=new RetryHandler();var info='file name: '+filename+' file size: '+filesize+' file last modified: '+fileLastModified;globalLogger.log('qgMultiUpload fileUpload start',{info:info});data.submit();deferred.resolve();return deferred;};var input=new Input(inputTypes.FILE_UPLOAD);input.setCallback(callBack).setSize(filesize).setName(filename).setUploadData(data);_uploader._queueInput(input);};AddFileUpload.prototype._processFileUploadSubmit=function(event,data){return true;};AddFileUpload.prototype._processFileUploadDone=function(event,data){if(typeof data.result==='string'){globalLogger.log('qgMultiUpload fileUpload info',{info:'sever response was not parsed by browser',server_response:JSON.stringify(data.result)});try{data.result=JSON.parse(data.result);}catch(e){globalLogger.log('qgMultiUpload fileUpload fail',{info:'server response could not be parsed as JSON',server_response:JSON.stringify(data.result)});}}
var uploadedFileInfo=data.result;if(!testIsUploadedFileInfoObject(uploadedFileInfo)){globalLogger.log('qgMultiUpload fileUpload fail - invalid response',{info:'response: '+JSON.stringify(uploadedFileInfo)});this._uploader.failInput(data.pgLocalId);return;}
if(uploadedFileInfo.completed!==true){globalLogger.log('qgMultiUpload fileUpload fail - not completed',{info:'response: '+JSON.stringify(uploadedFileInfo)});this._uploader.failInput(data.pgLocalId);return;}
var localId=data.pgLocalId;var inputId=uploadedFileInfo.id.input;this._uploader.getInput(localId).setInputId(inputId);var filename=data.files[0].name;var filesize=data.files[0].size;this._uploader.getInput(localId).setName(filename);this._uploader.getInput(localId).setSize(filesize);var passwordMissing=isPasswordMissing(uploadedFileInfo.metadata);if(this._enablePasswords&&passwordMissing){this._uploader.getInput(localId).setStatus(inputStatusUploader.PASSWORD_MISSING);this._uploader.dispatchInputEvent(inputEvents.PASSWORD_MISSING,localId);}else{this._uploader.getInput(localId).setStatus(inputStatusUploader.DONE);this._uploader.dispatchInputEvent(inputEvents.DONE,localId);}
if(data.pgRetryHandler.getFailedChunks()>0){globalLogger.log('qgMultiUpload fileUpload info',{info:'upload needed retries',input_id:inputId,filename:filename});}
globalLogger.log('qgMultiUpload fileUpload done',{input_id:inputId,info:'file name: '+filename+' file size: '+filesize});};AddFileUpload.prototype._processFileUploadFail=function(event,data){this._dynamicChunkHandler.resetChunkSpeed();data.pgRetryHandler.handleChunkFail();if(data.errorThrown==='abort'){globalLogger.log('qgMultiUpload fileUpload abort',{ajax_status:data.textStatus,ajax_error:data.errorThrown});return;}
var hasJsonResponse=false;try{hasJsonResponse=typeof data.jqXHR.responseJSON==='object';}catch(e){}
var uploadServerErrorCode=null;try{uploadServerErrorCode=data.jqXHR.responseJSON.error_code;}catch(e){}
var problemUploadingFile=uploadServerErrorCode===uploadServerErrors.PROBLEM_UPLOADING_FILE;if(!hasJsonResponse||problemUploadingFile){var retriesAvailable=data.uploadedBytes<data.files[0].size&&data.pgRetryHandler.isAllowedToRetry();if(retriesAvailable){if(this._isUploadFallbackFeatureEnabled&&data.uploadedBytes===0&&data.pgRetryHandler.getCurrentRetry()===3){globalLogger.log('qgMultiUpload fileUpload info','use upload redirect');var job=this._uploader.getJob();data.url=job.getRedirectUploadUrl();}
logRetryInfo(data);var retry=function(){data.submit();};window.setTimeout(retry,data.pgRetryHandler.getTimeOutForNextChunk_ms());return;}}
var errorData={error:uploaderErrors.UNKNOWN};if(uploadServerErrorCode===uploadServerErrors.FILE_TOO_LARGE||uploadServerErrorCode===uploadServerErrors.SUM_OF_UPLOADS_TOO_LARGE){errorData.error=uploaderErrors.LIMITS_INPUT_TOO_LARGE;}
logFailInfo(data);this._uploader.failInput(data.pgLocalId,errorData);};AddFileUpload.prototype._processFileUploadProgress=function(event,data){var progressData={bitrate:data.bitrate,bytesLoaded:data.loaded,bytesTotal:data.total};this._uploader.dispatchInputEvent(inputEvents.UPLOAD_PROGRESS,data.pgLocalId,progressData);};var pickerApiLoaded=false;var scope=['https://www.googleapis.com/auth/drive.readonly','https://www.googleapis.com/auth/drive.install'];var picker;function AddGdrive(uploader,config){this._uploader=uploader;this._oauthToken=null;this._maxFileSize=config.maxFileSize;this._clientId=null;this._developerKey=null;if(testIsNonEmptyString(config.gdriveClientId)&&testIsNonEmptyString(config.gdriveDeveloperKey)){this._clientId=config.gdriveClientId;this._developerKey=config.gdriveDeveloperKey;}}
AddGdrive.prototype.add=function(name,token,fileId,mimeType){if(this._clientId===null||this._developerKey===null){return;}
var _this=this;var _uploader=this._uploader;function loadPicker(){window.gapi.load('auth',{callback:onAuthApiLoad});window.gapi.load('picker',{callback:onPickerApiLoad});}
function onAuthApiLoad(){assertIsNonEmptyString(_this._clientId);window.gapi.auth.authorize({client_id:_this._clientId,scope:scope,immediate:false},handleAuthResult);}
function onPickerApiLoad(){pickerApiLoaded=true;createPicker();}
function handleAuthResult(authResult){if(authResult&&!authResult.error){_this._oauthToken=authResult.access_token;createPicker();}}
function createPicker(){if(pickerApiLoaded&&_this._oauthToken){assertIsNonEmptyString(_this._developerKey);var view=new google.picker.View(google.picker.ViewId.DOCS);picker=new google.picker.PickerBuilder().enableFeature(google.picker.Feature.NAV_HIDDEN).enableFeature(google.picker.Feature.MULTISELECT_ENABLED).setOAuthToken(_this._oauthToken).addView(view).addView(new google.picker.DocsUploadView()).setDeveloperKey(_this._developerKey).setCallback(_gdriveCallback).build();picker.setVisible(true);}}
var _gdriveCallback=function(data){if(typeof data.action==='undefined'||data.action!=='picked'){return;}
if(typeof data.docs==='undefined'){return;}
$.each(data.docs,function(key,value){var size=0;var name='gDrive';if(value.hasOwnProperty('sizeBytes')&&typeof value.sizeBytes==='number'){size=value.sizeBytes;}
if(value.hasOwnProperty('name')){name=value.name;}
helper(_this._oauthToken,name,size,value.id,value.mimeType);});};var helper=function(token,name,size,file_id,content_type){var callback=function(localId){var deferred=$.Deferred();_uploader.getInput(localId).setName(name);_uploader.getInput(localId).setSize(size);var totalSize=_uploader.getBytesInJob()+size;if(totalSize>_this._maxFileSize){var errorData={error:uploaderErrors.LIMITS_INPUT_TOO_LARGE,size:totalSize};globalLogger.log('qgMultiUpload gdrive fail',{info:'file too large',filename:name,file_size:size,max_file_size:_this._maxFileSize});_uploader.failInput(localId,errorData);_uploader.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);return deferred.resolve();}
var jobId=_uploader.getJob().getId();_uploader.getInput(localId).setStatus(inputStatusUploader.SUBMITTING);_uploader.dispatchInputEvent(inputEvents.SUBMITTING,localId);_uploader.getApiHelper().addInput(jobId,{type:'gdrive_picker',source:file_id,credentials:{token:token},filename:name,content_type:content_type}).done(function(inputInfo){var inputId=inputInfo.id;_uploader.getInput(localId).setInputId(inputId);_uploader.getInput(localId).setStatus(inputStatusUploader.LOADING);_uploader.dispatchInputEvent(inputEvents.LOADING,localId);_uploader.waitForRemoteInput(localId);deferred.resolve();}).fail(function(error){var errorData={error:uploaderErrors.UNKNOWN};if(error.hasOwnProperty('code')&&error.hasOwnProperty('text')){if(error.code===50||error.code===34){errorData.error=uploaderErrors.LIMITS_INPUT_TOO_LARGE;}}
globalLogger.log('qgMultiUpload gdrive fail',{info:'file too large',filename:name,file_size:size,max_file_size:_this._maxFileSize});_uploader.failInput(localId,errorData);_uploader.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);deferred.resolve();});return deferred;};var input=new Input(inputTypes.GDRIVE);input.setCallback(callback).setName(name).setSize(size);_uploader._queueInput(input);};if(typeof name==='string'&&typeof token==='string'&&typeof fileId==='string'&&typeof mimeType==='string'){helper(token,name,0,fileId,mimeType);return;}
var hasGapi=window.hasOwnProperty('gapi');var hasGapiLoad=hasGapi&&window.gapi.hasOwnProperty('load');if(!hasGapi||!hasGapiLoad){globalLogger.log('qgMultiUpload gdrive fail','gapi missing');alert('Google Drive could not be initialized, please try again later!');return;}
if(typeof picker==='undefined'){loadPicker();return;}
picker.setVisible(true);};function AddInputId(uploader,config){this._uploader=uploader;}
AddInputId.prototype.add=function(inputId){assertIsString(inputId);var _uploader=this._uploader;var callback=function(localId){var deferred=$.Deferred();var jobId=_uploader.getJob().getId();_uploader.getInput(localId).setStatus(inputStatusUploader.SUBMITTING);_uploader.getInput(localId).setName(inputId);_uploader.dispatchInputEvent(inputEvents.SUBMITTING,localId);_uploader.getApiHelper().addInputId(jobId,inputId).done(function(rawInputInfo){assertIsRawInputInfo(rawInputInfo);var inputId=rawInputInfo.id;_uploader.getInput(localId).setInputId(inputId);_uploader.getInput(localId).setStatus(inputStatusUploader.LOADING);_uploader.dispatchInputEvent(inputEvents.LOADING,localId);_uploader.waitForRemoteInput(localId);deferred.resolve();}).fail(function(error){assertIsUploaderError(error);var errorData={error:error};_uploader.failInput(localId,errorData);deferred.resolve();});return deferred;};var input=new Input(inputTypes.INPUT_ID);input.setCallback(callback).setName(inputId);this._uploader._queueInput(input);};var isYouTubeUrl=function(url){assertIsString(url);url=url.replace(/\s/g,'');if(url===''){return false;}
var hostname='';try{var parser=document.createElement('a');parser.href=url;hostname=parser.hostname;hostname=hostname.toLowerCase();}catch(e){return false;}
return(hostname.indexOf('youtube.com')!==-1||hostname.indexOf('youtu.be')!==-1||hostname.indexOf('googlevideo.com')!==-1);};function Uploader(apiHelper,config){assertIsObject(config);this._apiHelper=apiHelper;this._isEnabled=true;this._inputList=new InputList(config);this._inputEventHandler=new EventHandler();this._globalEventHandler=new EventHandler();this._job=new Job(apiHelper,config);this._addExternalUrlHelper=new AddExternalUrl(this,config);this._addDropboxHelper=new AddDropbox(this,config);this._addGdriveHelper=new AddGdrive(this,config);this._addInputIdHelper=new AddInputId(this,config);this._addFileUploadHelper=new AddFileUpload(this,config);this._queueIsBeingProcessed=false;this._sentLogAboutMaxInputs=false;this._maxFileSize=8589934592;if(testIsNumber(config.maxFileSize)){this._maxFileSize=config.maxFileSize;}
this._blockYouTubeUrls=true;this._singleInput=config.maxNumberOfInputs===1;this._enablePasswords=config.enablePasswords===true;this._showPasswordOnlyForSingleInput=config.showPasswordOnlyForSingleInput===true;if(config.hasOwnProperty('blockYouTubeUrls')){this._blockYouTubeUrls=config.blockYouTubeUrls;}
this._jobData={};if(config.hasOwnProperty('jobData')){this._jobData=config.jobData;}
if(config.hasOwnProperty('jobId')){this._initFromJobId(config.jobId);}}
Uploader.prototype._initFromJobId=function(jobId){assertIsUUID4(jobId);var _this=this;this._job.initFromExistingJob(jobId).done(function(rawJobInfo){var jobInfo=new JobInfoHelper(rawJobInfo);var inputs=jobInfo.getInputs();_this._tryToSetSatLimitsFromJobInfo(rawJobInfo);var processSingleInput=function(idx,rawInput){var apiStatus=rawInput.status;if(apiStatus===inputStatusApi.FAILED||apiStatus===inputStatusApi.CANCELED){return;}
var type=inputTypes.EXTERNAL_URL;if(rawInput.type==='upload'){type=inputTypes.FILE_UPLOAD;}
if(rawInput.type==='gdrive_picker'){type=inputTypes.GDRIVE;}
var input=new Input(type);input.setName(rawInput.filename).setSize(rawInput.size).setInputId(rawInput.id);var localId=_this._inputList.addInput(input);_this.dispatchInputEvent(inputEvents.QUEUED,localId);if(apiStatus===inputStatusApi.DOWNLOADING){input.setStatus(inputStatusUploader.LOADING);_this.dispatchInputEvent(inputEvents.LOADING,localId);_this.waitForRemoteInput(localId);return;}
if(apiStatus===inputStatusApi.READY){var passwordMissing=isPasswordMissing(rawInput.metadata);if(this._enablePasswords&&passwordMissing){input.setStatus(inputStatusUploader.PASSWORD_MISSING);_this.dispatchInputEvent(inputEvents.PASSWORD_MISSING,localId);}else{input.setStatus(inputStatusUploader.DONE);_this.dispatchInputEvent(inputEvents.DONE,localId);}
return;}
globalLogger.error('qgMultiUpload init fail unknown input status',JSON.stringify(rawInput));};$.each(inputs,processSingleInput);_this._submitNextQueuedInput();}).fail(function(error){});};Uploader.prototype.enable=function(){this._isEnabled=true;};Uploader.prototype.disable=function(){this._isEnabled=false;};Uploader.prototype.isEnabled=function(){return this._isEnabled;};Uploader.prototype.isEmpty=function(){var inputs=this.getInputList();return inputs.getNumberOfQueuedInputs()===0&&inputs.getNumberOfInputsInApi()===0;};Uploader.prototype.isReadyToSubmit=function(ignoreMissingPasswords){var inputs=this.getInputList();if(inputs.getNumberOfQueuedInputs()>0){return false;}
if(inputs.getNumberOfInputsInApi()===0){return false;}
if(inputs.getNumberOfSubmittingInputs()>0){return false;}
if(inputs.getNumberOfActiveFileUploads()>0){return false;}
if(inputs.getNumberOfDeletingInputs()>0){return false;}
if(inputs.getNumberOfPasswordMissing()>0){if(ignoreMissingPasswords===true){return true;}else{return false;}}
return true;};Uploader.prototype.isWaitingForPasswords=function(){var inputs=this.getInputList();return inputs.getNumberOfPasswordMissing()>0;};Uploader.prototype.registerInputEventCallback=function(callback){assertIsFunction(callback);this._inputEventHandler.register(callback);};Uploader.prototype.dispatchInputEvent=function(event,localId,data){assertIsInputEvent(event);this._inputEventHandler.dispatch(event,localId,data);};Uploader.prototype.registerGlobalEventCallback=function(callback){assertIsFunction(callback);this._globalEventHandler.register(callback);};Uploader.prototype.dispatchGlobalEvent=function(event,localId,data){assertIsGlobalEvent(event);this._globalEventHandler.dispatch(event,localId,data);};Uploader.prototype.getJob=function(){return this._job;};Uploader.prototype.getInput=function(localId){return this._inputList.getInput(localId);};Uploader.prototype.getInputList=function(){return this._inputList;};Uploader.prototype.getApiHelper=function(){return this._apiHelper;};Uploader.prototype._queueInput=function(newInput){if(!this._isEnabled){return;}
if(this._job.isFailed()){return;}
var localId=this._inputList.addInput(newInput);this.dispatchInputEvent(inputEvents.QUEUED,localId);var input=this.getInput(localId);var size=input.getSize();if(size>this._maxFileSize){var errorDataSize={error:uploaderErrors.LIMITS_INPUT_TOO_LARGE,size:size};globalLogger.log('qgMultiUpload queue fail',{info:'file too large',filename:input.getName(),file_size:size,max_file_size:this._maxFileSize});this.failInput(localId,errorDataSize);this.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);return;}
if(this._blockYouTubeUrls&&input.getType()===inputTypes.EXTERNAL_URL){var url=input.getName();if(isYouTubeUrl(url)){var errorDataYoutube={error:uploaderErrors.LIMITS_YOUTUBE_FORBIDDEN};this.failInput(localId,errorDataYoutube);this.dispatchGlobalEvent(globalEvents.LIMITS_YOUTUBE_FORBIDDEN);return;}}
if(this._job.isCreating()){return;}
if(this._job.isCreated()){if(!this._queueIsBeingProcessed){this._submitNextQueuedInput();}
return;}
var _this=this;this.dispatchGlobalEvent(globalEvents.JOB_CREATE_START);this._job.createWithServerCheck(this._jobData).done(function(rawJobInfo){assertIsRawJobInfo(rawJobInfo);globalLogger.addLogData('job_id',_this._job.getId());_this._tryToSetSatLimitsFromJobInfo(rawJobInfo);_this.dispatchGlobalEvent(globalEvents.JOB_CREATE_DONE);_this._submitNextQueuedInput();}).fail(function(error){assertIsUploaderError(error);_this._failQueuedInputs(error);_this.dispatchGlobalEvent(globalEvents.JOB_CREATE_FAIL);});};Uploader.prototype._submitNextQueuedInput=function(){this._queueIsBeingProcessed=true;var queuedInputLocalId=this._getNextQueuedInput();if(queuedInputLocalId===null){this._queueIsBeingProcessed=false;return;}
if(this.isInputLimitReached()){this._queueIsBeingProcessed=false;this._failQueuedInputs(uploaderErrors.LIMITS_TOO_MANY_INPUTS);this.dispatchGlobalEvent(globalEvents.LIMITS_TOO_MANY_INPUTS);if(!this._sentLogAboutMaxInputs){globalLogger.log('qgMultiUpload processQueuedInputs fail max number of inputs');this._sentLogAboutMaxInputs=true;}
return;}
var queuedInput=this._inputList.getInput(queuedInputLocalId);var inputTooLarge=queuedInput.getSize()>this._maxFileSize;var jobTooLarge=queuedInput.getSize()+this._inputList.getBytesInJob()>this._maxFileSize;if(inputTooLarge||jobTooLarge){var errorDataSize={error:uploaderErrors.LIMITS_INPUT_TOO_LARGE,size:queuedInput.getSize()};globalLogger.log('qgMultiUpload queue fail',{info:'file too large',filename:queuedInput.getName(),file_size:queuedInput.getSize(),max_file_size:this._maxFileSize});this.failInput(queuedInputLocalId,errorDataSize);this.dispatchGlobalEvent(globalEvents.LIMITS_INPUT_TOO_LARGE);if(this._getNextQueuedInput()===null){this._queueIsBeingProcessed=false;return;}
this._submitNextQueuedInput();return;}
var sendInputToApi=queuedInput.getCallback();var _this=this;sendInputToApi(queuedInput.getLocalId()).always(function(){if(_this._getNextQueuedInput()===null){_this._queueIsBeingProcessed=false;return;}
_this._submitNextQueuedInput();});};Uploader.prototype._getNextQueuedInput=function(){var nextLocalId=null;var inputs=this._inputList.getInputs();$.each(inputs,function(localId,input){if(input.getStatus()===inputStatusUploader.QUEUED&&nextLocalId===null){nextLocalId=localId;}});return nextLocalId;};Uploader.prototype.failInput=function(localId,errorData){if(typeof errorData==='undefined'){errorData={error:uploaderErrors.UNKNOWN};}
this.getInput(localId).setStatus(inputStatusUploader.FAILED);this.dispatchInputEvent(inputEvents.FAIL,localId,errorData);};Uploader.prototype.deleteInput=function(localId){if(!this._isEnabled){return;}
var input=this.getInput(localId);var status=input.getStatus();if(status===inputStatusUploader.DELETING){return;}
var canBeDeleted=function(){if(status===inputStatusUploader.PASSWORD_MISSING){return true;}
if(status===inputStatusUploader.DONE){return true;}
return false;};if(!canBeDeleted()){throw new Error('wrong state for being deleted');}
input.setStatus(inputStatusUploader.DELETING);var _this=this;this._apiHelper.deleteInput(this._job.getId(),input.getInputId()).done(function(){input.setStatus(inputStatusUploader.DELETED);_this.dispatchInputEvent(inputEvents.DELETED,localId);}).fail(function(error){assertIsUploaderError(error);input.setStatus(status);});};Uploader.prototype.cancelFileUpload=function(localId){if(!this._isEnabled){return;}
var input=this.getInput(localId);if(input.getType()!==inputTypes.FILE_UPLOAD){throw new Error('only file uploads can be canceled');}
var status=input.getStatus();if(status!==inputStatusUploader.LOADING){globalLogger.log('qgMultiUpload fileUpload wrong state while canceling');return;}
var uploadData=input.getUploadData();uploadData.abort();input.setStatus(inputStatusUploader.DELETED);this.dispatchInputEvent(inputEvents.UPLOAD_CANCELED,localId);};Uploader.prototype._failQueuedInputs=function(error){var errorData={error:uploaderErrors.UNKNOWN};if(typeof error!=='undefined'){assertIsUploaderError(error);errorData.error=error;}
var _this=this;var inputs=this._inputList.getInputs();$.each(inputs,function(localId,input){if(input.getStatus()===inputStatusUploader.QUEUED){_this.failInput(localId,errorData);}});};Uploader.prototype.getBytesInJob=function(){return this._inputList.getBytesInJob();};Uploader.prototype.isInputLimitReached=function(){return this._inputList.isInputLimitReached();};Uploader.prototype.waitForRemoteInput=function(localId){var inputId=this.getInput(localId).getInputId();var _this=this;this._job.waitForRemoteInput(inputId).done(function(rawInputInfo){assertIsRawInputInfo(rawInputInfo);_this.getInput(localId).setSize(rawInputInfo.size);_this.getInput(localId).setName(rawInputInfo.filename);var passwordMissing=isPasswordMissing(rawInputInfo.metadata);if(_this._enablePasswords&&passwordMissing){_this.getInput(localId).setStatus(inputStatusUploader.PASSWORD_MISSING);_this.dispatchInputEvent(inputEvents.PASSWORD_MISSING,localId);}else{_this.getInput(localId).setStatus(inputStatusUploader.DONE);_this.dispatchInputEvent(inputEvents.DONE,localId);}}).fail(function(error){assertIsUploaderError(error);var errorData={error:error};_this.failInput(localId,errorData);});};Uploader.prototype.addInputId=function(id){this._addInputIdHelper.add(id);};Uploader.prototype.addExternalUrl=function(url){this._addExternalUrlHelper.add(url);};Uploader.prototype.addExternalUrls=function(urls){assertIsArray(urls);var addExternalUrlHelper=this._addExternalUrlHelper;urls.forEach(function(url){addExternalUrlHelper.add(url);});};Uploader.prototype.addDropbox=function(){this._addDropboxHelper.add();};Uploader.prototype.addGdrive=function(name,token,fileId,mimeType){this._addGdriveHelper.add(name,token,fileId,mimeType);};Uploader.prototype.startJob=function(serializedForm){assertIsNonEmptyString(serializedForm);var jobId=this._job.getId();return this._apiHelper.startJob(jobId,serializedForm);};Uploader.prototype.savePreset=function(conversionOptions){return this._apiHelper.savePreset(conversionOptions);};Uploader.prototype._tryToSetSatLimitsFromJobInfo=function(jobInfo){var constraints=null;try{constraints=jobInfo.sat.product.constraints;}catch(e){}
if(constraints===null){return;}
try{var maxFileSize=constraints.job.general.max_size;if(typeof maxFileSize==='string'){maxFileSize=parseInt(maxFileSize);}
if(testIsNumber(maxFileSize)&&!isNaN(maxFileSize)&&maxFileSize>0){this._maxFileSize=maxFileSize;}}catch(e){}
try{if(!this._singleInput){var maxInputs=constraints.job.inputs.max_count;if(typeof maxInputs==='string'){maxInputs=parseInt(maxInputs);}
if(testIsNumber(maxInputs)&&!isNaN(maxInputs)&&maxInputs>0){this._inputList._maxNumberOfInputs=maxInputs;}}}catch(e){}};var formatting={fileSize:function(bytes){var GB_SIZE=1073741824;var MB_SIZE=1048576;var KB_SIZE=1024;if(typeof bytes!=='number'){return '';}
if(bytes>=GB_SIZE){return(bytes/GB_SIZE).toFixed(2)+' GB';}
if(bytes>=MB_SIZE){return(bytes/MB_SIZE).toFixed(2)+' MB';}
if(bytes>=KB_SIZE){return(bytes/KB_SIZE).toFixed(2)+' KB';}
if(bytes!==1){return bytes.toFixed(2)+' bytes';}
return bytes.toFixed(2)+' byte';},bitrate:function(bits){if(typeof bits!=='number'){return '';}
if(bits>=1000000000){return(bits/1000000000).toFixed(2)+' Gbit/s';}
if(bits>=1000000){return(bits/1000000).toFixed(2)+' Mbit/s';}
if(bits>=1000){return(bits/1000).toFixed(2)+' kbit/s';}
return bits.toFixed(2)+' bit/s';},time:function(seconds){assertIsNumber(seconds);var date=new Date(seconds*1000);var days=Math.floor(seconds/86400);var d=days?days+'d ':'';var h=('0'+date.getUTCHours()).slice(-2);var m=('0'+date.getUTCMinutes()).slice(-2);var s=('0'+date.getUTCSeconds()).slice(-2);if(seconds<60*60){return m+':'+s;}
return d+h+':'+m+':'+s;},percentage:function(floatValue){assertIsNumber(floatValue);assertIsTrue(floatValue>=-0.1);assertIsTrue(floatValue<=1.1);return(floatValue*100).toFixed(0);}};var initialized=false;var setupEvents=function(){if(initialized){return;}
initialized=true;$(document).on('click','[data-hide-alert]',function(){var selector='.'+$(this).attr('data-hide-alert');$(this).closest(selector).removeClass('show');return false;});};var notificationBootstrapDeprecated={show:function(selector){if(!initialized){setupEvents();}
$(selector).addClass('show');},hide:function(selector){if(!initialized){setupEvents();}
$(selector).removeClass('show');},remove:function(selector){if(!initialized){setupEvents();}
$(selector).remove();},isVisible:function(selector){if(!initialized){setupEvents();}
$(selector).is(':visible');},alerts:{INPUT_MISSING:'.alert-input-missing',PASSWORD_MISSING:'.alert-password-missing',PASSWORD_WRONG:'.alert-password-wrong',INVALID_API_KEY:'.alert-invalid-api-key',ERROR_TRY_RELOAD:'.alert-try-reload'}};var translate=function(message){try{message=Translator.trans(message);}catch(e){globalLogger.log('translator exception',e.message);}
return message;};var BOOTSTRAP_INFO='info';var BOOTSTRAP_WARNING='warning';var BOOTSTRAP_SUCCESS='success';var BOOTSTRAP_ERROR='danger';var bootstrapNotifyWrapper=function(message,type){try{message=translate(message);$.notify({message:message},{type:type,placement:{from:'top',align:'right'}});}catch(e){}};var pageNotification={info:function(message){bootstrapNotifyWrapper(message,BOOTSTRAP_INFO);},warning:function(message){bootstrapNotifyWrapper(message,BOOTSTRAP_WARNING);},success:function(message){bootstrapNotifyWrapper(message,BOOTSTRAP_SUCCESS);},error:function(message){bootstrapNotifyWrapper(message,BOOTSTRAP_ERROR);}};var renderTemplate=function(templateName,options){assertIsNonEmptyString(templateName,'invalid template name');if(typeof options==='undefined'){options={};}
assertIsObject(options);var templateFunction=tmpl(templateName);var result=templateFunction(options);if(result instanceof $){return result;}
return $('<div></div>').html(result).children();};function UploadUi(type,uploader,config){assertIsObject(uploader);assertIsObject(config);assertObjectHasKey(config,'fileListSelector','file input selector missing');assertIsTrue($(config.fileListSelector).length===1,'could not find file input element');assertIsTrue(type==='oc'||type==='sat','invalid ui type');this._uploader=uploader;this._type=type;this._apiHelper=this._uploader.getApiHelper();this.oldBitrates=[];this.fileListSelector=config.fileListSelector;this.showPasswordOnlyForSingleInput=config.showPasswordOnlyForSingleInput===true;this.showFailedInput=config.showFailedInput!==false;var _this=this;var cb=function(event,localId,data){_this.callback(event,localId,data);};this._uploader.registerInputEventCallback(cb);var inputs=this._uploader.getInputList();if(inputs.getNumberOfAllInputs()!==0){globalLogger.log('qgMultiUpload ui started with a non-empty job');}}
UploadUi.prototype._getFileList=function(){var $fileList=$(this.fileListSelector);assertIsTrue($fileList.length===1,'cant find file input element');return $fileList;};UploadUi.prototype._createNewRow=function(localId){assertIsNumber(localId);var $fileList=this._getFileList();var $html=renderTemplate('template-base-row');$html.addClass('local-id-'+localId);$html.addClass('uploader-input-element');$fileList.append($html);};UploadUi.prototype._updateRow=function(localId,templateName,options){assertIsNumber(localId);assertIsNonEmptyString(templateName);var $row=this._getRow(localId);var template=renderTemplate(templateName,options);$row.html(template);};UploadUi.prototype._hideRow=function(localId){assertIsNumber(localId);var $row=this._getRow(localId);$row.addClass('hidden');};UploadUi.prototype._getRow=function(localId){assertIsNumber(localId);var $fileList=this._getFileList();var row=$fileList.find('.local-id-'+localId);assertIsTrue(row.length===1,'cant find row: '+localId);return row;};UploadUi.prototype._updateInputStatusCssClass=function(localId,status){assertIsNumber(localId);assertIsInputStatusUploader(status);var $fileList=this._getFileList();var row=$fileList.find('.local-id-'+localId);assertIsTrue(row.length===1,'cant find row: '+localId);var classList=row.attr('class').split(/\s+/);$.each(classList,function(index,className){if(className.indexOf('input-status-')===0){row.removeClass(className);}});if(status===inputStatusUploader.QUEUED){row.addClass('input-status-queued');}else if(status===inputStatusUploader.SUBMITTING){row.addClass('input-status-submitting');}else if(status===inputStatusUploader.LOADING){row.addClass('input-status-loading');}else if(status===inputStatusUploader.DONE){row.addClass('input-status-done');}else if(status===inputStatusUploader.FAILED){row.addClass('input-status-failed');}else if(status===inputStatusUploader.PASSWORD_MISSING){row.addClass('input-status-password-missing');}else if(status===inputStatusUploader.DELETING){row.addClass('input-status-deleting');}else if(status===inputStatusUploader.DELETED){row.addClass('input-status-deleted');}else{row.addClass('input-status-unknown');}
return row;};var _startSpinningAnimation=function(inputId){$('.input-id-'+inputId+' i').removeClass('fa-unlock-alt');$('.input-id-'+inputId+' i').addClass('fa-spin fa-spinner');};var _stopSpinningAnimation=function(inputId){$('.input-id-'+inputId+' i').removeClass('fa-spin fa-spinner');$('.input-id-'+inputId+' i').addClass('fa-unlock-alt');};UploadUi.prototype.enablePwInput=function(localId){var $row=this._getRow(localId);var pwgroup=$row.find('.password-inputs');var pwinput=$row.find('input[type="password"]');var pwbutton=$row.find('.pwbutton');pwinput.keydown(function(e){if(e.keyCode==13){pwbutton.trigger('click',pwButtonFunction);}});if(!pwgroup.hasClass('hidden')){return;}
pwgroup.removeClass('hidden');var input=this._uploader.getInput(localId);var inputId=input.getInputId();pwbutton.addClass('input-id-'+inputId);var _this=this;var jobId=this._uploader.getJob().getId();var disableButton=function(){_startSpinningAnimation(inputId);pwbutton.prop('disabled',true);};var enableButton=function(){_stopSpinningAnimation(inputId);pwbutton.prop('disabled',false);};var pwButtonFunction=function(){var password=pwinput.val();if(password===''){return;}
disableButton();_this._apiHelper.setPassword(jobId,inputId,password).done(function(data){enableButton();var passwordMissing=isPasswordMissing(data.metadata);if(passwordMissing){pwinput.val('');if(_this._type==='oc'){notificationBootstrapDeprecated.show(notificationBootstrapDeprecated.alerts.PASSWORD_WRONG);}
if(_this._type==='sat'){pageNotification.warning('Wrong password, please enter the correct one!');}
return;}
pwgroup.addClass('hidden');_this._uploader.getInput(localId).setStatus(inputStatusUploader.DONE);_this._uploader.dispatchInputEvent(inputEvents.DONE,localId);}).fail(function(errorMessage){pwinput.val('');enableButton();globalLogger.log('qgMultiUpload set password fail',errorMessage+'input id: '+inputId);if(_this._type==='oc'){if(errorMessage===uploaderErrors.ERROR_TRY_RELOAD){notificationBootstrapDeprecated.show(notificationBootstrapDeprecated.alerts.ERROR_TRY_RELOAD);}else{notificationBootstrapDeprecated.show(notificationBootstrapDeprecated.alerts.PASSWORD_WRONG);}}
if(_this._type==='sat'){pageNotification.error('Failed to set password. Please try again!');}});};pwbutton.on('click',pwButtonFunction);$('.pwd').submit(function(){return false;});};UploadUi.prototype.enableDeleteButton=function(localId){var $row=this._getRow(localId);var _this=this;$row.find('.deletebutton').click(function(){_this._uploader.deleteInput(localId);});};UploadUi.prototype.enableFileUploadCancelButton=function(localId){var $row=this._getRow(localId);var _this=this;$row.find('.cancelbutton').click(function(){_this._uploader.cancelFileUpload(localId);});};UploadUi.prototype._showPasswordEntryField=function(localId){var status=this._uploader.getInput(localId).getStatus();if(status!==inputStatusUploader.PASSWORD_MISSING){return;}
var type=this._uploader.getInput(localId).getType();var name=this._uploader.getInput(localId).getName();var size=this._uploader.getInput(localId).getSize();var templateName=null;if(type===inputTypes.DROPBOX){templateName='template-dropbox-added';}else if(type===inputTypes.EXTERNAL_URL){templateName='template-external-url-added';}else if(type===inputTypes.FILE_UPLOAD){templateName='template-file-uploaded';}else if(type===inputTypes.GDRIVE){templateName='template-gdrive-added';}else if(type===inputTypes.INPUT_ID){templateName='template-external-url-added';}else{assertIsTrue(false);}
var options={name:name,size:formatting.fileSize(size)};this._updateRow(localId,templateName,options);this._updateInputStatusCssClass(localId,inputStatusUploader.PASSWORD_MISSING);this.enableDeleteButton(localId);this.enablePwInput(localId);};UploadUi.prototype._showUploadDone=function(localId){var type=this._uploader.getInput(localId).getType();var name=this._uploader.getInput(localId).getName();var size=this._uploader.getInput(localId).getSize();var templateName=null;if(type===inputTypes.DROPBOX){templateName='template-dropbox-added';}else if(type===inputTypes.EXTERNAL_URL){templateName='template-external-url-added';}else if(type===inputTypes.FILE_UPLOAD){templateName='template-file-uploaded';}else if(type===inputTypes.GDRIVE){templateName='template-gdrive-added';}else if(type===inputTypes.INPUT_ID){templateName='template-external-url-added';}else{assertIsTrue(false);}
var options={name:name,size:formatting.fileSize(size)};this._updateRow(localId,templateName,options);this._updateInputStatusCssClass(localId,inputStatusUploader.DONE);this.enableDeleteButton(localId);var inputList=this._uploader.getInputList();if(inputList.getNumberOfAllInputs()>1&&this.showPasswordOnlyForSingleInput){this._hideAllPasswordMissing();}};UploadUi.prototype._showStartLoading=function(localId){var type=this._uploader.getInput(localId).getType();var name=this._uploader.getInput(localId).getName();var size=this._uploader.getInput(localId).getSize();var templateName=null;if(type===inputTypes.DROPBOX){templateName='template-dropbox-adding';}else if(type===inputTypes.EXTERNAL_URL){templateName='template-external-url-adding';}else if(type===inputTypes.FILE_UPLOAD){templateName='template-file-uploading';}else if(type===inputTypes.GDRIVE){templateName='template-gdrive-adding';}else if(type===inputTypes.INPUT_ID){templateName='template-external-url-adding';}else{assertIsTrue(false);}
var options={name:name,size:formatting.fileSize(size)};this._updateRow(localId,templateName,options);this._updateInputStatusCssClass(localId,inputStatusUploader.LOADING);if(type===inputTypes.FILE_UPLOAD){this.enableFileUploadCancelButton(localId);}};UploadUi.prototype._showUploadFail=function(localId){if(this.showFailedInput===false){this._hideRow(localId);return;}
var type=this._uploader.getInput(localId).getType();var name=this._uploader.getInput(localId).getName();var size=this._uploader.getInput(localId).getSize();var templateName=null;if(type===inputTypes.DROPBOX){templateName='template-dropbox-fail';}else if(type===inputTypes.EXTERNAL_URL){templateName='template-external-url-fail';}else if(type===inputTypes.FILE_UPLOAD){templateName='template-file-upload-fail';}else if(type===inputTypes.GDRIVE){templateName='template-gdrive-fail';}else if(type===inputTypes.INPUT_ID){templateName='template-external-url-fail';}else{assertIsTrue(false);}
var options={name:name,size:formatting.fileSize(size)};var isTooManyFilesError=typeof data==='object'&&data.hasOwnProperty('error')&&data.error===uploaderErrors.LIMITS_TOO_MANY_INPUTS;if(isTooManyFilesError){templateName='template-file-upload-fail-too-many-files';}
this._updateRow(localId,templateName,options);this._updateInputStatusCssClass(localId,inputStatusUploader.FAILED);};UploadUi.prototype._showUploadDeleted=function(localId){this._hideRow(localId);this._updateInputStatusCssClass(localId,inputStatusUploader.DELETED);var inputList=this._uploader.getInputList();if(inputList.getNumberOfDoneInputs()===0&&inputList.getNumberOfPasswordMissing()===1&&this.showPasswordOnlyForSingleInput){var _this=this;$(inputList._inputs).each(function(key,input){if(input._status===inputStatusUploader.PASSWORD_MISSING){_this._showPasswordEntryField(input._localId);}});}};UploadUi.prototype._showUploadCanceled=function(localId){var name=this._uploader.getInput(localId).getName();var templateName='template-file-upload-canceled';var options={name:name};this._updateRow(localId,templateName,options);this._updateInputStatusCssClass(localId,inputStatusUploader.DELETED);};UploadUi.prototype._hideAllPasswordMissing=function(){$('.password-inputs').addClass('hidden');qgAlertHelper.hide(qgAlertHelper.alerts.PASSWORD_MISSING);qgAlertHelper.hide(qgAlertHelper.alerts.PASSWORD_WRONG);};UploadUi.prototype.onInputQueued=function(localId){this._createNewRow(localId);this._updateRow(localId,'template-waiting');this._updateInputStatusCssClass(localId,inputStatusUploader.QUEUED);};UploadUi.prototype.onStartLoading=function(localId){this._showStartLoading(localId);};UploadUi.prototype.onUploadDone=function(localId){this._showUploadDone(localId);};UploadUi.prototype.onPasswordMissing=function(localId){var inputList=this._uploader.getInputList();var inputsToCount=inputList.getNumberOfDoneInputs()+inputList.getNumberOfPasswordMissing();if(inputsToCount>1&&this.showPasswordOnlyForSingleInput){this._showUploadDone(localId);return;}
this._showPasswordEntryField(localId);};UploadUi.prototype.onUploadFail=function(localId,data){this._showUploadFail(localId);};UploadUi.prototype.onUploadDeleted=function(localId){this._showUploadDeleted(localId);};UploadUi.prototype.onUploadCanceled=function(localId){this._showUploadCanceled(localId);};UploadUi.prototype.getAveragedBitrate=function(localId,currentBitrate){if(typeof this.oldBitrates[localId]==='undefined'){this.oldBitrates[localId]=[];}
this.oldBitrates[localId].push(currentBitrate);var newestData=this.oldBitrates[localId].slice(-20);this.oldBitrates[localId]=newestData;var total=0;for(var i=0;i<newestData.length;i++){total+=newestData[i];}
return total/newestData.length;};UploadUi.prototype.onUploadProgress=function(localId,data){var progressText='';var progressPercentage=0;if(typeof data==='number'){progressText=data+'%';progressPercentage=data;}else if(typeof data==='object'){var rawPercentage=(data.bytesLoaded/data.bytesTotal)*100;progressPercentage=Math.floor(rawPercentage);var textPercentage=rawPercentage.toFixed(1)+'%';var bitrate=this.getAveragedBitrate(localId,data.bitrate);var bytesRemaining=data.bytesTotal-data.bytesLoaded;var secondsRemaining=(bytesRemaining*8)/bitrate;var timeLeft=formatting.time(secondsRemaining);progressText=textPercentage+' - '+timeLeft;}else{throw new Error('unknown data passed in progress event');}
var $row=this._getRow(localId);var $progressMain=$row.find('.progress');$progressMain.attr('aria-valuenow',progressPercentage);var $progressBar=$row.find('.progress-bar');$progressBar.css('width',progressPercentage+'%');var $progressText=$row.find('.progress-text');$progressText.text(progressText);};UploadUi.prototype.callback=function(event,localId,data){try{assertIsInputEvent(event);if(event===inputEvents.QUEUED){this.onInputQueued(localId);return;}
if(event===inputEvents.SUBMITTING){return;}
if(event===inputEvents.LOADING){this.onStartLoading(localId);return;}
if(event===inputEvents.UPLOAD_CANCELED){this.onUploadCanceled(localId);return;}
if(event===inputEvents.DELETED){this.onUploadDeleted(localId);return;}
if(event===inputEvents.PASSWORD_MISSING){this.onPasswordMissing(localId);return;}
if(event===inputEvents.DONE){this.onUploadDone(localId);return;}
if(event===inputEvents.FAIL){this.onUploadFail(localId,data);return;}
if(event===inputEvents.UPLOAD_PROGRESS){this.onUploadProgress(localId,data);return;}}catch(e){globalLogger.log('uploadui exception',e);}};var createSatUi=function(uploader,config){assertIsObject(config);return new UploadUi('sat',uploader,config);};var uploader=null;var ui=null;var api=null;window.qgEditorUI={images:{},loadImage:function(src){},getDataUri:function(url,callback){var image=new Image();image.crossOrigin='anonymous';image.onload=function(){var canvas=document.createElement('canvas');canvas.width=this.naturalWidth;canvas.height=this.naturalHeight;canvas.getContext('2d').drawImage(this,0,0);callback(canvas.toDataURL('image/png'),url);};image.src=url;},renderPages:function(pages){var $pageTpl=$('.page-tpl-box');var logBrokenThumbnailSent=false;$.each(pages,function(page,data){var realPage=++page;var $newPage=$pageTpl.clone();if(realPage>qgPdfEditor.maxPages){$newPage.addClass('disabled');}
$newPage.find('img').eq(1).attr('data-src',data.thumbnail);$newPage.find('.page-number').html(realPage);$newPage.removeClass('hidden');$newPage.addClass('lazy-page');$newPage.find('img').eq(1).attr('original-src',data.thumbnail);$newPage.find('img').eq(1).attr('data-page',realPage);$('.pages-container').append($newPage);if($newPage.visible(true)){window.qgEditorUI.loadImage(data.thumbnail);$newPage.find('img').eq(1).attr('src',data.thumbnail);}});$('.editor-page-img-load').on('error',function(e){$(this).addClass('hidden');if(!logBrokenThumbnailSent){var $page=$(this);var filename='';try{var imgSrc=$page.data('src');var srcParts=imgSrc.split('/');filename=srcParts[srcParts.length-1];}catch(e){}
globalLogger.info('pdf editor thumbnail fail','pageNumber: '+$page.data('page')+' filename: '+filename);logBrokenThumbnailSent=true;}
if($(this).attr('data-reloaded')==='true'){return;}
$(this).attr('src',$(this).attr('original-src')+'?t='+new Date().getTime());$(this).attr('data-reloaded','true');});$('.editor-page-img-load').one('load',function(e){if(qgOperation!=='edit'){window.qgEditorUI.getDataUri($(this).attr('src'),function(dataUri,url){$("img[src$='"+url+"']").attr('src',dataUri);});}
var $parent=$(this).parent();$parent.parent().removeClass('lazy-page');$parent.parent().find('.loading').addClass('hidden');$(this).removeClass('hidden');$parent.removeClass('hidden');if($(this).attr('data-page')==='1'&&$(this).attr('data-page-type')==='edit'){$parent.click();}});$('.panel').scroll(function(){$('.lazy-page').each(function(index){if($(this).visible(true)){var $image=$(this).find('img').eq(1);if($image.attr('src')!==$image.attr('data-src')){$image.attr('src',$image.attr('data-src'));}}});});$('.editor-stage').scroll(function(){$('.lazy-page').each(function(index){if($(this).visible(true)){var $image=$(this).find('img').eq(1);if(!$image.is('[src]')){$image.attr('src',$image.attr('data-src'));}}});});$('.menu-left').on('click','.page-tpl',window.qgPdfEditor.selectPage).on('click','.editor-rotate-left',qgPdfEditor.rotateLeft).on('click','.editor-rotate-right',qgPdfEditor.rotateRight).on('click','.editor-split',qgPdfEditor.splitAfter).on('click','.editor-delete',qgPdfEditor.delete);$('.editor-stage').on('click','.page-tpl',window.qgPdfEditor.selectPage).on('click','.editor-rotate-left',qgPdfEditor.rotateLeft).on('click','.editor-rotate-right',qgPdfEditor.rotateRight).on('click','.editor-split',qgPdfEditor.splitAfter).on('click','.editor-delete',qgPdfEditor.delete);$('.editor-toolbar').on('click','.editor-rotate-left-all',function(){$('.i-am-selected').each(function(){$(this).find('.editor-rotate-left').click();});if($('.i-am-selected').length===0){$('.page-tpl-box').each(function(){$(this).find('.editor-rotate-left').click();});}}).on('click','.editor-rotate-right-all',function(){$('.i-am-selected.page-container').each(function(){$(this).find('.editor-rotate-right').click();});if($('.i-am-selected.page-container').length===0){$('.page-tpl-box').each(function(){$(this).find('.editor-rotate-right').click();});}}).on('click','.editor-delete-all',function(){$('.selected.page-container').each(function(){$(this).find('.editor-delete').click();});if($('.selected.page-container').length===0){$('.page-container').each(function(){$(this).find('.editor-delete').click();});}}).on('click','.editor-sort-asc',function(){var list=$('.pages-container');var listItems=list.find('.page-tpl-box').sort(function(a,b){return(parseInt($(a).find('.page-number').html())-
parseInt($(b).find('.page-number').html()));});list.find('.page-tpl-box').remove();list.append(listItems);$('.editor-page-img-load').one('load',function(e){if(qgOperation!=='edit'){window.qgEditorUI.getDataUri($(this).attr('src'),function(dataUri,url){$("img[src$='"+url+"']").attr('src',dataUri);});}
var $parent=$(this).parent();$parent.parent().removeClass('lazy-page');$parent.parent().find('.loading').addClass('hidden');$(this).removeClass('hidden');$parent.removeClass('hidden');if($(this).attr('data-page')==='1'&&$(this).attr('data-page-type')==='edit'){$parent.click();}});$('.lazy-page').each(function(index){if($(this).visible(true)){var $image=$(this).find('img').eq(1);if(typeof $image.attr('src')==='undefined'){$image.attr('src',$image.attr('data-src'));}else{if($image.attr('src')!==$image.attr('data-src')){if($image.attr('src').indexOf('data')<0){$image.attr('src',$image.attr('data-src'));}}}}});return false;}).on('click','.editor-sort-desc',function(){var list=$('.pages-container');var listItems=list.find('.page-tpl-box').sort(function(a,b){return(parseInt($(b).find('.page-number').html())-
parseInt($(a).find('.page-number').html()));});list.find('.page-tpl-box').remove();list.append(listItems);$('.editor-page-img-load').one('load',function(e){if(qgOperation!=='edit'){window.qgEditorUI.getDataUri($(this).attr('src'),function(dataUri,url){$("img[src$='"+url+"']").attr('src',dataUri);});}
var $parent=$(this).parent();$parent.parent().removeClass('lazy-page');$parent.parent().find('.loading').addClass('hidden');$(this).removeClass('hidden');$parent.removeClass('hidden');if($(this).attr('data-page')==='1'&&$(this).attr('data-page-type')==='edit'){$parent.click();}});$('.lazy-page').each(function(index){if($(this).visible(true)){var $image=$(this).find('img').eq(1);if(typeof $image.attr('src')==='undefined'){$image.attr('src',$image.attr('data-src'));}else{if($image.attr('src')!==$image.attr('data-src')){if($image.attr('src').indexOf('data')<0){$image.attr('src',$image.attr('data-src'));}}}}});return false;}).on('click','.editor-split-all',function(){$('.page-container').each(function(){if(!$(this).parent().hasClass('split')){$(this).parent().find('.editor-split').click();}});}).on('click','.editor-reset-all',function(){$('.page-tpl-box').removeClass('split');$('.page-container').each(function(){if($(this).find('.deleted').length>0){$(this).parent().find('.editor-delete').click();}});var $page=$('.pages-container').find('img');var rotation=0;$page.attr('data-rotation',rotation);_rotateThumbnail($page,rotation);$('.editor-sort-asc').click();}).on('click','.editor-select-all',function(){var $pages=$('.page-container');if($pages.filter(':not(.selected)').length===0){$pages.removeClass('selected');return false;}
$pages.addClass('selected');}).on('click','.editor-split-selected',function(){$('.page-container.selected').each(function(){$(this).find('.editor-split').click();});});window.qgPdfEditor.initLC();},registerListener:function(){$('#submitBtn').on('click',qgPdfEditor.submit);$('#submitBtnEdit').on('click',qgPdfEditor.submitEdit);$('#colorpicker-tool-bg').spectrum({preferredFormat:'hex',showInput:true,showPalette:false,showButtons:false,showAlpha:true,clickoutFiresChange:true,allowEmpty:true,change:function(color){if(color===null){qgPdfEditor.lc.setColor('secondary','transparent');qgPdfEditor.colorBg={rgba:'transparent',hex:'transparent',alpha:'transparent'};return;}
qgPdfEditor.lc.setColor('secondary',color.toRgbString());qgPdfEditor.colorBg={rgba:color.toRgbString(),hex:'#'+color.toHex(),alpha:color.getAlpha()};if(qgPdfEditor.activeTool==='tool-rectangle'||qgPdfEditor.activeTool==='tool-ellipse'||qgPdfEditor.activeTool==='tool-polygon'||qgPdfEditor.activeTool==='tool-highlighter'){qgPdfEditor.lc.tool.setOriginalFillColor(qgPdfEditor.colorBg.hex);qgPdfEditor.lc.tool.setFillColor(qgPdfEditor.colorBg.rgba);qgPdfEditor.lc.tool.setRectAlpha(qgPdfEditor.colorBg.alpha);}}});$('#colorpicker-tool-fg').spectrum({preferredFormat:'hex',showInput:true,showPalette:false,showButtons:false,showAlpha:true,clickoutFiresChange:true,allowEmpty:true,change:function(color){if(color===null){qgPdfEditor.lc.setColor('primary','transparent');qgPdfEditor.colorFg={rgba:'transparent',hex:'transparent',alpha:'transparent'};return;}
qgPdfEditor.lc.setColor('primary',color.toRgbString());qgPdfEditor.colorFg={rgba:color.toRgbString(),hex:'#'+color.toHex(),alpha:color.getAlpha()};if(qgPdfEditor.activeTool==='tool-rectangle'||qgPdfEditor.activeTool==='tool-ellipse'||qgPdfEditor.activeTool==='tool-polygon'){qgPdfEditor.lc.tool.setOriginalFillColor(qgPdfEditor.colorBg.hex);qgPdfEditor.lc.tool.setFillColor(qgPdfEditor.colorBg.rgba);qgPdfEditor.lc.tool.setRectAlpha(qgPdfEditor.colorBg.alpha);}}});}};var qgThumbnailHelper={getThumbnails:function(jobId){var sentLogAboutMissingStatus=false;var getInfoHelper=function(){api.getJobInfo(jobId).done(function(response){var statusCode=null;try{statusCode=response.status.code;}catch(e){}
if(statusCode==='completed'){$('.ui-loader').addClass('hidden');$('.ui-loading').removeClass('hidden');$('.menu-left-options').addClass('hidden');window.qgPdfEditor.setupPagesFromJob(response);qgPdfEditor.originalJob=response;return;}
if(statusCode==='failed'){window.allowLeave=true;if(typeof window.previousPage==='string'){window.location=window.previousPage;return;}
globalLogger.log('pdf editor previousUrl not defined for '+qgOperation);var redirectUrl=window.location.protocol+'//'+window.location.host;var pathParts=window.location.pathname.split('/');if(pathParts.length===3){redirectUrl+='/'+pathParts[1];}else if(pathParts.length===4){redirectUrl+='/'+pathParts[2];}
window.location=redirectUrl;return;}
if(statusCode===null){if(sentLogAboutMissingStatus===false){sentLogAboutMissingStatus=true;globalLogger.log('pdf editor problem with missing status code');}}
setTimeout(function(){getInfoHelper();},1000);});};getInfoHelper();}};var mergeHelper={init:function(config){$('.ui-loading').removeClass('hidden');uploader=new Uploader(api,config);ui=createSatUi(uploader,config);window.qgUploader=uploader;window.qgPdfEditor.originalJob={id:config.jobId};mergeHelper.uploader=uploader;var inputCallback=function(event,localId,data2,data3){if(event===inputEvents.QUEUED){mergeHelper.addPage(uploader.getJob().getId(),uploader.getInput(localId).getInputId(),localId,uploader.getInput(localId).getName());return;}
if(event===inputEvents.DONE){mergeHelper.donePage(uploader.getJob().getId(),uploader.getInput(localId).getInputId(),localId);return;}
var needsRemoval=event===inputEvents.FAIL||event===inputEvents.UPLOAD_CANCELED||event===inputEvents.DELETED;if(needsRemoval){mergeHelper.removePage(localId);return;}};uploader.registerInputEventCallback(inputCallback);var limitCallback=function(event,data1,data2,data3){if(event===globalEvents.LIMITS_INPUT_TOO_LARGE||event===globalEvents.LIMITS_TOO_MANY_INPUTS||event===globalEvents.LIMITS_JOB_TOO_LARGE){try{limitReached(event);}catch(e){}}};uploader.registerGlobalEventCallback(limitCallback);$('.editor-stage').on('click','.editor-merge-delete',mergeHelper.deleteButton);uploadHelper.setupUploadButtons(uploader);mergeHelper.syncPages(window.qgPdfEditor.originalJob.id);mergeHelper.registerListener();},startMergeConversion:function(job){if(qgPdfEditor.finishedUploads!==qgPdfEditor.totalUploads){setTimeout(function(){mergeHelper.startMergeConversion(job);},3000);return;}
var conversion=conversionOptions.getConversionOptionsFromForm('#sendform');api.addConversion(job.id,conversion).then(function(data){if(sat.locale!=='en'){window.location='/'+sat.locale+'/result/'+job.id;}else{window.location='/result/'+job.id;}});},addMergeInputs:function(job,inputsToMerge){if(inputsToMerge.length===0){return;}
var inputToUpload=inputsToMerge.shift();api.addInputId(job.id,inputToUpload).then(function(){qgPdfEditor.finishedUploads++;mergeHelper.addMergeInputs(job,inputsToMerge);});},submitMerge:function(){var inputs=uploader.getInputList();if(inputs.getNumberOfInputsInApi()===0){return;}
window.allowLeave=true;$(this).attr('disabled',true);$(this).find('i').removeClass('fa-save');$(this).find('i').addClass('fa-spin fa-spinner');if(uploadHelper.hasActiveUploads()){setTimeout(function(){mergeHelper.submitMerge();},1000);return;}
api.createJob({operation:'merge',previousJob:window.qgPdfEditor.originalJob.id}).then(function(job){var inputsToMerge=[];$('.pages-container').find('.page-tpl-box').each(function(index){qgPdfEditor.totalUploads++;inputsToMerge.push($(this).attr('data-input'));});mergeHelper.addMergeInputs(job,inputsToMerge);mergeHelper.startMergeConversion(job);});},registerListener:function(){$('#submitBtn').on('click',mergeHelper.submitMerge);$('.editor-toolbar').on('click','.editor-sort-alphabetical-asc',function(){var list=$('.pages-container');var listItems=list.find('.page-tpl-box').sort(function(a,b){var filenameA=$(a).find('.filename').html().toUpperCase();var filenameB=$(b).find('.filename').html().toUpperCase();return filenameA.localeCompare(filenameB);});list.find('.page-tpl-box').remove();list.append(listItems);mergeHelper.updatePageNumbers();return false;}).on('click','.editor-sort-alphabetical-desc',function(){var list=$('.pages-container');var listItems=list.find('.page-tpl-box').sort(function(a,b){var filenameA=$(a).find('.filename').html().toUpperCase();var filenameB=$(b).find('.filename').html().toUpperCase();return filenameB.localeCompare(filenameA);});list.find('.page-tpl-box').remove();list.append(listItems);mergeHelper.updatePageNumbers();return false;});},syncPages:function(jobId){api.getJobInfo(jobId).done(function(response){window.qgPdfEditor.originalJob=response;});},addPage:function(jobId,inputId,localId,name){var $pageTpl=$('.page-tpl-box-base');if($pageTpl.length!==1){return;}
var $newPage=$pageTpl.clone();$newPage.removeClass('page-tpl-box-base');$newPage.removeClass('hidden');$newPage.find('img').attr('data-input',inputId);$newPage.find('img').attr('data-input-local',localId);$newPage.find('img').attr('data-job',jobId);$newPage.find('.filename').html(name);$newPage.find('.filename').attr('title',name);$newPage.attr('data-input',inputId);$newPage.attr('data-input-local',localId);$('.pages-container').append($newPage);mergeHelper.updatePageNumbers();},donePage:function(jobId,inputId,localId){var $page=$('.pages-container').find("[data-input-local='"+localId+"']");$page.attr('data-input',inputId);mergeHelper.updatePageNumbers();},removePage:function(localId){var $container=$('.pages-container');if($container.length!==1){return;}
var $page=$container.find(".page-tpl-box[data-input-local='"+localId+"']");if($page.length!==1){return;}
$page.remove();mergeHelper.updatePageNumbers();},deleteButton:function(){var $page=$(this).parent();uploader.deleteInput(parseInt($page.attr('data-input-local')));},updatePageNumbers:function(){var i=0;$('.pages-container').find('.page-tpl-box').each(function(index){i++;$(this).find('.page-number').html(i);});}};window.qgMergeHelper=mergeHelper;var uploadHelper={hasActiveUploads:function(){var inputs=uploader.getInputList();return inputs.getNumberOfQueuedInputs()!==0||inputs.getNumberOfActiveFileUploads()!==0;},setupUploadButtons:function(uploader){$('.dropzone').click(function(e){e.stopPropagation();_uploadFile();});$('#fileUploadButton').click(function(e){e.stopPropagation();_uploadFile();});var _uploadFile=function(){if(!$('#fileUploadButton').hasClass('disabled')){$('#fileUploadInput').click();}};$('.external-url-button').click(function(e){e.stopPropagation();$('#externalUrlInput').removeClass('emptyUrlError');if(!$(this).hasClass('disabled')){$('#externalUrlDialog').modal('show');$('#externalUrlInput').removeClass('emptyUrlError').val('');$('#cloudModelUrlMessage').addClass('hidden');}});$('#externalUrlDialogOkButton').click(function(e){e.stopPropagation();var externalUrl=$('#externalUrlInput').val();$('#externalUrlDialog').modal('hide');uploader.addExternalUrl(externalUrl);});$('#FormSubmitURL').submit(function(){var externalUrl=$('#externalUrlInput').val();$('#externalUrlDialog').modal('hide');uploader.addExternalUrl(externalUrl);return false;});$('.dropbox-button').click(function(e){e.stopPropagation();uploader.addDropbox();});$('.gdrive-button').click(function(e){e.stopPropagation();if($(this).hasClass('disabled')){return;}
uploader.addGdrive();});}};window.qgPdfEditor={pages:[],layer:{uploaded:0,total:0,job:{}},colorFg:{rgba:'rgb(0,0,0)',hex:'#000000',alpha:1},colorBg:{rgba:'rgb(255,255,255)',hex:'#ffffff',alpha:1},activeTool:'',defaultZoom:1,selectedShape:'',customImage:'',lcStorage:[],lcBackgroundStorage:[],currentPage:0,originalJob:{},totalUploads:0,finishedUploads:0,rotations:[0,90,180,270],lc:null,isInit:false,maxPages:199,emptyPage:'',init:function(config){globalLogger.addLogData('operation',qgOperation);window.qgPdfEditor.setupPreventNavigateAway();window.allowLeave=false;$('.ui-loading').addClass('hidden');api=createSatApi(config);if(config.hasOwnProperty('useInputs')&&config.useInputs===true){mergeHelper.init(config);}else{qgThumbnailHelper.getThumbnails(config.jobId);qgEditorUI.registerListener();}},setupPreventNavigateAway:function(){var alertText='You have unsaved changes on this page. '+
'Do you want to leave this page and discard your changes or stay on this page?';$(window).bind('beforeunload',function(){if(window.allowLeave===false){return alertText;}});},submit:function(){var pages=qgPdfEditor.getPages();if(pages===''){return;}
window.allowLeave=true;$(this).attr('disabled',true);$(this).find('i').removeClass('fa-save');$(this).find('i').addClass('fa-spin fa-spinner');api.createJob({operation:qgOperation,previousJob:window.qgPdfEditor.originalJob.id}).then(function(job){api.addInputId(job.id,qgPdfEditor.originalJob.input[0].id).then(function(data){var conversion=conversionOptions.getConversionOptionsFromForm('#sendform');var pagesToSplit=qgPdfEditor.getSplitPages();var pagesToRotate=qgPdfEditor.getRotatedPages();conversion.options.rearrange=qgPdfEditor.getPages();if(pagesToSplit!==''){conversion.options.split=pagesToSplit;}
if(pagesToRotate.length>0){conversion.options.rotate=pagesToRotate;}
api.addConversion(job.id,conversion).then(function(data){if(sat.locale!=='en'){window.location='/'+sat.locale+'/result/'+job.id;}else{window.location='/result/'+job.id;}});});});},startLayerConversion:function(){if(qgPdfEditor.layer.uploaded!==qgPdfEditor.layer.total&&qgPdfEditor.layer.uploaded<qgPdfEditor.maxPages){setTimeout(qgPdfEditor.startLayerConversion,1000);}else{api.addConversion(qgPdfEditor.layer.job.id,{target:'pdf',category:'document',options:{merge:true,allow_multiple_outputs:true}}).then(function(data){qgPdfEditor.stampLayerConversion();});}},convertToPdf:function(data){api.getJobInfo(qgPdfEditor.layer.job.id).done(function(response){if(response.status.code==='completed'){api.createJob({}).then(function(job){var newInputs=[];$.each(response.output,function(output,data){newInputs.push({type:'remote',source:data.uri});});api.addInputs(job.id,newInputs).then(function(data){api.addConversion(job.id,{target:'pdf',category:'document',options:{merge:true}}).then(function(data){qgPdfEditor.layer.job=job;qgPdfEditor.stampLayerConversion();});});});return;}
setTimeout(function(){qgPdfEditor.convertToPdf();},2000);});},stampLayerConversion:function(){api.getJobInfo(qgPdfEditor.layer.job.id).done(function(response){if(response.status.code==='completed'){api.createJob({operation:'edit',previousJob:response.id}).then(function(job){api.addInputId(job.id,qgPdfEditor.originalJob.input[0].id).then(function(){api.addExternalUrl(job.id,response.output[0].uri).then(function(){var conversion=conversionOptions.getConversionOptionsFromForm('#sendform');api.addConversion(job.id,conversion).then(function(data){if(sat.locale!=='en'){window.location='/'+sat.locale+'/result/'+job.id;}else{window.location='/result/'+job.id;}});});});});return;}
setTimeout(function(){qgPdfEditor.stampLayerConversion();},1000);});},submitEdit:function(){window.allowLeave=true;$('#tool-select').click();qgPdfEditor.saveLC(qgPdfEditor.currentPage);var pageSvgArr=[];$('.ui-loader').removeClass('hidden');$('.ui-loading').addClass('hidden');$('.menu-left-options').addClass('hidden').css('display','');$.each(qgPdfEditor.pages,function(page,data){pageSvgArr.push(qgPdfEditor.pages[page].svg);});api.createJob({operation:'edit system layers',previousJob:qgPdfEditor.originalJob.id}).then(function(job){qgPdfEditor.layer.job=job;qgPdfEditor.layer.total=pageSvgArr.length;qgPdfEditor.batchUploadLayers();});},batchUploadLayers:function(){var data=[];for(var page=0;page<qgPdfEditor.layer.total;page++){var svgContent=qgPdfEditor.pages[page].svg.replace(/fill:transparent/g,'fill:none').replace(/ 's/g,"' s").replace(/'s/g,"' s");data.push({content:Base64.encode(svgContent),filename:page+'.svg'});}
var ajaxWrapper=new AjaxWrapper();var jobInfoHelper=new JobInfoHelper(qgPdfEditor.layer.job);var options={url:jobInfoHelper.getUploadUrlBase64(),crossDomain:true,xhrFields:{withCredentials:false},cache:false,headers:{'X-Oc-Token':jobInfoHelper.getToken()},data:data,maxRetries:1,timeout:30000};ajaxWrapper.postJson(options).done(function(){globalLogger.log('pdf editor batch upload base64 layers done');qgPdfEditor.layer.uploaded=qgPdfEditor.layer.total;qgPdfEditor.startLayerConversion();}).fail(function(jqXHR,textStatus,errorThrown){globalLogger.log('pdf editor batch upload base64 layers fail',{info:options.url,ajax_status:textStatus,ajax_error:errorThrown,http_status:jqXHR.status,http_method:options.method});qgPdfEditor.uploadLayers();});},uploadLayers:function(){var totalPerc=(qgPdfEditor.layer.uploaded/qgPdfEditor.layer.total)*100;if(qgPdfEditor.layer.uploaded!==0&&qgPdfEditor.layer.uploaded===qgPdfEditor.layer.total){$('.loading-count').html(totalPerc.toFixed(0)+'%');qgPdfEditor.startLayerConversion();return;}
$('.loading-count').html(totalPerc.toFixed(0)+'%');var page=qgPdfEditor.layer.uploaded;if(page>qgPdfEditor.maxPages){qgPdfEditor.startLayerConversion();return;}
var ajaxWrapper=new AjaxWrapper();var jobInfoHelper=new JobInfoHelper(qgPdfEditor.layer.job);var options={url:jobInfoHelper.getUploadUrlBase64(),crossDomain:true,xhrFields:{withCredentials:false},cache:false,headers:{'X-Oc-Token':jobInfoHelper.getToken()},maxRetries:1};var svgContent=qgPdfEditor.pages[page].svg.replace(/fill:transparent/g,'fill:none').replace(/ 's/g,"' s").replace(/'s/g,"' s");options.data={content:Base64.encode(svgContent),filename:page+'.svg'};ajaxWrapper.postJson(options).then(function(data){qgPdfEditor.layer.uploaded++;qgPdfEditor.uploadLayers();});},setupPagesFromJob:function(job){$.each(job.output,function(page,data){window.qgPdfEditor.pages.push({id:data.id,thumbnail:data.uri,svg:''});});qgEditorUI.renderPages(window.qgPdfEditor.pages);},initLC:function(){$('.editor-stage').on('click','.page',function(e){var $parentBox=$(this).parent();});$(window).bind('mousewheel',function(event){});},saveLC:function(pageId){var arrPageId=parseInt(pageId)-1;qgPdfEditor.lcStorage[arrPageId]=JSON.stringify(qgPdfEditor.lc.getSnapshot(['shapes','imageSize','colors','position','scale']));qgPdfEditor.pages[arrPageId].svg='<?xml version="1.0" encoding="UTF-8"?> <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">'+
LC.renderSnapshotToSVG(qgPdfEditor.lc.getSnapshot(['shapes','imageSize','colors','position','scale']),{});try{qgPdfEditor.lc.setColor('background','white');var base64Image=qgPdfEditor.lc.getImage().toDataURL();qgPdfEditor.lc.setColor('background','none');}catch(e){}
var $page=$('#editor-pages').find("[data-page='"+pageId+"']");$page.parent().find('img').eq(0).attr('src',base64Image);$page.parent().find('img').eq(0).removeClass('hidden');$page.parent().find('img').eq(1).addClass('hidden');},splitAfter:function(){var $page=$(this).parent().find('img');$page.toggleClass('split');$(this).parent().toggleClass('split');},selectPage:function(e){var $testPage=$(this);if($testPage.hasClass('disabled')){return;}
var $testImg=$testPage.find('img').eq(1);if(qgPdfEditor.currentPage===$testImg.attr('data-page')){return;}
if(qgPdfEditor.currentPage!==0){$('#tool-select').click();qgPdfEditor.saveLC(qgPdfEditor.currentPage);}
qgPdfEditor.currentPage=$testImg.attr('data-page');var arrPage=$testImg.attr('data-page')-1;qgPdfEditor.initLCbackground(arrPage,$testPage);},initLCbackground:function(arrPage,$testPage){var $testImg=$testPage.find('img').eq(1);if(qgPdfEditor.lcStorage[arrPage]===undefined){var backgroundImage=new Image();backgroundImage.onload=function(){qgPdfEditor.lcBackgroundStorage[arrPage]=backgroundImage;qgPdfEditor.initLCoptions(arrPage,backgroundImage);};backgroundImage.crossOrigin='anonymous';backgroundImage.src=$testImg.attr('src');}else{var backgroundImage=qgPdfEditor.lcBackgroundStorage[arrPage];qgPdfEditor.initLCoptions(arrPage,backgroundImage);}},initLCoptions:function(arrPage,backgroundImage){var lcOptions={imageURLPrefix:'/static/img',snapshot:qgPdfEditor.lcStorage[arrPage]!==undefined?JSON.parse(qgPdfEditor.lcStorage[arrPage]):'',primaryColor:'#000000',secondaryColor:'transparent',backgroundColor:'none'};var background=[LC.createShape('Image',{x:0,y:0,image:backgroundImage})];lcOptions.imageSize={width:backgroundImage.naturalWidth,height:backgroundImage.naturalHeight};lcOptions.backgroundShapes=background;window.qgPdfEditor.lc=LC.init(document.getElementsByClassName('lc-stage')[0],lcOptions);qgPdfEditor.initLCTools();},initLCTools:function(){qgPdfEditor.lc.setZoom(qgPdfEditor.defaultZoom);var zoomIn=function(){if(qgPdfEditor.defaultZoom<=4){qgPdfEditor.defaultZoom=(parseFloat(qgPdfEditor.defaultZoom)+0.2).toFixed(1);qgPdfEditor.lc.setZoom(qgPdfEditor.defaultZoom);$('#tool-pan').trigger('click');}};var zoomOut=function(){if(qgPdfEditor.defaultZoom>=0.6){qgPdfEditor.defaultZoom=(parseFloat(qgPdfEditor.defaultZoom)-0.2).toFixed(1);qgPdfEditor.lc.setZoom(qgPdfEditor.defaultZoom);$('#tool-pan').trigger('click');}};$('#tool-zoom-in').unbind().click(function(){zoomIn();});$('#tool-zoom-out').unbind().click(function(){zoomOut();});$('#tool-image').unbind().click(function(){$('#add_image_input').trigger('click');});$('#tool-reset').unbind().click(function(){while(qgPdfEditor.lc.canUndo()){qgPdfEditor.lc.undo();}});qgPdfEditor.lc.on('shapeSelected',function(e){qgPdfEditor.selectedShape=e.selectedShape;});$('#tool-delete').unbind().click(function(){if(qgPdfEditor.selectedShape!=''&&typeof qgPdfEditor.selectedShape!='undefined'){var value=confirm(translate('Please note that you can not undo the deletion!'));if(value==true&&typeof qgPdfEditor.lc.delete!=='undefined'){qgPdfEditor.lc.delete(qgPdfEditor.selectedShape);qgPdfEditor.selectedShape='';$('#tool-select').trigger('click');}}});$('#strokewidth').unbind().change(function(){qgPdfEditor.lc.trigger('setStrokeWidth',parseInt($(this).val()));});$('#add_image_input').unbind().change(function(){if($(this).val()!==''){var fr=new FileReader(),newImage=new Image();fr.onload=function(){newImage.src=this.result;newImage.onload=function(){qgPdfEditor.customImage=this;$('#image_settings_modal').modal().on('shown.bs.modal',function(){$('#image_width').focus();});$('#image_width').val(this.width);$('#image_height').val(this.height);$('#add_image_input').val('');};};fr.readAsDataURL(this.files[0]);}});$('#add_image_button').unbind().click(function(){var errorCounter=0,imgWidthObj=$('#image_width'),imgWidthErrorContainer=imgWidthObj.parent().find('div.alert-danger');if(imgWidthObj.val()===''){errorCounter++;imgWidthErrorContainer.removeClass('hidden').find('p').html(translate("Image's width is required."));}else if(imgWidthObj.val()<=0){errorCounter++;imgWidthErrorContainer.removeClass('hidden').find('p').html(translate("Image's width must be greater than zero."));}else{imgWidthErrorContainer.addClass('hidden').find('p').html('');}
var imgHeightObj=$('#image_height'),imgHeightErrorContainer=imgHeightObj.parent().find('div.alert-danger');if(imgHeightObj.val()===''){errorCounter++;imgHeightErrorContainer.removeClass('hidden').find('p').html(translate("Image's height is required."));}else if(imgHeightObj.val()<=0){errorCounter++;imgHeightErrorContainer.removeClass('hidden').find('p').html(translate("Image's height must be greater than zero."));}else{imgHeightErrorContainer.addClass('hidden').find('p').html('');}
if(errorCounter===0){$('#image_settings_modal').modal('hide');qgPdfEditor.customImage.style.opacity=$('#image_opacity').val();qgPdfEditor.lc.saveShape(LC.createShape('Image',{x:parseInt(50),y:parseInt(50),image:qgPdfEditor.customImage,scale:(parseInt(imgWidthObj.val())/qgPdfEditor.customImage.width+
parseInt(imgHeightObj.val())/qgPdfEditor.customImage.height)/2}));qgPdfEditor.selectRecentlyAddedShape();}});$('#tool-undo').unbind().click(function(){qgPdfEditor.lc.undo();});$('#tool-redo').unbind().click(function(){qgPdfEditor.lc.redo();});$('.btn.font-tools').unbind().click(function(){if($(this).attr('id')=='font-underline-tool'){$('#font-strike-through-tool').removeClass('current');}else if($(this).attr('id')=='font-strike-through-tool'){$('#font-underline-tool').removeClass('current');}
$(this).toggleClass('current');$('#tool-text').trigger('click');});$('select[id^=font]').unbind().change(function(){$('#tool-text').trigger('click');});$('.editor-stage').unbind().on('DOMMouseScroll mousewheel',function(event){if(event.originalEvent.detail>0||event.originalEvent.wheelDelta<0){zoomOut();}else{zoomIn();}
return false;});var tools=[{name:'pan',el:document.getElementById('tool-pan'),tool:function(){return new LC.tools.Pan(qgPdfEditor.lc);},cursor:'move'},{name:'pencil',el:document.getElementById('tool-pencil'),tool:new LC.tools.Pencil(qgPdfEditor.lc)},{name:'whiteout',el:document.getElementById('tool-whiteout'),tool:function(){var eraser=new LC.tools.Rectangle(qgPdfEditor.lc),currentBgColor=qgPdfEditor.lc.getColor('secondary');qgPdfEditor.lc.setColor('primary','#ffffff');qgPdfEditor.lc.setColor('secondary','#ffffff');eraser.strokeColor='#000000';eraser.fillColor='#FFFFFF';eraser.isWhiteout=true;return eraser;},cursor:'crosshair'},{name:'tool-highlight',el:document.getElementById('tool-highlighter'),tool:function(){var highlighter=new LC.tools.Rectangle(qgPdfEditor.lc);highlighter.strokeColor='transparent';highlighter.setHighliter='yes';qgPdfEditor.lc.setColor('primary','rgba(0, 0, 0, 0');$('#colorpicker-tool-fg').spectrum('set','').spectrum('disable');qgPdfEditor.lc.setColor('secondary','rgba(255, 255, 0, 0.4)');$('#colorpicker-tool-bg').spectrum('set','rgba(255, 255, 0, 0.4)');highlighter.originalFillColor='yellow';highlighter.fillColor='rgba(255, 255, 0, 0.4)';return highlighter;},cursor:'crosshair'},{name:'line',el:document.getElementById('tool-line'),tool:function(){return new LC.tools.Line(qgPdfEditor.lc);},cursor:'crosshair'},{name:'tool-select',el:document.getElementById('tool-select'),tool:function(){return new LC.tools.SelectShape(qgPdfEditor.lc);},cursor:'pointer'},{name:'arrow',el:document.getElementById('tool-arrow'),tool:function(){var arrow=new LC.tools.Line(qgPdfEditor.lc);arrow.hasEndArrow=true;return arrow;},cursor:'crosshair'},{name:'dashed',el:document.getElementById('tool-dashed'),tool:function(){var dashed=new LC.tools.Line(qgPdfEditor.lc);dashed.isDashed=true;return dashed;},cursor:'crosshair'},{name:'ellipse',el:document.getElementById('tool-ellipse'),tool:function(){var ellipse=new LC.tools.Ellipse(qgPdfEditor.lc);ellipse.setOriginalFillColor(qgPdfEditor.colorBg.hex);ellipse.setFillColor(qgPdfEditor.colorBg.rgba);ellipse.setRectAlpha(qgPdfEditor.colorBg.alpha);return ellipse;},cursor:'crosshair'},{name:'tool-rectangle',el:document.getElementById('tool-rectangle'),tool:function(){var rectangle=new LC.tools.Rectangle(qgPdfEditor.lc);rectangle.setOriginalFillColor(qgPdfEditor.colorBg.hex);rectangle.setFillColor(qgPdfEditor.colorBg.rgba);rectangle.setRectAlpha(qgPdfEditor.colorBg.alpha);return rectangle;},cursor:'crosshair'},{name:'tool-polygon',el:document.getElementById('tool-polygon'),tool:function(){var polygon=new LC.tools.Polygon(qgPdfEditor.lc);polygon.setOriginalFillColor(qgPdfEditor.colorBg.hex);polygon.setFillColor(qgPdfEditor.colorBg.rgba);polygon.setRectAlpha(qgPdfEditor.colorBg.alpha);return polygon;},cursor:'crosshair'},{name:'text',el:document.getElementById('tool-text'),tool:function(){var text=new LC.tools.Text(qgPdfEditor.lc),fontStyle=$('#font-italic-tool').hasClass('current')?'italic':'normal',fontWeight=$('#font-bold-tool').hasClass('current')?'bold':'normal',textDecoration='none';if($('#font-strike-through-tool').hasClass('current')){textDecoration='line-through';}else if($('#font-underline-tool').hasClass('current')){textDecoration='underline';}
text.font=fontStyle+
' normal '+
fontWeight+
' '+
$('#fontSizesDropdown').val()+
'px '+
textDecoration+
' '+
$('#fonttype').val();var fontItalic1="font-style='italic'";var fontItalic2="font-style='normal'";text.fontItalic=$('#font-italic-tool').hasClass('current')?fontItalic1:fontItalic2;var fontBold1="font-weight='bold'";var fontBold2="font-weight='normal'";text.fontBold=$('#font-bold-tool').hasClass('current')?fontBold1:fontBold2;var fontSize="font-size='"+$('#fontSizesDropdown').val()+"'";text.fontSize=fontSize;var fontType="font-family='"+$('#fonttype').val()+"'";text.fontType=fontType;return text;},cursor:'text'}];var activateTool=function(t){qgPdfEditor.resetColor();qgPdfEditor.lc.setTool(new LC.tools.SelectShape(qgPdfEditor.lc));qgPdfEditor.activeTool=t.el.id;if(t.name==='whiteout'){$('#colorpicker-tool-fg').spectrum('disable');$('#colorpicker-tool-bg').spectrum('disable');$('.sp-replacer').css('opacity','.2');}else{$('#colorpicker-tool-fg').spectrum('enable');$('#colorpicker-tool-bg').spectrum('enable');$('.sp-replacer').css('opacity','1');}
if(typeof t.tool==='function'){qgPdfEditor.lc.setTool(t.tool());}else{qgPdfEditor.lc.setTool(t.tool);}
tools.forEach(function(t2){if(t==t2){t2.el.style.backgroundColor='#0D47A1';t2.el.style.color='white';}else{t2.el.style.backgroundColor='transparent';t2.el.style.color='#585858';}});};tools.forEach(function(t){t.el.style.cursor='pointer';t.el.onclick=function(e){e.preventDefault();activateTool(t);};});activateTool(tools[0]);$('.zoom-input').change(function(e){var level=$(this).val();qgPdfEditor.lc.setZoom(level);});if(qgPdfEditor.isInit===false){qgPdfEditor.isInit=true;$.each(qgPdfEditor.pages,function(page,data){qgPdfEditor.pages[page].svg=LC.renderSnapshotToSVG(qgPdfEditor.lc.getSnapshot(['shapes','imageSize','colors','position','scale']));});}},selectRecentlyAddedShape:function(){$('#tool-select').trigger('click');var selectedShape=qgPdfEditor.lc.shapes[qgPdfEditor.lc.shapes.length-1];if(typeof selectedShape!='undefined'){qgPdfEditor.lc.trigger('shapeSelected',{selectedShape:selectedShape});qgPdfEditor.lc.setShapesInProgress([selectedShape,LC.createShape('SelectionBox',{shape:selectedShape,handleSize:0})]);}
qgPdfEditor.lc.repaintLayer('main');},resetColor:function(){qgPdfEditor.lc.setColor('primary',qgPdfEditor.colorFg.hex);$('#colorpicker-tool-fg').spectrum('set',qgPdfEditor.colorFg.rgba);qgPdfEditor.lc.setColor('secondary',qgPdfEditor.colorBg.hex);$('#colorpicker-tool-bg').spectrum('set',qgPdfEditor.colorBg.rgba);},getPages:function(){return $('.pages-container').find('.editor-page-img-load').filter(':not(".deleted")').map(function(){return parseInt($(this).attr('data-page'));}).get().join(',');},getSplitPages:function(){var $totalPages=$('.pages-container').find('.editor-page-img-load').not('.deleted').length;var activePages=0;var $pages=$('.pages-container').find('.editor-page-img-load').map(function(i,val){if($(this).hasClass('deleted')===false){activePages++;}
if($(this).hasClass('deleted')===false&&$(this).hasClass('split')===true){if(activePages!==$totalPages){return activePages;}}}).get();return $pages.join(',');},getRotatedPages:function(){var rotateData=[];$.each(qgPdfEditor.rotations,function(index,rotation){var pages=$('.pages-container').find('.editor-page-img-load').filter(':not(".deleted")').filter('[data-rotation="'+rotation+'"]').map(function(){return parseInt($(this).attr('data-page'));}).get().join(',');if(pages!==''){rotateData.push({angle:rotation,pages:pages});}});return rotateData;},rotateLeft:function(){var $page=$(this).parent().find('img');var rotation=Math.abs(parseInt($page.attr('data-rotation')))||0;rotation=_getNewRotation(rotation,'left');$page.attr('data-rotation',rotation);_rotateThumbnail($page,rotation);},rotateRight:function(){var $page=$(this).parent().find('img');var rotation=Math.abs(parseInt($page.attr('data-rotation')))||0;rotation=_getNewRotation(rotation,'right');$page.attr('data-rotation',rotation);_rotateThumbnail($page,rotation);},delete:function(){var $page=$(this).parent().find('img');$page.toggleClass('deleted');$page.parent().toggleClass('pageDeleted');if($page.parent().find('.pageDeletedIcon').length>0){$page.parent().find('.pageDeletedIcon').remove();}else{$page.parent().append('<div class="pageDeletedIcon"><i class="fa fa-trash fa-4x"></i></div>');}},inputEvents:inputEvents};var _getNewRotation=function(rotation,direction){var newRotation={left:{0:270,270:180,180:90,90:0},right:{0:90,90:180,180:270,270:0}};return newRotation[direction][rotation];};var _rotateThumbnail=function($thumbnail,rotation){var width=$thumbnail.parent().width();$thumbnail.css({'-webkit-transform':'rotate('+rotation+'deg)',transform:'rotate('+rotation+'deg)','-webkit-transition':'none',transition:'none'});$thumbnail.attr('data-rotation',rotation);};}());